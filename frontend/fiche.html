<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chargement...</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <!-- Theme Loader -->
  <script src="/js/theme-loader.js"></script>
  <style id="dynamic-styles">
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
    }
  </style>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }

    .navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      padding: 1rem 0;
    }

    .navbar-brand {
      font-weight: bold;
      font-size: 1.5rem;
    }

    /* Breadcrumb */
    .breadcrumb-section {
      background: white;
      padding: 1rem 0;
      border-bottom: 1px solid #e9ecef;
    }

    .breadcrumb {
      margin-bottom: 0;
    }

    /* Main content */
    .fiche-section {
      padding: 2rem 0;
    }

    .fiche-card {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .fiche-image-container {
      position: relative;
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fiche-image {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
    }

    .fiche-image-placeholder {
      font-size: 6rem;
      color: #adb5bd;
    }

    .fiche-body {
      padding: 2rem;
    }

    .fiche-type-badge {
      display: inline-block;
      padding: 0.35rem 1rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 1rem;
    }

    .badge-jeu { background: #e8f5e9; color: #2e7d32; }
    .badge-livre { background: #e3f2fd; color: #1565c0; }
    .badge-film { background: #fce4ec; color: #c2185b; }
    .badge-disque { background: #fff3e0; color: #e65100; }

    .fiche-title {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .fiche-subtitle {
      font-size: 1.25rem;
      color: #6c757d;
      margin-bottom: 1.5rem;
    }

    .fiche-status {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    .status-disponible { background: #d4edda; color: #155724; }
    .status-emprunte { background: #f8d7da; color: #721c24; }
    .status-maintenance { background: #fff3cd; color: #856404; }

    /* Nouveaute badge */
    .fiche-nouveaute-badge {
      display: inline-block;
      padding: 0.35rem 0.85rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 1rem;
      animation: nouveaute-pulse 2s ease-in-out infinite;
    }

    @keyframes nouveaute-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.85; transform: scale(1.05); }
    }

    /* Meta grid */
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .meta-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
    }

    .meta-item i {
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      display: block;
    }

    .meta-item .meta-label {
      font-size: 0.75rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .meta-item .meta-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
    }

    /* Tags */
    .tags-section {
      margin-bottom: 1.5rem;
    }

    .tags-section h6 {
      color: #6c757d;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }

    .tag {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      background: #e9ecef;
      border-radius: 50px;
      font-size: 0.85rem;
      margin: 0.25rem;
      color: #495057;
    }

    /* Description */
    .description-section {
      margin-bottom: 1.5rem;
    }

    .description-section h5 {
      color: #333;
      margin-bottom: 1rem;
    }

    .description-section p {
      color: #6c757d;
      line-height: 1.7;
    }

    /* Actions */
    .actions-section {
      padding-top: 1.5rem;
      border-top: 1px solid #e9ecef;
    }

    /* Similar items */
    .similar-section {
      padding: 2rem 0;
    }

    .similar-section h4 {
      margin-bottom: 1.5rem;
    }

    .similar-card {
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .similar-card:hover {
      transform: translateY(-3px);
    }

    .similar-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .similar-card .card-body {
      padding: 0.75rem;
    }

    .similar-card .card-title {
      font-size: 0.9rem;
      margin-bottom: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Loading */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary-color);
    }

    /* Error */
    .error-container {
      text-align: center;
      padding: 4rem;
    }

    .error-container i {
      font-size: 4rem;
      color: #dc3545;
      margin-bottom: 1rem;
    }

    /* Footer */
    footer {
      background: #333;
      color: white;
      padding: 2rem 0;
      text-align: center;
      margin-top: 2rem;
    }

    footer a {
      color: #20c997;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="/" id="nav-brand">
        <i class="bi bi-dice-5 me-2" style="font-size: 2rem;"></i>
        <span id="site-name">Chargement...</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Accueil</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/catalogue.html">Catalogue</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/infos.html">Infos pratiques</a>
          </li>
          <li class="nav-item" id="nav-espace" style="display: none;">
            <a class="nav-link btn btn-light text-dark ms-2 px-3" href="/usager/login.html">
              <i class="bi bi-person-circle"></i> Mon espace
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Breadcrumb -->
  <section class="breadcrumb-section">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Accueil</a></li>
          <li class="breadcrumb-item"><a href="/catalogue.html">Catalogue</a></li>
          <li class="breadcrumb-item active" id="breadcrumb-item">Chargement...</li>
        </ol>
      </nav>
    </div>
  </section>

  <!-- Main content -->
  <section class="fiche-section">
    <div class="container">
      <!-- Loading -->
      <div class="loading-container" id="loading">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
      </div>

      <!-- Error -->
      <div class="error-container" id="error" style="display: none;">
        <i class="bi bi-exclamation-circle"></i>
        <h4>Item non trouve</h4>
        <p class="text-muted">Cet element n'existe pas ou n'est plus disponible.</p>
        <a href="/catalogue.html" class="btn btn-primary">Retour au catalogue</a>
      </div>

      <!-- Fiche content -->
      <div id="fiche-content" style="display: none;">
        <div class="row">
          <div class="col-lg-5 mb-4">
            <div class="fiche-image-container" id="image-container">
              <!-- Image loaded dynamically -->
            </div>
          </div>
          <div class="col-lg-7">
            <div class="fiche-card">
              <div class="fiche-body">
                <span class="fiche-type-badge" id="type-badge">Type</span>
                <span class="badge bg-danger fiche-nouveaute-badge" id="nouveaute-badge" style="display: none;">
                  <i class="bi bi-stars me-1"></i>Nouveau
                </span>
                <h1 class="fiche-title" id="item-title">Titre</h1>
                <p class="fiche-subtitle" id="item-subtitle" style="display: none;"></p>

                <span class="fiche-status" id="item-status">Statut</span>

                <div class="meta-grid" id="meta-grid">
                  <!-- Meta items loaded dynamically -->
                </div>

                <div class="tags-section" id="categories-section" style="display: none;">
                  <h6>Categories</h6>
                  <div id="categories-list"></div>
                </div>

                <div class="tags-section" id="themes-section" style="display: none;">
                  <h6>Themes</h6>
                  <div id="themes-list"></div>
                </div>

                <div class="tags-section" id="mecanismes-section" style="display: none;">
                  <h6>Mecanismes</h6>
                  <div id="mecanismes-list"></div>
                </div>

                <div class="description-section" id="description-section" style="display: none;">
                  <h5>Description</h5>
                  <p id="item-description"></p>
                </div>

                <div class="actions-section">
                  <a href="/catalogue.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Retour au catalogue
                  </a>
                  <button class="btn btn-primary ms-2" id="btn-reserve" style="display: none;">
                    <i class="bi bi-bookmark-plus"></i> Reserver
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p class="mb-2" id="footer-text">&copy; 2025 - Tous droits reserves</p>
      <p class="mb-0">
        <a href="/admin/login.html"><i class="bi bi-lock"></i> Administration</a>
      </p>
    </div>
  </footer>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    // Icons for each type
    const typeIcons = {
      jeu: 'bi-controller',
      livre: 'bi-book',
      film: 'bi-film',
      disque: 'bi-disc'
    };

    const typeLabels = {
      jeu: 'Jeu',
      livre: 'Livre',
      film: 'Film',
      disque: 'Disque'
    };

    let config = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      await loadItem();
    });

    // Load site configuration
    async function loadConfig() {
      try {
        const response = await fetch('/api/public/config');
        config = await response.json();

        document.getElementById('site-name').textContent = config.nom_site;

        if (config.couleur_primaire || config.couleur_secondaire) {
          document.getElementById('dynamic-styles').textContent = `
            :root {
              --primary-color: ${config.couleur_primaire || '#667eea'};
              --secondary-color: ${config.couleur_secondaire || '#764ba2'};
            }
          `;
        }

        if (config.css_personnalise) {
          const customStyle = document.createElement('style');
          customStyle.textContent = config.css_personnalise;
          document.head.appendChild(customStyle);
        }

        // Show "Mon espace" if inscriptions enabled
        if (config.modules && config.modules.inscriptions) {
          document.getElementById('nav-espace').style.display = 'block';
        }

        document.getElementById('footer-text').textContent = `Â© 2025 ${config.nom_site} - Tous droits reserves`;

      } catch (error) {
        console.error('Erreur chargement config:', error);
      }
    }

    // Load item
    async function loadItem() {
      const params = new URLSearchParams(window.location.search);
      const type = params.get('type');
      const id = params.get('id');

      if (!type || !id) {
        showError();
        return;
      }

      try {
        const response = await fetch(`/api/public/catalogue/${type}/${id}`);

        if (!response.ok) {
          showError();
          return;
        }

        const item = await response.json();
        renderItem(item);

      } catch (error) {
        console.error('Erreur chargement item:', error);
        showError();
      }
    }

    // Show error
    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
    }

    // Render item
    function renderItem(item) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('fiche-content').style.display = 'block';

      // Update page title
      document.title = `${item.titre} - ${config.nom_site}`;
      document.getElementById('breadcrumb-item').textContent = item.titre;

      // Image
      const imageContainer = document.getElementById('image-container');
      if (item.image_url) {
        imageContainer.innerHTML = `<img src="${item.image_url}" alt="${item.titre}" class="fiche-image">`;
      } else {
        imageContainer.innerHTML = `<i class="bi ${typeIcons[item.type]} fiche-image-placeholder"></i>`;
      }

      // Type badge
      const typeBadge = document.getElementById('type-badge');
      typeBadge.textContent = item.type_label;
      typeBadge.className = `fiche-type-badge badge-${item.type}`;

      // Nouveaute badge
      if (item.est_nouveau) {
        document.getElementById('nouveaute-badge').style.display = 'inline-block';
      }

      // Title
      document.getElementById('item-title').textContent = item.titre;

      // Subtitle
      if (item.sous_titre) {
        const subtitleEl = document.getElementById('item-subtitle');
        subtitleEl.textContent = item.sous_titre;
        subtitleEl.style.display = 'block';
      }

      // Status
      const statusEl = document.getElementById('item-status');
      const statusLabels = {
        disponible: 'Disponible',
        emprunte: 'Actuellement emprunte',
        maintenance: 'En maintenance'
      };
      statusEl.textContent = statusLabels[item.statut] || item.statut;
      statusEl.className = `fiche-status status-${item.statut}`;

      // Meta grid
      const metaGrid = document.getElementById('meta-grid');
      let metaHtml = '';

      if (item.type === 'jeu') {
        if (item.nb_joueurs_min) {
          const joueurs = item.nb_joueurs_max && item.nb_joueurs_max !== item.nb_joueurs_min
            ? `${item.nb_joueurs_min} - ${item.nb_joueurs_max}`
            : item.nb_joueurs_min;
          metaHtml += createMetaItem('bi-people', 'Joueurs', joueurs);
        }
        if (item.duree_partie) {
          metaHtml += createMetaItem('bi-clock', 'Duree', `${item.duree_partie} min`);
        }
        if (item.age_min) {
          metaHtml += createMetaItem('bi-person', 'Age minimum', `${item.age_min} ans`);
        }
        if (item.annee_sortie) {
          metaHtml += createMetaItem('bi-calendar', 'Annee', item.annee_sortie);
        }
      }

      if (item.type === 'livre') {
        if (item.nb_pages) {
          metaHtml += createMetaItem('bi-file-text', 'Pages', item.nb_pages);
        }
        if (item.annee_publication) {
          metaHtml += createMetaItem('bi-calendar', 'Annee', item.annee_publication);
        }
        if (item.tome) {
          metaHtml += createMetaItem('bi-collection', 'Tome', item.tome);
        }
      }

      if (item.type === 'film') {
        if (item.duree) {
          metaHtml += createMetaItem('bi-clock', 'Duree', `${item.duree} min`);
        }
        if (item.annee_sortie) {
          metaHtml += createMetaItem('bi-calendar', 'Annee', item.annee_sortie);
        }
        if (item.classification) {
          metaHtml += createMetaItem('bi-shield', 'Classification', item.classification);
        }
      }

      if (item.type === 'disque') {
        if (item.nb_pistes) {
          metaHtml += createMetaItem('bi-music-note-list', 'Pistes', item.nb_pistes);
        }
        if (item.duree_totale) {
          metaHtml += createMetaItem('bi-clock', 'Duree', `${item.duree_totale} min`);
        }
        if (item.annee_sortie) {
          metaHtml += createMetaItem('bi-calendar', 'Annee', item.annee_sortie);
        }
      }

      if (item.prix_indicatif) {
        metaHtml += createMetaItem('bi-tag', 'Prix indicatif', `${item.prix_indicatif} EUR`);
      }

      metaGrid.innerHTML = metaHtml;

      // Categories (jeux)
      if (item.categories && item.categories.length > 0) {
        document.getElementById('categories-section').style.display = 'block';
        document.getElementById('categories-list').innerHTML = item.categories
          .map(c => `<span class="tag">${c.nom}</span>`)
          .join('');
      }

      // Themes
      if (item.themes && item.themes.length > 0) {
        document.getElementById('themes-section').style.display = 'block';
        document.getElementById('themes-list').innerHTML = item.themes
          .map(t => `<span class="tag">${t.nom}</span>`)
          .join('');
      }

      // Mecanismes (jeux)
      if (item.mecanismes && item.mecanismes.length > 0) {
        document.getElementById('mecanismes-section').style.display = 'block';
        document.getElementById('mecanismes-list').innerHTML = item.mecanismes
          .map(m => `<span class="tag">${m.nom}</span>`)
          .join('');
      }

      // Description
      const description = item.description || item.resume || item.synopsis;
      if (description) {
        document.getElementById('description-section').style.display = 'block';
        document.getElementById('item-description').textContent = description;
      }

      // Reservation button
      if (config.modules.reservations && item.statut === 'disponible') {
        document.getElementById('btn-reserve').style.display = 'inline-block';
      }
    }

    // Create meta item HTML
    function createMetaItem(icon, label, value) {
      return `
        <div class="meta-item">
          <i class="bi ${icon}"></i>
          <div class="meta-label">${label}</div>
          <div class="meta-value">${value}</div>
        </div>
      `;
    }
  </script>
</body>
</html>
