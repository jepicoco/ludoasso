<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration LLM - Parametres - Liberteko Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    .section-card { margin-bottom: 1.5rem; }
    .section-card .card-header { background-color: #f8f9fa; font-weight: 600; }
    .config-card { transition: transform 0.2s, box-shadow 0.2s; }
    .config-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .config-card.default { border-color: #198754; border-width: 2px; }
    .config-card.inactive { opacity: 0.6; }
    .sub-nav { background: #f8f9fa; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e9ecef; }
    .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .status-indicator.success { background-color: #198754; }
    .status-indicator.error { background-color: #dc3545; }
    .status-indicator.pending { background-color: #ffc107; }
    .provider-icon { font-size: 1.5rem; }
    .cost-badge { font-size: 0.75rem; }
    .quota-bar { height: 6px; }
  </style>
</head>
<body>
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <div class="col-md-10">
        <div id="sub-nav-container"></div>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1><i class="bi bi-robot"></i> Configuration LLM</h1>
            <p class="text-muted mb-0">Providers d'intelligence artificielle pour la recherche naturelle</p>
          </div>
          <button class="btn btn-primary" onclick="openAddModal()">
            <i class="bi bi-plus"></i> Ajouter un provider
          </button>
        </div>

        <!-- Stats rapides -->
        <div class="row mb-4" id="stats-container">
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body py-3">
                <div class="fs-3 fw-bold text-primary" id="stat-active">-</div>
                <div class="text-muted small">Providers actifs</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body py-3">
                <div class="fs-3 fw-bold text-success" id="stat-default">-</div>
                <div class="text-muted small">Provider par defaut</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body py-3">
                <div class="fs-3 fw-bold text-info" id="stat-usage">-</div>
                <div class="text-muted small">Requetes aujourd'hui</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body py-3">
                <div class="fs-3 fw-bold text-secondary" id="stat-total">-</div>
                <div class="text-muted small">Configurations</div>
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          Configurez les providers LLM (Anthropic Claude, OpenAI GPT, Mistral, Ollama local) pour activer la recherche naturelle
          dans le catalogue. Le provider par defaut sera utilise pour les recherches et l'enrichissement thematique.
        </div>

        <div id="configs-container">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 mb-0">Chargement...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Config LLM -->
  <div class="modal fade" id="modalConfig" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalConfigTitle">Nouveau provider LLM</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formConfig">
            <input type="hidden" id="config_id">

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="config_provider" class="form-label">Provider <span class="text-danger">*</span></label>
                  <select class="form-select" id="config_provider" required onchange="onProviderChange()">
                    <option value="">-- Selectionnez --</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="config_libelle" class="form-label">Libelle <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="config_libelle" required placeholder="Ex: Claude Principal">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="config_model" class="form-label">Modele <span class="text-danger">*</span></label>
                  <select class="form-select" id="config_model" required>
                    <option value="">-- Selectionnez d'abord un provider --</option>
                  </select>
                  <div class="form-text" id="model-cost-info"></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="config_temperature" class="form-label">Temperature</label>
                  <input type="number" class="form-control" id="config_temperature" min="0" max="1" step="0.1" value="0.3">
                  <div class="form-text">0 = deterministe, 1 = creatif</div>
                </div>
              </div>
            </div>

            <hr>
            <h6 class="mb-3">Authentification</h6>

            <div class="row">
              <div class="col-md-12">
                <div class="mb-3" id="api-key-group">
                  <label for="config_api_key" class="form-label">Cle API <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="config_api_key" placeholder="sk-...">
                    <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                      <i class="bi bi-eye" id="api-key-toggle-icon"></i>
                    </button>
                  </div>
                  <div class="form-text">Laissez vide pour conserver la cle existante lors de la modification</div>
                </div>
              </div>
            </div>

            <div class="row" id="base-url-group" style="display: none;">
              <div class="col-md-12">
                <div class="mb-3">
                  <label for="config_base_url" class="form-label">URL de base</label>
                  <input type="url" class="form-control" id="config_base_url" placeholder="http://localhost:11434">
                  <div class="form-text">Requis pour Ollama, optionnel pour les autres (proxy, endpoint custom)</div>
                </div>
              </div>
            </div>

            <hr>
            <h6 class="mb-3">Parametres avances</h6>

            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="config_max_tokens" class="form-label">Max tokens</label>
                  <input type="number" class="form-control" id="config_max_tokens" min="100" max="8000" value="1000">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="config_limite" class="form-label">Limite requetes/jour</label>
                  <input type="number" class="form-control" id="config_limite" min="0" placeholder="Illimite">
                  <div class="form-text">0 ou vide = illimite</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Options</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="config_actif">
                    <label class="form-check-label" for="config_actif">Actif</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="config_par_defaut">
                    <label class="form-check-label" for="config_par_defaut">Par defaut</label>
                  </div>
                </div>
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveConfig()">
            <i class="bi bi-check"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Test Connection -->
  <div class="modal fade" id="modalTest" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Test de connexion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="test-result">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 mb-0">Test en cours...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="/admin/js/admin-navigation.js"></script>
  <script src="/admin/js/admin-template.js"></script>
  <script src="/admin/js/api-admin.js"></script>
  <script src="/admin/js/parametres-nav.js"></script>
  <script>
    let modalConfig, modalTest;
    let providers = [];
    let configurations = [];

    document.addEventListener('DOMContentLoaded', async () => {
      initTemplate('parametres');
      renderSubNav('services-externes', 'ia');
      modalConfig = new bootstrap.Modal(document.getElementById('modalConfig'));
      modalTest = new bootstrap.Modal(document.getElementById('modalTest'));

      await loadProviders();
      await loadConfigurations();
      await loadStats();
    });

    async function loadProviders() {
      try {
        providers = await apiAdmin.get('/parametres/llm/providers');
        const select = document.getElementById('config_provider');
        select.innerHTML = '<option value="">-- Selectionnez --</option>';
        providers.forEach(p => {
          select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
      } catch (error) {
        console.error('Error loading providers:', error);
      }
    }

    async function loadConfigurations() {
      try {
        configurations = await apiAdmin.get('/parametres/llm');
        renderConfigurations();
      } catch (error) {
        console.error('Error loading configurations:', error);
        document.getElementById('configs-container').innerHTML = `
          <div class="alert alert-danger">Erreur lors du chargement des configurations</div>
        `;
      }
    }

    async function loadStats() {
      try {
        const stats = await apiAdmin.get('/parametres/llm/stats');
        document.getElementById('stat-active').textContent = stats.active_configs;
        document.getElementById('stat-default').textContent = stats.has_default ? 'Oui' : 'Non';
        document.getElementById('stat-usage').textContent = stats.usage_today;
        document.getElementById('stat-total').textContent = stats.total_configs;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    function renderConfigurations() {
      const container = document.getElementById('configs-container');

      if (configurations.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-robot text-muted" style="font-size: 4rem;"></i>
            <p class="mt-3 text-muted">Aucun provider LLM configure</p>
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus"></i> Ajouter un provider
            </button>
          </div>
        `;
        return;
      }

      // Grouper par provider
      const byProvider = {};
      configurations.forEach(c => {
        if (!byProvider[c.provider]) byProvider[c.provider] = [];
        byProvider[c.provider].push(c);
      });

      let html = '';
      for (const [provider, configs] of Object.entries(byProvider)) {
        const providerInfo = providers.find(p => p.id === provider) || { name: provider };

        html += `
          <div class="card section-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>${getProviderIcon(provider)} ${providerInfo.name}</span>
              <span class="badge bg-secondary">${configs.length} configuration(s)</span>
            </div>
            <div class="card-body">
              <div class="row">
        `;

        configs.forEach(config => {
          const isDefault = config.par_defaut;
          const isActive = config.actif;
          const quotaPercent = config.limite_requetes_jour
            ? Math.round((config.requetes_aujourdhui / config.limite_requetes_jour) * 100)
            : 0;

          html += `
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card config-card h-100 ${isDefault ? 'default' : ''} ${!isActive ? 'inactive' : ''}">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">${config.libelle}</h6>
                    <div>
                      ${isDefault ? '<span class="badge bg-success me-1">Defaut</span>' : ''}
                      <span class="badge ${isActive ? 'bg-primary' : 'bg-secondary'}">${isActive ? 'Actif' : 'Inactif'}</span>
                    </div>
                  </div>
                  <p class="card-text small text-muted mb-2">
                    <i class="bi bi-cpu"></i> ${config.model}
                  </p>
                  <p class="card-text small mb-2">
                    <i class="bi bi-key"></i> Cle API: ${config.has_api_key ? '<span class="text-success">Configuree</span>' : '<span class="text-danger">Manquante</span>'}
                  </p>
                  ${config.limite_requetes_jour ? `
                    <div class="mb-2">
                      <small class="text-muted">Quota: ${config.requetes_aujourdhui}/${config.limite_requetes_jour}</small>
                      <div class="progress quota-bar">
                        <div class="progress-bar ${quotaPercent > 80 ? 'bg-danger' : quotaPercent > 50 ? 'bg-warning' : 'bg-success'}"
                             style="width: ${quotaPercent}%"></div>
                      </div>
                    </div>
                  ` : ''}
                </div>
                <div class="card-footer bg-transparent">
                  <div class="btn-group btn-group-sm w-100">
                    <button class="btn btn-outline-primary" onclick="testConnection(${config.id})" title="Tester">
                      <i class="bi bi-plug"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="editConfig(${config.id})" title="Modifier">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-${isActive ? 'warning' : 'success'}" onclick="toggleConfig(${config.id})" title="${isActive ? 'Desactiver' : 'Activer'}">
                      <i class="bi bi-${isActive ? 'pause' : 'play'}"></i>
                    </button>
                    ${!isDefault && isActive ? `
                      <button class="btn btn-outline-success" onclick="setDefault(${config.id})" title="Definir par defaut">
                        <i class="bi bi-star"></i>
                      </button>
                    ` : ''}
                    <button class="btn btn-outline-danger" onclick="deleteConfig(${config.id})" title="Supprimer">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div></div></div>';
      }

      container.innerHTML = html;
    }

    function getProviderIcon(provider) {
      const icons = {
        anthropic: '<i class="bi bi-chat-square-dots text-primary"></i>',
        openai: '<i class="bi bi-stars text-success"></i>',
        mistral: '<i class="bi bi-wind text-info"></i>',
        ollama: '<i class="bi bi-pc-display text-secondary"></i>'
      };
      return icons[provider] || '<i class="bi bi-robot"></i>';
    }

    function onProviderChange() {
      const provider = document.getElementById('config_provider').value;
      const modelSelect = document.getElementById('config_model');
      const apiKeyGroup = document.getElementById('api-key-group');
      const baseUrlGroup = document.getElementById('base-url-group');

      modelSelect.innerHTML = '<option value="">-- Selectionnez --</option>';

      if (!provider) return;

      const providerInfo = providers.find(p => p.id === provider);
      if (providerInfo) {
        providerInfo.models.forEach(m => {
          const costBadge = m.cost === 'free' ? 'Gratuit' :
                           m.cost === 'low' ? 'Economique' :
                           m.cost === 'medium' ? 'Standard' : 'Premium';
          modelSelect.innerHTML += `<option value="${m.id}" data-cost="${m.cost}">${m.name} (${costBadge})</option>`;
        });

        // Afficher/masquer les champs selon le provider
        if (provider === 'ollama') {
          apiKeyGroup.style.display = 'none';
          baseUrlGroup.style.display = 'block';
          document.getElementById('config_base_url').value = 'http://localhost:11434';
        } else {
          apiKeyGroup.style.display = 'block';
          baseUrlGroup.style.display = 'none';
        }
      }
    }

    function toggleApiKeyVisibility() {
      const input = document.getElementById('config_api_key');
      const icon = document.getElementById('api-key-toggle-icon');
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
      }
    }

    function openAddModal() {
      document.getElementById('formConfig').reset();
      document.getElementById('config_id').value = '';
      document.getElementById('modalConfigTitle').textContent = 'Nouveau provider LLM';
      document.getElementById('config_model').innerHTML = '<option value="">-- Selectionnez d\'abord un provider --</option>';
      document.getElementById('api-key-group').style.display = 'block';
      document.getElementById('base-url-group').style.display = 'none';
      modalConfig.show();
    }

    async function editConfig(id) {
      try {
        const config = await apiAdmin.get(`/parametres/llm/${id}`);

        document.getElementById('config_id').value = config.id;
        document.getElementById('config_provider').value = config.provider;
        onProviderChange();
        document.getElementById('config_libelle').value = config.libelle;
        document.getElementById('config_model').value = config.model;
        document.getElementById('config_temperature').value = config.temperature;
        document.getElementById('config_max_tokens').value = config.max_tokens;
        document.getElementById('config_limite').value = config.limite_requetes_jour || '';
        document.getElementById('config_base_url').value = config.base_url || '';
        document.getElementById('config_actif').checked = config.actif;
        document.getElementById('config_par_defaut').checked = config.par_defaut;
        document.getElementById('config_api_key').value = '';

        document.getElementById('modalConfigTitle').textContent = 'Modifier le provider LLM';
        modalConfig.show();
      } catch (error) {
        showToast('Erreur lors du chargement de la configuration', 'error')
      }
    }

    async function saveConfig() {
      const id = document.getElementById('config_id').value;
      const data = {
        provider: document.getElementById('config_provider').value,
        libelle: document.getElementById('config_libelle').value,
        model: document.getElementById('config_model').value,
        temperature: parseFloat(document.getElementById('config_temperature').value),
        max_tokens: parseInt(document.getElementById('config_max_tokens').value),
        limite_requetes_jour: document.getElementById('config_limite').value ? parseInt(document.getElementById('config_limite').value) : null,
        base_url: document.getElementById('config_base_url').value || null,
        actif: document.getElementById('config_actif').checked,
        par_defaut: document.getElementById('config_par_defaut').checked
      };

      const apiKey = document.getElementById('config_api_key').value;
      if (apiKey) {
        data.api_key = apiKey;
      }

      try {
        if (id) {
          await apiAdmin.put(`/parametres/llm/${id}`, data);
        } else {
          await apiAdmin.post('/parametres/llm', data);
        }
        modalConfig.hide();
        await loadConfigurations();
        await loadStats();
      } catch (error) {
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'success')
      }
    }

    async function toggleConfig(id) {
      try {
        await apiAdmin.patch(`/parametres/llm/${id}/toggle`);
        await loadConfigurations();
        await loadStats();
      } catch (error) {
        showToast('Erreur lors du changement de statut', 'error')
      }
    }

    async function setDefault(id) {
      try {
        await apiAdmin.patch(`/parametres/llm/${id}/set-default`);
        await loadConfigurations();
        await loadStats();
      } catch (error) {
        showToast(error.message || 'Erreur lors de la definition par defaut', 'error')
      }
    }

    async function deleteConfig(id) {
      if (!confirm('Supprimer cette configuration ?')) return;
      try {
        await apiAdmin.delete(`/parametres/llm/${id}`);
        await loadConfigurations();
        await loadStats();
      } catch (error) {
        showToast('Erreur lors de la suppression', 'error')
      }
    }

    async function testConnection(id) {
      document.getElementById('test-result').innerHTML = `
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 mb-0">Test en cours...</p>
      `;
      modalTest.show();

      try {
        const result = await apiAdmin.post(`/parametres/llm/${id}/test`);
        if (result.success) {
          document.getElementById('test-result').innerHTML = `
            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            <p class="mt-3 mb-0 text-success fw-bold">Connexion reussie !</p>
            <p class="text-muted small">${result.response || ''}</p>
          `;
        } else {
          document.getElementById('test-result').innerHTML = `
            <i class="bi bi-x-circle text-danger" style="font-size: 4rem;"></i>
            <p class="mt-3 mb-0 text-danger fw-bold">Echec de connexion</p>
            <p class="text-muted small">${result.message}</p>
          `;
        }
      } catch (error) {
        document.getElementById('test-result').innerHTML = `
          <i class="bi bi-x-circle text-danger" style="font-size: 4rem;"></i>
          <p class="mt-3 mb-0 text-danger fw-bold">Erreur</p>
          <p class="text-muted small">${error.message}</p>
        `;
      }
    }
  </script>
</body>
</html>
