<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveautes - Parametres - Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    .module-card {
      border: 2px solid #dee2e6;
      border-radius: 0.75rem;
      transition: all 0.2s;
      height: 100%;
    }
    .module-card.active {
      border-color: #dc3545;
    }
    .module-card.inactive {
      opacity: 0.5;
      border-color: #dee2e6;
    }
    .module-card.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    .module-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }
    .module-icon.ludotheque { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .module-icon.bibliotheque { background: rgba(32, 201, 151, 0.1); color: #20c997; }
    .module-icon.filmotheque { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .module-icon.discotheque { background: rgba(232, 62, 140, 0.1); color: #e83e8c; }
    .form-range-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .form-range-container .form-range {
      flex: 1;
    }
    .form-range-value {
      min-width: 55px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      z-index: 1050;
      display: none;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .save-indicator.saving {
      display: flex;
      background: #fff3cd;
      color: #856404;
    }
    .save-indicator.saved {
      display: flex;
      background: #d1e7dd;
      color: #0f5132;
    }
    .save-indicator.error {
      display: flex;
      background: #f8d7da;
      color: #842029;
    }
    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .module-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .module-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .config-section {
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
    }
    .nouveaute-badge-preview {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.35rem 0.65rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.85; transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <!-- Navigation (genere par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (genere par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <div id="sub-nav-container"></div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="parametres.html">Parametres</a></li>
                <li class="breadcrumb-item active">Nouveautes</li>
              </ol>
            </nav>
            <h1 class="h3 mb-0">
              <i class="bi bi-stars me-2 text-danger"></i>Nouveautes
              <span class="badge bg-danger nouveaute-badge-preview ms-2">
                <i class="bi bi-stars"></i> Nouveau
              </span>
            </h1>
          </div>
        </div>

        <div class="alert alert-info mb-4">
          <i class="bi bi-info-circle me-2"></i>
          Configurez la duree pendant laquelle un article est considere comme "nouveau" apres son acquisition.
          Les modifications sont enregistrees automatiquement.
        </div>

        <!-- Message si aucune structure selectionnee -->
        <div class="alert alert-warning d-none" id="noStructureAlert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Structure requise</strong> - Veuillez selectionner une structure dans le menu en haut de page pour configurer les nouveautes.
          <br><small class="text-muted">Les parametres de nouveautes sont specifiques a chaque structure.</small>
        </div>

        <div class="row g-4" id="modulesContainer">
          <!-- Modules generes par JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Indicateur de sauvegarde -->
  <div class="save-indicator" id="saveIndicator">
    <span class="spinner-border spinner-border-sm" id="saveSpinner"></span>
    <i class="bi bi-check-circle d-none" id="saveCheck"></i>
    <i class="bi bi-exclamation-circle d-none" id="saveError"></i>
    <span id="saveText">Enregistrement...</span>
  </div>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script>
    const API_URL = '/api';
    let saveTimeout = null;
    let currentParams = {};
    let isLoading = false; // Flag pour eviter auto-save pendant le chargement

    const MODULES = [
      { id: 'ludotheque', code: 'jeux', label: 'Ludotheque', sublabel: 'Jeux de societe', icon: 'bi-dice-5', defaultDuree: 60 },
      { id: 'bibliotheque', code: 'livres', label: 'Bibliotheque', sublabel: 'Livres', icon: 'bi-book', defaultDuree: 30 },
      { id: 'filmotheque', code: 'films', label: 'Filmotheque', sublabel: 'Films', icon: 'bi-film', defaultDuree: 45 },
      { id: 'discotheque', code: 'disques', label: 'Discotheque', sublabel: 'Disques & Vinyles', icon: 'bi-disc', defaultDuree: 10 }
    ];

    // Helper pour parser modules_actifs (peut etre string JSON ou array)
    function parseModulesActifs(modules) {
      if (!modules) return [];
      if (Array.isArray(modules)) return modules;
      if (typeof modules === 'string') {
        try {
          const parsed = JSON.parse(modules);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    /**
     * Obtenir les modules actifs pour la structure courante
     * @returns {Array} Liste des codes de collection actifs (jeux, livres, films, disques)
     */
    function getStructureModules() {
      const structureId = window.CURRENT_STRUCTURE_ID;

      // Si pas de structure selectionnee
      if (!structureId) {
        // Admin global ou mono-structure : union de tous les modules
        if (!window.USER_STRUCTURES || window.USER_STRUCTURES.length === 0) {
          return ['jeux', 'livres', 'films', 'disques']; // Tous par defaut
        }
        if (window.USER_STRUCTURES.length === 1) {
          return parseModulesActifs(window.USER_STRUCTURES[0].modules_actifs);
        }
        // Multi-structure sans selection : union des modules
        const allModules = new Set();
        window.USER_STRUCTURES.forEach(s => {
          const mods = parseModulesActifs(s.modules_actifs);
          mods.forEach(m => allModules.add(m));
        });
        return Array.from(allModules);
      }

      // Structure selectionnee : ses modules
      const currentStructure = window.USER_STRUCTURES?.find(s => s.id === structureId);
      return parseModulesActifs(currentStructure?.modules_actifs);
    }

    // Init template et navigation
    initTemplate('parametres');

    document.addEventListener('DOMContentLoaded', () => {
      renderSubNav('configuration', 'nouveautes');
      checkStructureAndLoad();
    });

    // Ecouter les changements de structure
    window.addEventListener('structureChanged', () => {
      checkStructureAndLoad();
    });

    /**
     * Verifie si une structure est selectionnee et charge les donnees
     */
    function checkStructureAndLoad() {
      const hasMultipleStructures = window.USER_STRUCTURES && window.USER_STRUCTURES.length > 1;
      const structureId = window.CURRENT_STRUCTURE_ID;

      // Si plusieurs structures et aucune selectionnee, afficher l'alerte
      if (hasMultipleStructures && !structureId) {
        document.getElementById('noStructureAlert').classList.remove('d-none');
      } else {
        document.getElementById('noStructureAlert').classList.add('d-none');
      }

      renderModules();
      loadConfig();
    }

    // Auth - avec header structure si selectionnee
    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      };
      // Ajouter le header structure si une structure est selectionnee
      if (window.CURRENT_STRUCTURE_ID) {
        headers['X-Structure-Id'] = window.CURRENT_STRUCTURE_ID;
      }
      return headers;
    }

    // Render modules cards
    function renderModules() {
      const container = document.getElementById('modulesContainer');
      container.innerHTML = MODULES.map(mod => `
        <div class="col-lg-6">
          <div class="module-card p-3" id="card-${mod.id}">
            <div class="module-header">
              <div class="module-title">
                <div class="module-icon ${mod.id}">
                  <i class="bi ${mod.icon}"></i>
                </div>
                <div>
                  <h5 class="mb-0">${mod.label}</h5>
                  <small class="text-muted">${mod.sublabel}</small>
                </div>
              </div>
              <div class="module-controls">
                <span class="badge bg-secondary me-2" id="badge-module-${mod.id}">Module inactif</span>
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" id="active-${mod.id}"
                         onchange="toggleModule('${mod.id}', this.checked)"
                         style="width: 2.5em; height: 1.25em;">
                </div>
              </div>
            </div>

            <div class="config-section" id="config-${mod.id}">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">
                    <i class="bi bi-calendar-range me-1"></i>Duree de nouveaute (jours)
                  </label>
                  <div class="form-range-container">
                    <input type="range" class="form-range" min="1" max="180" value="${mod.defaultDuree}"
                           id="duree-${mod.id}" onchange="scheduleAutoSave()">
                    <span class="form-range-value badge bg-danger" id="duree-${mod.id}-value">${mod.defaultDuree}j</span>
                  </div>
                  <small class="text-muted">
                    Les articles acquis dans les <strong id="duree-${mod.id}-text">${mod.defaultDuree}</strong> derniers jours seront marques comme "Nouveau"
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // Bind range input events
      MODULES.forEach(mod => {
        document.getElementById(`duree-${mod.id}`).addEventListener('input', (e) => {
          const val = e.target.value;
          document.getElementById(`duree-${mod.id}-value`).textContent = `${val}j`;
          document.getElementById(`duree-${mod.id}-text`).textContent = val;
        });
      });
    }

    // Toggle module activation
    function toggleModule(modId, active) {
      const card = document.getElementById(`card-${modId}`);
      const config = document.getElementById(`config-${modId}`);

      if (active) {
        card.classList.add('active');
        card.classList.remove('inactive');
        config.style.opacity = '1';
        config.querySelectorAll('input').forEach(input => input.disabled = false);
      } else {
        card.classList.remove('active');
        card.classList.add('inactive');
        config.style.opacity = '0.5';
        config.querySelectorAll('input').forEach(input => input.disabled = true);
      }

      // Ne pas sauvegarder pendant le chargement initial
      if (!isLoading) {
        scheduleAutoSave();
      }
    }

    // Load config - depuis la structure selectionnee ou globale
    async function loadConfig() {
      isLoading = true; // Eviter auto-save pendant le chargement
      try {
        const structureId = window.CURRENT_STRUCTURE_ID;

        // Charger les parametres globaux pour les modules actifs
        console.log('Fetching global params...');
        const globalResponse = await fetch(`${API_URL}/parametres/front`, {
          headers: getHeaders()
        });
        console.log('Global response status:', globalResponse.status);
        if (!globalResponse.ok) {
          const errText = await globalResponse.text();
          console.error('Global params error:', errText);
          throw new Error('Erreur chargement parametres globaux');
        }
        const globalParams = await globalResponse.json();
        console.log('Global params received:', globalParams);
        console.log('module_ludotheque:', globalParams.module_ludotheque);

        // Charger les parametres de la structure si une structure est selectionnee
        let structureParams = {};
        if (structureId) {
          const structResponse = await fetch(`${API_URL}/structures/${structureId}/parametres-front`, {
            headers: getHeaders()
          });
          if (structResponse.ok) {
            structureParams = await structResponse.json();
          }
        }

        // Stocker pour la sauvegarde
        currentParams = { global: globalParams, structure: structureParams };

        // Obtenir les modules actifs de la structure
        const structureModules = getStructureModules();
        console.log('Structure modules:', structureModules);

        MODULES.forEach(mod => {
          // Verifier si le module est actif dans la structure (par code de collection)
          const moduleActif = structureModules.includes(mod.code);
          const card = document.getElementById(`card-${mod.id}`);
          const badge = document.getElementById(`badge-module-${mod.id}`);

          // Module actif/inactif dans la structure
          if (!moduleActif) {
            card.classList.add('disabled');
            badge.className = 'badge bg-secondary me-2';
            badge.textContent = 'Module inactif';
            return;
          }

          badge.className = 'badge bg-success me-2';
          badge.textContent = 'Module actif';

          // Utiliser les parametres structure si disponibles, sinon valeurs par defaut
          const nouveauteActive = structureParams[`nouveaute_active_${mod.id}`] !== undefined
            ? structureParams[`nouveaute_active_${mod.id}`]
            : true; // Par defaut actif
          const duree = structureParams[`nouveaute_duree_${mod.id}`]
            || mod.defaultDuree;

          document.getElementById(`active-${mod.id}`).checked = nouveauteActive;
          toggleModule(mod.id, nouveauteActive);

          document.getElementById(`duree-${mod.id}`).value = duree;
          document.getElementById(`duree-${mod.id}-value`).textContent = `${duree}j`;
          document.getElementById(`duree-${mod.id}-text`).textContent = duree;
        });

        // Si multi-structure et aucune structure selectionnee, mettre en lecture seule
        const hasMultipleStructures = window.USER_STRUCTURES && window.USER_STRUCTURES.length > 1;
        if (hasMultipleStructures && !structureId) {
          document.querySelectorAll('#modulesContainer input').forEach(input => {
            input.disabled = true;
          });
          document.querySelectorAll('#modulesContainer .module-card').forEach(card => {
            card.style.opacity = '0.7';
          });
        }

      } catch (error) {
        console.error('Erreur:', error);
        showSaveIndicator('error', 'Erreur de chargement');
      } finally {
        isLoading = false; // Reactiver l'auto-save
      }
    }

    // Schedule auto save (debounce 800ms)
    function scheduleAutoSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveConfig, 800);
    }

    // Save config - vers la structure selectionnee
    async function saveConfig() {
      const structureId = window.CURRENT_STRUCTURE_ID;

      // Si pas de structure selectionnee et multi-structure, ne pas sauvegarder
      if (!structureId && window.USER_STRUCTURES && window.USER_STRUCTURES.length > 1) {
        showSaveIndicator('error', 'Selectionnez une structure');
        return;
      }

      showSaveIndicator('saving');

      const data = {};

      // Obtenir les modules actifs de la structure
      const structureModules = getStructureModules();

      MODULES.forEach(mod => {
        // Skip si module non actif dans la structure
        if (!structureModules.includes(mod.code)) return;

        data[`nouveaute_active_${mod.id}`] = document.getElementById(`active-${mod.id}`).checked;
        data[`nouveaute_duree_${mod.id}`] = parseInt(document.getElementById(`duree-${mod.id}`).value);
      });

      try {
        // Sauvegarder dans les parametres de la structure
        const url = structureId
          ? `${API_URL}/structures/${structureId}/parametres-front`
          : `${API_URL}/parametres/front`;

        console.log('Saving to:', url);
        console.log('Data:', data);
        console.log('Headers:', getHeaders());

        if (Object.keys(data).length === 0) {
          console.warn('No data to save!');
          showSaveIndicator('error', 'Aucune donnee a sauvegarder');
          return;
        }

        const response = await fetch(url, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify(data)
        });

        console.log('Response status:', response.status);
        const responseData = await response.json();
        console.log('Response data:', responseData);

        if (!response.ok) throw new Error(responseData.error || 'Erreur sauvegarde');

        showSaveIndicator('saved');
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        showSaveIndicator('error', error.message || 'Erreur de sauvegarde');
      }
    }

    // Show save indicator
    function showSaveIndicator(state, customMessage = null) {
      const indicator = document.getElementById('saveIndicator');
      const spinner = document.getElementById('saveSpinner');
      const check = document.getElementById('saveCheck');
      const errorIcon = document.getElementById('saveError');
      const text = document.getElementById('saveText');

      indicator.className = 'save-indicator ' + state;
      spinner.classList.toggle('d-none', state !== 'saving');
      check.classList.toggle('d-none', state !== 'saved');
      errorIcon.classList.toggle('d-none', state !== 'error');

      if (state === 'saving') {
        text.textContent = 'Enregistrement...';
      } else if (state === 'saved') {
        text.textContent = customMessage || 'Enregistre';
        setTimeout(() => {
          indicator.className = 'save-indicator';
        }, 2000);
      } else if (state === 'error') {
        text.textContent = customMessage || 'Erreur';
        setTimeout(() => {
          indicator.className = 'save-indicator';
        }, 4000);
      }
    }
  </script>
</body>
</html>
