<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration des Tarifs - Ludothèque</title>
    <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <!-- Navigation (généré par JS) -->
    <nav id="admin-navbar"></nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar (généré par JS) -->
            <div id="admin-sidebar" class="col-md-2 bg-light"></div>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-currency-euro"></i> Configuration des Tarifs de Cotisation</h2>
                    <button class="btn btn-primary" onclick="showTarifModal()">
                        <i class="bi bi-plus-circle"></i> Nouveau Tarif
                    </button>
                </div>

                <!-- Alerts -->
                <div id="alertContainer"></div>

                <!-- Tarifs List -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Libellé</th>
                                        <th>Type Période</th>
                                        <th>Type Montant</th>
                                        <th>Montant de Base</th>
                                        <th>Réduction Association</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tarifsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarif -->
    <div class="modal fade" id="tarifModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tarifModalTitle">Nouveau Tarif</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tarifForm">
                        <input type="hidden" id="tarifId">

                        <!-- Informations de base -->
                        <h6 class="border-bottom pb-2 mb-3">Informations de base</h6>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="libelle" class="form-label">Libellé *</label>
                                <input type="text" class="form-control" id="libelle" required>
                            </div>
                            <div class="col-md-4">
                                <label for="ordre_affichage" class="form-label">Ordre d'affichage</label>
                                <input type="number" class="form-control" id="ordre_affichage" value="0">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="2"></textarea>
                        </div>

                        <!-- Configuration période et montant -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Configuration</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="type_periode" class="form-label">Type de Période *</label>
                                <select class="form-select" id="type_periode" required>
                                    <option value="annee_civile">Année Civile (1er janv - 31 déc)</option>
                                    <option value="annee_scolaire">Année Scolaire (1er sept - 31 août)</option>
                                    <option value="date_a_date">Date à Date (1 an)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="type_montant" class="form-label">Type de Montant *</label>
                                <select class="form-select" id="type_montant" required>
                                    <option value="fixe">Fixe</option>
                                    <option value="prorata">Prorata (mois entamé)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="montant_base" class="form-label">Montant de Base (€) *</label>
                                <input type="number" step="0.01" min="0" class="form-control" id="montant_base" required>
                            </div>
                        </div>

                        <!-- Réduction association -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Réduction pour Adhérents Association</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="reduction_association_type" class="form-label">Type de Réduction</label>
                                <select class="form-select" id="reduction_association_type">
                                    <option value="pourcentage">Pourcentage (%)</option>
                                    <option value="montant">Montant Fixe (€)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="reduction_association_valeur" class="form-label">Valeur</label>
                                <input type="number" step="0.01" min="0" class="form-control" id="reduction_association_valeur" value="0">
                            </div>
                        </div>

                        <!-- Validité -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Période de Validité</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="date_debut_validite" class="form-label">Date Début Validité</label>
                                <input type="date" class="form-control" id="date_debut_validite">
                                <small class="text-muted">Laisser vide pour aucune limite</small>
                            </div>
                            <div class="col-md-6">
                                <label for="date_fin_validite" class="form-label">Date Fin Validité</label>
                                <input type="date" class="form-control" id="date_fin_validite">
                                <small class="text-muted">Laisser vide pour aucune limite</small>
                            </div>
                        </div>

                        <!-- Comptabilité (Phase 2) -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Comptabilité <span class="badge bg-secondary">Phase 2</span></h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="code_comptable" class="form-label">Code Comptable</label>
                                <input type="text" class="form-control" id="code_comptable" maxlength="20">
                            </div>
                            <div class="col-md-6">
                                <label for="code_analytique" class="form-label">Code Analytique</label>
                                <input type="text" class="form-control" id="code_analytique" maxlength="20">
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="actif" checked>
                            <label class="form-check-label" for="actif">
                                Tarif actif
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveTarif()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Calculatrice -->
    <div class="modal fade" id="calculatorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Calculateur de Cotisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Adhérent à l'association ?</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="calc_adhesion" id="calc_adhesion_oui" value="true">
                            <label class="form-check-label" for="calc_adhesion_oui">Oui</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="calc_adhesion" id="calc_adhesion_non" value="false" checked>
                            <label class="form-check-label" for="calc_adhesion_non">Non</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="calc_date_debut" class="form-label">Date de début (optionnel)</label>
                        <input type="date" class="form-control" id="calc_date_debut">
                    </div>
                    <button class="btn btn-primary w-100" onclick="calculerMontant()">Calculer</button>
                    <div id="calcResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-admin.js"></script>
    <script src="js/auth-admin.js"></script>
    <script src="js/admin-navigation.js"></script>
    <script src="js/admin-template.js"></script>
    <script>
        let currentTarifId = null;
        let tarifsCache = [];

        // Load tarifs on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser le template (navbar + sidebar)
            initTemplate('tarifs-cotisation');
            loadTarifs();
        });

        // Load all tarifs
        async function loadTarifs() {
            try {
                tarifsCache = await apiRequest('/tarifs-cotisation');
                displayTarifs(tarifsCache);
            } catch (error) {
                showAlert('Erreur lors du chargement des tarifs: ' + error.message, 'danger');
            }
        }

        // Display tarifs in table
        function displayTarifs(tarifs) {
            const tbody = document.getElementById('tarifsTableBody');

            if (!tarifs || tarifs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucun tarif configuré</td></tr>';
                return;
            }

            tbody.innerHTML = tarifs.map(tarif => {
                const isUsed = tarif.nb_utilisations > 0;
                return `
                <tr>
                    <td>
                        <strong>${tarif.libelle}</strong>
                        ${tarif.description ? `<br><small class="text-muted">${tarif.description}</small>` : ''}
                        ${isUsed ? `<br><span class="badge bg-info mt-1">${tarif.nb_utilisations} cotisation(s)</span>` : ''}
                    </td>
                    <td>${formatTypePeriode(tarif.type_periode)}</td>
                    <td>${formatTypeMontant(tarif.type_montant)}</td>
                    <td><strong>${tarif.montant_base} €</strong></td>
                    <td>${formatReduction(tarif)}</td>
                    <td>
                        <span class="badge bg-${tarif.actif ? 'success' : 'secondary'}">
                            ${tarif.actif ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${isUsed
                                ? `<button class="btn btn-outline-success" onclick="duplicateTarif(${tarif.id})" title="Dupliquer">
                                    <i class="bi bi-files"></i>
                                </button>`
                                : `<button class="btn btn-outline-primary" onclick="editTarif(${tarif.id})" title="Modifier">
                                    <i class="bi bi-pencil"></i>
                                </button>`
                            }
                            <button class="btn btn-outline-info" onclick="showCalculator(${tarif.id})" title="Calculer">
                                <i class="bi bi-calculator"></i>
                            </button>
                            <button class="btn btn-outline-${tarif.actif ? 'warning' : 'success'}"
                                    onclick="toggleActif(${tarif.id})"
                                    title="${tarif.actif ? 'Désactiver' : 'Activer'}">
                                <i class="bi bi-power"></i>
                            </button>
                            ${!isUsed
                                ? `<button class="btn btn-outline-danger" onclick="deleteTarif(${tarif.id})" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>`
                                : ''
                            }
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Format helpers
        function formatTypePeriode(type) {
            const types = {
                'annee_civile': 'Année Civile',
                'annee_scolaire': 'Année Scolaire',
                'date_a_date': 'Date à Date'
            };
            return types[type] || type;
        }

        function formatTypeMontant(type) {
            return type === 'fixe' ? 'Fixe' : 'Prorata';
        }

        function formatReduction(tarif) {
            if (tarif.reduction_association_valeur == 0) {
                return '<span class="text-muted">Aucune</span>';
            }
            const value = tarif.reduction_association_type === 'pourcentage'
                ? `${tarif.reduction_association_valeur}%`
                : `${tarif.reduction_association_valeur} €`;
            return `<span class="badge bg-info">${value}</span>`;
        }

        // Show modal for new tarif
        function showTarifModal() {
            currentTarifId = null;
            document.getElementById('tarifModalTitle').textContent = 'Nouveau Tarif';
            document.getElementById('tarifForm').reset();
            document.getElementById('tarifId').value = '';
            document.getElementById('actif').checked = true;
            new bootstrap.Modal(document.getElementById('tarifModal')).show();
        }

        // Edit tarif
        async function editTarif(id) {
            try {
                const tarif = await apiRequest(`/tarifs-cotisation/${id}`);

                currentTarifId = id;
                document.getElementById('tarifModalTitle').textContent = 'Modifier le Tarif';
                document.getElementById('tarifId').value = id;
                document.getElementById('libelle').value = tarif.libelle || '';
                document.getElementById('description').value = tarif.description || '';
                document.getElementById('type_periode').value = tarif.type_periode;
                document.getElementById('type_montant').value = tarif.type_montant;
                document.getElementById('montant_base').value = tarif.montant_base;
                document.getElementById('reduction_association_type').value = tarif.reduction_association_type;
                document.getElementById('reduction_association_valeur').value = tarif.reduction_association_valeur;
                document.getElementById('ordre_affichage').value = tarif.ordre_affichage || 0;
                document.getElementById('date_debut_validite').value = tarif.date_debut_validite || '';
                document.getElementById('date_fin_validite').value = tarif.date_fin_validite || '';
                document.getElementById('code_comptable').value = tarif.code_comptable || '';
                document.getElementById('code_analytique').value = tarif.code_analytique || '';
                document.getElementById('actif').checked = tarif.actif;

                new bootstrap.Modal(document.getElementById('tarifModal')).show();
            } catch (error) {
                showAlert('Erreur lors du chargement du tarif: ' + error.message, 'danger');
            }
        }

        // Duplicate tarif
        async function duplicateTarif(id) {
            try {
                const tarif = await apiRequest(`/tarifs-cotisation/${id}`);

                currentTarifId = null;
                document.getElementById('tarifModalTitle').textContent = 'Dupliquer le Tarif';
                document.getElementById('tarifId').value = '';
                document.getElementById('libelle').value = `${tarif.libelle} (Copie)`;
                document.getElementById('description').value = tarif.description || '';
                document.getElementById('type_periode').value = tarif.type_periode;
                document.getElementById('type_montant').value = tarif.type_montant;
                document.getElementById('montant_base').value = tarif.montant_base;
                document.getElementById('reduction_association_type').value = tarif.reduction_association_type;
                document.getElementById('reduction_association_valeur').value = tarif.reduction_association_valeur;
                document.getElementById('ordre_affichage').value = tarif.ordre_affichage || 0;
                document.getElementById('date_debut_validite').value = '';
                document.getElementById('date_fin_validite').value = '';
                document.getElementById('code_comptable').value = tarif.code_comptable || '';
                document.getElementById('code_analytique').value = tarif.code_analytique || '';
                document.getElementById('actif').checked = true;

                new bootstrap.Modal(document.getElementById('tarifModal')).show();
            } catch (error) {
                showAlert('Erreur lors du chargement du tarif: ' + error.message, 'danger');
            }
        }

        // Save tarif
        async function saveTarif() {
            const form = document.getElementById('tarifForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                libelle: document.getElementById('libelle').value,
                description: document.getElementById('description').value || null,
                type_periode: document.getElementById('type_periode').value,
                type_montant: document.getElementById('type_montant').value,
                montant_base: parseFloat(document.getElementById('montant_base').value),
                reduction_association_type: document.getElementById('reduction_association_type').value,
                reduction_association_valeur: parseFloat(document.getElementById('reduction_association_valeur').value),
                ordre_affichage: parseInt(document.getElementById('ordre_affichage').value),
                date_debut_validite: document.getElementById('date_debut_validite').value || null,
                date_fin_validite: document.getElementById('date_fin_validite').value || null,
                code_comptable: document.getElementById('code_comptable').value || null,
                code_analytique: document.getElementById('code_analytique').value || null,
                actif: document.getElementById('actif').checked
            };

            try {
                const method = currentTarifId ? 'PUT' : 'POST';
                const endpoint = currentTarifId
                    ? `/tarifs-cotisation/${currentTarifId}`
                    : '/tarifs-cotisation';

                await apiRequest(endpoint, {
                    method,
                    body: JSON.stringify(data)
                });

                showAlert(`Tarif ${currentTarifId ? 'modifié' : 'créé'} avec succès`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('tarifModal')).hide();
                loadTarifs();
            } catch (error) {
                showAlert('Erreur lors de l\'enregistrement: ' + error.message, 'danger');
            }
        }

        // Toggle actif status
        async function toggleActif(id) {
            try {
                await apiRequest(`/tarifs-cotisation/${id}/toggle-actif`, {
                    method: 'PATCH'
                });
                showAlert('Statut modifié avec succès', 'success');
                loadTarifs();
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'danger');
            }
        }

        // Delete tarif
        async function deleteTarif(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce tarif ?')) {
                return;
            }

            try {
                await apiRequest(`/tarifs-cotisation/${id}`, {
                    method: 'DELETE'
                });
                showAlert('Tarif supprimé avec succès', 'success');
                loadTarifs();
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'danger');
            }
        }

        // Show calculator modal
        function showCalculator(id) {
            currentTarifId = id;
            document.getElementById('calcResult').innerHTML = '';
            document.getElementById('calc_date_debut').value = '';
            new bootstrap.Modal(document.getElementById('calculatorModal')).show();
        }

        // Calculate montant
        async function calculerMontant() {
            const adhesion = document.querySelector('input[name="calc_adhesion"]:checked').value === 'true';
            const dateDebut = document.getElementById('calc_date_debut').value || undefined;

            try {
                const result = await apiRequest(`/tarifs-cotisation/${currentTarifId}/calculer`, {
                    method: 'POST',
                    body: JSON.stringify({
                        date_debut: dateDebut,
                        adhesion_association: adhesion
                    })
                });

                document.getElementById('calcResult').innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h6>Résultat du calcul</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Période:</td>
                                    <td><strong>${result.periode.debut} → ${result.periode.fin}</strong></td>
                                </tr>
                                <tr>
                                    <td>Montant de base:</td>
                                    <td>${result.calcul.montant_base.toFixed(2)} €</td>
                                </tr>
                                ${result.calcul.prorata ? `
                                <tr class="table-info">
                                    <td>Prorata (${result.calcul.prorata.mois_effectifs}/${result.calcul.prorata.mois_total} mois):</td>
                                    <td>${result.calcul.montant_apres_prorata.toFixed(2)} €</td>
                                </tr>
                                ` : ''}
                                ${result.calcul.reduction_appliquee > 0 ? `
                                <tr class="table-warning">
                                    <td>Réduction ${result.adhesion_association ? 'adhérent association' : ''}:</td>
                                    <td>-${result.calcul.reduction_appliquee.toFixed(2)} €</td>
                                </tr>
                                ` : ''}
                                <tr class="table-success">
                                    <td><strong>Montant final:</strong></td>
                                    <td><strong>${result.calcul.montant_final.toFixed(2)} €</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                showAlert('Erreur lors du calcul: ' + error.message, 'danger');
            }
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
    </script>
</body>
</html>
