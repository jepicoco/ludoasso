<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Cotisations - Ludothèque</title>
    <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
    <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
    <style>
        /* Style pour la recherche d'adhérent */
        #adherentsList .list-group-item {
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        #adherentsList .list-group-item:hover {
            background-color: #f8f9fa;
        }
        #adherent_search:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .alert-sm {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <!-- Navigation (généré par JS) -->
    <nav id="admin-navbar"></nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar (généré par JS) -->
            <div id="admin-sidebar" class="col-md-2 bg-light"></div>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-receipt"></i> Gestion des Cotisations</h2>
                    <button class="btn btn-primary" onclick="showCotisationModal()">
                        <i class="bi bi-plus-circle"></i> Nouvelle Cotisation
                    </button>
                </div>

                <!-- Alerts -->
                <div id="alertContainer"></div>

                <!-- Statistics Cards -->
                <div class="row mb-4" id="statsCards">
                    <div class="col-md-3">
                        <div class="card text-white bg-primary">
                            <div class="card-body">
                                <h6 class="card-title">Total Cotisations</h6>
                                <h3 id="statTotal">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-success">
                            <div class="card-body">
                                <h6 class="card-title">En Cours</h6>
                                <h3 id="statEnCours">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-warning">
                            <div class="card-body">
                                <h6 class="card-title">Expirées</h6>
                                <h3 id="statExpirees">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white bg-info">
                            <div class="card-body">
                                <h6 class="card-title">Montant Total</h6>
                                <h3 id="statMontant">-</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Statut</label>
                                <select class="form-select" id="filterStatut" onchange="loadCotisations()">
                                    <option value="">Tous</option>
                                    <option value="en_cours">En cours</option>
                                    <option value="expiree">Expirées</option>
                                    <option value="annulee">Annulées</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Année</label>
                                <select class="form-select" id="filterAnnee" onchange="loadCotisations()">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Rechercher usager</label>
                                <input type="text" class="form-control" id="searchAdherent" placeholder="Nom, prenom ou email...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-secondary w-100" onclick="loadCotisations()">
                                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cotisations List -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Usager</th>
                                        <th>Tarif</th>
                                        <th>Période</th>
                                        <th>Montant</th>
                                        <th>Paiement</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cotisationsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nouvelle Cotisation -->
    <div class="modal fade" id="cotisationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouvelle Cotisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="cotisationForm">
                        <!-- Selection usager -->
                        <div class="mb-3">
                            <label for="adherent_search" class="form-label">Usager *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="adherent_search"
                                       placeholder="Rechercher par nom, prenom, email ou code barre..."
                                       autocomplete="off"
                                       oninput="filterAdherents()"
                                       onfocus="showAdherentsList()"
                                       onblur="hideAdherentsListDelayed()"
                                       onkeydown="handleAdherentSearchKeyboard(event)">
                                <input type="hidden" id="adherent_id" required>

                                <!-- Liste déroulante des résultats -->
                                <div id="adherentsList" class="position-absolute w-100 bg-white border rounded shadow-lg"
                                     style="display: none; max-height: 300px; overflow-y: auto; z-index: 1050; top: 100%; margin-top: 2px;">
                                    <div class="list-group list-group-flush">
                                        <!-- Résultats injectés ici -->
                                    </div>
                                </div>
                            </div>
                            <div id="adherentInfo" class="mt-2"></div>
                        </div>

                        <!-- Sélection tarif -->
                        <div class="mb-3">
                            <label for="tarif_cotisation_id" class="form-label">Tarif *</label>
                            <select class="form-select" id="tarif_cotisation_id" required onchange="updateTarifInfo()">
                                <option value="">Sélectionnez un tarif</option>
                            </select>
                            <div id="tarifInfo" class="mt-2"></div>
                        </div>

                        <!-- Dates (optionnel pour date_a_date) -->
                        <div class="mb-3" id="datesSection" style="display:none;">
                            <label class="form-label">Dates personnalisées (optionnel)</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="date_debut" class="form-label">Date début</label>
                                    <input type="date" class="form-control" id="date_debut">
                                </div>
                                <div class="col-md-6">
                                    <label for="date_fin" class="form-label">Date fin</label>
                                    <input type="date" class="form-control" id="date_fin">
                                </div>
                            </div>
                            <small class="text-muted">Laisser vide pour calculer automatiquement selon le tarif</small>
                        </div>

                        <!-- Code de réduction -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Code de Réduction (optionnel)</h6>
                        <div class="mb-3">
                            <label for="code_reduction" class="form-label">Code de Réduction</label>
                            <div class="input-group">
                                <input type="text" class="form-control text-uppercase" id="code_reduction" placeholder="Saisissez un code de réduction">
                                <button class="btn btn-outline-secondary" type="button" onclick="verifierCodeReduction()">
                                    <i class="bi bi-check-circle"></i> Vérifier
                                </button>
                                <button class="btn btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Voir les codes disponibles">
                                    <i class="bi bi-list-ul"></i> Codes
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" id="codesDisponiblesMenu" style="max-height: 400px; overflow-y: auto; min-width: 350px;">
                                    <li><h6 class="dropdown-header">Codes de réduction disponibles</h6></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="px-3 py-2 text-muted"><small>Chargement...</small></li>
                                </ul>
                                <button class="btn btn-outline-danger" type="button" onclick="retirerCodeReduction()" id="btnRetirerCode" style="display:none;">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                            <div id="codeReductionInfo" class="mt-2"></div>
                            <input type="hidden" id="code_reduction_id" value="">
                        </div>

                        <!-- Paiement -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Informations de Paiement</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="date_paiement" class="form-label">Date de Paiement *</label>
                                <input type="date" class="form-control" id="date_paiement" required>
                            </div>
                            <div class="col-md-6">
                                <label for="mode_paiement" class="form-label">Mode de Paiement *</label>
                                <select class="form-select" id="mode_paiement" required onchange="updateReferencePlaceholder()">
                                    <option value="">Chargement...</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="reference_paiement" class="form-label">Référence Paiement</label>
                            <input type="text" class="form-control" id="reference_paiement" placeholder="Référence de paiement">
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="2"></textarea>
                        </div>

                        <!-- Aperçu montant avec simulation avancée -->
                        <div id="montantPreview" class="card border-primary" style="display:none;">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-calculator"></i> Simulation du montant</h6>
                                <button type="button" class="btn btn-sm btn-outline-light" onclick="simulerCotisation()" title="Recalculer">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="montantDetails"></div>

                                <!-- Zone détail QF -->
                                <div id="qfSection" style="display:none;" class="mt-3 pt-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted"><i class="bi bi-calculator"></i> Quotient Familial:</span>
                                        <span id="qfValue" class="fw-bold">-</span>
                                    </div>
                                    <div id="qfTrancheInfo" class="text-muted small"></div>
                                    <div id="qfHeritageInfo" class="text-info small"></div>
                                </div>

                                <!-- Zone détail réductions -->
                                <div id="reductionsSection" style="display:none;" class="mt-3 pt-3 border-top">
                                    <h6 class="text-success mb-2"><i class="bi bi-tags"></i> Réductions appliquées</h6>
                                    <div id="reductionsList"></div>
                                </div>

                                <!-- Zone type tarif détecté -->
                                <div id="typeTarifSection" style="display:none;" class="mt-3 pt-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted"><i class="bi bi-person"></i> Type de tarif:</span>
                                        <span id="typeTarifValue" class="badge bg-secondary">-</span>
                                    </div>
                                    <div id="ageInfo" class="text-muted small"></div>
                                </div>

                                <!-- Zone arbre de décision -->
                                <div id="arbreDecisionSection" style="display:none;" class="mt-3 pt-3 border-top">
                                    <h6 class="text-info mb-2"><i class="bi bi-diagram-3"></i> Arbre de décision</h6>
                                    <div id="arbreDecisionInfo" class="small text-muted mb-2"></div>
                                    <div id="arbreCheminList"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveCotisation()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Détails Cotisation -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Détails de la Cotisation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsContent">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Scan Usager (cotisation rapide) -->
    <div class="modal fade" id="scanUsagerModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-badge me-2"></i>Cotisation Usager</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Colonne gauche: Infos usager -->
                        <div class="col-md-5">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-person me-2"></i>Informations</h6>
                                    <span id="scanUsagerStatut" class="badge"></span>
                                </div>
                                <div class="card-body" id="scanUsagerInfos">
                                    <!-- Rempli dynamiquement -->
                                </div>
                            </div>
                        </div>
                        <!-- Colonne droite: Cotisations et tarifs -->
                        <div class="col-md-7">
                            <!-- Cotisations en cours -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>Cotisations en cours</h6>
                                </div>
                                <div class="card-body p-2" id="scanUsagerCotisations" style="max-height: 150px; overflow-y: auto;">
                                    <!-- Rempli dynamiquement -->
                                </div>
                            </div>
                            <!-- Nouvelle cotisation -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Ajouter une cotisation</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Code de réduction -->
                                    <div class="input-group mb-3">
                                        <span class="input-group-text"><i class="bi bi-tag"></i></span>
                                        <input type="text" class="form-control" id="scanCodeReduction" placeholder="Code de réduction (optionnel)">
                                        <button class="btn btn-outline-secondary" type="button" onclick="appliquerCodeReductionScan()">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                    </div>
                                    <div id="scanCodeReductionInfo" class="mb-3"></div>
                                    <!-- Cartes tarifs -->
                                    <div id="scanTarifsCards" class="row g-2">
                                        <!-- Rempli dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted me-auto"><i class="bi bi-upc-scan"></i> Scannez un code-barre pour changer d'usager</small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Récapitulatif Cotisation -->
    <div class="modal fade" id="recapCotisationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Cotisation créée</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="recapCotisationContent">
                    <!-- Rempli dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="imprimerRecuCotisation()">
                        <i class="bi bi-printer"></i> Imprimer le reçu
                    </button>
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="fermerRecapEtContinuer()">
                        <i class="bi bi-arrow-right"></i> Continuer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicateur de scan actif -->
    <div id="scanIndicator" class="position-fixed bottom-0 end-0 m-3 p-2 bg-primary text-white rounded shadow d-flex align-items-center" style="display: none !important;">
        <i class="bi bi-upc-scan me-2 fs-5"></i>
        <span>Scanner actif</span>
    </div>

    <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="js/api-admin.js"></script>
    <script src="js/auth-admin.js"></script>
    <script src="js/admin-navigation.js"></script>
    <script src="js/admin-template.js"></script>
    <script>
        let cotisationsCache = [];
        let adherentsCache = [];
        let tarifsCache = [];
        let modesPaiementCache = [];
        let codesReductionCache = [];
        let currentCodeReduction = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser le template (navbar + sidebar)
            initTemplate('cotisations');
            initializeYearFilter();
            loadStatistics();
            loadCotisations();
            loadAdherents();
            loadTarifs();
            loadModesPaiement();
            loadCodesReductionDisponibles();

            // Set today's date for date_paiement
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date_paiement').value = today;

            // Recalculer la simulation quand la date de début change
            document.getElementById('date_debut').addEventListener('change', () => {
                calculerMontantTotal();
            });
        });

        // Initialize year filter
        function initializeYearFilter() {
            const select = document.getElementById('filterAnnee');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const annee = document.getElementById('filterAnnee').value;
                const stats = await apiRequest(`/cotisations/statistiques?annee=${annee}`);

                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statEnCours').textContent = stats.par_statut.en_cours;
                document.getElementById('statExpirees').textContent = stats.par_statut.expirees;
                document.getElementById('statMontant').textContent = stats.montant_total + ' €';
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
            }
        }

        // Load cotisations
        async function loadCotisations() {
            try {
                let url = '/cotisations?';
                const statut = document.getElementById('filterStatut').value;
                const annee = document.getElementById('filterAnnee').value;

                if (statut) url += `statut=${statut}&`;
                if (annee) url += `annee=${annee}&`;

                cotisationsCache = await apiRequest(url);
                displayCotisations(cotisationsCache);
                loadStatistics();
            } catch (error) {
                showAlert('Erreur lors du chargement: ' + error.message, 'danger');
            }
        }

        // Display cotisations
        function displayCotisations(cotisations) {
            const tbody = document.getElementById('cotisationsTableBody');
            const search = document.getElementById('searchAdherent').value.toLowerCase();

            let filtered = cotisations;
            if (search) {
                filtered = cotisations.filter(c =>
                    c.adherent && (
                        (c.adherent.nom || '').toLowerCase().includes(search) ||
                        (c.adherent.prenom || '').toLowerCase().includes(search) ||
                        (c.adherent.email || '').toLowerCase().includes(search)
                    )
                );
            }

            if (!filtered || filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune cotisation trouvée</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(cot => `
                <tr>
                    <td>
                        <strong>${cot.adherent?.nom || 'N/A'} ${cot.adherent?.prenom || ''}</strong><br>
                        <small class="text-muted">${cot.adherent?.email || 'Email non disponible'}</small>
                    </td>
                    <td>${cot.tarif.libelle}</td>
                    <td>
                        <small>${formatDate(cot.periode_debut)}<br>→ ${formatDate(cot.periode_fin)}</small>
                    </td>
                    <td>
                        <strong>${cot.montant_paye} €</strong>
                        ${cot.reduction_appliquee > 0 ? `<br><small class="text-success">-${cot.reduction_appliquee} €</small>` : ''}
                        ${cot.code_reduction_applique ? `<br><small class="badge bg-info">${cot.code_reduction_applique}</small>` : ''}
                        ${cot.avoir_genere > 0 ? `<br><small class="text-info">Avoir: +${cot.avoir_genere} €</small>` : ''}
                    </td>
                    <td>
                        <small>${formatDate(cot.date_paiement)}<br>${formatModePaiement(cot.mode_paiement)}</small>
                    </td>
                    <td>${formatStatutBadge(cot.statut)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="showDetails(${cot.id})" title="Détails">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${cot.statut === 'en_cours' ? `
                                <button class="btn btn-outline-danger" onclick="annulerCotisation(${cot.id})" title="Annuler">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Load adherents for select
        async function loadAdherents() {
            try {
                const data = await apiRequest('/adherents');
                adherentsCache = data.adherents || data;

                // Trier par nom puis prénom
                adherentsCache.sort((a, b) => {
                    const nomCompare = a.nom.localeCompare(b.nom, 'fr');
                    if (nomCompare !== 0) return nomCompare;
                    return a.prenom.localeCompare(b.prenom, 'fr');
                });

                // Rendre la liste au démarrage
                renderAdherentsList(adherentsCache);
            } catch (error) {
                console.error('Erreur chargement adhérents:', error);
            }
        }

        // Afficher la liste des adhérents filtrés
        function renderAdherentsList(adherents) {
            const listContainer = document.querySelector('#adherentsList .list-group');

            if (!adherents || adherents.length === 0) {
                listContainer.innerHTML = `
                    <div class="list-group-item text-center text-muted">
                        <i class="bi bi-search"></i> Aucun usager trouve
                    </div>
                `;
                return;
            }

            // Limiter à 50 résultats pour les performances
            const limited = adherents.slice(0, 50);

            listContainer.innerHTML = limited.map(adh => {
                const isAssociation = adh.adhesion_association || false;
                const isActif = adh.statut === 'actif';

                // Badge statut
                const badgeStatut = isActif
                    ? '<span class="badge bg-success" style="font-size: 0.7em;">Actif</span>'
                    : '<span class="badge bg-secondary" style="font-size: 0.7em;">Inactif</span>';

                // Badge adhésion
                const badgeAdhesion = isAssociation
                    ? '<span class="badge bg-primary" style="font-size: 0.7em;"><i class="bi bi-star-fill"></i> Membre</span>'
                    : '';

                // Dernière cotisation (si disponible)
                let derniereCotisation = '';
                if (adh.date_fin_adhesion) {
                    const dateFin = new Date(adh.date_fin_adhesion);
                    const now = new Date();
                    const isExpire = dateFin < now;
                    derniereCotisation = `
                        <small class="text-muted">
                            Cotisation: ${formatDate(adh.date_fin_adhesion)}
                            ${isExpire ? '<span class="text-danger">⚠️ Expirée</span>' : ''}
                        </small>
                    `;
                }

                return `
                    <a href="#" class="list-group-item list-group-item-action"
                       onclick="event.preventDefault(); selectAdherent(${adh.id}, '${adh.nom}', '${adh.prenom}', ${isAssociation});"
                       onmousedown="event.preventDefault();">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-bold">
                                    ${adh.nom} ${adh.prenom}
                                    ${badgeStatut}
                                    ${badgeAdhesion}
                                </div>
                                <small class="text-muted">${adh.email}</small>
                                ${adh.code_barre ? `<small class="text-muted"> | ${adh.code_barre}</small>` : ''}
                                ${derniereCotisation ? `<br>${derniereCotisation}` : ''}
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            // Ajouter message si limité
            if (adherents.length > 50) {
                listContainer.innerHTML += `
                    <div class="list-group-item text-center text-muted bg-light">
                        <small>... et ${adherents.length - 50} autres résultats. Affinez votre recherche.</small>
                    </div>
                `;
            }
        }

        // Filtrer les adhérents selon la recherche
        function filterAdherents() {
            const search = document.getElementById('adherent_search').value.toLowerCase().trim();

            // Réinitialiser l'index de sélection
            selectedAdherentIndex = -1;

            if (!search) {
                // Si vide, afficher tous les adhérents
                renderAdherentsList(adherentsCache);
                showAdherentsList();
                return;
            }

            // Filtrer par nom, prénom, email ou code barre
            const filtered = adherentsCache.filter(adh => {
                const nom = (adh.nom || '').toLowerCase();
                const prenom = (adh.prenom || '').toLowerCase();
                const email = (adh.email || '').toLowerCase();
                const codeBarre = (adh.code_barre || '').toLowerCase();
                const fullName = `${nom} ${prenom}`;

                return nom.includes(search) ||
                       prenom.includes(search) ||
                       fullName.includes(search) ||
                       email.includes(search) ||
                       codeBarre.includes(search);
            });

            renderAdherentsList(filtered);
            showAdherentsList();
        }

        // Afficher la liste déroulante
        function showAdherentsList() {
            document.getElementById('adherentsList').style.display = 'block';
        }

        // Masquer la liste avec délai (pour permettre le clic)
        let hideTimeout;
        function hideAdherentsListDelayed() {
            hideTimeout = setTimeout(() => {
                document.getElementById('adherentsList').style.display = 'none';
            }, 200);
        }

        // Sélectionner un adhérent
        function selectAdherent(id, nom, prenom, isAssociation) {
            // Annuler le timeout de masquage si en cours
            if (hideTimeout) {
                clearTimeout(hideTimeout);
            }

            // Remplir les champs
            document.getElementById('adherent_id').value = id;
            document.getElementById('adherent_search').value = `${nom} ${prenom}`;

            // Masquer la liste
            document.getElementById('adherentsList').style.display = 'none';

            // Mettre à jour les infos adhérent
            updateAdherentInfoFromSelection(isAssociation);

            // Recalculer le montant
            calculerMontantTotal();
        }

        // Mettre à jour les infos adhérent après sélection
        function updateAdherentInfoFromSelection(isAssociation) {
            const div = document.getElementById('adherentInfo');

            div.innerHTML = `
                <div class="alert alert-${isAssociation ? 'success' : 'info'} alert-sm">
                    <i class="bi bi-info-circle"></i>
                    ${isAssociation ? 'Membre de l\'association - Reduction applicable' : 'Non membre de l\'association'}
                </div>
            `;
        }

        // Gérer la navigation clavier dans la recherche d'adhérent
        let selectedAdherentIndex = -1;
        function handleAdherentSearchKeyboard(event) {
            const list = document.getElementById('adherentsList');
            const items = list.querySelectorAll('.list-group-item-action');

            if (items.length === 0) return;

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedAdherentIndex = Math.min(selectedAdherentIndex + 1, items.length - 1);
                    highlightAdherentItem(items);
                    break;

                case 'ArrowUp':
                    event.preventDefault();
                    selectedAdherentIndex = Math.max(selectedAdherentIndex - 1, 0);
                    highlightAdherentItem(items);
                    break;

                case 'Enter':
                    event.preventDefault();
                    if (selectedAdherentIndex >= 0 && selectedAdherentIndex < items.length) {
                        items[selectedAdherentIndex].click();
                    }
                    break;

                case 'Escape':
                    event.preventDefault();
                    document.getElementById('adherentsList').style.display = 'none';
                    selectedAdherentIndex = -1;
                    break;
            }
        }

        // Mettre en surbrillance l'élément sélectionné au clavier
        function highlightAdherentItem(items) {
            items.forEach((item, index) => {
                if (index === selectedAdherentIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Load tarifs for select
        async function loadTarifs() {
            try {
                tarifsCache = await apiRequest('/tarifs-cotisation?actif=true&valide=true');

                const select = document.getElementById('tarif_cotisation_id');
                select.innerHTML = '<option value="">Sélectionnez un tarif</option>';

                let tarifDefaut = null;

                tarifsCache.forEach(tarif => {
                    const option = document.createElement('option');
                    option.value = tarif.id;
                    option.textContent = `${tarif.libelle} - ${tarif.montant_base}€`;
                    option.dataset.tarif = JSON.stringify(tarif);

                    // Ajouter un indicateur visuel pour le tarif par défaut
                    if (tarif.par_defaut) {
                        option.textContent += ' ⭐';
                        tarifDefaut = tarif;
                    }

                    select.appendChild(option);
                });

                // Précharger le tarif par défaut lors de l'ouverture du modal
                if (tarifDefaut) {
                    window.tarifParDefautId = tarifDefaut.id;
                }
            } catch (error) {
                console.error('Erreur chargement tarifs:', error);
            }
        }

        // Load modes de paiement for select
        async function loadModesPaiement() {
            try {
                modesPaiementCache = await apiRequest('/parametres/modes-paiement?actif=true');

                const select = document.getElementById('mode_paiement');
                select.innerHTML = '<option value="">Sélectionnez un mode de paiement</option>';

                modesPaiementCache.forEach(mode => {
                    const option = document.createElement('option');
                    option.value = mode.id;
                    option.textContent = mode.libelle;
                    option.dataset.mode = JSON.stringify(mode);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement modes paiement:', error);
                // Fallback aux modes par défaut si erreur
                const select = document.getElementById('mode_paiement');
                select.innerHTML = `
                    <option value="">Sélectionnez un mode de paiement</option>
                    <option value="especes">Espèces</option>
                    <option value="cheque">Chèque</option>
                    <option value="carte_bancaire">Carte Bancaire</option>
                    <option value="virement">Virement</option>
                `;
            }
        }

        // Charger les codes de réduction disponibles pour le dropdown
        async function loadCodesReductionDisponibles() {
            try {
                codesReductionCache = await apiRequest('/parametres/codes-reduction?actif=true');
                renderCodesDisponiblesMenu();
            } catch (error) {
                console.error('Erreur chargement codes réduction:', error);
                const menu = document.getElementById('codesDisponiblesMenu');
                menu.innerHTML = `
                    <li><h6 class="dropdown-header">Codes de réduction disponibles</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-3 py-2 text-danger"><small><i class="bi bi-exclamation-triangle"></i> Erreur de chargement</small></li>
                `;
            }
        }

        // Afficher les codes disponibles dans le menu dropdown
        function renderCodesDisponiblesMenu() {
            const menu = document.getElementById('codesDisponiblesMenu');

            if (!codesReductionCache || codesReductionCache.length === 0) {
                menu.innerHTML = `
                    <li><h6 class="dropdown-header">Codes de réduction disponibles</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-3 py-2 text-muted"><small>Aucun code disponible</small></li>
                `;
                return;
            }

            const typeLabels = {
                'pourcentage': 'Pourcentage',
                'fixe': 'Fixe',
                'fixe_avec_avoir': 'Fixe + Avoir'
            };

            const typeIcons = {
                'pourcentage': 'bi-percent',
                'fixe': 'bi-cash-coin',
                'fixe_avec_avoir': 'bi-piggy-bank'
            };

            // Filtrer les codes valides
            const codesValides = codesReductionCache.filter(code => {
                // Vérifier les dates si définies
                const now = new Date();
                if (code.date_debut_validite) {
                    const debut = new Date(code.date_debut_validite);
                    if (now < debut) return false;
                }
                if (code.date_fin_validite) {
                    const fin = new Date(code.date_fin_validite);
                    if (now > fin) return false;
                }
                // Vérifier la limite d'usage
                if (code.usage_limite !== null && code.usage_count >= code.usage_limite) {
                    return false;
                }
                return true;
            });

            if (codesValides.length === 0) {
                menu.innerHTML = `
                    <li><h6 class="dropdown-header">Codes de réduction disponibles</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-3 py-2 text-muted"><small>Aucun code valide actuellement</small></li>
                `;
                return;
            }

            let html = `
                <li><h6 class="dropdown-header">Codes de réduction disponibles</h6></li>
                <li><hr class="dropdown-divider"></li>
            `;

            codesValides.forEach(code => {
                const valeur = code.type_reduction === 'pourcentage'
                    ? `${code.valeur}%`
                    : `${code.valeur}€`;

                const icon = typeIcons[code.type_reduction] || 'bi-tag';
                const couleur = code.couleur || 'primary';

                // Badges additionnels
                let badges = '';
                if (code.usage_limite !== null) {
                    const restant = code.usage_limite - code.usage_count;
                    if (restant <= 5) {
                        badges += `<span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">Limité (${restant})</span>`;
                    }
                }
                if (code.date_fin_validite) {
                    const fin = new Date(code.date_fin_validite);
                    const diff = (fin - new Date()) / (1000 * 60 * 60 * 24);
                    if (diff <= 7 && diff > 0) {
                        badges += `<span class="badge bg-danger ms-1" style="font-size: 0.7em;">Expire bientôt</span>`;
                    }
                }

                html += `
                    <li>
                        <a class="dropdown-item" href="#" onclick="event.preventDefault(); selectionnerCode('${code.code}');" style="white-space: normal;">
                            <div class="d-flex align-items-start">
                                <i class="bi ${icon} text-${couleur} me-2 mt-1" style="font-size: 1.2em;"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${code.code} - ${valeur}</div>
                                    <small class="text-muted">${code.libelle}</small>
                                    ${badges}
                                    ${code.description ? `<div><small class="text-muted fst-italic">${code.description}</small></div>` : ''}
                                </div>
                            </div>
                        </a>
                    </li>
                `;
            });

            menu.innerHTML = html;
        }

        // Sélectionner un code depuis le dropdown
        function selectionnerCode(code) {
            document.getElementById('code_reduction').value = code;
            verifierCodeReduction();
        }

        // Mettre à jour le placeholder de la référence selon le mode de paiement
        function updateReferencePlaceholder() {
            const select = document.getElementById('mode_paiement');
            const input = document.getElementById('reference_paiement');
            const selectedOption = select.options[select.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                input.placeholder = 'Référence de paiement';
                return;
            }

            // Si c'est un mode chargé depuis l'API
            if (selectedOption.dataset.mode) {
                try {
                    const mode = JSON.parse(selectedOption.dataset.mode);
                    const libelle = mode.libelle.toLowerCase();

                    // Mapping des placeholders selon le libellé
                    const placeholders = {
                        'chèque': 'N° de chèque (ex: 1234567)',
                        'cheque': 'N° de chèque (ex: 1234567)',
                        'virement': 'Référence bancaire',
                        'carte': 'N° de transaction (optionnel)',
                        'carte bancaire': 'N° de transaction (optionnel)',
                        'cb': 'N° de transaction (optionnel)',
                        'espèces': 'N° de reçu (optionnel)',
                        'espece': 'N° de reçu (optionnel)',
                        'prélèvement': 'N° de mandat SEPA',
                        'prelevement': 'N° de mandat SEPA',
                        'paypal': 'ID de transaction PayPal',
                        'autre': 'Référence de paiement'
                    };

                    // Chercher une correspondance partielle
                    let placeholder = 'Référence de paiement';
                    for (const [key, value] of Object.entries(placeholders)) {
                        if (libelle.includes(key)) {
                            placeholder = value;
                            break;
                        }
                    }

                    input.placeholder = placeholder;
                } catch (e) {
                    console.error('Erreur parsing mode:', e);
                    input.placeholder = 'Référence de paiement';
                }
            } else {
                // Fallback pour les modes statiques
                const value = selectedOption.value.toLowerCase();
                const placeholders = {
                    'especes': 'N° de reçu (optionnel)',
                    'cheque': 'N° de chèque (ex: 1234567)',
                    'carte_bancaire': 'N° de transaction (optionnel)',
                    'virement': 'Référence bancaire',
                    'prelevement': 'N° de mandat SEPA'
                };

                input.placeholder = placeholders[value] || 'Référence de paiement';
            }
        }

        // Vérifier un code de réduction
        async function verifierCodeReduction() {
            const codeInput = document.getElementById('code_reduction');
            const code = codeInput.value.trim().toUpperCase();
            const infoDiv = document.getElementById('codeReductionInfo');
            const btnRetirer = document.getElementById('btnRetirerCode');

            if (!code) {
                infoDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Veuillez saisir un code</div>';
                return;
            }

            try {
                const response = await apiRequest(`/parametres/codes-reduction/verifier/${code}`);

                if (response.valide) {
                    currentCodeReduction = response.code;
                    document.getElementById('code_reduction_id').value = response.code.id;

                    const typeLabels = {
                        'pourcentage': 'Pourcentage',
                        'fixe': 'Fixe',
                        'fixe_avec_avoir': 'Fixe avec avoir'
                    };

                    const valeur = response.code.type_reduction === 'pourcentage'
                        ? `${response.code.valeur}%`
                        : `${response.code.valeur}€`;

                    infoDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>${response.code.libelle}</strong><br>
                            Type: ${typeLabels[response.code.type_reduction]} - Valeur: ${valeur}
                            ${response.code.description ? `<br><small>${response.code.description}</small>` : ''}
                        </div>
                    `;

                    codeInput.disabled = true;
                    btnRetirer.style.display = 'inline-block';

                    // Mettre à jour l'aperçu du montant
                    calculerMontantTotal();
                } else {
                    infoDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${response.error}</div>`;
                    currentCodeReduction = null;
                    document.getElementById('code_reduction_id').value = '';
                }
            } catch (error) {
                infoDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${error.message}</div>`;
                currentCodeReduction = null;
                document.getElementById('code_reduction_id').value = '';
            }
        }

        // Retirer le code de réduction
        function retirerCodeReduction() {
            currentCodeReduction = null;
            document.getElementById('code_reduction').value = '';
            document.getElementById('code_reduction').disabled = false;
            document.getElementById('code_reduction_id').value = '';
            document.getElementById('codeReductionInfo').innerHTML = '';
            document.getElementById('btnRetirerCode').style.display = 'none';

            // Mettre à jour l'aperçu du montant
            calculerMontantTotal();
        }

        // Variable pour stocker la dernière simulation
        let lastSimulation = null;

        // Calculer le montant total avec simulation avancée
        async function calculerMontantTotal() {
            const tarifSelect = document.getElementById('tarif_cotisation_id');
            const adherentId = document.getElementById('adherent_id').value;
            const previewDiv = document.getElementById('montantPreview');

            if (!tarifSelect.value || !adherentId) {
                previewDiv.style.display = 'none';
                return;
            }

            await simulerCotisation();
        }

        // Simulation avancée via API tarification
        async function simulerCotisation() {
            const adherentId = document.getElementById('adherent_id').value;
            const tarifId = document.getElementById('tarif_cotisation_id').value;
            const previewDiv = document.getElementById('montantPreview');
            const detailsDiv = document.getElementById('montantDetails');

            if (!adherentId || !tarifId) {
                previewDiv.style.display = 'none';
                return;
            }

            // Options de simulation
            const dateDebut = document.getElementById('date_debut').value || null;
            const codeReductionId = document.getElementById('code_reduction_id').value || null;

            try {
                // Appel API simulation avancée
                const simulation = await apiRequest('/tarification/simuler', {
                    method: 'POST',
                    body: JSON.stringify({
                        utilisateur_id: parseInt(adherentId),
                        tarif_cotisation_id: parseInt(tarifId),
                        date_debut: dateDebut,
                        code_reduction_id: codeReductionId ? parseInt(codeReductionId) : null
                    })
                });

                lastSimulation = simulation;
                afficherSimulation(simulation);
                previewDiv.style.display = 'block';

            } catch (error) {
                console.warn('Simulation avancée non disponible, fallback:', error.message);
                // Fallback vers calcul simple si API non disponible
                await calculerMontantSimple();
            }
        }

        // Afficher les résultats de la simulation
        function afficherSimulation(sim) {
            const detailsDiv = document.getElementById('montantDetails');
            const qfSection = document.getElementById('qfSection');
            const reductionsSection = document.getElementById('reductionsSection');
            const typeTarifSection = document.getElementById('typeTarifSection');

            // Montants principaux
            let html = `
                <div class="row g-2">
                    <div class="col-7 text-end">Tarif de base:</div>
                    <div class="col-5"><strong>${(sim.tarif_base || 0).toFixed(2)} €</strong></div>
            `;

            // Montant QF si différent
            if (sim.montant_qf !== undefined && sim.montant_qf !== sim.tarif_base) {
                html += `
                    <div class="col-7 text-end text-info">Montant QF:</div>
                    <div class="col-5 text-info">${sim.montant_qf.toFixed(2)} €</div>
                `;
            }

            // Total réductions
            if (sim.total_reductions > 0) {
                html += `
                    <div class="col-7 text-end text-success">Total réductions:</div>
                    <div class="col-5 text-success">-${sim.total_reductions.toFixed(2)} €</div>
                `;
            }

            // Avoir si présent
            if (sim.avoir_genere > 0) {
                html += `
                    <div class="col-7 text-end text-info">Avoir généré:</div>
                    <div class="col-5 text-info">+${sim.avoir_genere.toFixed(2)} €</div>
                `;
            }

            // Séparateur et montant final
            html += `
                <div class="col-12"><hr class="my-2"></div>
                <div class="col-7 text-end"><strong>Montant à payer:</strong></div>
                <div class="col-5"><strong class="fs-4 text-primary">${sim.montant_final.toFixed(2)} €</strong></div>
            </div>
            `;

            detailsDiv.innerHTML = html;

            // Section QF
            if (sim.quotient_familial !== undefined && sim.quotient_familial !== null) {
                qfSection.style.display = 'block';
                document.getElementById('qfValue').textContent = sim.quotient_familial;

                // Info tranche
                let trancheInfo = '';
                if (sim.tranche_qf) {
                    trancheInfo = `Tranche: ${sim.tranche_qf.qf_min} - ${sim.tranche_qf.qf_max || '∞'} → ${sim.tranche_qf.montant || sim.tranche_qf.pourcentage_reduction + '%'}`;
                }
                document.getElementById('qfTrancheInfo').textContent = trancheInfo;

                // Info héritage
                let heritageInfo = '';
                if (sim.qf_herite) {
                    heritageInfo = '<i class="bi bi-arrow-down-circle"></i> Hérité du parent';
                }
                document.getElementById('qfHeritageInfo').innerHTML = heritageInfo;
            } else {
                qfSection.style.display = 'none';
            }

            // Section réductions
            if (sim.reductions && sim.reductions.length > 0) {
                reductionsSection.style.display = 'block';
                const reductionsList = document.getElementById('reductionsList');

                const sourcesLabels = {
                    'quotient_familial': 'Quotient familial',
                    'commune': 'Commune',
                    'statut_social': 'Statut social',
                    'multi_enfants': 'Multi-enfants',
                    'fidelite': 'Fidélité',
                    'partenariat': 'Partenariat',
                    'handicap': 'Handicap',
                    'age': 'Âge',
                    'code_reduction': 'Code promo',
                    'manuel': 'Manuel',
                    // Types arbre de décision
                    'ARBRE_COMMUNE': 'Commune (arbre)',
                    'ARBRE_QF': 'Quotient familial (arbre)',
                    'ARBRE_AGE': 'Âge (arbre)',
                    'ARBRE_FIDELITE': 'Fidélité (arbre)',
                    'ARBRE_MULTI_INSCRIPTIONS': 'Multi-inscriptions (arbre)',
                    'ARBRE_TAG': 'Tag (arbre)',
                    'ARBRE_STATUT_SOCIAL': 'Statut social (arbre)'
                };

                reductionsList.innerHTML = sim.reductions.map(r => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted small">
                            <i class="bi bi-tag-fill text-success"></i>
                            ${sourcesLabels[r.type_source] || r.type_source}
                            ${r.libelle ? `<small>(${r.libelle})</small>` : ''}
                        </span>
                        <span class="text-success fw-bold">-${r.montant.toFixed(2)} €</span>
                    </div>
                `).join('');
            } else {
                reductionsSection.style.display = 'none';
            }

            // Section type tarif
            if (sim.type_tarif) {
                typeTarifSection.style.display = 'block';
                document.getElementById('typeTarifValue').textContent = sim.type_tarif.libelle || sim.type_tarif.code;
                document.getElementById('typeTarifValue').className = 'badge bg-' + (sim.type_tarif.couleur || 'secondary');

                let ageInfo = '';
                if (sim.age !== undefined) {
                    ageInfo = `Âge calculé: ${sim.age} ans`;
                    if (sim.type_tarif.age_min !== null || sim.type_tarif.age_max !== null) {
                        ageInfo += ` (${sim.type_tarif.age_min || 0}-${sim.type_tarif.age_max || '∞'} ans)`;
                    }
                }
                document.getElementById('ageInfo').textContent = ageInfo;
            } else {
                typeTarifSection.style.display = 'none';
            }

            // Section arbre de décision
            const arbreDecisionSection = document.getElementById('arbreDecisionSection');
            if (sim.arbre_decision || sim.chemin_arbre) {
                arbreDecisionSection.style.display = 'block';
                const arbreInfo = document.getElementById('arbreDecisionInfo');
                const arbreCheminList = document.getElementById('arbreCheminList');

                // Info arbre
                if (sim.arbre_decision) {
                    let infoHtml = `Version ${sim.arbre_decision.version}`;
                    if (sim.arbre_decision.verrouille) {
                        infoHtml += ' <span class="badge bg-secondary"><i class="bi bi-lock"></i> Verrouillé</span>';
                    }
                    arbreInfo.innerHTML = infoHtml;
                }

                // Chemin parcouru
                if (sim.chemin_arbre && sim.chemin_arbre.length > 0) {
                    arbreCheminList.innerHTML = sim.chemin_arbre.map((etape, index) => `
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge bg-light text-dark me-2">${index + 1}</span>
                            <span class="text-muted small">
                                <strong>${etape.noeud_type}</strong>:
                                ${etape.branche_libelle}
                                ${etape.reduction ? `<span class="text-success">(-${etape.reduction} €)</span>` : ''}
                            </span>
                        </div>
                    `).join('');
                } else {
                    arbreCheminList.innerHTML = '<span class="text-muted small">Aucune branche correspondante</span>';
                }
            } else {
                arbreDecisionSection.style.display = 'none';
            }
        }

        // Fallback: calcul simple si API tarification non disponible
        async function calculerMontantSimple() {
            const tarifSelect = document.getElementById('tarif_cotisation_id');
            const previewDiv = document.getElementById('montantPreview');
            const detailsDiv = document.getElementById('montantDetails');

            const selectedOption = tarifSelect.options[tarifSelect.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.tarif) return;

            const tarif = JSON.parse(selectedOption.dataset.tarif);
            let montantBase = parseFloat(tarif.montant_base);
            let reductionCode = 0;
            let avoir = 0;

            // Réduction code si présent
            if (currentCodeReduction) {
                try {
                    const calcul = await apiRequest(`/parametres/codes-reduction/${currentCodeReduction.id}/calculer`, {
                        method: 'POST',
                        body: JSON.stringify({ montant: montantBase })
                    });

                    reductionCode = calcul.calcul.reduction;
                    avoir = calcul.calcul.avoir || 0;
                    montantBase = calcul.calcul.montant_final;
                } catch (error) {
                    console.error('Erreur calcul réduction:', error);
                }
            }

            // Masquer les sections avancées
            document.getElementById('qfSection').style.display = 'none';
            document.getElementById('reductionsSection').style.display = 'none';
            document.getElementById('typeTarifSection').style.display = 'none';
            document.getElementById('arbreDecisionSection').style.display = 'none';

            detailsDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-7 text-end">Montant de base:</div>
                    <div class="col-5"><strong>${parseFloat(tarif.montant_base).toFixed(2)} €</strong></div>
                    ${reductionCode > 0 ? `
                        <div class="col-7 text-end text-success">Réduction code:</div>
                        <div class="col-5 text-success">-${reductionCode.toFixed(2)} €</div>
                    ` : ''}
                    <div class="col-12"><hr class="my-2"></div>
                    <div class="col-7 text-end"><strong>Montant à payer:</strong></div>
                    <div class="col-5"><strong class="fs-4 text-primary">${montantBase.toFixed(2)} €</strong></div>
                    ${avoir > 0 ? `
                        <div class="col-7 text-end text-info">Avoir généré:</div>
                        <div class="col-5 text-info">+${avoir.toFixed(2)} €</div>
                    ` : ''}
                </div>
                <div class="text-muted small mt-2">
                    <i class="bi bi-info-circle"></i> Mode simplifié (tarification avancée non configurée)
                </div>
            `;

            previewDiv.style.display = 'block';
        }


        // Update tarif info
        function updateTarifInfo() {
            const select = document.getElementById('tarif_cotisation_id');
            const selectedOption = select.options[select.selectedIndex];
            const div = document.getElementById('tarifInfo');

            if (!select.value) {
                div.innerHTML = '';
                return;
            }

            const tarif = JSON.parse(selectedOption.dataset.tarif);
            div.innerHTML = `
                <div class="alert alert-secondary">
                    <strong>Type période:</strong> ${formatTypePeriode(tarif.type_periode)}<br>
                    <strong>Type montant:</strong> ${tarif.type_montant === 'fixe' ? 'Fixe' : 'Prorata'}<br>
                    <strong>Montant de base:</strong> ${tarif.montant_base} €
                    ${tarif.reduction_association_valeur > 0 ? `<br><strong>Réduction association:</strong> ${tarif.reduction_association_valeur}${tarif.reduction_association_type === 'pourcentage' ? '%' : '€'}` : ''}
                </div>
            `;

            // Recalculer le montant
            calculerMontantTotal();
        }

        // Show modal for new cotisation
        function showCotisationModal() {
            document.getElementById('cotisationForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date_paiement').value = today;

            // Réinitialiser les infos
            document.getElementById('adherent_search').value = '';
            document.getElementById('adherent_id').value = '';
            document.getElementById('adherentInfo').innerHTML = '';
            document.getElementById('tarifInfo').innerHTML = '';
            document.getElementById('montantPreview').style.display = 'none';
            document.getElementById('adherentsList').style.display = 'none';

            // Réinitialiser le code de réduction
            retirerCodeReduction();

            // Précharger le tarif par défaut si disponible
            if (window.tarifParDefautId) {
                const select = document.getElementById('tarif_cotisation_id');
                select.value = window.tarifParDefautId;
                updateTarifInfo();
            }

            new bootstrap.Modal(document.getElementById('cotisationModal')).show();
        }

        // Save cotisation
        async function saveCotisation() {
            const form = document.getElementById('cotisationForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const codeReductionId = document.getElementById('code_reduction_id').value;

            const data = {
                adherent_id: parseInt(document.getElementById('adherent_id').value),
                tarif_cotisation_id: parseInt(document.getElementById('tarif_cotisation_id').value),
                date_debut: document.getElementById('date_debut').value || undefined,
                date_fin: document.getElementById('date_fin').value || undefined,
                date_paiement: document.getElementById('date_paiement').value,
                mode_paiement_id: parseInt(document.getElementById('mode_paiement').value),
                reference_paiement: document.getElementById('reference_paiement').value || undefined,
                notes: document.getElementById('notes').value || undefined
            };

            // Ajouter le code de réduction si présent
            if (codeReductionId) {
                data.code_reduction_id = parseInt(codeReductionId);
            }

            try {
                // Utiliser la route tarification/creer pour le calcul complet avec arbre de décision
                const result = await apiRequest('/tarification/creer', {
                    method: 'POST',
                    body: JSON.stringify({
                        utilisateur_id: data.adherent_id,
                        tarif_cotisation_id: data.tarif_cotisation_id,
                        date_cotisation: data.date_debut,
                        date_paiement: data.date_paiement,
                        mode_paiement_id: data.mode_paiement_id,
                        reference_paiement: data.reference_paiement,
                        notes: data.notes,
                        code_reduction_id: data.code_reduction_id
                    })
                });

                showAlert('Cotisation créée avec succès', 'success');
                bootstrap.Modal.getInstance(document.getElementById('cotisationModal')).hide();
                loadCotisations();
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'danger');
            }
        }

        // Annuler cotisation
        async function annulerCotisation(id) {
            const motif = prompt('Motif de l\'annulation (optionnel):');
            if (motif === null) return; // User cancelled

            try {
                await apiRequest(`/cotisations/${id}/annuler`, {
                    method: 'POST',
                    body: JSON.stringify({ motif })
                });

                showAlert('Cotisation annulée avec succès', 'success');
                loadCotisations();
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'danger');
            }
        }

        // Show details
        async function showDetails(id) {
            try {
                const cot = await apiRequest(`/cotisations/${id}`);

                // Charger les réductions si disponibles
                let reductionsHtml = '';
                try {
                    const recap = await apiRequest(`/tarification/cotisation/${id}/reductions`);
                    if (recap && recap.reductions && recap.reductions.length > 0) {
                        const sourcesLabels = {
                            'quotient_familial': 'Quotient familial',
                            'commune': 'Commune',
                            'statut_social': 'Statut social',
                            'multi_enfants': 'Multi-enfants',
                            'fidelite': 'Fidélité',
                            'partenariat': 'Partenariat',
                            'handicap': 'Handicap',
                            'age': 'Âge',
                            'code_reduction': 'Code promo',
                            'manuel': 'Manuel',
                            // Types arbre de décision
                            'ARBRE_COMMUNE': 'Commune (arbre)',
                            'ARBRE_QF': 'Quotient familial (arbre)',
                            'ARBRE_AGE': 'Âge (arbre)',
                            'ARBRE_FIDELITE': 'Fidélité (arbre)',
                            'ARBRE_MULTI_INSCRIPTIONS': 'Multi-inscriptions (arbre)',
                            'ARBRE_TAG': 'Tag (arbre)',
                            'ARBRE_STATUT_SOCIAL': 'Statut social (arbre)'
                        };

                        reductionsHtml = `
                        <tr>
                            <th>Détail réductions:</th>
                            <td>
                                ${recap.reductions.map(r => `
                                    <div class="d-flex justify-content-between text-success small">
                                        <span>${sourcesLabels[r.type_source] || r.type_source}${r.libelle_source ? ` (${r.libelle_source})` : ''}</span>
                                        <span>-${parseFloat(r.montant_reduction).toFixed(2)} €</span>
                                    </div>
                                `).join('')}
                            </td>
                        </tr>
                        `;

                        // Ajouter info QF si présent
                        if (recap.quotient_familial_snapshot) {
                            reductionsHtml += `
                            <tr>
                                <th>QF au moment:</th>
                                <td>${recap.quotient_familial_snapshot}${recap.tranche_qf ? ` (tranche ${recap.tranche_qf.qf_min}-${recap.tranche_qf.qf_max || '∞'})` : ''}</td>
                            </tr>
                            `;
                        }
                    }
                } catch (e) {
                    // API tarification non disponible, ignorer
                    console.log('Détail réductions non disponible');
                }

                document.getElementById('detailsContent').innerHTML = `
                    <table class="table">
                        <tr>
                            <th width="30%">Usager:</th>
                            <td>${cot.adherent?.nom || 'N/A'} ${cot.adherent?.prenom || ''}<br>
                                <small class="text-muted">${cot.adherent?.email || 'Email non disponible'}</small></td>
                        </tr>
                        <tr>
                            <th>Tarif:</th>
                            <td>${cot.tarif.libelle}</td>
                        </tr>
                        <tr>
                            <th>Période:</th>
                            <td>${formatDate(cot.periode_debut)} → ${formatDate(cot.periode_fin)}</td>
                        </tr>
                        <tr>
                            <th>Montant de base:</th>
                            <td>${cot.montant_base} €</td>
                        </tr>
                        ${cot.tarif_base && cot.tarif_base !== cot.montant_base ? `
                        <tr>
                            <th>Tarif type:</th>
                            <td>${cot.tarif_base} €</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <th>Réduction totale:</th>
                            <td class="text-success">${cot.reduction_appliquee || cot.total_reductions || 0} €</td>
                        </tr>
                        ${reductionsHtml}
                        ${cot.code_reduction_applique ? `
                        <tr>
                            <th>Code de réduction:</th>
                            <td><span class="badge bg-info">${cot.code_reduction_applique}</span></td>
                        </tr>
                        ` : ''}
                        ${cot.avoir_genere > 0 ? `
                        <tr>
                            <th>Avoir généré:</th>
                            <td class="text-info"><strong>+${cot.avoir_genere} €</strong></td>
                        </tr>
                        ` : ''}
                        <tr>
                            <th>Montant payé:</th>
                            <td><strong class="fs-5">${cot.montant_paye} €</strong></td>
                        </tr>
                        <tr>
                            <th>Date paiement:</th>
                            <td>${formatDate(cot.date_paiement)}</td>
                        </tr>
                        <tr>
                            <th>Mode paiement:</th>
                            <td>${formatModePaiement(cot.mode_paiement)}</td>
                        </tr>
                        ${cot.reference_paiement ? `
                        <tr>
                            <th>Référence:</th>
                            <td>${cot.reference_paiement}</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <th>Statut:</th>
                            <td>${formatStatutBadge(cot.statut)}</td>
                        </tr>
                        ${cot.age_snapshot !== null && cot.age_snapshot !== undefined ? `
                        <tr>
                            <th>Âge au moment:</th>
                            <td>${cot.age_snapshot} ans</td>
                        </tr>
                        ` : ''}
                        ${cot.notes ? `
                        <tr>
                            <th>Notes:</th>
                            <td>${cot.notes}</td>
                        </tr>
                        ` : ''}
                        ${cot.arbre_decision_id ? `
                        <tr>
                            <th>Arbre de décision:</th>
                            <td>
                                <span class="badge bg-info"><i class="bi bi-diagram-3"></i> Version ${cot.arbre_version || '?'}</span>
                                ${cot.chemin_arbre_json && cot.chemin_arbre_json.length > 0 ? `
                                    <div class="mt-2 small">
                                        ${cot.chemin_arbre_json.map((etape, i) => `
                                            <div class="text-muted">
                                                <span class="badge bg-light text-dark">${i + 1}</span>
                                                <strong>${etape.noeud_type}</strong>: ${etape.branche_libelle}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </td>
                        </tr>
                        ` : ''}
                    </table>
                `;

                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'danger');
            }
        }

        // Format helpers
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function formatTypePeriode(type) {
            const types = {
                'annee_civile': 'Année Civile',
                'annee_scolaire': 'Année Scolaire',
                'date_a_date': 'Date à Date'
            };
            return types[type] || type;
        }

        function formatModePaiement(mode) {
            const modes = {
                'especes': 'Espèces',
                'cheque': 'Chèque',
                'carte_bancaire': 'CB',
                'virement': 'Virement',
                'prelevement': 'Prélèvement',
                'autre': 'Autre'
            };
            return modes[mode] || mode;
        }

        function formatStatutBadge(statut) {
            const statuts = {
                'en_cours': { label: 'En Cours', class: 'success' },
                'expiree': { label: 'Expirée', class: 'warning' },
                'annulee': { label: 'Annulée', class: 'danger' }
            };
            const s = statuts[statut] || { label: statut, class: 'secondary' };
            return `<span class="badge bg-${s.class}">${s.label}</span>`;
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Search on input
        document.getElementById('searchAdherent').addEventListener('input', () => {
            displayCotisations(cotisationsCache);
        });

        // ==================== BARCODE SCANNER ====================
        let barcodeBuffer = '';
        let barcodeTimeout = null;
        let scanUsagerActuel = null;
        let scanCodeReductionActuel = null;
        let scanSimulationsCache = {};
        let derniereCotisationCreee = null;
        let champsVisiblesCache = null;

        // Initialiser l'écoute du scanner
        document.addEventListener('keydown', handleBarcodeScanner);

        // Afficher l'indicateur de scan
        document.getElementById('scanIndicator').style.display = 'flex';

        function handleBarcodeScanner(e) {
            const isInputField = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);
            const scanCodeInput = document.getElementById('scanCodeReduction');

            // Ignorer si on est dans le champ code réduction
            if (document.activeElement === scanCodeInput) return;

            if (e.key === 'Enter' && barcodeBuffer.length >= 3) {
                e.preventDefault();
                const code = barcodeBuffer.trim().toUpperCase();
                barcodeBuffer = '';
                clearTimeout(barcodeTimeout);
                processBarcodeScan(code);
                return;
            }

            if (e.key.length === 1 && /[a-zA-Z0-9\-]/.test(e.key)) {
                if (!isInputField) e.preventDefault();
                barcodeBuffer += e.key;
                clearTimeout(barcodeTimeout);
                barcodeTimeout = setTimeout(() => { barcodeBuffer = ''; }, 100);
            }
        }

        async function processBarcodeScan(code) {
            try {
                const data = await barcodesAPI.scan(code);

                if (data.type === 'adherent' || data.type === 'utilisateur') {
                    const usager = data.adherent || data.utilisateur;
                    await ouvrirModaleScanUsager(usager.id);
                } else {
                    showAlert(`Code-barre "${code}" n'est pas un usager`, 'warning');
                }
            } catch (error) {
                showAlert(`Code-barre invalide: ${error.message}`, 'danger');
            }
        }

        // ==================== MODAL SCAN USAGER ====================
        async function ouvrirModaleScanUsager(usagerId) {
            try {
                // Charger les champs visibles pour le rôle actuel
                await chargerChampsVisibles();

                // Charger les infos de l'usager
                const usager = await apiRequest(`/utilisateurs/${usagerId}`);
                scanUsagerActuel = usager;
                scanCodeReductionActuel = null;
                scanSimulationsCache = {};

                // Afficher les infos
                afficherInfosUsager(usager);

                // Charger les cotisations en cours
                await chargerCotisationsUsager(usagerId);

                // Charger et simuler les tarifs
                await chargerEtSimulerTarifs(usagerId);

                // Vider le champ code réduction
                document.getElementById('scanCodeReduction').value = '';
                document.getElementById('scanCodeReductionInfo').innerHTML = '';

                // Ouvrir la modale
                const modal = new bootstrap.Modal(document.getElementById('scanUsagerModal'));
                modal.show();

            } catch (error) {
                showAlert(`Erreur chargement usager: ${error.message}`, 'danger');
            }
        }

        async function chargerChampsVisibles() {
            if (champsVisiblesCache) return;

            try {
                // Récupérer le rôle de l'utilisateur connecté
                const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
                const role = userInfo.role || 'benevole';

                const config = await apiRequest(`/parametres/acces-donnees/role/${role}`);
                champsVisiblesCache = config.champsVisibles || ['nom', 'prenom'];
            } catch (error) {
                // Fallback: nom et prénom seulement
                champsVisiblesCache = ['nom', 'prenom'];
            }
        }

        function afficherInfosUsager(usager) {
            const container = document.getElementById('scanUsagerInfos');
            const statutBadge = document.getElementById('scanUsagerStatut');

            // Badge statut
            const statutClass = usager.statut === 'actif' ? 'success' : 'secondary';
            statutBadge.className = `badge bg-${statutClass}`;
            statutBadge.textContent = usager.statut;

            // Construire le HTML des infos en fonction des droits
            const champs = champsVisiblesCache || ['nom', 'prenom'];
            let html = '<table class="table table-sm mb-0">';

            // Nom et prénom (toujours visibles)
            html += `<tr><th width="40%">Nom</th><td>${usager.nom || '-'} ${usager.prenom || ''}</td></tr>`;

            // Date de naissance
            if (champs.includes('date_naissance') && usager.date_naissance) {
                const age = calculerAge(usager.date_naissance);
                html += `<tr><th>Naissance</th><td>${formatDate(usager.date_naissance)} (${age} ans)</td></tr>`;
            }

            // Téléphone
            if (champs.includes('telephone') && usager.telephone) {
                html += `<tr><th>Téléphone</th><td>${usager.telephone}</td></tr>`;
            }

            // Email
            if (champs.includes('email') && usager.email) {
                html += `<tr><th>Email</th><td class="text-truncate" style="max-width:200px">${usager.email}</td></tr>`;
            }

            // Adresse
            if (champs.includes('adresse') || champs.includes('code_postal') || champs.includes('ville')) {
                let adresse = '';
                if (champs.includes('adresse') && usager.adresse) adresse += usager.adresse;
                if (champs.includes('code_postal') && usager.code_postal) adresse += (adresse ? '<br>' : '') + usager.code_postal;
                if (champs.includes('ville') && usager.ville) adresse += (usager.code_postal ? ' ' : (adresse ? '<br>' : '')) + usager.ville;
                if (adresse) {
                    html += `<tr><th>Adresse</th><td>${adresse}</td></tr>`;
                }
            }

            // Quotient Familial
            if (usager.quotient_familial !== undefined && usager.quotient_familial !== null) {
                html += `<tr><th>QF</th><td><span class="badge bg-info">${usager.quotient_familial}</span></td></tr>`;
            }

            html += '</table>';
            container.innerHTML = html;
        }

        function calculerAge(dateNaissance) {
            const naissance = new Date(dateNaissance);
            const aujourdhui = new Date();
            let age = aujourdhui.getFullYear() - naissance.getFullYear();
            const moisDiff = aujourdhui.getMonth() - naissance.getMonth();
            if (moisDiff < 0 || (moisDiff === 0 && aujourdhui.getDate() < naissance.getDate())) {
                age--;
            }
            return age;
        }

        async function chargerCotisationsUsager(usagerId) {
            const container = document.getElementById('scanUsagerCotisations');

            try {
                const cotisations = await apiRequest(`/cotisations?adherent_id=${usagerId}&statut=en_cours`);

                if (cotisations.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-2"><i class="bi bi-info-circle"></i> Aucune cotisation active</div>';
                    return;
                }

                container.innerHTML = cotisations.map(cot => `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${cot.tarif?.libelle || 'Tarif inconnu'}</strong>
                            <small class="d-block text-muted">${formatDate(cot.periode_debut)} → ${formatDate(cot.periode_fin)}</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">${parseFloat(cot.montant_paye).toFixed(2)} €</strong>
                            ${formatStatutBadge(cot.statut)}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> Erreur: ${error.message}</div>`;
            }
        }

        async function chargerEtSimulerTarifs(usagerId) {
            const container = document.getElementById('scanTarifsCards');
            container.innerHTML = '<div class="col-12 text-center py-3"><div class="spinner-border spinner-border-sm"></div> Calcul des tarifs...</div>';

            try {
                // Charger les tarifs disponibles
                const tarifs = await apiRequest('/tarifs-cotisation?actif=true&valide=true');

                if (tarifs.length === 0) {
                    container.innerHTML = '<div class="col-12 text-muted text-center py-2">Aucun tarif disponible</div>';
                    return;
                }

                // Simuler chaque tarif
                const simulations = await Promise.all(tarifs.map(async (tarif) => {
                    try {
                        const result = await apiRequest('/tarification/simuler', {
                            method: 'POST',
                            body: JSON.stringify({
                                utilisateur_id: usagerId,
                                tarif_cotisation_id: tarif.id
                            })
                        });
                        return { tarif, simulation: result.data, error: null };
                    } catch (error) {
                        return { tarif, simulation: null, error: error.message };
                    }
                }));

                // Mettre en cache les simulations
                simulations.forEach(s => {
                    if (s.simulation) {
                        scanSimulationsCache[s.tarif.id] = s.simulation;
                    }
                });

                // Afficher les cartes
                container.innerHTML = simulations.map(({ tarif, simulation, error }) => {
                    if (error) {
                        return `
                            <div class="col-md-6">
                                <div class="card border-danger h-100">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="card-title mb-1">${tarif.libelle}</h6>
                                        <small class="text-danger">${error}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    const montantOriginal = simulation.tarif?.montant_base_tarif || tarif.montant_base;
                    const montantFinal = simulation.calcul?.montant_final ?? montantOriginal;
                    const hasReduction = montantFinal < montantOriginal;
                    const hasArbre = simulation.arbre_decision && simulation.chemin_arbre?.length > 0;

                    return `
                        <div class="col-md-6">
                            <div class="card h-100 ${tarif.par_defaut ? 'border-primary' : ''}">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">${tarif.libelle}</h6>
                                        ${tarif.par_defaut ? '<span class="badge bg-primary">Défaut</span>' : ''}
                                    </div>
                                    <div class="text-center mb-2">
                                        <span class="fs-4 fw-bold ${hasReduction ? 'text-success' : ''}">${montantFinal.toFixed(2)} €</span>
                                        ${hasReduction ? `<br><small class="text-muted text-decoration-line-through">${montantOriginal.toFixed(2)} €</small>` : ''}
                                    </div>
                                    ${hasArbre ? `<div class="small text-info mb-2"><i class="bi bi-diagram-3"></i> Arbre appliqué</div>` : ''}
                                    ${simulation.reductions?.length > 0 ? `
                                        <div class="small text-success mb-2">
                                            <i class="bi bi-tags"></i> ${simulation.reductions.length} réduction(s)
                                        </div>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="choisirTarif(${tarif.id})">
                                        <i class="bi bi-check-lg"></i> Choisir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = `<div class="col-12 text-danger"><i class="bi bi-exclamation-triangle"></i> Erreur: ${error.message}</div>`;
            }
        }

        async function appliquerCodeReductionScan() {
            const codeInput = document.getElementById('scanCodeReduction');
            const infoDiv = document.getElementById('scanCodeReductionInfo');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                scanCodeReductionActuel = null;
                infoDiv.innerHTML = '';
                // Recharger les tarifs sans code
                if (scanUsagerActuel) {
                    await chargerEtSimulerTarifs(scanUsagerActuel.id);
                }
                return;
            }

            try {
                // Vérifier le code
                const result = await apiRequest(`/parametres/codes-reduction/code/${code}`);

                if (!result || !result.valide) {
                    infoDiv.innerHTML = '<div class="alert alert-warning py-1 mb-0"><i class="bi bi-exclamation-triangle"></i> Code invalide ou expiré</div>';
                    scanCodeReductionActuel = null;
                    return;
                }

                scanCodeReductionActuel = result;
                infoDiv.innerHTML = `
                    <div class="alert alert-success py-1 mb-0">
                        <i class="bi bi-check-circle"></i> <strong>${result.code}</strong>: ${result.description || 'Réduction appliquée'}
                    </div>
                `;

                // Recharger les simulations avec le code de réduction
                // Note: les codes de réduction sont appliqués côté serveur lors de la création
                showAlert('Code de réduction appliqué. Le montant sera ajusté lors de la création.', 'info');

            } catch (error) {
                infoDiv.innerHTML = `<div class="alert alert-danger py-1 mb-0"><i class="bi bi-x-circle"></i> ${error.message}</div>`;
                scanCodeReductionActuel = null;
            }
        }

        async function choisirTarif(tarifId) {
            if (!scanUsagerActuel) {
                showAlert('Aucun usager sélectionné', 'warning');
                return;
            }

            const simulation = scanSimulationsCache[tarifId];
            if (!simulation) {
                showAlert('Simulation non disponible pour ce tarif', 'warning');
                return;
            }

            // Créer la cotisation
            try {
                const data = {
                    utilisateur_id: scanUsagerActuel.id,
                    tarif_cotisation_id: tarifId,
                    mode_paiement: 'especes', // Par défaut
                    date_paiement: new Date().toISOString().split('T')[0]
                };

                if (scanCodeReductionActuel) {
                    data.code_reduction_id = scanCodeReductionActuel.id;
                }

                const result = await apiRequest('/tarification/creer', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                derniereCotisationCreee = result.data;

                // Afficher le récapitulatif
                afficherRecapCotisation(result.data, simulation);

                // Recharger les cotisations dans la modale scan
                await chargerCotisationsUsager(scanUsagerActuel.id);

                // Recharger la liste principale
                loadCotisations();

            } catch (error) {
                showAlert(`Erreur création cotisation: ${error.message}`, 'danger');
            }
        }

        function afficherRecapCotisation(cotisation, simulation) {
            const container = document.getElementById('recapCotisationContent');

            const usager = scanUsagerActuel;
            const tarif = simulation?.tarif || cotisation.tarif || {};

            container.innerHTML = `
                <div class="text-center mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                </div>
                <table class="table">
                    <tr>
                        <th>Usager</th>
                        <td>${usager.nom} ${usager.prenom}</td>
                    </tr>
                    <tr>
                        <th>Tarif</th>
                        <td>${tarif.libelle || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Période</th>
                        <td>${formatDate(cotisation.periode_debut)} → ${formatDate(cotisation.periode_fin)}</td>
                    </tr>
                    <tr>
                        <th>Montant payé</th>
                        <td><strong class="text-success fs-4">${parseFloat(cotisation.montant_paye).toFixed(2)} €</strong></td>
                    </tr>
                    ${cotisation.reduction_appliquee > 0 || cotisation.total_reductions > 0 ? `
                    <tr>
                        <th>Réductions</th>
                        <td class="text-success">-${(cotisation.reduction_appliquee || cotisation.total_reductions || 0).toFixed(2)} €</td>
                    </tr>
                    ` : ''}
                    ${cotisation.arbre_decision_id ? `
                    <tr>
                        <th>Arbre décision</th>
                        <td><span class="badge bg-info"><i class="bi bi-diagram-3"></i> v${cotisation.arbre_version || '?'}</span></td>
                    </tr>
                    ` : ''}
                </table>
            `;

            // Ouvrir la modale récap
            const recapModal = new bootstrap.Modal(document.getElementById('recapCotisationModal'));
            recapModal.show();
        }

        async function imprimerRecuCotisation() {
            if (!derniereCotisationCreee) {
                showAlert('Aucune cotisation à imprimer', 'warning');
                return;
            }

            try {
                // Télécharger le PDF via fetch avec Authorization header
                const token = getAuthToken();
                const headers = {
                    'Authorization': `Bearer ${token}`
                };
                const structureId = typeof getCurrentStructureId === 'function' ? getCurrentStructureId() : null;
                if (structureId) {
                    headers['X-Structure-Id'] = structureId.toString();
                }
                const response = await fetch(`${API_BASE_URL}/cotisations/${derniereCotisationCreee.id}/recu`, {
                    method: 'GET',
                    headers
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la génération du reçu');
                }

                // Créer un blob et l'ouvrir dans un nouvel onglet
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');

                // Nettoyer le blob URL après un délai
                setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
            } catch (error) {
                showAlert(`Erreur impression: ${error.message}`, 'danger');
            }
        }

        function fermerRecapEtContinuer() {
            // Fermer la modale récap (fait automatiquement par data-bs-dismiss)
            // La modale scan usager reste ouverte pour permettre d'autres cotisations
        }
    </script>
</body>
</html>
