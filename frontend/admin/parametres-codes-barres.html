<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codes-Barres Reserves - Parametres - Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .module-card {
      border: 2px solid #dee2e6;
      border-radius: 0.75rem;
      transition: all 0.2s;
    }
    .module-card.locked {
      border-color: #ffc107;
    }
    .module-card.unsaved {
      border-color: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
    }
    .module-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }
    .module-icon.utilisateur { background: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    .module-icon.jeu { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .module-icon.livre { background: rgba(32, 201, 151, 0.1); color: #20c997; }
    .module-icon.film { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .module-icon.disque { background: rgba(232, 62, 140, 0.1); color: #e83e8c; }

    .token-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .token-item {
      padding: 0.2rem 0.6rem;
      border-radius: 0.375rem;
      background: #e9ecef;
      cursor: grab;
      font-size: 0.8rem;
      transition: all 0.2s;
      user-select: none;
    }
    .token-item:active {
      cursor: grabbing;
    }
    .token-item:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .token-item.prefix-token { background: #e9ecef; color: #495057; }
    .token-item.prefix-token:hover { background: #6c757d; color: white; }
    .token-item.date-token { background: #fff3cd; color: #664d03; }
    .token-item.date-token:hover { background: #ffc107; color: #000; }
    .token-item.seq-token { background: #cfe2ff; color: #084298; }
    .token-item.seq-token:hover { background: #0d6efd; color: white; }
    .token-item.dragging {
      opacity: 0.5;
      transform: scale(1.1);
    }

    .format-preview {
      font-family: monospace;
      font-size: 1.1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      text-align: center;
      border: 1px dashed #dee2e6;
    }
    .format-preview .code {
      font-weight: bold;
      letter-spacing: 1px;
    }

    .format-input {
      font-family: monospace;
      font-size: 0.9rem;
    }
    .format-input.drop-target {
      border-color: #0d6efd;
      background: rgba(13, 110, 253, 0.05);
    }

    .locked-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      background: #fff3cd;
      color: #664d03;
      border-radius: 0.25rem;
      font-size: 0.7rem;
    }

    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
    }
    .stats-card h3 {
      font-size: 2rem;
      font-weight: bold;
    }

    .sub-nav {
      background: #f8f9fa;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e9ecef;
      margin-bottom: 1.5rem;
    }

    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      z-index: 1050;
      display: none;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .save-indicator.saving { display: flex; background: #fff3cd; color: #856404; }
    .save-indicator.saved { display: flex; background: #d1e7dd; color: #0f5132; }
    .save-indicator.error { display: flex; background: #f8d7da; color: #842029; }

    .tokens-toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 1rem;
      margin: -1rem -1rem 1rem -1rem;
      border-bottom: 1px solid #e9ecef;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .module-config-form .form-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .module-config-form .form-control,
    .module-config-form .form-select {
      font-size: 0.85rem;
    }
    .module-config-form .form-text {
      font-size: 0.7rem;
    }

    .btn-save-module {
      transition: all 0.2s;
    }
    .btn-save-module:not(:disabled) {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(13, 110, 253, 0); }
    }
  </style>
</head>
<body>
  <!-- Navigation (genere par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (genere par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <div id="sub-nav-container"></div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="parametres.html">Parametres</a></li>
                <li class="breadcrumb-item active">Codes-Barres Reserves</li>
              </ol>
            </nav>
            <h1 class="h3 mb-0"><i class="bi bi-upc-scan me-2"></i>Codes-Barres Reserves</h1>
          </div>
          <a href="lots-codes-barres.html" class="btn btn-primary">
            <i class="bi bi-printer me-1"></i>Gerer les lots
          </a>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="config">
              <i class="bi bi-sliders me-1"></i>Configuration
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-tab="stats">
              <i class="bi bi-bar-chart me-1"></i>Statistiques
            </a>
          </li>
        </ul>

        <!-- Contenu Configuration -->
        <div id="tab-config">
          <!-- Toolbar tokens (sticky) -->
          <div class="tokens-toolbar rounded">
            <h6 class="mb-2"><i class="bi bi-grip-vertical me-1"></i>Glissez les tokens dans les champs "Format"</h6>
            <div class="d-flex flex-wrap gap-3">
              <div>
                <small class="text-muted d-block mb-1">Prefix</small>
                <div class="token-list">
                  <span class="token-item prefix-token" draggable="true" data-token="{PREFIX}" title="Prefix du module">{PREFIX}</span>
                </div>
              </div>
              <div>
                <small class="text-muted d-block mb-1">Date</small>
                <div class="token-list" id="date-tokens"></div>
              </div>
              <div>
                <small class="text-muted d-block mb-1">Sequence</small>
                <div class="token-list" id="seq-tokens"></div>
              </div>
            </div>
          </div>

          <!-- Configuration par module -->
          <div class="row" id="modules-container">
            <!-- Genere par JS -->
          </div>
        </div>

        <!-- Contenu Statistiques -->
        <div id="tab-stats" style="display: none;">
          <div class="row mb-4" id="stats-cards">
            <!-- Genere par JS -->
          </div>

          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-table me-2"></i>Recapitulatif par module</h5>
            </div>
            <div class="card-body">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Module</th>
                    <th>Prefix</th>
                    <th>Format verrouille</th>
                    <th>Sequence courante</th>
                    <th>Lots</th>
                    <th>Codes totaux</th>
                    <th>Utilises</th>
                    <th>Disponibles</th>
                  </tr>
                </thead>
                <tbody id="stats-table">
                  <!-- Genere par JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Indicateur de sauvegarde -->
  <div id="save-indicator" class="save-indicator">
    <span class="indicator-icon"></span>
    <span class="indicator-text"></span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script>
    // Initialiser le template (navbar + sidebar)
    initTemplate('parametres');

    const API_BASE = '/api/codes-barres-reserves';

    // Helper pour les appels API authentifies
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      };
    }

    async function apiGet(endpoint) {
      const response = await fetch(endpoint, { headers: getAuthHeaders() });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.message || `Erreur ${response.status}`);
      }
      return response.json();
    }

    async function apiPut(endpoint, data) {
      const response = await fetch(endpoint, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
      });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.message || `Erreur ${response.status}`);
      }
      return response.json();
    }

    const MODULES = [
      { id: 'utilisateur', label: 'Usagers', icon: 'bi-person-badge', colorClass: 'utilisateur', defaultPrefix: 'USA' },
      { id: 'jeu', label: 'Jeux', icon: 'bi-dice-5', colorClass: 'jeu', defaultPrefix: 'JEU' },
      { id: 'livre', label: 'Livres', icon: 'bi-book', colorClass: 'livre', defaultPrefix: 'LIV' },
      { id: 'film', label: 'Films', icon: 'bi-film', colorClass: 'film', defaultPrefix: 'FLM' },
      { id: 'disque', label: 'Disques', icon: 'bi-disc', colorClass: 'disque', defaultPrefix: 'DSQ' }
    ];

    let parametres = {};
    let stats = {};
    let tokens = [];
    let originalValues = {}; // Pour tracker les changements

    // Initialisation
    document.addEventListener('DOMContentLoaded', async () => {
      initSubNav('general', 'codes-barres');
      await loadTokens();
      await loadParametres();
      await loadStats();
      initTabs();
      initModuleCards();
      initDragAndDrop();
    });

    // Charger les tokens
    async function loadTokens() {
      try {
        const response = await apiGet(`${API_BASE}/tokens`);
        if (response.success) {
          tokens = response.tokens;
          renderTokens();
        }
      } catch (error) {
        console.error('Erreur chargement tokens:', error);
      }
    }

    // Afficher les tokens
    function renderTokens() {
      const dateTokensEl = document.getElementById('date-tokens');
      const seqTokensEl = document.getElementById('seq-tokens');

      const dateTokens = tokens.filter(t => t.key.includes('ANNEE') || t.key.includes('MOIS') || t.key.includes('JOUR'));
      const seqTokens = tokens.filter(t => t.key.includes('SEQUENCE'));

      dateTokensEl.innerHTML = dateTokens.map(t => `
        <span class="token-item date-token" draggable="true" data-token="${t.token}" title="${t.description} (ex: ${t.example})">
          ${t.token}
        </span>
      `).join('');

      seqTokensEl.innerHTML = seqTokens.map(t => `
        <span class="token-item seq-token" draggable="true" data-token="${t.token}" title="${t.description} (ex: ${t.example})">
          ${t.token}
        </span>
      `).join('');
    }

    // Initialiser le drag & drop
    function initDragAndDrop() {
      // Deleguer les events sur le document pour les tokens
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('token-item')) {
          e.target.classList.add('dragging');
          e.dataTransfer.setData('text/plain', e.target.dataset.token);
          e.dataTransfer.effectAllowed = 'copy';
        }
      });

      document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('token-item')) {
          e.target.classList.remove('dragging');
        }
      });

      // Drop sur les champs format
      document.addEventListener('dragover', (e) => {
        if (e.target.classList.contains('format-input')) {
          e.preventDefault();
          e.target.classList.add('drop-target');
        }
      });

      document.addEventListener('dragleave', (e) => {
        if (e.target.classList.contains('format-input')) {
          e.target.classList.remove('drop-target');
        }
      });

      document.addEventListener('drop', (e) => {
        if (e.target.classList.contains('format-input')) {
          e.preventDefault();
          e.target.classList.remove('drop-target');

          const token = e.dataTransfer.getData('text/plain');
          const input = e.target;

          // Inserer a la position du curseur ou a la fin
          const start = input.selectionStart || input.value.length;
          const end = input.selectionEnd || input.value.length;
          const before = input.value.substring(0, start);
          const after = input.value.substring(end);

          input.value = before + token + after;
          input.focus();
          input.setSelectionRange(start + token.length, start + token.length);

          // Declencher l'evenement input pour la mise a jour de l'apercu
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
    }

    // Charger les parametres
    async function loadParametres() {
      try {
        const response = await apiGet(`${API_BASE}/parametres`);
        if (response.success) {
          parametres = response.parametres;
          // Stocker les valeurs originales
          originalValues = JSON.parse(JSON.stringify(parametres));
        }
      } catch (error) {
        console.error('Erreur chargement parametres:', error);
        alert('Erreur lors du chargement des parametres');
      }
    }

    // Charger les stats
    async function loadStats() {
      try {
        const response = await apiGet(`${API_BASE}/stats`);
        if (response.success) {
          stats = response.stats;
          renderStats();
        }
      } catch (error) {
        console.error('Erreur chargement stats:', error);
      }
    }

    // Afficher les cartes modules avec formulaires integres
    function initModuleCards() {
      const container = document.getElementById('modules-container');
      container.innerHTML = MODULES.map(m => {
        const p = parametres[m.id] || {};
        const locked = p.format_locked;
        const lockedClass = locked ? 'locked' : '';

        return `
          <div class="col-lg-6 mb-4">
            <div class="module-card card ${lockedClass}" id="card-${m.id}">
              <div class="card-header d-flex align-items-center">
                <div class="module-icon ${m.colorClass} me-3">
                  <i class="bi ${m.icon}"></i>
                </div>
                <div class="flex-grow-1">
                  <h5 class="mb-0">${m.label}</h5>
                  <small class="text-muted">Module ${m.id}</small>
                </div>
                ${locked ? '<span class="locked-badge"><i class="bi bi-lock-fill"></i>Format verrouille</span>' : ''}
              </div>
              <div class="card-body module-config-form">
                ${locked ? `
                  <div class="alert alert-warning py-2 mb-3">
                    <small><i class="bi bi-info-circle me-1"></i>Ce format a deja ete utilise. Seule l'option "griller les annules" peut etre modifiee.</small>
                  </div>
                ` : ''}

                <div class="row g-3">
                  <div class="col-4">
                    <label class="form-label">Prefix</label>
                    <input type="text" class="form-control" id="prefix-${m.id}"
                           value="${p.prefix || m.defaultPrefix}" maxlength="10"
                           ${locked ? 'disabled' : ''}
                           onchange="markUnsaved('${m.id}')" oninput="updateModulePreview('${m.id}')">
                  </div>
                  <div class="col-8">
                    <label class="form-label">Reset sequence</label>
                    <select class="form-select" id="reset-${m.id}" ${locked ? 'disabled' : ''}
                            onchange="markUnsaved('${m.id}'); updateModulePreview('${m.id}')">
                      <option value="never" ${(p.sequence_reset || 'never') === 'never' ? 'selected' : ''}>Jamais</option>
                      <option value="yearly" ${p.sequence_reset === 'yearly' ? 'selected' : ''}>Annuel</option>
                      <option value="monthly" ${p.sequence_reset === 'monthly' ? 'selected' : ''}>Mensuel</option>
                      <option value="daily" ${p.sequence_reset === 'daily' ? 'selected' : ''}>Journalier</option>
                    </select>
                  </div>
                </div>

                <div class="mt-3">
                  <label class="form-label">Format <small class="text-muted">(glissez les tokens ici)</small></label>
                  <input type="text" class="form-control format-input" id="pattern-${m.id}"
                         value="${p.format_pattern || '{PREFIX}{NUMERO_SEQUENCE_8}'}"
                         ${locked ? 'disabled' : ''}
                         oninput="markUnsaved('${m.id}'); updateModulePreview('${m.id}')"
                         placeholder="Ex: {PREFIX}{ANNEE_COURTE}{NUMERO_SEQUENCE_6}">
                </div>

                <div class="mt-3">
                  <label class="form-label">Apercu</label>
                  <div class="format-preview">
                    <span class="code" id="preview-${m.id}">${generatePreview(p, m.defaultPrefix)}</span>
                  </div>
                </div>

                <div class="mt-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="griller-${m.id}"
                           ${p.griller_annules ? 'checked' : ''} onchange="markUnsaved('${m.id}')">
                    <label class="form-check-label small" for="griller-${m.id}">
                      Griller les codes annules (ne pourront plus etre reutilises)
                    </label>
                  </div>
                </div>

                <div class="mt-3 d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    Seq. actuelle: <strong>${p.current_sequence || 0}</strong>
                    ${p.current_period ? `| Periode: <strong>${p.current_period}</strong>` : ''}
                  </small>
                  <button class="btn btn-primary btn-sm btn-save-module" id="save-${m.id}"
                          onclick="saveModule('${m.id}')" disabled>
                    <i class="bi bi-check-lg me-1"></i>Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Marquer une carte comme modifiee
    function markUnsaved(moduleId) {
      const card = document.getElementById(`card-${moduleId}`);
      const btn = document.getElementById(`save-${moduleId}`);

      const p = parametres[moduleId] || {};
      const current = {
        prefix: document.getElementById(`prefix-${moduleId}`).value,
        format_pattern: document.getElementById(`pattern-${moduleId}`).value,
        sequence_reset: document.getElementById(`reset-${moduleId}`).value,
        griller_annules: document.getElementById(`griller-${moduleId}`).checked
      };

      const orig = originalValues[moduleId] || {};
      const hasChanges =
        current.prefix !== (orig.prefix || MODULES.find(m => m.id === moduleId).defaultPrefix) ||
        current.format_pattern !== (orig.format_pattern || '{PREFIX}{NUMERO_SEQUENCE_8}') ||
        current.sequence_reset !== (orig.sequence_reset || 'never') ||
        current.griller_annules !== (orig.griller_annules || false);

      if (hasChanges) {
        card.classList.add('unsaved');
        btn.disabled = false;
      } else {
        card.classList.remove('unsaved');
        btn.disabled = true;
      }
    }

    // Mettre a jour l'apercu d'un module
    function updateModulePreview(moduleId) {
      const m = MODULES.find(mod => mod.id === moduleId);
      const params = {
        prefix: document.getElementById(`prefix-${moduleId}`).value,
        format_pattern: document.getElementById(`pattern-${moduleId}`).value,
        sequence_reset: document.getElementById(`reset-${moduleId}`).value
      };
      document.getElementById(`preview-${moduleId}`).textContent = generatePreview(params, m.defaultPrefix);
    }

    // Generer un apercu de code
    function generatePreview(params, defaultPrefix = 'XXX') {
      if (!params.format_pattern) return `${defaultPrefix}00000042`;

      let code = params.format_pattern;
      const now = new Date();

      code = code.replace('{PREFIX}', params.prefix || defaultPrefix);
      code = code.replace('{ANNEE_LONGUE}', now.getFullYear().toString());
      code = code.replace('{ANNEE_COURTE}', now.getFullYear().toString().slice(-2));
      code = code.replace('{MOIS_LONG}', String(now.getMonth() + 1).padStart(2, '0'));
      code = code.replace('{MOIS_COURT}', String(now.getMonth() + 1));
      code = code.replace('{JOUR_LONG}', String(now.getDate()).padStart(2, '0'));
      code = code.replace('{JOUR_COURT}', String(now.getDate()));
      code = code.replace('{NUMERO_SEQUENCE_4}', '0042');
      code = code.replace('{NUMERO_SEQUENCE_6}', '000042');
      code = code.replace('{NUMERO_SEQUENCE_8}', '00000042');
      code = code.replace('{NUMERO_SEQUENCE_10}', '0000000042');

      return code;
    }

    // Sauvegarder un module
    async function saveModule(moduleId) {
      const data = {
        prefix: document.getElementById(`prefix-${moduleId}`).value,
        format_pattern: document.getElementById(`pattern-${moduleId}`).value,
        sequence_reset: document.getElementById(`reset-${moduleId}`).value,
        griller_annules: document.getElementById(`griller-${moduleId}`).checked
      };

      const btn = document.getElementById(`save-${moduleId}`);
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>...';
      btn.disabled = true;

      showSaveIndicator('saving');

      try {
        const response = await apiPut(`${API_BASE}/parametres/${moduleId}`, data);

        if (response.success) {
          parametres[moduleId] = response.parametres;
          originalValues[moduleId] = JSON.parse(JSON.stringify(response.parametres));

          // Recharger la carte si le format est maintenant verrouille
          initModuleCards();
          showSaveIndicator('saved');
        } else {
          throw new Error(response.message);
        }
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        showSaveIndicator('error');
        alert(error.message || 'Erreur lors de la sauvegarde');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Afficher les stats
    function renderStats() {
      let totalCodes = 0, totalUtilises = 0, totalDisponibles = 0, totalLots = 0;

      Object.values(stats).forEach(s => {
        totalCodes += s.total_codes || 0;
        totalUtilises += s.total_utilises || 0;
        totalDisponibles += s.total_disponibles || 0;
        totalLots += s.total_lots || 0;
      });

      document.getElementById('stats-cards').innerHTML = `
        <div class="col-md-3">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Lots crees</h6>
                <h3 class="mb-0">${totalLots}</h3>
              </div>
              <i class="bi bi-box-seam" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Codes reserves</h6>
                <h3 class="mb-0">${totalCodes}</h3>
              </div>
              <i class="bi bi-upc" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #FC466B 0%, #3F5EFB 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Utilises</h6>
                <h3 class="mb-0">${totalUtilises}</h3>
              </div>
              <i class="bi bi-check2-circle" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Disponibles</h6>
                <h3 class="mb-0">${totalDisponibles}</h3>
              </div>
              <i class="bi bi-stack" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
      `;

      document.getElementById('stats-table').innerHTML = MODULES.map(m => {
        const s = stats[m.id] || {};
        return `
          <tr>
            <td>
              <span class="module-icon ${m.colorClass} me-2" style="width: 32px; height: 32px; display: inline-flex;">
                <i class="bi ${m.icon}"></i>
              </span>
              ${m.label}
            </td>
            <td><code>${s.prefix || '-'}</code></td>
            <td>
              ${s.format_locked
                ? '<span class="badge bg-warning text-dark"><i class="bi bi-lock-fill me-1"></i>Oui</span>'
                : '<span class="badge bg-secondary">Non</span>'
              }
            </td>
            <td>${s.current_sequence || 0}</td>
            <td>${s.total_lots || 0}</td>
            <td>${s.total_codes || 0}</td>
            <td>${s.total_utilises || 0}</td>
            <td><span class="badge bg-success">${s.total_disponibles || 0}</span></td>
          </tr>
        `;
      }).join('');
    }

    // Gestion des onglets
    function initTabs() {
      document.querySelectorAll('[data-tab]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const tab = link.dataset.tab;

          document.querySelectorAll('[data-tab]').forEach(l => l.classList.remove('active'));
          link.classList.add('active');

          document.getElementById('tab-config').style.display = tab === 'config' ? 'block' : 'none';
          document.getElementById('tab-stats').style.display = tab === 'stats' ? 'block' : 'none';

          if (tab === 'stats') loadStats();
        });
      });
    }

    // Indicateur de sauvegarde
    function showSaveIndicator(status) {
      const indicator = document.getElementById('save-indicator');
      indicator.className = 'save-indicator ' + status;

      const icons = { saving: 'bi-hourglass-split', saved: 'bi-check-circle', error: 'bi-exclamation-triangle' };
      const texts = { saving: 'Sauvegarde...', saved: 'Enregistre !', error: 'Erreur' };

      indicator.innerHTML = `
        <i class="bi ${icons[status]}"></i>
        <span>${texts[status]}</span>
      `;

      if (status !== 'saving') {
        setTimeout(() => indicator.className = 'save-indicator', 3000);
      }
    }
  </script>
</body>
</html>
