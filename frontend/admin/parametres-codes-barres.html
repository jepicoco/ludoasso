<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codes-Barres Reserves - Parametres - Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    .module-card {
      border: 2px solid #dee2e6;
      border-radius: 0.75rem;
      transition: all 0.2s;
    }
    .module-card.locked {
      border-color: #ffc107;
    }
    .module-card.unsaved {
      border-color: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
    }
    .module-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }
    .module-icon.utilisateur { background: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    .module-icon.jeu { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .module-icon.livre { background: rgba(32, 201, 151, 0.1); color: #20c997; }
    .module-icon.film { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .module-icon.disque { background: rgba(232, 62, 140, 0.1); color: #e83e8c; }

    .token-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .token-item {
      padding: 0.2rem 0.6rem;
      border-radius: 0.375rem;
      background: #e9ecef;
      cursor: grab;
      font-size: 0.8rem;
      transition: all 0.2s;
      user-select: none;
    }
    .token-item:active {
      cursor: grabbing;
    }
    .token-item:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .token-item.prefix-token { background: #e9ecef; color: #495057; }
    .token-item.prefix-token:hover { background: #6c757d; color: white; }
    .token-item.date-token { background: #fff3cd; color: #664d03; }
    .token-item.date-token:hover { background: #ffc107; color: #000; }
    .token-item.seq-token { background: #cfe2ff; color: #084298; }
    .token-item.seq-token:hover { background: #0d6efd; color: white; }
    .token-item.dragging {
      opacity: 0.5;
      transform: scale(1.1);
    }

    .format-preview {
      font-family: monospace;
      font-size: 1.1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      text-align: center;
      border: 1px dashed #dee2e6;
    }
    .format-preview .code {
      font-weight: bold;
      letter-spacing: 1px;
    }

    .format-input {
      font-family: monospace;
      font-size: 0.9rem;
    }
    .format-input.drop-target {
      border-color: #0d6efd;
      background: rgba(13, 110, 253, 0.05);
    }

    .locked-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      background: #fff3cd;
      color: #664d03;
      border-radius: 0.25rem;
      font-size: 0.7rem;
    }

    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
    }
    .stats-card h3 {
      font-size: 2rem;
      font-weight: bold;
    }

    .sub-nav {
      background: #f8f9fa;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e9ecef;
      margin-bottom: 1.5rem;
    }

    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      z-index: 1050;
      display: none;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .save-indicator.saving { display: flex; background: #fff3cd; color: #856404; }
    .save-indicator.saved { display: flex; background: #d1e7dd; color: #0f5132; }
    .save-indicator.error { display: flex; background: #f8d7da; color: #842029; }

    .tokens-toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 1rem;
      margin: -1rem -1rem 1rem -1rem;
      border-bottom: 1px solid #e9ecef;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .module-config-form .form-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .module-config-form .form-control,
    .module-config-form .form-select {
      font-size: 0.85rem;
    }
    .module-config-form .form-text {
      font-size: 0.7rem;
    }

    .btn-save-module {
      transition: all 0.2s;
    }
    .btn-save-module:not(:disabled) {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(13, 110, 253, 0); }
    }
  </style>
</head>
<body>
  <!-- Navigation (genere par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (genere par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <div id="sub-nav-container"></div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="parametres.html">Parametres</a></li>
                <li class="breadcrumb-item active">Codes-Barres Reserves</li>
              </ol>
            </nav>
            <h1 class="h3 mb-0"><i class="bi bi-upc-scan me-2"></i>Codes-Barres Reserves</h1>
          </div>
          <a href="lots-codes-barres.html" class="btn btn-primary">
            <i class="bi bi-printer me-1"></i>Gerer les lots
          </a>
        </div>

        <!-- Selecteur de contexte -->
        <div class="card mb-4" id="context-selector-card">
          <div class="card-header py-2">
            <div class="d-flex align-items-center">
              <i class="bi bi-funnel me-2"></i>
              <strong>Charger la configuration</strong>
            </div>
          </div>
          <div class="card-body py-3">
            <div class="row g-3 align-items-end">
              <!-- Type de chargement -->
              <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Charger par</label>
                <select class="form-select" id="load-type-select">
                  <option value="organisation" selected>Organisation</option>
                  <option value="structure">Structure</option>
                  <option value="groupe">Groupe</option>
                </select>
              </div>

              <!-- Selecteur Organisation (visible par defaut) -->
              <div class="col-md-4" id="org-select-container">
                <label class="form-label small text-muted mb-1">Organisation</label>
                <select class="form-select" id="organisation-select">
                  <option value="">-- Choisir --</option>
                </select>
              </div>

              <!-- Selecteur Structure (cache par defaut) -->
              <div class="col-md-4" id="structure-select-container" style="display: none;">
                <label class="form-label small text-muted mb-1">Structure</label>
                <select class="form-select" id="structure-select">
                  <option value="">-- Choisir --</option>
                </select>
              </div>

              <!-- Selecteur Groupe (cache par defaut) -->
              <div class="col-md-4" id="groupe-select-container" style="display: none;">
                <label class="form-label small text-muted mb-1">Groupe</label>
                <select class="form-select" id="groupe-select">
                  <option value="">-- Choisir --</option>
                </select>
              </div>

              <!-- Info -->
              <div class="col-md-5">
                <div class="alert alert-light border py-2 mb-0 small" id="context-info">
                  <i class="bi bi-info-circle me-1"></i>
                  <span id="context-info-text">Selectionnez un type puis un element pour voir les modules concernes.</span>
                </div>
              </div>
            </div>

            <!-- Badge des modules concernes -->
            <div class="mt-3" id="modules-filter-info" style="display: none;">
              <span class="text-muted small me-2">Modules geres par ce contexte :</span>
              <span id="modules-badges"></span>
            </div>
          </div>
        </div>

        <!-- Configuration des modes de gestion par module -->
        <div id="gestion-mode-config" class="card mb-4" style="display: none;">
          <div class="card-header d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
              <i class="bi bi-diagram-3 me-2"></i>
              <strong>Mode de gestion par module</strong>
              <span class="text-muted ms-2 small" id="gestion-org-name"></span>
            </div>
            <button type="button" class="btn btn-sm btn-primary" id="btn-save-gestion" disabled>
              <i class="bi bi-check-lg me-1"></i>Enregistrer
            </button>
          </div>
          <div class="card-body">
            <p class="text-muted small mb-3">
              Pour chaque module, choisissez comment les codes-barres sont geres :
              <strong>Organisation</strong> (centralise),
              <strong>Structure</strong> (par site), ou
              <strong>Groupe</strong> (par portail public).
            </p>
            <div class="row g-3" id="gestion-modules-config">
              <!-- Genere par JS -->
            </div>
          </div>
        </div>

        <!-- Apercu de la configuration actuelle -->
        <div id="gestion-mode-preview" class="card mb-4" style="display: none;">
          <div class="card-header py-2">
            <div class="d-flex align-items-center">
              <i class="bi bi-eye me-2"></i>
              <strong>Apercu de la configuration</strong>
            </div>
          </div>
          <div class="card-body py-2">
            <div class="row g-2" id="gestion-modules-list">
              <!-- Genere par JS -->
            </div>
          </div>
        </div>

        <!-- Loading (cache par defaut, affiche lors du changement d'organisation) -->
        <div class="text-center py-5" id="loadingContainer" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-2 text-muted">Chargement des parametres...</p>
        </div>

        <!-- Contenu principal (cache pendant le chargement) -->
        <div id="mainContent" style="display: none;">
          <!-- Onglets -->
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="config">
              <i class="bi bi-sliders me-1"></i>Configuration
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-tab="stats">
              <i class="bi bi-bar-chart me-1"></i>Statistiques
            </a>
          </li>
        </ul>

        <!-- Contenu Configuration -->
        <div id="tab-config">
          <!-- Toolbar tokens (sticky) -->
          <div class="tokens-toolbar rounded">
            <h6 class="mb-2"><i class="bi bi-grip-vertical me-1"></i>Glissez les tokens dans les champs "Format"</h6>
            <div class="d-flex flex-wrap gap-3">
              <div>
                <small class="text-muted d-block mb-1">Prefix</small>
                <div class="token-list">
                  <span class="token-item prefix-token" draggable="true" data-token="{PREFIX}" title="Prefix du module">{PREFIX}</span>
                </div>
              </div>
              <div>
                <small class="text-muted d-block mb-1">Date</small>
                <div class="token-list" id="date-tokens"></div>
              </div>
              <div>
                <small class="text-muted d-block mb-1">Sequence</small>
                <div class="token-list" id="seq-tokens"></div>
              </div>
            </div>
          </div>

          <!-- Configuration par module -->
          <div class="row" id="modules-container">
            <!-- Genere par JS -->
          </div>
        </div>

        <!-- Contenu Statistiques -->
        <div id="tab-stats" style="display: none;">
          <div class="row mb-4" id="stats-cards">
            <!-- Genere par JS -->
          </div>

          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-table me-2"></i>Recapitulatif par module</h5>
            </div>
            <div class="card-body">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Module</th>
                    <th>Prefix</th>
                    <th>Format verrouille</th>
                    <th>Sequence courante</th>
                    <th>Lots</th>
                    <th>Codes totaux</th>
                    <th>Utilises</th>
                    <th>Disponibles</th>
                  </tr>
                </thead>
                <tbody id="stats-table">
                  <!-- Genere par JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        </div><!-- Fin mainContent -->
      </div>
    </div>
  </div>

  <!-- Indicateur de sauvegarde -->
  <div id="save-indicator" class="save-indicator">
    <span class="indicator-icon"></span>
    <span class="indicator-text"></span>
  </div>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script>
    const API_BASE = '/api/codes-barres-reserves';

    // Helper pour les appels API authentifies
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      };
    }

    async function apiGet(endpoint) {
      const response = await fetch(endpoint, { headers: getAuthHeaders() });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.message || `Erreur ${response.status}`);
      }
      return response.json();
    }

    async function apiPut(endpoint, data) {
      const response = await fetch(endpoint, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
      });
      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.message || `Erreur ${response.status}`);
      }
      return response.json();
    }

    const MODULES = [
      { id: 'utilisateur', label: 'Usagers', icon: 'bi-person-badge', colorClass: 'utilisateur', defaultPrefix: 'USA' },
      { id: 'jeu', label: 'Jeux', icon: 'bi-dice-5', colorClass: 'jeu', defaultPrefix: 'JEU' },
      { id: 'livre', label: 'Livres', icon: 'bi-book', colorClass: 'livre', defaultPrefix: 'LIV' },
      { id: 'film', label: 'Films', icon: 'bi-film', colorClass: 'film', defaultPrefix: 'FLM' },
      { id: 'disque', label: 'Disques', icon: 'bi-disc', colorClass: 'disque', defaultPrefix: 'DSQ' }
    ];

    let parametres = {};
    let stats = {};
    let tokens = [];
    let originalValues = {}; // Pour tracker les changements

    // Donnees pour la gestion des organisations
    let organisations = [];
    let structures = [];
    let barcodeGroups = []; // Groupes de codes-barres globaux
    let barcodeConfig = {}; // Config par module (pour l'org selectionnee)
    let selectedOrganisation = null;
    let barcodeConfigOriginal = {};

    // Contexte de chargement actuel
    let currentLoadType = 'organisation'; // organisation | structure | groupe
    let currentContextId = null;
    let currentContextName = '';
    let filteredModules = []; // Modules filtres selon le contexte

    /**
     * Genere les query params pour le contexte actuel
     * Retourne les params selon le module et sa config de gestion
     */
    function getContextQueryParams(moduleId) {
      if (!selectedOrganisation || !barcodeConfig[moduleId]) return '';

      const config = barcodeConfig[moduleId];
      const type = config.type_gestion;

      if (type === 'organisation') {
        return `?organisation_id=${selectedOrganisation.id}`;
      } else if (type === 'structure' && currentLoadType === 'structure' && currentContextId) {
        return `?structure_id=${currentContextId}`;
      } else if (type === 'groupe' && config.groupe_id) {
        return `?groupe_id=${config.groupe_id}`;
      }

      // Fallback : organisation
      return `?organisation_id=${selectedOrganisation.id}`;
    }

    /**
     * Genere les query params pour tous les modules du contexte actuel
     */
    function getContextQueryParamsForAll() {
      if (!selectedOrganisation) return '';

      if (currentLoadType === 'organisation') {
        return `?organisation_id=${selectedOrganisation.id}`;
      } else if (currentLoadType === 'structure' && currentContextId) {
        return `?structure_id=${currentContextId}`;
      } else if (currentLoadType === 'groupe' && currentContextId) {
        return `?groupe_id=${currentContextId}`;
      }

      return '';
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', async () => {
      await initTemplate('parametres');

      // Verifier que l'utilisateur est admin
      const userRole = localStorage.getItem('userRole');
      if (userRole !== 'administrateur') {
        window.location.replace('/admin/parametres.html#outils');
        return;
      }

      renderSubNav('configuration', 'codes-barres');

      // Charger les donnees initiales
      await loadInitialData();

      // Evenements
      document.getElementById('load-type-select').addEventListener('change', onLoadTypeChange);
      document.getElementById('organisation-select').addEventListener('change', onOrganisationChange);
      document.getElementById('structure-select').addEventListener('change', onStructureChange);
      document.getElementById('groupe-select').addEventListener('change', onGroupeChange);
      document.getElementById('btn-save-gestion').addEventListener('click', saveGestionConfig);
    });

    /**
     * Charge les donnees initiales (organisations, structures, groupes)
     */
    async function loadInitialData() {
      try {
        const [orgsResponse, structuresResponse, groupsResponse] = await Promise.all([
          apiGet('/api/organisations'),
          apiGet('/api/structures'),
          apiGet('/api/organisations/barcode-groups')
        ]);

        organisations = Array.isArray(orgsResponse) ? orgsResponse : [];
        structures = Array.isArray(structuresResponse) ? structuresResponse : [];
        barcodeGroups = Array.isArray(groupsResponse) ? groupsResponse : [];

        // Remplir les selects
        populateOrganisationSelect();
        populateStructureSelect();
        populateGroupeSelect();

        // Si une seule organisation, la selectionner automatiquement
        if (organisations.length === 1) {
          document.getElementById('organisation-select').value = organisations[0].id;
          setTimeout(() => onOrganisationChange(), 100);
        }

      } catch (error) {
        console.error('Erreur chargement donnees initiales:', error);
        alert('Erreur lors du chargement des donnees');
      }
    }

    function populateOrganisationSelect() {
      const select = document.getElementById('organisation-select');
      select.innerHTML = '<option value="">-- Choisir --</option>';
      organisations.forEach(org => {
        const option = document.createElement('option');
        option.value = org.id;
        option.textContent = org.nom;
        select.appendChild(option);
      });
    }

    function populateStructureSelect() {
      const select = document.getElementById('structure-select');
      select.innerHTML = '<option value="">-- Choisir --</option>';
      structures.forEach(struct => {
        const option = document.createElement('option');
        option.value = struct.id;
        option.textContent = `${struct.nom} (${struct.code})`;
        select.appendChild(option);
      });
    }

    function populateGroupeSelect() {
      const select = document.getElementById('groupe-select');
      select.innerHTML = '<option value="">-- Choisir --</option>';
      barcodeGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.code;
        select.appendChild(option);
      });
    }

    /**
     * Quand le type de chargement change
     */
    function onLoadTypeChange() {
      const loadType = document.getElementById('load-type-select').value;
      currentLoadType = loadType;

      // Masquer tous les selecteurs
      document.getElementById('org-select-container').style.display = 'none';
      document.getElementById('structure-select-container').style.display = 'none';
      document.getElementById('groupe-select-container').style.display = 'none';

      // Afficher le bon selecteur
      if (loadType === 'organisation') {
        document.getElementById('org-select-container').style.display = 'block';
      } else if (loadType === 'structure') {
        document.getElementById('structure-select-container').style.display = 'block';
      } else if (loadType === 'groupe') {
        document.getElementById('groupe-select-container').style.display = 'block';
      }

      // Reinitialiser
      resetContext();
    }

    function resetContext() {
      currentContextId = null;
      currentContextName = '';
      filteredModules = [];

      document.getElementById('modules-filter-info').style.display = 'none';
      document.getElementById('gestion-mode-config').style.display = 'none';
      document.getElementById('gestion-mode-preview').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';

      updateContextInfo('Selectionnez un element pour voir les modules concernes.');
    }

    function updateContextInfo(text) {
      document.getElementById('context-info-text').textContent = text;
    }

    /**
     * Charge les groupes et config d'une organisation
     */
    async function loadBarcodeData(orgId) {
      const configResponse = await apiGet(`/api/organisations/${orgId}/barcode-config`);
      barcodeConfig = configResponse || {};
      barcodeConfigOriginal = JSON.parse(JSON.stringify(barcodeConfig));
    }

    /**
     * Filtre les modules selon le contexte
     */
    function filterModulesByContext(loadType, contextId) {
      if (!barcodeConfig || !selectedOrganisation) return [];

      const filtered = [];

      MODULES.forEach(module => {
        const config = barcodeConfig[module.id];
        if (!config) return;

        if (loadType === 'organisation' && config.type_gestion === 'organisation') {
          filtered.push(module.id);
        } else if (loadType === 'structure' && config.type_gestion === 'structure') {
          filtered.push(module.id);
        } else if (loadType === 'groupe' && config.type_gestion === 'groupe' && config.groupe_id == contextId) {
          filtered.push(module.id);
        }
      });

      return filtered;
    }

    /**
     * Affiche les badges des modules filtres
     */
    function renderModulesBadges() {
      const container = document.getElementById('modules-badges');
      const info = document.getElementById('modules-filter-info');

      if (filteredModules.length === 0) {
        info.style.display = 'none';
        return;
      }

      info.style.display = 'block';

      const moduleColors = {
        utilisateur: 'primary',
        jeu: 'purple',
        livre: 'success',
        film: 'warning',
        disque: 'danger'
      };

      container.innerHTML = filteredModules.map(modId => {
        const mod = MODULES.find(m => m.id === modId);
        const color = moduleColors[modId] || 'secondary';
        return `<span class="badge bg-${color} me-1"><i class="bi ${mod.icon} me-1"></i>${mod.label}</span>`;
      }).join('');
    }

    /**
     * Quand une organisation est selectionnee
     */
    let isLoading = false;

    async function onOrganisationChange() {
      if (isLoading) return;

      const select = document.getElementById('organisation-select');
      const orgId = select.value;

      if (!orgId) {
        resetContext();
        return;
      }

      selectedOrganisation = organisations.find(o => o.id == orgId);
      if (!selectedOrganisation) return;

      currentContextId = orgId;
      currentContextName = selectedOrganisation.nom;

      await loadContextData('organisation', orgId);
    }

    /**
     * Quand une structure est selectionnee
     */
    async function onStructureChange() {
      if (isLoading) return;

      const select = document.getElementById('structure-select');
      const structId = select.value;

      if (!structId) {
        resetContext();
        return;
      }

      const struct = structures.find(s => s.id == structId);
      if (!struct) return;

      // Trouver l'organisation parente
      selectedOrganisation = organisations.find(o => o.id == struct.organisation_id);
      if (!selectedOrganisation) {
        updateContextInfo('Structure sans organisation parente');
        return;
      }

      currentContextId = structId;
      currentContextName = struct.nom;

      await loadContextData('structure', structId);
    }

    /**
     * Quand un groupe est selectionne
     */
    async function onGroupeChange() {
      if (isLoading) return;

      const select = document.getElementById('groupe-select');
      const groupeId = select.value;

      if (!groupeId) {
        resetContext();
        return;
      }

      const groupe = barcodeGroups.find(g => g.id == groupeId);
      if (!groupe) return;

      currentContextId = groupeId;
      currentContextName = groupe.code;

      // Pour les groupes, on doit trouver quelle organisation l'utilise
      // On va charger la config de chaque organisation pour trouver les modules
      await loadContextDataForGroupe(groupeId, groupe.code);
    }

    /**
     * Charge les donnees pour un contexte organisation ou structure
     */
    async function loadContextData(loadType, contextId) {
      isLoading = true;
      const loadingContainer = document.getElementById('loadingContainer');
      const mainContent = document.getElementById('mainContent');
      const configCard = document.getElementById('gestion-mode-config');
      const previewCard = document.getElementById('gestion-mode-preview');

      loadingContainer.style.display = 'block';
      mainContent.style.display = 'none';

      try {
        // Pour structure, on charge la config de son organisation parente
        const orgId = loadType === 'structure'
          ? structures.find(s => s.id == contextId)?.organisation_id
          : contextId;

        if (!orgId) throw new Error('Organisation non trouvee');

        selectedOrganisation = organisations.find(o => o.id == orgId);
        await loadBarcodeData(orgId);

        // Filtrer les modules
        filteredModules = filterModulesByContext(loadType, contextId);

        if (filteredModules.length === 0) {
          updateContextInfo(`Aucun module n'est gere par ${loadType === 'organisation' ? 'organisation' : 'structure'} pour "${currentContextName}".`);
          loadingContainer.style.display = 'none';
          renderModulesBadges();
          return;
        }

        updateContextInfo(`${filteredModules.length} module(s) gere(s) par ${loadType} pour "${currentContextName}".`);
        renderModulesBadges();

        // Afficher le nom de l'organisation
        document.getElementById('gestion-org-name').textContent = `(${selectedOrganisation.nom})`;

        // Afficher le formulaire de configuration (uniquement pour type organisation)
        if (loadType === 'organisation') {
          renderGestionConfigForm();
          configCard.style.display = 'block';
          renderGestionPreview();
          previewCard.style.display = 'block';
        } else {
          configCard.style.display = 'none';
          previewCard.style.display = 'none';
        }

        // Charger les donnees des codes-barres
        await loadTokens();
        await loadParametres();
        await loadStats();
        initTabs();
        initModuleCards(); // Filtre integre
        initDragAndDrop();

        loadingContainer.style.display = 'none';
        mainContent.style.display = 'block';

      } catch (error) {
        console.error('Erreur chargement contexte:', error);
        loadingContainer.style.display = 'none';
        updateContextInfo('Erreur lors du chargement.');
      } finally {
        isLoading = false;
      }
    }

    /**
     * Charge les donnees pour un groupe (doit trouver quelles orgs l'utilisent)
     */
    async function loadContextDataForGroupe(groupeId, groupeCode) {
      isLoading = true;
      const loadingContainer = document.getElementById('loadingContainer');
      const mainContent = document.getElementById('mainContent');
      const configCard = document.getElementById('gestion-mode-config');
      const previewCard = document.getElementById('gestion-mode-preview');

      loadingContainer.style.display = 'block';
      mainContent.style.display = 'none';
      configCard.style.display = 'none';
      previewCard.style.display = 'none';

      try {
        // Trouver les organisations qui utilisent ce groupe
        let foundOrg = null;
        filteredModules = [];

        for (const org of organisations) {
          const configResponse = await apiGet(`/api/organisations/${org.id}/barcode-config`);

          MODULES.forEach(module => {
            const config = configResponse[module.id];
            if (config && config.type_gestion === 'groupe' && config.groupe_id == groupeId) {
              if (!foundOrg) foundOrg = org;
              if (!filteredModules.includes(module.id)) {
                filteredModules.push(module.id);
              }
            }
          });

          if (foundOrg) {
            barcodeConfig = configResponse;
            break;
          }
        }

        if (!foundOrg || filteredModules.length === 0) {
          updateContextInfo(`Le groupe "${groupeCode}" n'est utilise par aucun module.`);
          loadingContainer.style.display = 'none';
          renderModulesBadges();
          return;
        }

        selectedOrganisation = foundOrg;
        barcodeConfigOriginal = JSON.parse(JSON.stringify(barcodeConfig));

        updateContextInfo(`${filteredModules.length} module(s) gere(s) par le groupe "${groupeCode}" (${foundOrg.nom}).`);
        renderModulesBadges();

        document.getElementById('gestion-org-name').textContent = `(${selectedOrganisation.nom})`;

        // Charger les donnees des codes-barres
        await loadTokens();
        await loadParametres();
        await loadStats();
        initTabs();
        initModuleCards(); // Filtre integre
        initDragAndDrop();

        loadingContainer.style.display = 'none';
        mainContent.style.display = 'block';

      } catch (error) {
        console.error('Erreur chargement groupe:', error);
        loadingContainer.style.display = 'none';
        updateContextInfo('Erreur lors du chargement.');
      } finally {
        isLoading = false;
      }
    }

    /**
     * Affiche le formulaire de configuration des modes de gestion
     */
    function renderGestionConfigForm() {
      const container = document.getElementById('gestion-modules-config');

      container.innerHTML = MODULES.map(module => {
        const config = barcodeConfig[module.id] || { type_gestion: 'organisation', groupe_id: null };
        const mode = config.type_gestion;
        const selectedGroupId = config.groupe_id;

        return `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <div class="module-icon ${module.colorClass} me-2">
                    <i class="bi ${module.icon}"></i>
                  </div>
                  <h6 class="mb-0">${module.label}</h6>
                </div>

                <div class="mb-2">
                  <label class="form-label small">Mode de gestion</label>
                  <select class="form-select form-select-sm gestion-mode-select" data-module="${module.id}">
                    <option value="organisation" ${mode === 'organisation' ? 'selected' : ''}>Organisation (centralise)</option>
                    <option value="structure" ${mode === 'structure' ? 'selected' : ''}>Structure (par site)</option>
                    <option value="groupe" ${mode === 'groupe' ? 'selected' : ''}>Groupe</option>
                  </select>
                </div>

                <div class="groupe-select-container" data-module="${module.id}" style="display: ${mode === 'groupe' ? 'block' : 'none'};">
                  <label class="form-label small">Groupe</label>
                  <div class="input-group input-group-sm">
                    <select class="form-select form-select-sm groupe-select" data-module="${module.id}">
                      <option value="">-- Choisir un groupe --</option>
                      ${barcodeGroups.map(g => `
                        <option value="${g.id}" ${selectedGroupId == g.id ? 'selected' : ''}>${g.code}</option>
                      `).join('')}
                    </select>
                    <button type="button" class="btn btn-outline-secondary btn-add-group" data-module="${module.id}" title="Ajouter un groupe">
                      <i class="bi bi-plus-lg"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Ajouter les evenements
      container.querySelectorAll('.gestion-mode-select').forEach(select => {
        select.addEventListener('change', onGestionModeChange);
      });

      container.querySelectorAll('.groupe-select').forEach(select => {
        select.addEventListener('change', onGroupeSelectChange);
      });

      container.querySelectorAll('.btn-add-group').forEach(btn => {
        btn.addEventListener('click', onAddGroupClick);
      });

      updateSaveButton();
    }

    /**
     * Ajouter un groupe a la volee
     */
    async function onAddGroupClick(e) {
      const moduleId = e.currentTarget.dataset.module;
      const code = prompt('Entrez le code du nouveau groupe (ex: ZIK1, FILF):');

      if (!code || code.trim() === '') return;

      try {
        const response = await fetch(`/api/organisations/${selectedOrganisation.id}/barcode-groups`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ code: code.trim() })
        });

        if (!response.ok) {
          const err = await response.json();
          alert(err.error || 'Erreur lors de la creation du groupe');
          return;
        }

        const newGroup = await response.json();
        barcodeGroups.push(newGroup);

        // Mettre a jour tous les selects de groupes
        document.querySelectorAll('.groupe-select').forEach(select => {
          const option = document.createElement('option');
          option.value = newGroup.id;
          option.textContent = newGroup.code;
          select.appendChild(option);
        });

        // Selectionner le nouveau groupe dans le module concerne
        const targetSelect = document.querySelector(`.groupe-select[data-module="${moduleId}"]`);
        if (targetSelect) {
          targetSelect.value = newGroup.id;
          onGroupeSelectChange({ target: targetSelect });
        }

      } catch (error) {
        console.error('Erreur creation groupe:', error);
        alert('Erreur lors de la creation du groupe');
      }
    }

    /**
     * Quand le mode de gestion change pour un module
     */
    function onGestionModeChange(e) {
      const moduleId = e.target.dataset.module;
      const mode = e.target.value;

      // Afficher/masquer le select des groupes
      const groupeContainer = document.querySelector(`.groupe-select-container[data-module="${moduleId}"]`);
      groupeContainer.style.display = mode === 'groupe' ? 'block' : 'none';

      // Mettre a jour la config
      updateGestionConfig();
    }

    /**
     * Quand la selection de groupes change
     */
    function onGroupeSelectChange(e) {
      updateGestionConfig();
    }

    /**
     * Met a jour la configuration en memoire
     */
    function updateGestionConfig() {
      if (!selectedOrganisation) return;

      MODULES.forEach(module => {
        const modeSelect = document.querySelector(`.gestion-mode-select[data-module="${module.id}"]`);
        const groupeSelect = document.querySelector(`.groupe-select[data-module="${module.id}"]`);

        const mode = modeSelect.value;
        const groupeId = groupeSelect?.value ? parseInt(groupeSelect.value) : null;

        barcodeConfig[module.id] = {
          type_gestion: mode,
          groupe_id: mode === 'groupe' ? groupeId : null,
          groupe_code: mode === 'groupe' && groupeId ? barcodeGroups.find(g => g.id == groupeId)?.code : null
        };
      });

      // Mettre a jour l'apercu
      renderGestionPreview();
      updateSaveButton();
    }

    /**
     * Met a jour le bouton de sauvegarde
     */
    function updateSaveButton() {
      const btn = document.getElementById('btn-save-gestion');
      const currentConfig = JSON.stringify(barcodeConfig);
      const originalConfig = JSON.stringify(barcodeConfigOriginal);

      btn.disabled = currentConfig === originalConfig;
    }

    /**
     * Sauvegarde la configuration de gestion
     */
    async function saveGestionConfig() {
      if (!selectedOrganisation) return;

      const btn = document.getElementById('btn-save-gestion');
      const originalHtml = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enregistrement...';

        await apiPut(`/api/organisations/${selectedOrganisation.id}/barcode-config`, barcodeConfig);

        // Mettre a jour l'original
        barcodeConfigOriginal = JSON.parse(JSON.stringify(barcodeConfig));

        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Enregistre !';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        setTimeout(() => {
          btn.innerHTML = originalHtml;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-primary');
          updateSaveButton();
        }, 2000);

      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        alert('Erreur lors de la sauvegarde: ' + error.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
      }
    }

    /**
     * Affiche l'apercu de la configuration actuelle
     */
    function renderGestionPreview() {
      const container = document.getElementById('gestion-modules-list');

      container.innerHTML = MODULES.map(module => {
        const config = barcodeConfig[module.id] || { type_gestion: 'organisation' };
        const mode = config.type_gestion;
        const groupeCode = config.groupe_code;

        let badgeClass, badgeIcon, badgeText;

        if (mode === 'organisation') {
          badgeClass = 'bg-primary';
          badgeIcon = 'bi-building-gear';
          badgeText = 'Organisation';
        } else if (mode === 'structure') {
          badgeClass = 'bg-secondary';
          badgeIcon = 'bi-diagram-3';
          badgeText = 'Structure';
        } else {
          badgeClass = 'bg-success';
          badgeIcon = 'bi-link-45deg';
          badgeText = groupeCode || '(aucun)';
        }

        // Couleurs par module
        const moduleColors = {
          utilisateur: '#0d6efd',
          jeu: '#6f42c1',
          livre: '#20c997',
          film: '#fd7e14',
          disque: '#e83e8c'
        };

        return `
          <div class="col-auto">
            <div class="d-flex align-items-center gap-2 px-2 py-1 rounded" style="background: rgba(0,0,0,0.03);">
              <i class="bi ${module.icon}" style="color: ${moduleColors[module.id]};"></i>
              <span class="small">${module.label}:</span>
              <span class="badge ${badgeClass} small">
                <i class="bi ${badgeIcon} me-1"></i>${badgeText}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Charger les tokens
    async function loadTokens() {
      try {
        const response = await apiGet(`${API_BASE}/tokens`);
        if (response.success) {
          tokens = response.tokens;
          renderTokens();
        }
      } catch (error) {
        console.error('Erreur chargement tokens:', error);
      }
    }

    // Afficher les tokens
    function renderTokens() {
      const dateTokensEl = document.getElementById('date-tokens');
      const seqTokensEl = document.getElementById('seq-tokens');

      const dateTokens = tokens.filter(t => t.key.includes('ANNEE') || t.key.includes('MOIS') || t.key.includes('JOUR'));
      const seqTokens = tokens.filter(t => t.key.includes('SEQUENCE'));

      dateTokensEl.innerHTML = dateTokens.map(t => `
        <span class="token-item date-token" draggable="true" data-token="${t.token}" title="${t.description} (ex: ${t.example})">
          ${t.token}
        </span>
      `).join('');

      seqTokensEl.innerHTML = seqTokens.map(t => `
        <span class="token-item seq-token" draggable="true" data-token="${t.token}" title="${t.description} (ex: ${t.example})">
          ${t.token}
        </span>
      `).join('');
    }

    // Initialiser le drag & drop
    function initDragAndDrop() {
      // Deleguer les events sur le document pour les tokens
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('token-item')) {
          e.target.classList.add('dragging');
          e.dataTransfer.setData('text/plain', e.target.dataset.token);
          e.dataTransfer.effectAllowed = 'copy';
        }
      });

      document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('token-item')) {
          e.target.classList.remove('dragging');
        }
      });

      // Drop sur les champs format
      document.addEventListener('dragover', (e) => {
        if (e.target.classList.contains('format-input')) {
          e.preventDefault();
          e.target.classList.add('drop-target');
        }
      });

      document.addEventListener('dragleave', (e) => {
        if (e.target.classList.contains('format-input')) {
          e.target.classList.remove('drop-target');
        }
      });

      document.addEventListener('drop', (e) => {
        if (e.target.classList.contains('format-input')) {
          e.preventDefault();
          e.target.classList.remove('drop-target');

          const token = e.dataTransfer.getData('text/plain');
          const input = e.target;

          // Inserer a la position du curseur ou a la fin
          const start = input.selectionStart || input.value.length;
          const end = input.selectionEnd || input.value.length;
          const before = input.value.substring(0, start);
          const after = input.value.substring(end);

          input.value = before + token + after;
          input.focus();
          input.setSelectionRange(start + token.length, start + token.length);

          // Declencher l'evenement input pour la mise a jour de l'apercu
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
    }

    // Charger les parametres selon le contexte
    async function loadParametres() {
      try {
        // Pour chaque module filtre, charger ses parametres avec le bon contexte
        parametres = {};

        for (const moduleId of filteredModules) {
          const queryParams = getContextQueryParams(moduleId);
          const response = await apiGet(`${API_BASE}/parametres/${moduleId}${queryParams}`);
          if (response.success) {
            parametres[moduleId] = response.parametres;
          }
        }

        // Stocker les valeurs originales
        originalValues = JSON.parse(JSON.stringify(parametres));
      } catch (error) {
        console.error('Erreur chargement parametres:', error);
        showToast('Erreur lors du chargement des parametres', 'error')
      }
    }

    // Charger les stats
    async function loadStats() {
      try {
        const response = await apiGet(`${API_BASE}/stats`);
        if (response.success) {
          stats = response.stats;
          renderStats();
        }
      } catch (error) {
        console.error('Erreur chargement stats:', error);
      }
    }

    // Afficher les cartes modules avec formulaires integres
    function initModuleCards() {
      const container = document.getElementById('modules-container');

      // Filtrer les modules selon le contexte actuel
      const modulesToShow = filteredModules.length > 0
        ? MODULES.filter(m => filteredModules.includes(m.id))
        : MODULES;

      if (modulesToShow.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <p class="text-muted mt-3">Aucun module a configurer pour ce contexte.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = modulesToShow.map(m => {
        const p = parametres[m.id] || {};
        const locked = p.format_locked;
        const lockedClass = locked ? 'locked' : '';

        return `
          <div class="col-lg-6 mb-4">
            <div class="module-card card ${lockedClass}" id="card-${m.id}">
              <div class="card-header d-flex align-items-center">
                <div class="module-icon ${m.colorClass} me-3">
                  <i class="bi ${m.icon}"></i>
                </div>
                <div class="flex-grow-1">
                  <h5 class="mb-0">${m.label}</h5>
                  <small class="text-muted">Module ${m.id}</small>
                </div>
                ${locked ? '<span class="locked-badge"><i class="bi bi-lock-fill"></i>Format verrouille</span>' : ''}
              </div>
              <div class="card-body module-config-form">
                ${locked ? `
                  <div class="alert alert-warning py-2 mb-3">
                    <small><i class="bi bi-info-circle me-1"></i>Ce format a deja ete utilise. Seule l'option "griller les annules" peut etre modifiee.</small>
                  </div>
                ` : ''}

                <div class="row g-3">
                  <div class="col-4">
                    <label class="form-label">Prefix</label>
                    <input type="text" class="form-control" id="prefix-${m.id}"
                           value="${p.prefix || m.defaultPrefix}" maxlength="10"
                           ${locked ? 'disabled' : ''}
                           onchange="markUnsaved('${m.id}')" oninput="updateModulePreview('${m.id}')">
                  </div>
                  <div class="col-8">
                    <label class="form-label">Reset sequence</label>
                    <select class="form-select" id="reset-${m.id}" ${locked ? 'disabled' : ''}
                            onchange="markUnsaved('${m.id}'); updateModulePreview('${m.id}')">
                      <option value="never" ${(p.sequence_reset || 'never') === 'never' ? 'selected' : ''}>Jamais</option>
                      <option value="yearly" ${p.sequence_reset === 'yearly' ? 'selected' : ''}>Annuel</option>
                      <option value="monthly" ${p.sequence_reset === 'monthly' ? 'selected' : ''}>Mensuel</option>
                      <option value="daily" ${p.sequence_reset === 'daily' ? 'selected' : ''}>Journalier</option>
                    </select>
                  </div>
                </div>

                <div class="mt-3">
                  <label class="form-label">Format <small class="text-muted">(glissez les tokens ici)</small></label>
                  <input type="text" class="form-control format-input" id="pattern-${m.id}"
                         value="${p.format_pattern || '{PREFIX}{NUMERO_SEQUENCE_8}'}"
                         ${locked ? 'disabled' : ''}
                         oninput="markUnsaved('${m.id}'); updateModulePreview('${m.id}')"
                         placeholder="Ex: {PREFIX}{ANNEE_COURTE}{NUMERO_SEQUENCE_6}">
                </div>

                <div class="mt-3">
                  <label class="form-label">Apercu</label>
                  <div class="format-preview">
                    <span class="code" id="preview-${m.id}">${generatePreview(p, m.defaultPrefix)}</span>
                  </div>
                </div>

                <div class="mt-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="griller-${m.id}"
                           ${p.griller_annules ? 'checked' : ''} onchange="markUnsaved('${m.id}')">
                    <label class="form-check-label small" for="griller-${m.id}">
                      Griller les codes annules (ne pourront plus etre reutilises)
                    </label>
                  </div>
                </div>

                <div class="mt-3 d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    Seq. actuelle: <strong>${p.current_sequence || 0}</strong>
                    ${p.current_period ? `| Periode: <strong>${p.current_period}</strong>` : ''}
                  </small>
                  <button class="btn btn-primary btn-sm btn-save-module" id="save-${m.id}"
                          onclick="saveModule('${m.id}')" disabled>
                    <i class="bi bi-check-lg me-1"></i>Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Marquer une carte comme modifiee
    function markUnsaved(moduleId) {
      const card = document.getElementById(`card-${moduleId}`);
      const btn = document.getElementById(`save-${moduleId}`);

      const p = parametres[moduleId] || {};
      const current = {
        prefix: document.getElementById(`prefix-${moduleId}`).value,
        format_pattern: document.getElementById(`pattern-${moduleId}`).value,
        sequence_reset: document.getElementById(`reset-${moduleId}`).value,
        griller_annules: document.getElementById(`griller-${moduleId}`).checked
      };

      const orig = originalValues[moduleId] || {};
      const hasChanges =
        current.prefix !== (orig.prefix || MODULES.find(m => m.id === moduleId).defaultPrefix) ||
        current.format_pattern !== (orig.format_pattern || '{PREFIX}{NUMERO_SEQUENCE_8}') ||
        current.sequence_reset !== (orig.sequence_reset || 'never') ||
        current.griller_annules !== (orig.griller_annules || false);

      if (hasChanges) {
        card.classList.add('unsaved');
        btn.disabled = false;
      } else {
        card.classList.remove('unsaved');
        btn.disabled = true;
      }
    }

    // Mettre a jour l'apercu d'un module
    function updateModulePreview(moduleId) {
      const m = MODULES.find(mod => mod.id === moduleId);
      const params = {
        prefix: document.getElementById(`prefix-${moduleId}`).value,
        format_pattern: document.getElementById(`pattern-${moduleId}`).value,
        sequence_reset: document.getElementById(`reset-${moduleId}`).value
      };
      document.getElementById(`preview-${moduleId}`).textContent = generatePreview(params, m.defaultPrefix);
    }

    // Generer un apercu de code
    function generatePreview(params, defaultPrefix = 'XXX') {
      if (!params.format_pattern) return `${defaultPrefix}00000042`;

      let code = params.format_pattern;
      const now = new Date();

      code = code.replace('{PREFIX}', params.prefix || defaultPrefix);
      code = code.replace('{ANNEE_LONGUE}', now.getFullYear().toString());
      code = code.replace('{ANNEE_COURTE}', now.getFullYear().toString().slice(-2));
      code = code.replace('{MOIS_LONG}', String(now.getMonth() + 1).padStart(2, '0'));
      code = code.replace('{MOIS_COURT}', String(now.getMonth() + 1));
      code = code.replace('{JOUR_LONG}', String(now.getDate()).padStart(2, '0'));
      code = code.replace('{JOUR_COURT}', String(now.getDate()));
      code = code.replace('{NUMERO_SEQUENCE_4}', '0042');
      code = code.replace('{NUMERO_SEQUENCE_6}', '000042');
      code = code.replace('{NUMERO_SEQUENCE_8}', '00000042');
      code = code.replace('{NUMERO_SEQUENCE_10}', '0000000042');

      return code;
    }

    // Sauvegarder un module avec son contexte
    async function saveModule(moduleId) {
      const data = {
        prefix: document.getElementById(`prefix-${moduleId}`).value,
        format_pattern: document.getElementById(`pattern-${moduleId}`).value,
        sequence_reset: document.getElementById(`reset-${moduleId}`).value,
        griller_annules: document.getElementById(`griller-${moduleId}`).checked
      };

      const btn = document.getElementById(`save-${moduleId}`);
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>...';
      btn.disabled = true;

      showSaveIndicator('saving');

      try {
        // Ajouter les query params du contexte
        const queryParams = getContextQueryParams(moduleId);
        const response = await apiPut(`${API_BASE}/parametres/${moduleId}${queryParams}`, data);

        if (response.success) {
          parametres[moduleId] = response.parametres;
          originalValues[moduleId] = JSON.parse(JSON.stringify(response.parametres));

          // Recharger la carte si le format est maintenant verrouille
          initModuleCards();
          showSaveIndicator('saved');
        } else {
          throw new Error(response.message);
        }
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        showSaveIndicator('error');
        showToast(error.message || 'Erreur lors de la sauvegarde', 'success')
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Afficher les stats
    function renderStats() {
      // Filtrer les stats selon les modules filtres
      const modulesToShow = filteredModules.length > 0
        ? MODULES.filter(m => filteredModules.includes(m.id))
        : MODULES;

      let totalCodes = 0, totalUtilises = 0, totalDisponibles = 0, totalLots = 0;

      modulesToShow.forEach(m => {
        const s = stats[m.id] || {};
        totalCodes += s.total_codes || 0;
        totalUtilises += s.total_utilises || 0;
        totalDisponibles += s.total_disponibles || 0;
        totalLots += s.total_lots || 0;
      });

      document.getElementById('stats-cards').innerHTML = `
        <div class="col-md-3">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Lots crees</h6>
                <h3 class="mb-0">${totalLots}</h3>
              </div>
              <i class="bi bi-box-seam" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Codes reserves</h6>
                <h3 class="mb-0">${totalCodes}</h3>
              </div>
              <i class="bi bi-upc" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #FC466B 0%, #3F5EFB 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Utilises</h6>
                <h3 class="mb-0">${totalUtilises}</h3>
              </div>
              <i class="bi bi-check2-circle" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white-50 mb-1">Disponibles</h6>
                <h3 class="mb-0">${totalDisponibles}</h3>
              </div>
              <i class="bi bi-stack" style="font-size: 2rem; opacity: 0.5;"></i>
            </div>
          </div>
        </div>
      `;

      document.getElementById('stats-table').innerHTML = modulesToShow.map(m => {
        const s = stats[m.id] || {};
        return `
          <tr>
            <td>
              <span class="module-icon ${m.colorClass} me-2" style="width: 32px; height: 32px; display: inline-flex;">
                <i class="bi ${m.icon}"></i>
              </span>
              ${m.label}
            </td>
            <td><code>${s.prefix || '-'}</code></td>
            <td>
              ${s.format_locked
                ? '<span class="badge bg-warning text-dark"><i class="bi bi-lock-fill me-1"></i>Oui</span>'
                : '<span class="badge bg-secondary">Non</span>'
              }
            </td>
            <td>${s.current_sequence || 0}</td>
            <td>${s.total_lots || 0}</td>
            <td>${s.total_codes || 0}</td>
            <td>${s.total_utilises || 0}</td>
            <td><span class="badge bg-success">${s.total_disponibles || 0}</span></td>
          </tr>
        `;
      }).join('');
    }

    // Gestion des onglets
    function initTabs() {
      document.querySelectorAll('[data-tab]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const tab = link.dataset.tab;

          document.querySelectorAll('[data-tab]').forEach(l => l.classList.remove('active'));
          link.classList.add('active');

          document.getElementById('tab-config').style.display = tab === 'config' ? 'block' : 'none';
          document.getElementById('tab-stats').style.display = tab === 'stats' ? 'block' : 'none';

          if (tab === 'stats') loadStats();
        });
      });
    }

    // Indicateur de sauvegarde
    function showSaveIndicator(status) {
      const indicator = document.getElementById('save-indicator');
      indicator.className = 'save-indicator ' + status;

      const icons = { saving: 'bi-hourglass-split', saved: 'bi-check-circle', error: 'bi-exclamation-triangle' };
      const texts = { saving: 'Sauvegarde...', saved: 'Enregistre !', error: 'Erreur' };

      indicator.innerHTML = `
        <i class="bi ${icons[status]}"></i>
        <span>${texts[status]}</span>
      `;

      if (status !== 'saving') {
        setTimeout(() => indicator.className = 'save-indicator', 3000);
      }
    }
  </script>
</body>
</html>
