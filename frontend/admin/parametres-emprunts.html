<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emprunts & Prolongations - Parametres - Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .module-card {
      border: 2px solid #dee2e6;
      border-radius: 0.75rem;
      transition: all 0.2s;
      height: 100%;
    }
    .module-card.active {
      border-color: #198754;
    }
    .module-card.inactive {
      opacity: 0.5;
      border-color: #dee2e6;
    }
    .module-card.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    .module-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }
    .module-icon.ludotheque { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .module-icon.bibliotheque { background: rgba(32, 201, 151, 0.1); color: #20c997; }
    .module-icon.filmotheque { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .module-icon.discotheque { background: rgba(232, 62, 140, 0.1); color: #e83e8c; }
    .form-range-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .form-range-container .form-range {
      flex: 1;
    }
    .form-range-value {
      min-width: 55px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      z-index: 1050;
      display: none;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .save-indicator.saving {
      display: flex;
      background: #fff3cd;
      color: #856404;
    }
    .save-indicator.saved {
      display: flex;
      background: #d1e7dd;
      color: #0f5132;
    }
    .save-indicator.error {
      display: flex;
      background: #f8d7da;
      color: #842029;
    }
    .demandes-card {
      border: none;
      transition: box-shadow 0.2s;
    }
    .demandes-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .module-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .module-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .config-section {
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
    }
    .sub-nav {
      background: #f8f9fa;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e9ecef;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Navigation (genere par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (genere par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <div id="sub-nav-container"></div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="parametres.html">Parametres</a></li>
                <li class="breadcrumb-item active">Emprunts & Prolongations</li>
              </ol>
            </nav>
            <h1 class="h3 mb-0"><i class="bi bi-arrow-repeat me-2"></i>Emprunts & Prolongations</h1>
          </div>
        </div>

        <!-- Onglets -->
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-tab="config">
              <i class="bi bi-sliders me-1"></i>Configuration
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-tab="demandes">
              <i class="bi bi-hourglass-split me-1"></i>Demandes en attente
              <span class="badge bg-warning text-dark ms-1" id="countDemandes">0</span>
            </a>
          </li>
        </ul>

        <!-- Configuration -->
        <div id="configSection">
          <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Configurez les regles de prolongation pour chaque module. Les modifications sont enregistrees automatiquement.
          </div>

          <div class="row g-4" id="modulesContainer">
            <!-- Modules generes par JS -->
          </div>
        </div>

        <!-- Demandes en attente -->
        <div id="demandesSection" class="d-none">
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Demandes de prolongation en attente</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="loadDemandes()">
                <i class="bi bi-arrow-clockwise"></i> Actualiser
              </button>
            </div>
            <div class="card-body" id="demandesContainer">
              <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Indicateur de sauvegarde -->
  <div class="save-indicator" id="saveIndicator">
    <span class="spinner-border spinner-border-sm" id="saveSpinner"></span>
    <i class="bi bi-check-circle d-none" id="saveCheck"></i>
    <i class="bi bi-exclamation-circle d-none" id="saveError"></i>
    <span id="saveText">Enregistrement...</span>
  </div>

  <!-- Modal validation -->
  <div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Traiter la demande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Usager :</strong> <span id="modal-adherent"></span></p>
          <p><strong>Article :</strong> <span id="modal-article"></span></p>
          <p><strong>Prolongation demandee :</strong> <span id="modal-jours"></span> jours</p>
          <p><strong>Nouvelle date de retour :</strong> <span id="modal-date"></span></p>
          <div class="mb-3">
            <label class="form-label">Commentaire (optionnel)</label>
            <textarea class="form-control" id="modal-commentaire" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="btnRefuser">
            <i class="bi bi-x-lg me-1"></i>Refuser
          </button>
          <button type="button" class="btn btn-success" id="btnValider">
            <i class="bi bi-check-lg me-1"></i>Valider
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script>
    const API_URL = '/api';
    let currentProlongationId = null;
    let saveTimeout = null;
    let currentParams = {};

    const MODULES = [
      { id: 'ludotheque', label: 'Ludotheque', sublabel: 'Jeux de societe', icon: 'bi-dice-5', defaultJours: 14 },
      { id: 'bibliotheque', label: 'Bibliotheque', sublabel: 'Livres', icon: 'bi-book', defaultJours: 14 },
      { id: 'filmotheque', label: 'Filmotheque', sublabel: 'Films', icon: 'bi-film', defaultJours: 7 },
      { id: 'discotheque', label: 'Discotheque', sublabel: 'Disques & Vinyles', icon: 'bi-disc', defaultJours: 7 }
    ];

    // Init template et navigation
    initTemplate('parametres');

    document.addEventListener('DOMContentLoaded', () => {
      renderSubNav('emprunts', 'prolongations');
      renderModules();
      loadConfig();
      setupEventListeners();
    });

    // Auth
    function getHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      };
    }

    // Render modules cards
    function renderModules() {
      const container = document.getElementById('modulesContainer');
      container.innerHTML = MODULES.map(mod => `
        <div class="col-lg-6">
          <div class="module-card p-3" id="card-${mod.id}">
            <div class="module-header">
              <div class="module-title">
                <div class="module-icon ${mod.id}">
                  <i class="bi ${mod.icon}"></i>
                </div>
                <div>
                  <h5 class="mb-0">${mod.label}</h5>
                  <small class="text-muted">${mod.sublabel}</small>
                </div>
              </div>
              <div class="module-controls">
                <span class="badge bg-secondary me-2" id="badge-module-${mod.id}">Module inactif</span>
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" id="active-${mod.id}"
                         onchange="toggleModule('${mod.id}', this.checked)"
                         style="width: 2.5em; height: 1.25em;">
                </div>
              </div>
            </div>

            <div class="config-section" id="config-${mod.id}">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Jours par prolongation</label>
                  <div class="form-range-container">
                    <input type="range" class="form-range" min="1" max="30" value="${mod.defaultJours}"
                           id="jours-${mod.id}" onchange="scheduleAutoSave()">
                    <span class="form-range-value badge bg-primary" id="jours-${mod.id}-value">${mod.defaultJours}j</span>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Prolongations automatiques max</label>
                  <div class="form-range-container">
                    <input type="range" class="form-range" min="0" max="5" value="1"
                           id="auto-${mod.id}" onchange="scheduleAutoSave()">
                    <span class="form-range-value badge bg-secondary" id="auto-${mod.id}-value">1</span>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="manuelle-${mod.id}" checked
                           onchange="scheduleAutoSave()">
                    <label class="form-check-label small" for="manuelle-${mod.id}">
                      Autoriser les demandes manuelles (apres auto epuisees)
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="msg-${mod.id}" checked
                           onchange="scheduleAutoSave()">
                    <label class="form-check-label small" for="msg-${mod.id}">
                      Afficher avertissement si article reserve par un autre usager
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // Bind range input events
      MODULES.forEach(mod => {
        document.getElementById(`jours-${mod.id}`).addEventListener('input', (e) => {
          document.getElementById(`jours-${mod.id}-value`).textContent = `${e.target.value}j`;
        });
        document.getElementById(`auto-${mod.id}`).addEventListener('input', (e) => {
          document.getElementById(`auto-${mod.id}-value`).textContent = e.target.value;
        });
      });
    }

    // Toggle module activation
    function toggleModule(modId, active) {
      const card = document.getElementById(`card-${modId}`);
      const config = document.getElementById(`config-${modId}`);

      if (active) {
        card.classList.add('active');
        card.classList.remove('inactive');
        config.style.opacity = '1';
        config.querySelectorAll('input').forEach(input => input.disabled = false);
      } else {
        card.classList.remove('active');
        card.classList.add('inactive');
        config.style.opacity = '0.5';
        config.querySelectorAll('input').forEach(input => input.disabled = true);
      }

      scheduleAutoSave();
    }

    // Load config
    async function loadConfig() {
      try {
        const response = await fetch(`${API_URL}/parametres/front`, {
          headers: getHeaders()
        });

        if (!response.ok) throw new Error('Erreur chargement');

        currentParams = await response.json();

        MODULES.forEach(mod => {
          const moduleActif = currentParams[`module_${mod.id}`];
          const card = document.getElementById(`card-${mod.id}`);
          const badge = document.getElementById(`badge-module-${mod.id}`);

          // Module actif/inactif dans le systeme
          if (!moduleActif) {
            card.classList.add('disabled');
            badge.className = 'badge bg-secondary me-2';
            badge.textContent = 'Module inactif';
            return;
          }

          badge.className = 'badge bg-success me-2';
          badge.textContent = 'Module actif';

          // Prolongations activees pour ce module
          const prolongActive = currentParams[`prolongation_active_${mod.id}`] !== false;
          document.getElementById(`active-${mod.id}`).checked = prolongActive;
          toggleModule(mod.id, prolongActive);

          // Valeurs
          const jours = currentParams[`prolongation_jours_${mod.id}`] || mod.defaultJours;
          const autoMax = currentParams[`prolongation_auto_max_${mod.id}`] ?? 1;
          const manuelle = currentParams[`prolongation_manuelle_${mod.id}`] !== false;
          const msg = currentParams[`prolongation_msg_reservation_${mod.id}`] !== false;

          document.getElementById(`jours-${mod.id}`).value = jours;
          document.getElementById(`jours-${mod.id}-value`).textContent = `${jours}j`;
          document.getElementById(`auto-${mod.id}`).value = autoMax;
          document.getElementById(`auto-${mod.id}-value`).textContent = autoMax;
          document.getElementById(`manuelle-${mod.id}`).checked = manuelle;
          document.getElementById(`msg-${mod.id}`).checked = msg;
        });

      } catch (error) {
        console.error('Erreur:', error);
        showSaveIndicator('error', 'Erreur de chargement');
      }
    }

    // Schedule auto save (debounce 800ms)
    function scheduleAutoSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveConfig, 800);
    }

    // Save config
    async function saveConfig() {
      showSaveIndicator('saving');

      const data = {};

      MODULES.forEach(mod => {
        // Skip si module non actif dans le systeme
        if (!currentParams[`module_${mod.id}`]) return;

        data[`prolongation_active_${mod.id}`] = document.getElementById(`active-${mod.id}`).checked;
        data[`prolongation_jours_${mod.id}`] = parseInt(document.getElementById(`jours-${mod.id}`).value);
        data[`prolongation_auto_max_${mod.id}`] = parseInt(document.getElementById(`auto-${mod.id}`).value);
        data[`prolongation_manuelle_${mod.id}`] = document.getElementById(`manuelle-${mod.id}`).checked;
        data[`prolongation_msg_reservation_${mod.id}`] = document.getElementById(`msg-${mod.id}`).checked;
      });

      try {
        const response = await fetch(`${API_URL}/parametres/front`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Erreur sauvegarde');

        showSaveIndicator('saved');
      } catch (error) {
        console.error('Erreur:', error);
        showSaveIndicator('error', 'Erreur de sauvegarde');
      }
    }

    // Show save indicator
    function showSaveIndicator(state, customMessage = null) {
      const indicator = document.getElementById('saveIndicator');
      const spinner = document.getElementById('saveSpinner');
      const check = document.getElementById('saveCheck');
      const errorIcon = document.getElementById('saveError');
      const text = document.getElementById('saveText');

      indicator.className = 'save-indicator ' + state;
      spinner.classList.toggle('d-none', state !== 'saving');
      check.classList.toggle('d-none', state !== 'saved');
      errorIcon.classList.toggle('d-none', state !== 'error');

      if (state === 'saving') {
        text.textContent = 'Enregistrement...';
      } else if (state === 'saved') {
        text.textContent = customMessage || 'Enregistre';
        setTimeout(() => {
          indicator.className = 'save-indicator';
        }, 2000);
      } else if (state === 'error') {
        text.textContent = customMessage || 'Erreur';
        setTimeout(() => {
          indicator.className = 'save-indicator';
        }, 4000);
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Tabs
      document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.nav-tabs .nav-link').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          if (tab.dataset.tab === 'config') {
            document.getElementById('configSection').classList.remove('d-none');
            document.getElementById('demandesSection').classList.add('d-none');
          } else {
            document.getElementById('configSection').classList.add('d-none');
            document.getElementById('demandesSection').classList.remove('d-none');
            loadDemandes();
          }
        });
      });

      // Modal buttons
      document.getElementById('btnValider').addEventListener('click', () => traiterDemande('valider'));
      document.getElementById('btnRefuser').addEventListener('click', () => traiterDemande('refuser'));
    }

    // Load demandes en attente
    async function loadDemandes() {
      const container = document.getElementById('demandesContainer');

      try {
        const response = await fetch(`${API_URL}/prolongations?statut=en_attente`, {
          headers: getHeaders()
        });

        if (!response.ok) throw new Error('Erreur chargement');

        const data = await response.json();
        const demandes = data.prolongations || [];

        document.getElementById('countDemandes').textContent = demandes.length;

        if (demandes.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="bi bi-check-circle" style="font-size: 3rem;"></i>
              <p class="mt-2">Aucune demande en attente</p>
            </div>
          `;
          return;
        }

        container.innerHTML = demandes.map(d => `
          <div class="card demandes-card mb-3">
            <div class="card-body d-flex align-items-center">
              <div class="flex-grow-1">
                <h6 class="mb-1">${d.emprunt?.adherent?.prenom || ''} ${d.emprunt?.adherent?.nom || 'Usager'}</h6>
                <p class="mb-1 text-muted">
                  ${d.emprunt?.jeu?.titre || d.emprunt?.livre?.titre || d.emprunt?.film?.titre || d.emprunt?.disque?.titre || 'Article'}
                </p>
                <small class="text-muted">
                  <i class="bi bi-calendar me-1"></i>Demande le ${new Date(d.date_demande).toLocaleDateString('fr-FR')}
                  - ${d.jours_ajoutes} jours demandes
                </small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="openValidation(${d.id}, '${(d.emprunt?.adherent?.prenom || '')} ${d.emprunt?.adherent?.nom || ''}', '${d.emprunt?.jeu?.titre || d.emprunt?.livre?.titre || d.emprunt?.film?.titre || d.emprunt?.disque?.titre || ''}', ${d.jours_ajoutes}, '${d.nouvelle_date_retour}')">
                  <i class="bi bi-check-lg me-1"></i>Traiter
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    // Open validation modal
    function openValidation(id, adherent, article, jours, date) {
      currentProlongationId = id;
      document.getElementById('modal-adherent').textContent = adherent;
      document.getElementById('modal-article').textContent = article;
      document.getElementById('modal-jours').textContent = jours;
      document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString('fr-FR');
      document.getElementById('modal-commentaire').value = '';
      new bootstrap.Modal(document.getElementById('validationModal')).show();
    }

    // Valider/Refuser
    async function traiterDemande(action) {
      const commentaire = document.getElementById('modal-commentaire').value;

      try {
        const response = await fetch(`${API_URL}/prolongations/${currentProlongationId}/${action}`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ commentaire })
        });

        if (!response.ok) throw new Error('Erreur traitement');

        bootstrap.Modal.getInstance(document.getElementById('validationModal')).hide();
        loadDemandes();
        showSaveIndicator('saved', action === 'valider' ? 'Prolongation validee' : 'Prolongation refusee');
      } catch (error) {
        console.error('Erreur:', error);
        showSaveIndicator('error', 'Erreur lors du traitement');
      }
    }
  </script>
</body>
</html>
