<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Themes du site - Parametres - Liberteko Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    .section-card { margin-bottom: 1.5rem; }
    .section-card .card-header { background-color: #f8f9fa; font-weight: 600; }
    .theme-card {
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .theme-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .theme-card.active-theme {
      border-color: #198754;
    }
    .theme-card.active-theme::after {
      content: '\f26a';
      font-family: 'bootstrap-icons';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #198754;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .theme-preview {
      height: 100px;
      border-radius: 8px 8px 0 0;
      position: relative;
      overflow: hidden;
    }
    .theme-preview-header {
      height: 32px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 6px;
    }
    .theme-preview-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      opacity: 0.7;
    }
    .theme-preview-content {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .theme-preview-btn {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 10px;
      border: none;
      display: inline-block;
      width: fit-content;
    }
    .theme-preview-text {
      height: 6px;
      border-radius: 3px;
      opacity: 0.3;
    }
    .badge-filesystem { background: linear-gradient(135deg, #10b981, #059669); }
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 2px solid #dee2e6;
    }
    .color-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .color-input-group input[type="color"] {
      width: 50px;
      height: 38px;
      padding: 2px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      cursor: pointer;
    }
    .color-input-group input[type="text"] {
      width: 100px;
      font-family: monospace;
    }
    .color-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    .color-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
    }
    .color-item label {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 8px;
      display: block;
    }
    .live-preview {
      border: 1px solid #dee2e6;
      border-radius: 12px;
      overflow: hidden;
      background: white;
    }
    .live-preview-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .live-preview-content {
      padding: 16px;
      min-height: 150px;
    }
    .live-preview-btn-primary, .live-preview-btn-secondary {
      padding: 6px 16px;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      font-size: 13px;
    }
    .live-preview-card {
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    .mode-toggle {
      display: flex;
      gap: 5px;
      background: #f1f3f4;
      padding: 4px;
      border-radius: 8px;
    }
    .mode-toggle .btn {
      border-radius: 6px;
      padding: 6px 16px;
    }
    .mode-toggle .btn.active {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .sub-nav { background: #f8f9fa; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e9ecef; }
    .theme-files-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
    }
    .no-manifest {
      opacity: 0.6;
    }
    .no-manifest .theme-preview {
      filter: grayscale(50%);
    }
  </style>
</head>
<body>
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <div class="col-md-10">
        <div id="sub-nav-container"></div>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1><i class="bi bi-palette"></i> Themes du site</h1>
            <p class="text-muted mb-0">
              Themes detectes depuis <code>frontend/themes/</code>
              <button class="btn btn-sm btn-link p-0 ms-2" onclick="refreshThemes()" title="Rafraichir">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </p>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="showCreateModal()">
              <i class="bi bi-plus"></i> Nouveau theme
            </button>
          </div>
        </div>

        <!-- Theme actif -->
        <div class="card mb-4 border-success" id="activeThemeCard" style="display: none;">
          <div class="card-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>Theme actuellement actif
          </div>
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h5 class="mb-1" id="activeThemeName">-</h5>
                <p class="text-muted mb-0" id="activeThemeDesc">-</p>
                <small class="text-muted">Code: <code id="activeThemeCode">-</code></small>
              </div>
              <div class="col-md-4 text-end">
                <div class="d-flex gap-2 justify-content-end">
                  <div class="color-swatch" id="activeThemePrimary" title="Couleur primaire"></div>
                  <div class="color-swatch" id="activeThemeSecondary" title="Couleur secondaire"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filtres -->
        <div class="card mb-4">
          <div class="card-body py-3">
            <div class="row align-items-center g-3">
              <div class="col-md-4">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input type="text" class="form-control" id="searchInput" placeholder="Rechercher..." oninput="filterThemes()">
                </div>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="modeFilter" onchange="filterThemes()">
                  <option value="">Tous modes</option>
                  <option value="light">Clair</option>
                  <option value="dark">Sombre</option>
                </select>
              </div>
              <div class="col-md-3">
                <span class="text-muted" id="themesCount">0 themes</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Grille des themes -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4" id="themesGrid">
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 mb-0">Chargement...</p>
          </div>
        </div>

        <div id="noThemes" class="text-center py-5" style="display: none;">
          <i class="bi bi-palette display-1 text-muted"></i>
          <p class="text-muted mt-3">Aucun theme trouve</p>
          <p class="small text-muted">Creez un dossier avec un <code>manifest.json</code> dans <code>frontend/themes/</code></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Creation -->
  <div class="modal fade" id="createModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nouveau theme</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Un nouveau dossier sera cree dans <code>frontend/themes/</code> avec la structure de base.
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Code du theme <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="new_code" placeholder="mon-theme" pattern="[a-z0-9-]+" title="Lettres minuscules, chiffres et tirets uniquement">
                <small class="text-muted">Nom du dossier (lettres minuscules, chiffres, tirets)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nom d'affichage <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="new_name" placeholder="Mon Theme">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="new_description" rows="2" placeholder="Description du theme..."></textarea>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Mode</label>
                <select class="form-select" id="new_mode">
                  <option value="light">Clair</option>
                  <option value="dark">Sombre</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Couleur primaire</label>
                <div class="color-input-group">
                  <input type="color" id="new_primary" value="#667eea">
                  <input type="text" class="form-control form-control-sm" id="new_primary_text" value="#667eea">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="createTheme()">
            <i class="bi bi-folder-plus me-1"></i>Creer le theme
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edition -->
  <div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalTitle">Modifier le theme</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Colonne gauche : Parametres -->
            <div class="col-lg-7">
              <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item">
                  <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabGeneral">
                    <i class="bi bi-gear me-1"></i>General
                  </button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabColors">
                    <i class="bi bi-palette me-1"></i>Couleurs
                  </button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabStyle">
                    <i class="bi bi-brush me-1"></i>Style
                  </button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFiles">
                    <i class="bi bi-folder me-1"></i>Fichiers
                  </button>
                </li>
              </ul>

              <div class="tab-content">
                <!-- Onglet General -->
                <div class="tab-pane fade show active" id="tabGeneral">
                  <div class="mb-3">
                    <label class="form-label">Code</label>
                    <input type="text" class="form-control" id="edit_code" disabled>
                    <small class="text-muted">Le code ne peut pas etre modifie (nom du dossier)</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nom <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="edit_name">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="edit_description" rows="2"></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Auteur</label>
                        <input type="text" class="form-control" id="edit_author">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Version</label>
                        <input type="text" class="form-control" id="edit_version" placeholder="1.0.0">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Mode</label>
                    <div class="mode-toggle">
                      <button type="button" class="btn btn-sm active" id="modeLight" onclick="setEditMode('light')">
                        <i class="bi bi-sun me-1"></i>Clair
                      </button>
                      <button type="button" class="btn btn-sm" id="modeDark" onclick="setEditMode('dark')">
                        <i class="bi bi-moon me-1"></i>Sombre
                      </button>
                    </div>
                    <input type="hidden" id="edit_mode" value="light">
                  </div>
                </div>

                <!-- Onglet Couleurs -->
                <div class="tab-pane fade" id="tabColors">
                  <div class="color-grid">
                    <div class="color-item">
                      <label>Primaire</label>
                      <div class="color-input-group">
                        <input type="color" id="color_primary" value="#667eea" onchange="updateColorText(this, 'text_primary'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_primary" value="#667eea" oninput="updateColorPicker(this, 'color_primary'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Secondaire</label>
                      <div class="color-input-group">
                        <input type="color" id="color_secondary" value="#764ba2" onchange="updateColorText(this, 'text_secondary'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_secondary" value="#764ba2" oninput="updateColorPicker(this, 'color_secondary'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Accent</label>
                      <div class="color-input-group">
                        <input type="color" id="color_accent" value="#20c997" onchange="updateColorText(this, 'text_accent'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_accent" value="#20c997" oninput="updateColorPicker(this, 'color_accent'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Succes</label>
                      <div class="color-input-group">
                        <input type="color" id="color_success" value="#10b981" onchange="updateColorText(this, 'text_success'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_success" value="#10b981" oninput="updateColorPicker(this, 'color_success'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Avertissement</label>
                      <div class="color-input-group">
                        <input type="color" id="color_warning" value="#f59e0b" onchange="updateColorText(this, 'text_warning'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_warning" value="#f59e0b" oninput="updateColorPicker(this, 'color_warning'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Danger</label>
                      <div class="color-input-group">
                        <input type="color" id="color_danger" value="#ef4444" onchange="updateColorText(this, 'text_danger'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_danger" value="#ef4444" oninput="updateColorPicker(this, 'color_danger'); updateEditPreview()">
                      </div>
                    </div>
                  </div>

                  <hr class="my-4">
                  <h6 class="mb-3">Fond et texte</h6>
                  <div class="color-grid">
                    <div class="color-item">
                      <label>Fond principal</label>
                      <div class="color-input-group">
                        <input type="color" id="color_background" value="#ffffff" onchange="updateColorText(this, 'text_background'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_background" value="#ffffff" oninput="updateColorPicker(this, 'color_background'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Fond secondaire</label>
                      <div class="color-input-group">
                        <input type="color" id="color_backgroundSecondary" value="#f8f9fa" onchange="updateColorText(this, 'text_backgroundSecondary'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_backgroundSecondary" value="#f8f9fa" oninput="updateColorPicker(this, 'color_backgroundSecondary'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Texte principal</label>
                      <div class="color-input-group">
                        <input type="color" id="color_text" value="#333333" onchange="updateColorText(this, 'text_text'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_text" value="#333333" oninput="updateColorPicker(this, 'color_text'); updateEditPreview()">
                      </div>
                    </div>
                    <div class="color-item">
                      <label>Texte secondaire</label>
                      <div class="color-input-group">
                        <input type="color" id="color_textSecondary" value="#6c757d" onchange="updateColorText(this, 'text_textSecondary'); updateEditPreview()">
                        <input type="text" class="form-control form-control-sm" id="text_textSecondary" value="#6c757d" oninput="updateColorPicker(this, 'color_textSecondary'); updateEditPreview()">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Onglet Style -->
                <div class="tab-pane fade" id="tabStyle">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Border Radius</label>
                        <input type="text" class="form-control" id="edit_borderRadius" placeholder="8px">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Style d'ombre</label>
                        <select class="form-select" id="edit_shadowStyle">
                          <option value="subtle">Subtil</option>
                          <option value="medium">Medium</option>
                          <option value="strong">Fort</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Style de navbar</label>
                    <select class="form-select" id="edit_navbarStyle">
                      <option value="gradient">Gradient</option>
                      <option value="solid">Solide</option>
                      <option value="transparent">Transparent</option>
                    </select>
                  </div>
                </div>

                <!-- Onglet Fichiers -->
                <div class="tab-pane fade" id="tabFiles">
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Les fichiers du theme se trouvent dans <code id="themePath">frontend/themes/...</code>
                  </div>
                  <div id="filesList">
                    <p class="text-muted">Chargement des fichiers...</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Colonne droite : Preview -->
            <div class="col-lg-5">
              <div class="sticky-top" style="top: 20px;">
                <h6 class="mb-3"><i class="bi bi-eye me-2"></i>Apercu en direct</h6>
                <div class="live-preview" id="livePreview">
                  <div class="live-preview-header" id="previewHeader">
                    <i class="bi bi-box-seam fs-4"></i>
                    <span class="fw-bold">Ma Ludotheque</span>
                  </div>
                  <div class="live-preview-content" id="previewContent">
                    <h5 id="previewTitle">Bienvenue !</h5>
                    <p id="previewText" style="font-size: 14px;">Decouvrez notre collection.</p>
                    <div class="d-flex gap-2 mb-3">
                      <button class="live-preview-btn-primary" id="previewBtnPrimary">Catalogue</button>
                      <button class="live-preview-btn-secondary" id="previewBtnSecondary">Contact</button>
                    </div>
                    <div class="live-preview-card" id="previewCard">
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-dice-5 fs-5" id="previewCardIcon"></i>
                        <strong>Article exemple</strong>
                      </div>
                      <small id="previewCardText">Description de l'article.</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveTheme()">
            <i class="bi bi-check-lg me-1"></i>Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Actions -->
  <div class="modal fade" id="actionsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionsModalTitle">Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-success btn-lg text-start" onclick="activateTheme()" id="activateBtn">
              <i class="bi bi-check-circle me-2"></i>Activer ce theme
              <small class="d-block text-muted">Appliquer ce theme au site public</small>
            </button>
            <button class="btn btn-outline-primary btn-lg text-start" onclick="editTheme()">
              <i class="bi bi-pencil me-2"></i>Modifier
              <small class="d-block text-muted">Personnaliser les couleurs et parametres</small>
            </button>
            <button class="btn btn-outline-secondary btn-lg text-start" onclick="duplicateTheme()">
              <i class="bi bi-copy me-2"></i>Dupliquer
              <small class="d-block text-muted">Creer une copie modifiable</small>
            </button>
            <button class="btn btn-outline-info btn-lg text-start" onclick="exportTheme()">
              <i class="bi bi-download me-2"></i>Exporter
              <small class="d-block text-muted">Telecharger le manifest.json</small>
            </button>
            <button class="btn btn-outline-danger btn-lg text-start" onclick="deleteTheme()" id="deleteBtn">
              <i class="bi bi-trash me-2"></i>Supprimer
              <small class="d-block text-muted">Supprimer le dossier du theme</small>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script>
    let allThemes = [];
    let currentTheme = null;
    let activeThemeCode = null;
    let createModal, editModal, actionsModal;

    initTemplate('parametres');

    document.addEventListener('DOMContentLoaded', () => {
      renderSubNav('site-web', 'themes');
      createModal = new bootstrap.Modal(document.getElementById('createModal'));
      editModal = new bootstrap.Modal(document.getElementById('editModal'));
      actionsModal = new bootstrap.Modal(document.getElementById('actionsModal'));

      // Sync color inputs
      document.getElementById('new_primary').addEventListener('change', function() {
        document.getElementById('new_primary_text').value = this.value;
      });
      document.getElementById('new_primary_text').addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
          document.getElementById('new_primary').value = this.value;
        }
      });

      loadThemes();
    });

    async function loadThemes() {
      try {
        const response = await apiRequest('/parametres/themes');
        allThemes = response.themes || [];
        activeThemeCode = response.activeTheme || 'default';

        // Afficher le theme actif
        const activeTheme = allThemes.find(t => t.code === activeThemeCode);
        if (activeTheme) {
          showActiveTheme(activeTheme);
        }

        filterThemes();
      } catch (error) {
        console.error('Erreur chargement themes:', error);
        document.getElementById('themesGrid').innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Erreur de chargement</div>
          </div>`;
      }
    }

    async function refreshThemes() {
      try {
        await apiRequest('/parametres/themes/refresh', { method: 'POST' });
        showToast('Cache des themes rafraichi', 'success');
        loadThemes();
      } catch (error) {
        console.error('Erreur refresh:', error);
        showToast('Erreur lors du rafraichissement', 'error');
      }
    }

    function showActiveTheme(theme) {
      const card = document.getElementById('activeThemeCard');
      document.getElementById('activeThemeName').textContent = theme.name;
      document.getElementById('activeThemeDesc').textContent = theme.description || 'Aucune description';
      document.getElementById('activeThemeCode').textContent = theme.code;
      document.getElementById('activeThemePrimary').style.backgroundColor = theme.colors?.primary || '#667eea';
      document.getElementById('activeThemeSecondary').style.backgroundColor = theme.colors?.secondary || '#764ba2';
      card.style.display = 'block';
    }

    function filterThemes() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const mode = document.getElementById('modeFilter').value;

      let filtered = allThemes.filter(theme => {
        if (search && !theme.name.toLowerCase().includes(search) &&
            !theme.code.toLowerCase().includes(search)) return false;
        if (mode && theme.mode !== mode) return false;
        return true;
      });

      document.getElementById('themesCount').textContent = `${filtered.length} theme${filtered.length > 1 ? 's' : ''}`;
      renderThemes(filtered);
    }

    function renderThemes(themes) {
      const grid = document.getElementById('themesGrid');
      const noThemes = document.getElementById('noThemes');

      if (themes.length === 0) {
        grid.innerHTML = '';
        noThemes.style.display = 'block';
        return;
      }

      noThemes.style.display = 'none';

      grid.innerHTML = themes.map(theme => {
        const isActive = theme.code === activeThemeCode;
        const isDark = theme.mode === 'dark';
        const bgColor = theme.colors?.background || (isDark ? '#1e293b' : '#f8fafc');
        const textColor = theme.colors?.text || (isDark ? '#f1f5f9' : '#1e293b');
        const primary = theme.colors?.primary || '#667eea';
        const secondary = theme.colors?.secondary || '#764ba2';

        const fileCount = (theme.files?.css?.length || 0) + (theme.files?.js?.length || 0) + (theme.files?.pages?.length || 0);

        return `
          <div class="col">
            <div class="card theme-card h-100 position-relative ${isActive ? 'active-theme' : ''} ${!theme.hasManifest ? 'no-manifest' : ''}"
                 onclick="showActions('${theme.code}')">
              <div class="theme-preview" style="background: ${bgColor};">
                <div class="theme-preview-header" style="background: ${primary}; color: white;">
                  <span class="theme-preview-dot" style="background: white;"></span>
                  <span class="theme-preview-dot" style="background: white;"></span>
                  <span class="theme-preview-dot" style="background: white;"></span>
                </div>
                <div class="theme-preview-content">
                  <div class="theme-preview-btn" style="background: ${primary}; color: white;">Bouton</div>
                  <div class="theme-preview-text" style="background: ${textColor}; width: 80%;"></div>
                  <div class="theme-preview-text" style="background: ${textColor}; width: 60%;"></div>
                </div>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="card-title mb-0">${theme.name}</h6>
                    <small class="text-muted">${theme.code}</small>
                  </div>
                  ${!theme.hasManifest ? '<span class="badge bg-warning text-dark">No manifest</span>' : ''}
                </div>
                <p class="card-text small text-muted mb-2">${theme.description || 'Aucune description'}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex gap-1">
                    <div class="color-swatch" style="width: 20px; height: 20px; background: ${primary};" title="Primaire"></div>
                    <div class="color-swatch" style="width: 20px; height: 20px; background: ${secondary};" title="Secondaire"></div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    ${fileCount > 0 ? `<span class="badge bg-secondary theme-files-badge">${fileCount} fichier${fileCount > 1 ? 's' : ''}</span>` : ''}
                    <span class="badge bg-${isDark ? 'dark' : 'light'} text-${isDark ? 'white' : 'dark'}">
                      <i class="bi bi-${isDark ? 'moon' : 'sun'} me-1"></i>${isDark ? 'Sombre' : 'Clair'}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showActions(themeCode) {
      currentTheme = allThemes.find(t => t.code === themeCode);
      if (!currentTheme) return;

      document.getElementById('actionsModalTitle').textContent = currentTheme.name;

      // Masquer bouton supprimer pour default
      const deleteBtn = document.getElementById('deleteBtn');
      deleteBtn.style.display = currentTheme.code === 'default' ? 'none' : 'block';

      // Masquer bouton activer si deja actif
      const activateBtn = document.getElementById('activateBtn');
      activateBtn.style.display = currentTheme.code === activeThemeCode ? 'none' : 'block';

      actionsModal.show();
    }

    function showCreateModal() {
      document.getElementById('new_code').value = '';
      document.getElementById('new_name').value = '';
      document.getElementById('new_description').value = '';
      document.getElementById('new_mode').value = 'light';
      document.getElementById('new_primary').value = '#667eea';
      document.getElementById('new_primary_text').value = '#667eea';
      createModal.show();
    }

    async function createTheme() {
      const code = document.getElementById('new_code').value.trim().toLowerCase();
      const name = document.getElementById('new_name').value.trim();

      if (!code || !name) {
        showToast('Le code et le nom sont requis', 'error');
        return;
      }

      if (!/^[a-z0-9-]+$/.test(code)) {
        showToast('Le code doit contenir uniquement des lettres minuscules, chiffres et tirets', 'error');
        return;
      }

      const data = {
        code,
        name,
        description: document.getElementById('new_description').value.trim(),
        mode: document.getElementById('new_mode').value,
        colors: {
          primary: document.getElementById('new_primary').value
        }
      };

      try {
        await apiRequest('/parametres/themes', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        showToast('Theme cree avec succes', 'success');
        createModal.hide();
        loadThemes();
      } catch (error) {
        console.error('Erreur creation:', error);
        showToast(error.message || 'Erreur lors de la creation', 'error');
      }
    }

    async function editTheme() {
      actionsModal.hide();

      try {
        const theme = await apiRequest(`/parametres/themes/${currentTheme.code}`);

        document.getElementById('editModalTitle').textContent = `Modifier "${theme.name}"`;
        document.getElementById('edit_code').value = theme.code;
        document.getElementById('edit_name').value = theme.name || '';
        document.getElementById('edit_description').value = theme.description || '';
        document.getElementById('edit_author').value = theme.author || '';
        document.getElementById('edit_version').value = theme.version || '1.0.0';
        document.getElementById('edit_mode').value = theme.mode || 'light';
        setEditMode(theme.mode || 'light', false);

        // Couleurs
        const colors = theme.colors || {};
        setColorValue('primary', colors.primary || '#667eea');
        setColorValue('secondary', colors.secondary || '#764ba2');
        setColorValue('accent', colors.accent || '#20c997');
        setColorValue('success', colors.success || '#10b981');
        setColorValue('warning', colors.warning || '#f59e0b');
        setColorValue('danger', colors.danger || '#ef4444');
        setColorValue('background', colors.background || '#ffffff');
        setColorValue('backgroundSecondary', colors.backgroundSecondary || '#f8f9fa');
        setColorValue('text', colors.text || '#333333');
        setColorValue('textSecondary', colors.textSecondary || '#6c757d');

        // Style
        const style = theme.style || {};
        document.getElementById('edit_borderRadius').value = style.borderRadius || '8px';
        document.getElementById('edit_shadowStyle').value = style.shadowStyle || 'subtle';
        document.getElementById('edit_navbarStyle').value = style.navbarStyle || 'gradient';

        // Fichiers
        document.getElementById('themePath').textContent = `frontend/themes/${theme.code}/`;
        loadThemeFiles(theme);

        updateEditPreview();
        editModal.show();
      } catch (error) {
        console.error('Erreur chargement theme:', error);
        showToast('Erreur lors du chargement', 'error');
      }
    }

    function loadThemeFiles(theme) {
      const files = theme.files || {};
      let html = '<div class="row">';

      // CSS
      html += '<div class="col-md-6 mb-3"><h6><i class="bi bi-filetype-css text-primary me-2"></i>CSS</h6><ul class="list-unstyled small">';
      if (files.css?.length) {
        files.css.forEach(f => html += `<li><code>${f}</code></li>`);
      } else {
        html += '<li class="text-muted">Aucun fichier CSS</li>';
      }
      html += '</ul></div>';

      // JS
      html += '<div class="col-md-6 mb-3"><h6><i class="bi bi-filetype-js text-warning me-2"></i>JavaScript</h6><ul class="list-unstyled small">';
      if (files.js?.length) {
        files.js.forEach(f => html += `<li><code>${f}</code></li>`);
      } else {
        html += '<li class="text-muted">Aucun fichier JS</li>';
      }
      html += '</ul></div>';

      // Pages
      html += '<div class="col-12"><h6><i class="bi bi-file-earmark-code text-success me-2"></i>Pages personnalisees</h6><ul class="list-unstyled small">';
      if (files.pages?.length) {
        files.pages.forEach(f => html += `<li><code>${f}</code></li>`);
      } else {
        html += '<li class="text-muted">Aucune page personnalisee (utilise les pages par defaut)</li>';
      }
      html += '</ul></div>';

      html += '</div>';
      document.getElementById('filesList').innerHTML = html;
    }

    function setColorValue(field, value) {
      document.getElementById(`color_${field}`).value = value;
      document.getElementById(`text_${field}`).value = value;
    }

    function updateColorText(colorInput, textInputId) {
      document.getElementById(textInputId).value = colorInput.value;
    }

    function updateColorPicker(textInput, colorInputId) {
      const value = textInput.value;
      if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        document.getElementById(colorInputId).value = value;
      }
    }

    function setEditMode(mode, update = true) {
      document.getElementById('edit_mode').value = mode;
      document.getElementById('modeLight').classList.toggle('active', mode === 'light');
      document.getElementById('modeDark').classList.toggle('active', mode === 'dark');

      if (update) {
        if (mode === 'dark') {
          setColorValue('background', '#1a1a2e');
          setColorValue('backgroundSecondary', '#16213e');
          setColorValue('text', '#f1f5f9');
          setColorValue('textSecondary', '#94a3b8');
        } else {
          setColorValue('background', '#ffffff');
          setColorValue('backgroundSecondary', '#f8f9fa');
          setColorValue('text', '#333333');
          setColorValue('textSecondary', '#6c757d');
        }
        updateEditPreview();
      }
    }

    function updateEditPreview() {
      const primary = document.getElementById('color_primary').value;
      const secondary = document.getElementById('color_secondary').value;
      const bgPage = document.getElementById('color_background').value;
      const bgCard = document.getElementById('color_backgroundSecondary').value;
      const textMain = document.getElementById('color_text').value;
      const textSecondary = document.getElementById('color_textSecondary').value;

      const preview = document.getElementById('livePreview');
      const header = document.getElementById('previewHeader');
      const content = document.getElementById('previewContent');
      const btnPrimary = document.getElementById('previewBtnPrimary');
      const btnSecondary = document.getElementById('previewBtnSecondary');
      const card = document.getElementById('previewCard');
      const title = document.getElementById('previewTitle');
      const text = document.getElementById('previewText');
      const cardText = document.getElementById('previewCardText');
      const cardIcon = document.getElementById('previewCardIcon');

      preview.style.backgroundColor = bgPage;
      header.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
      header.style.color = 'white';
      content.style.backgroundColor = bgPage;
      btnPrimary.style.backgroundColor = primary;
      btnSecondary.style.backgroundColor = secondary;
      card.style.backgroundColor = bgCard;
      card.style.border = `1px solid ${textSecondary}33`;
      title.style.color = textMain;
      text.style.color = textSecondary;
      cardText.style.color = textSecondary;
      cardIcon.style.color = primary;
    }

    async function saveTheme() {
      const code = document.getElementById('edit_code').value;
      const name = document.getElementById('edit_name').value.trim();

      if (!name) {
        showToast('Le nom est requis', 'error');
        return;
      }

      const data = {
        name,
        description: document.getElementById('edit_description').value.trim(),
        author: document.getElementById('edit_author').value.trim(),
        version: document.getElementById('edit_version').value.trim() || '1.0.0',
        mode: document.getElementById('edit_mode').value,
        colors: {
          primary: document.getElementById('color_primary').value,
          secondary: document.getElementById('color_secondary').value,
          accent: document.getElementById('color_accent').value,
          success: document.getElementById('color_success').value,
          warning: document.getElementById('color_warning').value,
          danger: document.getElementById('color_danger').value,
          background: document.getElementById('color_background').value,
          backgroundSecondary: document.getElementById('color_backgroundSecondary').value,
          text: document.getElementById('color_text').value,
          textSecondary: document.getElementById('color_textSecondary').value
        },
        style: {
          borderRadius: document.getElementById('edit_borderRadius').value || '8px',
          shadowStyle: document.getElementById('edit_shadowStyle').value || 'subtle',
          navbarStyle: document.getElementById('edit_navbarStyle').value || 'gradient'
        }
      };

      try {
        await apiRequest(`/parametres/themes/${code}`, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
        showToast('Theme mis a jour', 'success');
        editModal.hide();
        loadThemes();
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        showToast(error.message || 'Erreur lors de la sauvegarde', 'error');
      }
    }

    async function activateTheme() {
      actionsModal.hide();

      try {
        await apiRequest(`/parametres/themes/${currentTheme.code}/activate`, { method: 'POST' });
        activeThemeCode = currentTheme.code;
        showToast(`Theme "${currentTheme.name}" active`, 'success');
        loadThemes();
      } catch (error) {
        console.error('Erreur activation:', error);
        showToast(error.message || 'Erreur lors de l\'activation', 'error');
      }
    }

    async function duplicateTheme() {
      actionsModal.hide();

      const newCode = prompt('Code du nouveau theme (lettres minuscules, chiffres, tirets):', `${currentTheme.code}-copy`);
      if (!newCode) return;

      if (!/^[a-z0-9-]+$/.test(newCode)) {
        showToast('Le code doit contenir uniquement des lettres minuscules, chiffres et tirets', 'error');
        return;
      }

      const newName = prompt('Nom du nouveau theme:', `${currentTheme.name} (copie)`);
      if (!newName) return;

      try {
        await apiRequest(`/parametres/themes/${currentTheme.code}/duplicate`, {
          method: 'POST',
          body: JSON.stringify({ newCode, newName })
        });
        showToast('Theme duplique', 'success');
        loadThemes();
      } catch (error) {
        console.error('Erreur duplication:', error);
        showToast(error.message || 'Erreur lors de la duplication', 'error');
      }
    }

    async function exportTheme() {
      actionsModal.hide();

      try {
        const response = await fetch(`${window.API_BASE_URL || ''}/api/parametres/themes/${currentTheme.code}/export`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `theme_${currentTheme.code}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showToast('Theme exporte', 'success');
      } catch (error) {
        console.error('Erreur export:', error);
        showToast('Erreur lors de l\'export', 'error');
      }
    }

    async function deleteTheme() {
      if (currentTheme.code === 'default') {
        showToast('Le theme default ne peut pas etre supprime', 'error');
        return;
      }

      if (currentTheme.code === activeThemeCode) {
        showToast('Impossible de supprimer le theme actif. Activez un autre theme d\'abord.', 'error');
        return;
      }

      if (!confirm(`Supprimer definitivement le theme "${currentTheme.name}" ?\n\nLe dossier frontend/themes/${currentTheme.code}/ sera supprime.`)) return;

      actionsModal.hide();

      try {
        await apiRequest(`/parametres/themes/${currentTheme.code}`, { method: 'DELETE' });
        showToast('Theme supprime', 'success');
        loadThemes();
      } catch (error) {
        console.error('Erreur suppression:', error);
        showToast(error.message || 'Erreur lors de la suppression', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container') || (() => {
        const c = document.createElement('div');
        c.id = 'toast-container';
        c.className = 'toast-container position-fixed top-0 end-0 p-3';
        c.style.zIndex = '1100';
        document.body.appendChild(c);
        return c;
      })();
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      container.appendChild(toast);
      new bootstrap.Toast(toast).show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }
  </script>
</body>
</html>
