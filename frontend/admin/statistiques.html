<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - Liberteko Admin</title>
    <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
    <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
    <style>
        .stat-card {
            transition: all 0.2s;
        }
        .stat-card:hover {
            transform: scale(1.02);
        }
        .module-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        .progress-thin {
            height: 8px;
        }
        .nav-pills .nav-link {
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
        }
        .nav-pills .nav-link.active {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .tab-icon {
            font-size: 1.2rem;
        }
        .nouveautes-card {
            border-left: 4px solid #198754;
        }
        .chart-bar {
            transition: height 0.3s ease;
        }
        /* Onglets dynamiques avec couleurs des modules */
        .nav-pills .nav-link.active {
            background-color: var(--tab-color, #0d6efd) !important;
            color: var(--tab-text, #ffffff) !important;
        }
        .nav-pills .nav-link.active i {
            color: var(--tab-text, #ffffff) !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav id="admin-navbar"></nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div id="admin-sidebar" class="col-md-2 bg-light"></div>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-graph-up"></i> Statistiques</h2>
                    <button class="btn btn-secondary" onclick="refreshStats()">
                        <i class="bi bi-arrow-clockwise"></i> Actualiser
                    </button>
                </div>

                <!-- Alerts -->
                <div id="alertContainer"></div>

                <!-- Onglets Navigation -->
                <ul class="nav nav-pills mb-4" id="statsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="pill"
                                data-bs-target="#general" type="button" role="tab">
                            <i class="bi bi-house-door tab-icon me-2"></i>General
                        </button>
                    </li>
                    <!-- Onglets modules generes dynamiquement -->
                </ul>

                <!-- Contenu des onglets -->
                <div class="tab-content" id="statsTabContent">
                    <!-- Onglet General -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <!-- Stats Globales -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3 col-6">
                                <div class="card border-primary stat-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Total Usagers</h6>
                                                <h2 class="mb-0" id="statTotalAdherents">-</h2>
                                            </div>
                                            <div class="module-icon text-primary">
                                                <i class="bi bi-people"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card border-success stat-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Usagers Actifs</h6>
                                                <h2 class="mb-0" id="statAdherentsActifs">-</h2>
                                                <small class="text-muted" id="statCotisationsActives"></small>
                                            </div>
                                            <div class="module-icon text-success">
                                                <i class="bi bi-person-check"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card border-info stat-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Total Collection</h6>
                                                <h2 class="mb-0" id="statTotalCollection">-</h2>
                                                <small class="text-muted" id="statCollectionDetails"></small>
                                            </div>
                                            <div class="module-icon text-info">
                                                <i class="bi bi-collection"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="card border-warning stat-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Emprunts en Cours</h6>
                                                <h2 class="mb-0" id="statEmpruntsEnCours">-</h2>
                                                <small class="text-danger" id="statRetards"></small>
                                            </div>
                                            <div class="module-icon text-warning">
                                                <i class="bi bi-arrow-left-right"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resume par module -->
                        <div class="row g-3 mb-4" id="modulesSummary">
                            <!-- Genere dynamiquement -->
                        </div>

                        <!-- Graphique emprunts globaux -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-bar-chart"></i> Emprunts Mensuels (toutes collections)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="globalMonthlyChart">
                                    <div class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Comptabilite (comptable+ uniquement) -->
                        <div id="comptabiliteSection" class="d-none">
                            <h4 class="mb-3"><i class="bi bi-cash-coin"></i> Statistiques Comptables</h4>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="mb-2">Chiffre d'Affaires <span id="comptaYear"></span></h6>
                                            <h2 class="mb-0" id="comptaCA">-</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body">
                                            <h6 class="mb-2">Cotisations Actives</h6>
                                            <h2 class="mb-0" id="comptaCotisationsActives">-</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="mb-2">Cotisations ce Mois</h6>
                                            <h2 class="mb-0" id="comptaCotisationsMois">-</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0"><i class="bi bi-bar-chart"></i> Cotisations Mensuelles</h5>
                                </div>
                                <div class="card-body">
                                    <div id="comptaMensuelChart">
                                        <div class="text-center p-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Onglets modules generes dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="js/api-admin.js"></script>
    <script src="js/auth-admin.js"></script>
    <script src="js/admin-navigation.js"></script>
    <script src="js/admin-template.js"></script>
    <script>
        // Configuration des modules avec couleurs par defaut
        const MODULE_CONFIG = {
            ludotheque: { icon: 'dice-6', color: '#6f42c1', label: 'Ludotheque', itemLabel: 'jeux', itemLabelSingular: 'jeu' },
            bibliotheque: { icon: 'book', color: '#20c997', label: 'Bibliotheque', itemLabel: 'livres', itemLabelSingular: 'livre' },
            filmotheque: { icon: 'film', color: '#fd7e14', label: 'Filmotheque', itemLabel: 'films', itemLabelSingular: 'film' },
            discotheque: { icon: 'disc', color: '#e83e8c', label: 'Discotheque', itemLabel: 'disques', itemLabelSingular: 'disque' }
        };

        // Mapping collection -> module
        const COLLECTION_TO_MODULE = {
            'jeux': 'ludotheque',
            'livres': 'bibliotheque',
            'films': 'filmotheque',
            'disques': 'discotheque'
        };

        let dashboardData = null;
        let userRole = null;
        let accessibleModules = [];

        // Recupere les couleurs dynamiques des modules depuis admin-template.js
        function loadModuleColorsIntoConfig() {
            if (typeof getModuleColor === 'function') {
                Object.keys(MODULE_CONFIG).forEach(mod => {
                    MODULE_CONFIG[mod].color = getModuleColor(mod);
                    MODULE_CONFIG[mod].textColor = typeof getModuleTextColor === 'function' ? getModuleTextColor(mod) : '#ffffff';
                });
            }
        }

        // Parse modules_actifs qui peut etre un array ou une string JSON (MariaDB)
        function parseModulesActifs(modules) {
            if (!modules) return null;
            if (Array.isArray(modules)) return modules;
            if (typeof modules === 'string') {
                try {
                    const parsed = JSON.parse(modules);
                    return Array.isArray(parsed) ? parsed : null;
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // Filtre les modules selon la structure selectionnee
        function getStructureModules() {
            if (!window.CURRENT_STRUCTURE_ID) {
                // Pas de structure selectionnee = tous les modules de l'API
                return null;
            }
            const currentStructure = window.USER_STRUCTURES?.find(s => s.id === window.CURRENT_STRUCTURE_ID);
            const modules = parseModulesActifs(currentStructure?.modules_actifs);
            if (!modules) {
                return null;
            }
            return modules.map(m => COLLECTION_TO_MODULE[m] || m);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initTemplate('statistiques');
            // Charger les couleurs des modules
            loadModuleColorsIntoConfig();
            // Recuperer le role depuis le token
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    userRole = payload.role;
                } catch (e) {
                    console.error('Error parsing token:', e);
                }
            }
            loadStatistics();
        });

        async function loadStatistics() {
            try {
                // Charger le dashboard principal
                dashboardData = await apiRequest('/stats/dashboard');
                accessibleModules = dashboardData.accessibleModules || [];

                // Generer les onglets des modules accessibles
                renderModuleTabs();

                // Afficher les stats globales
                renderGlobalStats();

                // Charger le graphique global
                loadGlobalMonthlyStats();

                // Charger les stats comptables si comptable+
                if (isComptable()) {
                    document.getElementById('comptabiliteSection').classList.remove('d-none');
                    loadComptabiliteStats();
                }
            } catch (error) {
                showAlert('Erreur lors du chargement des statistiques: ' + error.message, 'danger');
            }
        }

        function isComptable() {
            const comptableRoles = ['comptable', 'administrateur'];
            return comptableRoles.includes(userRole);
        }

        function renderModuleTabs() {
            const tabsContainer = document.getElementById('statsTabs');
            const contentContainer = document.getElementById('statsTabContent');

            // Filtrer les modules selon la structure selectionnee
            const structureModules = getStructureModules();
            const filteredModules = structureModules
                ? accessibleModules.filter(m => structureModules.includes(m))
                : accessibleModules;

            // Ajouter les onglets pour chaque module accessible
            filteredModules.forEach(moduleCode => {
                const config = MODULE_CONFIG[moduleCode];
                if (!config) return;

                // Couleurs dynamiques
                const bgColor = config.color || '#6c757d';
                const textColor = config.textColor || '#ffffff';

                // Ajouter l'onglet
                const tabLi = document.createElement('li');
                tabLi.className = 'nav-item';
                tabLi.setAttribute('role', 'presentation');
                tabLi.innerHTML = `
                    <button class="nav-link" id="${moduleCode}-tab" data-bs-toggle="pill"
                            data-bs-target="#${moduleCode}" type="button" role="tab"
                            onclick="loadModuleStats('${moduleCode}')"
                            style="--tab-color: ${bgColor}; --tab-text: ${textColor};">
                        <i class="bi bi-${config.icon} tab-icon me-2" style="color: ${bgColor};"></i>${config.label}
                    </button>
                `;
                tabsContainer.appendChild(tabLi);

                // Ajouter le contenu de l'onglet
                const tabPane = document.createElement('div');
                tabPane.className = 'tab-pane fade';
                tabPane.id = moduleCode;
                tabPane.setAttribute('role', 'tabpanel');
                tabPane.innerHTML = `
                    <div id="${moduleCode}-content">
                        <div class="text-center p-5">
                            <div class="spinner-border" style="color: ${bgColor};" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2 text-muted">Chargement des statistiques ${config.label}...</p>
                        </div>
                    </div>
                `;
                contentContainer.appendChild(tabPane);
            });

            // Afficher le resume par module dans l'onglet general
            renderModulesSummary();
        }

        function renderModulesSummary() {
            const container = document.getElementById('modulesSummary');

            // Filtrer les modules selon la structure selectionnee
            const structureModules = getStructureModules();
            const filteredModules = structureModules
                ? accessibleModules.filter(m => structureModules.includes(m))
                : accessibleModules;

            if (filteredModules.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-warning">Aucun module accessible pour cette structure</div></div>';
                return;
            }

            container.innerHTML = filteredModules.map(moduleCode => {
                const config = MODULE_CONFIG[moduleCode];
                if (!config) return '';

                const moduleStats = dashboardData.modules?.[moduleCode];
                const total = moduleStats?.collection?.total || 0;
                const disponibles = moduleStats?.collection?.disponibles || 0;
                const emprunts = moduleStats?.emprunts?.enCours || 0;
                const retards = moduleStats?.emprunts?.enRetard || 0;
                const moduleColor = config.color || '#6c757d';

                return `
                    <div class="col-md-3 col-6">
                        <div class="card stat-card h-100" style="border-left: 4px solid ${moduleColor};">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-${config.icon} fs-4 me-2" style="color: ${moduleColor};"></i>
                                    <h6 class="mb-0">${config.label}</h6>
                                </div>
                                <div class="row text-center">
                                    <div class="col-6 border-end">
                                        <h4 class="mb-0" style="color: ${moduleColor};">${total}</h4>
                                        <small class="text-muted">${config.itemLabel}</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="mb-0">${emprunts}</h4>
                                        <small class="text-muted">emprunts</small>
                                    </div>
                                </div>
                                ${retards > 0 ? `<div class="text-danger text-center mt-2"><small><i class="bi bi-exclamation-triangle"></i> ${retards} en retard</small></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGlobalStats() {
            document.getElementById('statTotalAdherents').textContent = dashboardData.utilisateurs?.total || 0;
            document.getElementById('statAdherentsActifs').textContent = dashboardData.utilisateurs?.actifs || 0;
            document.getElementById('statTotalCollection').textContent = dashboardData.global?.collection?.total || 0;
            document.getElementById('statEmpruntsEnCours').textContent = dashboardData.global?.emprunts?.enCours || 0;

            // Details supplementaires
            const retards = dashboardData.global?.emprunts?.enRetard || 0;
            if (retards > 0) {
                document.getElementById('statRetards').innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${retards} en retard`;
            }

            // Details collection par module (filtre par structure)
            const structureModules = getStructureModules();
            const modulesToShow = structureModules
                ? accessibleModules.filter(m => structureModules.includes(m))
                : accessibleModules;
            const details = modulesToShow.map(m => {
                const count = dashboardData.modules?.[m]?.collection?.total || 0;
                return count > 0 ? `${count} ${MODULE_CONFIG[m]?.itemLabel || m}` : null;
            }).filter(Boolean);
            if (details.length > 0) {
                document.getElementById('statCollectionDetails').textContent = details.join(', ');
            }
        }

        async function loadGlobalMonthlyStats() {
            try {
                const data = await apiRequest('/stats/monthly?months=12');
                const monthly = data.data || [];
                renderBarChart('globalMonthlyChart', monthly, 'primary');
            } catch (error) {
                console.error('Error loading global monthly stats:', error);
                document.getElementById('globalMonthlyChart').innerHTML =
                    '<p class="text-center text-muted">Erreur de chargement</p>';
            }
        }

        async function loadModuleStats(moduleCode) {
            const config = MODULE_CONFIG[moduleCode];
            const container = document.getElementById(`${moduleCode}-content`);
            const moduleStats = dashboardData.modules?.[moduleCode];

            if (!config || !moduleStats) {
                container.innerHTML = '<div class="alert alert-warning">Donnees non disponibles pour ce module</div>';
                return;
            }

            const collection = moduleStats.collection;
            const emprunts = moduleStats.emprunts;
            const disponibilite = collection.total > 0 ? ((collection.disponibles / collection.total) * 100).toFixed(1) : 0;
            const moduleColor = config.color || '#6c757d';

            // Generer le contenu de l'onglet
            container.innerHTML = `
                <!-- Stats du module -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="card stat-card" style="border-left: 4px solid ${moduleColor};">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Total ${config.itemLabel}</h6>
                                <h3 class="mb-0" style="color: ${moduleColor};">${collection.total}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card border-success stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Disponibles</h6>
                                <h3 class="mb-0 text-success">${collection.disponibles}</h3>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-success" style="width: ${disponibilite}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card border-info stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Empruntes</h6>
                                <h3 class="mb-0 text-info">${collection.empruntes}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card border-danger stat-card">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">En Retard</h6>
                                <h3 class="mb-0 text-danger">${emprunts.enRetard}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top emprunts et usagers -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-trophy" style="color: ${moduleColor};"></i>
                                    Top 10 ${config.itemLabel} les plus empruntes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="${moduleCode}-topItems">
                                    <div class="text-center p-4">
                                        <div class="spinner-border spinner-border-sm" style="color: ${moduleColor};" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-star text-warning"></i>
                                    Top 10 Usagers les Plus Actifs
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="${moduleCode}-topAdherents">
                                    <div class="text-center p-4">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nouveautes -->
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <div class="card nouveautes-card">
                            <div class="card-header bg-success bg-opacity-10">
                                <h5 class="card-title mb-0 text-success">
                                    <i class="bi bi-stars"></i> Nouveautes - Emprunts recents
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="${moduleCode}-nouveautes">
                                    <div class="text-center p-4">
                                        <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories / Editeurs -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-pie-chart" style="color: ${moduleColor};"></i>
                                    Repartition par Categorie
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="${moduleCode}-categories">
                                    <div class="text-center p-4">
                                        <div class="spinner-border spinner-border-sm" style="color: ${moduleColor};" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-building" style="color: ${moduleColor};"></i>
                                    Top Editeurs
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="${moduleCode}-editeurs">
                                    <div class="text-center p-4">
                                        <div class="spinner-border spinner-border-sm" style="color: ${moduleColor};" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique mensuel -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart" style="color: ${moduleColor};"></i>
                            Emprunts Mensuels (12 derniers mois)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="${moduleCode}-monthly">
                            <div class="text-center p-4">
                                <div class="spinner-border" style="color: ${moduleColor};" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Charger les donnees
            loadModuleDetails(moduleCode, config);
        }

        async function loadModuleDetails(moduleCode, config) {
            await Promise.all([
                loadTopItems(moduleCode, config),
                loadTopAdherents(moduleCode),
                loadNouveautes(moduleCode, config),
                loadCategories(moduleCode, config),
                loadEditeurs(moduleCode, config),
                loadMonthlyStats(moduleCode, config)
            ]);
        }

        async function loadTopItems(moduleCode, config) {
            try {
                const data = await apiRequest(`/stats/popular-items?module=${moduleCode}&limit=10`);
                const items = data.items || [];
                const container = document.getElementById(`${moduleCode}-topItems`);
                const moduleColor = config.color || '#6c757d';

                if (items.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Aucune donnee disponible</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="list-group list-group-flush">
                        ${items.map((entry, index) => `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <span class="badge rounded-pill me-2" style="background-color: ${moduleColor}; color: ${config.textColor || '#ffffff'};">${index + 1}</span>
                                    <strong>${entry.item?.titre || 'N/A'}</strong>
                                </div>
                                <span class="badge bg-info rounded-pill">${entry.emprunts} emprunts</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading top items:', error);
                document.getElementById(`${moduleCode}-topItems`).innerHTML = '<p class="text-center text-muted">Erreur de chargement</p>';
            }
        }

        async function loadTopAdherents(moduleCode) {
            try {
                const data = await apiRequest(`/stats/active-members?module=${moduleCode}&limit=10`);
                const members = data.members || [];
                const container = document.getElementById(`${moduleCode}-topAdherents`);

                if (members.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Aucune donnee disponible</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="list-group list-group-flush">
                        ${members.map((entry, index) => `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <span class="badge bg-primary rounded-pill me-2">${index + 1}</span>
                                    <strong>${entry.utilisateur?.prenom || ''} ${entry.utilisateur?.nom || 'N/A'}</strong>
                                </div>
                                <span class="badge bg-success rounded-pill">${entry.emprunts} emprunts</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading top adherents:', error);
                document.getElementById(`${moduleCode}-topAdherents`).innerHTML = '<p class="text-center text-muted">Erreur de chargement</p>';
            }
        }

        async function loadNouveautes(moduleCode, config) {
            const container = document.getElementById(`${moduleCode}-nouveautes`);
            try {
                const data = await apiRequest(`/stats/nouveautes?module=${moduleCode}&limit=10`);
                const items = data.items || [];

                if (items.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Pas de nouveautes recentes</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="list-group list-group-flush">
                        ${items.map(item => `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <strong>${item.titre || 'N/A'}</strong>
                                    ${item.date_acquisition ? `<br><small class="text-muted">Acquis le ${new Date(item.date_acquisition).toLocaleDateString('fr-FR')}</small>` : ''}
                                </div>
                                <span class="badge bg-success rounded-pill">${item.emprunts_count || 0} emprunts</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading nouveautes:', error);
                container.innerHTML = '<p class="text-center text-muted">Donnees non disponibles</p>';
            }
        }

        async function loadCategories(moduleCode, config) {
            try {
                const data = await apiRequest(`/stats/categories?module=${moduleCode}`);
                const categories = data.categories || [];
                const container = document.getElementById(`${moduleCode}-categories`);
                const moduleColor = config.color || '#6c757d';

                if (categories.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Aucune donnee disponible</p>';
                    return;
                }

                const total = categories.reduce((sum, c) => sum + c.count, 0);

                container.innerHTML = `
                    <div class="row">
                        ${categories.slice(0, 8).map(cat => {
                            const percentage = ((cat.count / total) * 100).toFixed(1);
                            return `
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-truncate" style="max-width: 120px;" title="${cat.categorie || 'Non categorise'}">${cat.categorie || 'Non categorise'}</span>
                                        <small class="text-muted">${cat.count}</small>
                                    </div>
                                    <div class="progress progress-thin">
                                        <div class="progress-bar" style="width: ${percentage}%; background-color: ${moduleColor};"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById(`${moduleCode}-categories`).innerHTML = '<p class="text-center text-muted">Erreur de chargement</p>';
            }
        }

        async function loadEditeurs(moduleCode, config) {
            const container = document.getElementById(`${moduleCode}-editeurs`);
            const moduleColor = config.color || '#6c757d';
            try {
                const data = await apiRequest(`/stats/editeurs?module=${moduleCode}&limit=8`);
                const editeurs = data.editeurs || [];

                if (editeurs.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Aucune donnee disponible</p>';
                    return;
                }

                const total = editeurs.reduce((sum, e) => sum + e.count, 0);

                container.innerHTML = `
                    <div class="row">
                        ${editeurs.map(ed => {
                            const percentage = ((ed.count / total) * 100).toFixed(1);
                            return `
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-truncate" style="max-width: 120px;" title="${ed.editeur || 'Non renseigne'}">${ed.editeur || 'Non renseigne'}</span>
                                        <small class="text-muted">${ed.count}</small>
                                    </div>
                                    <div class="progress progress-thin">
                                        <div class="progress-bar" style="width: ${percentage}%; background-color: ${moduleColor};"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading editeurs:', error);
                container.innerHTML = '<p class="text-center text-muted">Donnees non disponibles</p>';
            }
        }

        async function loadMonthlyStats(moduleCode, config) {
            try {
                const data = await apiRequest(`/stats/monthly?module=${moduleCode}&months=12`);
                const monthly = data.data || [];
                renderBarChart(`${moduleCode}-monthly`, monthly, config.color);
            } catch (error) {
                console.error('Error loading monthly stats:', error);
                document.getElementById(`${moduleCode}-monthly`).innerHTML = '<p class="text-center text-muted">Erreur de chargement</p>';
            }
        }

        function renderBarChart(containerId, monthly, color) {
            const container = document.getElementById(containerId);

            if (monthly.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Aucune donnee disponible</p>';
                return;
            }

            const maxValue = Math.max(...monthly.map(m => m.emprunts), 1);
            const monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Support both Bootstrap classes (e.g., 'primary') and hex colors (e.g., '#6f42c1')
            const isHexColor = color && color.startsWith('#');
            const barClass = isHexColor ? '' : `bg-${color}`;
            const barStyle = isHexColor ? `background-color: ${color};` : '';

            container.innerHTML = `
                <div class="d-flex align-items-end justify-content-around" style="height: 200px;">
                    ${monthly.map(m => {
                        const height = (m.emprunts / maxValue) * 100;
                        const [year, month] = m.month.split('-');
                        const label = monthNames[parseInt(month) - 1];
                        return `
                            <div class="text-center" style="flex: 1; max-width: 60px;">
                                <div class="${barClass} rounded-top mx-1 chart-bar"
                                     style="height: ${Math.max(height, 5)}%; min-height: 5px; ${barStyle}"
                                     title="${m.emprunts} emprunts">
                                </div>
                                <small class="text-muted d-block mt-1">${label}</small>
                                <small class="fw-bold">${m.emprunts}</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function loadComptabiliteStats() {
            try {
                const currentYear = new Date().getFullYear();
                const data = await apiRequest(`/stats/cotisations?year=${currentYear}`);

                document.getElementById('comptaYear').textContent = currentYear;
                document.getElementById('comptaCA').textContent = `${data.summary?.totalCA || 0} EUR`;

                const actives = data.summary?.byStatus?.find(s => s.statut === 'en_cours');
                document.getElementById('comptaCotisationsActives').textContent = actives?.count || 0;

                // Cotisations du mois en cours
                const currentMonth = new Date().toISOString().slice(0, 7);
                const thisMonth = data.monthly?.find(m => m.month === currentMonth);
                document.getElementById('comptaCotisationsMois').textContent = thisMonth?.count || 0;

                // Graphique mensuel
                renderComptaMensuel(data.monthly || []);
            } catch (error) {
                console.error('Error loading comptabilite stats:', error);
                document.getElementById('comptabiliteSection').innerHTML = `
                    <div class="alert alert-danger">Erreur de chargement des statistiques comptables</div>
                `;
            }
        }

        function renderComptaMensuel(monthly) {
            const container = document.getElementById('comptaMensuelChart');

            if (monthly.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Aucune donnee disponible</p>';
                return;
            }

            const maxValue = Math.max(...monthly.map(m => parseFloat(m.total)), 1);
            const monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

            container.innerHTML = `
                <div class="d-flex align-items-end justify-content-around" style="height: 200px;">
                    ${monthly.map(m => {
                        const height = (parseFloat(m.total) / maxValue) * 100;
                        const [year, month] = m.month.split('-');
                        const label = monthNames[parseInt(month) - 1];
                        return `
                            <div class="text-center" style="flex: 1; max-width: 80px;">
                                <div class="bg-success rounded-top mx-1 chart-bar"
                                     style="height: ${Math.max(height, 5)}%; min-height: 5px;"
                                     title="${m.total} EUR - ${m.count} cotisations">
                                </div>
                                <small class="text-muted d-block mt-1">${label}</small>
                                <small class="fw-bold">${m.total} EUR</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function refreshStats() {
            loadStatistics();
            showAlert('Statistiques actualisees', 'success');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</body>
</html>
