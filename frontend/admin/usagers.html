<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Usagers - Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    /* Style pour les tags checkbox */
    .tag-checkbox {
      display: none;
    }
    .tag-label {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.35rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      border: 2px solid var(--tag-color, #6c757d);
      background-color: white;
      color: #333;
      transition: all 0.2s;
    }
    .tag-label:hover {
      background-color: color-mix(in srgb, var(--tag-color, #6c757d) 15%, white);
    }
    .tag-checkbox:checked + .tag-label {
      background-color: var(--tag-color, #6c757d);
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .tag-label i {
      font-size: 0.9rem;
    }
    /* Bouton ajout tag */
    .add-tag-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-style: dashed;
    }
    .add-tag-btn:hover {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: white;
    }
    /* Badge tags dans la liste */
    .user-tag-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.15rem;
      padding: 0.15rem 0.5rem;
      border-radius: 0.75rem;
      font-size: 0.75rem;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Navigation (généré par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (généré par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <div class="mb-4">
          <h1>Gestion des Usagers</h1>
        </div>

        <!-- Actions Bar -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-2">
              <!-- Ligne 1: Actions principales -->
              <div class="col-12 d-flex justify-content-between align-items-center">
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle"></i> Nouvel usager
                  </button>
                  <button class="btn btn-outline-success" onclick="exportAdherentsCSV()">
                    <i class="bi bi-download"></i> Exporter CSV
                  </button>
                  <button class="btn btn-secondary" onclick="loadAdherents()">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                  </button>
                </div>
                <div class="d-flex gap-2 align-items-center">
                  <span class="badge bg-info" id="adherentsCount">0 usager(s)</span>
                  <button class="btn btn-outline-primary btn-sm" onclick="toggleFilters()">
                    <i class="bi bi-funnel"></i> <span id="filterToggleText">Afficher filtres</span>
                  </button>
                </div>
              </div>

              <!-- Ligne 2: Filtres (masqués par défaut) -->
              <div class="col-12" id="filtersSection" style="display: none;">
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="row g-2">
                      <div class="col-md-3">
                        <label class="form-label small">Recherche</label>
                        <input
                          type="text"
                          id="searchInput"
                          class="form-control form-control-sm"
                          placeholder="Nom, prénom, email..."
                          onkeyup="handleSearch()"
                        >
                      </div>
                      <div class="col-md-2">
                        <label class="form-label small">Statut</label>
                        <select id="statutFilter" class="form-select form-select-sm" onchange="pagination && pagination.reset(); loadAdherents()">
                          <option value="">Tous</option>
                          <option value="actif">Actif</option>
                          <option value="inactif">Inactif</option>
                          <option value="suspendu">Suspendu</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label small">Role</label>
                        <select id="roleFilter" class="form-select form-select-sm" onchange="pagination && pagination.reset(); loadAdherents()">
                          <option value="">Tous</option>
                          <option value="usager">Usager</option>
                          <option value="benevole">Bénévole</option>
                          <option value="agent">Agent</option>
                          <option value="gestionnaire">Gestionnaire</option>
                          <option value="comptable">Comptable</option>
                          <option value="administrateur">Administrateur</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label small">Membre asso.</label>
                        <select id="assocFilter" class="form-select form-select-sm" onchange="pagination && pagination.reset(); loadAdherents()">
                          <option value="">Tous</option>
                          <option value="true">Oui</option>
                          <option value="false">Non</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small">Actions</label>
                        <div class="d-flex gap-1">
                          <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="resetFilters()">
                            <i class="bi bi-x-circle"></i> Réinitialiser
                          </button>
                        </div>
                      </div>
                    </div>
                    <!-- Ligne 2: Filtres supplementaires -->
                    <div class="row g-2 mt-2">
                      <div class="col-md-2">
                        <label class="form-label small">Sexe</label>
                        <select id="sexeFilter" class="form-select form-select-sm" onchange="pagination && pagination.reset(); loadAdherents()">
                          <option value="">Tous</option>
                          <option value="M">Masculin</option>
                          <option value="F">Feminin</option>
                          <option value="A">Autre</option>
                          <option value="N">Non precise</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small">Tag</label>
                        <select id="tagFilter" class="form-select form-select-sm" onchange="pagination && pagination.reset(); loadAdherents()">
                          <option value="">Tous les tags</option>
                          <!-- Options chargees dynamiquement -->
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="mb-2"></div>

        <!-- Adherents List -->
        <div class="card">
          <div class="card-body">
            <div id="adherentsList">
              <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Chargement des usagers...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal fade" id="adherentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Nouvel usager</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="adherentForm">
            <input type="hidden" id="adherentId">

            <!-- Recherche usager externe -->
            <div class="card mb-4" id="searchExternalCard">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-search"></i> Recherche usager externe
                </h6>
                <p class="small text-muted">
                  Recherchez un usager existant dans le systeme externe pour pre-remplir le formulaire
                </p>
                <div class="input-group">
                  <input
                    type="text"
                    id="numeroAdherentExterne"
                    class="form-control"
                    placeholder="Numero d'usager (optionnel)"
                  >
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    onclick="rechercherEtChargerAdherent()"
                    id="btnRechercheExterne"
                  >
                    <i class="bi bi-search"></i> Rechercher
                  </button>
                </div>
                <small class="text-muted">Exemple: TEST123 pour tester</small>
              </div>
            </div>

            <!-- Onglets -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-infos-btn" data-bs-toggle="tab" data-bs-target="#tab-infos" type="button">
                  <i class="bi bi-person"></i> Informations personnelles
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-adhesion-btn" data-bs-toggle="tab" data-bs-target="#tab-adhesion" type="button">
                  <i class="bi bi-calendar-check"></i> Adhésion
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-notes-btn" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button">
                  <i class="bi bi-journal-text"></i> Notes
                </button>
              </li>
            </ul>

            <!-- Contenu des onglets -->
            <div class="tab-content">
              <!-- Onglet: Informations personnelles -->
              <div class="tab-pane fade show active" id="tab-infos">
                <!-- Alerte champs obligatoires pour facturation -->
                <div class="alert alert-info py-2 mb-3">
                  <i class="bi bi-info-circle me-1"></i>
                  <small>Les champs marques * sont obligatoires pour la facturation.</small>
                </div>

                <div class="row mb-3">
                  <div class="col-md-2">
                    <label for="civilite" class="form-label">Civilite</label>
                    <select id="civilite" class="form-select">
                      <option value="N">-</option>
                      <option value="M">M.</option>
                      <option value="F">Mme</option>
                      <option value="A">Mx</option>
                    </select>
                  </div>
                  <div class="col-md-5">
                    <label for="nom" class="form-label">Nom *</label>
                    <input type="text" id="nom" class="form-control" required>
                  </div>
                  <div class="col-md-5">
                    <label for="prenom" class="form-label">Prenom *</label>
                    <input type="text" id="prenom" class="form-control" required>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="email" class="form-label">Email *</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                      <input type="email" id="email" class="form-control" required>
                    </div>
                    <small class="text-muted">Un email de bienvenue sera envoye automatiquement</small>
                  </div>
                  <div class="col-md-6">
                    <label for="telephone" class="form-label">Telephone</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                      <input type="tel" id="telephone" class="form-control" placeholder="+33 6 12 34 56 78">
                    </div>
                    <small class="text-muted">Format: +33 6 12 34 56 78 ou 06 12 34 56 78</small>
                  </div>
                </div>

                <div class="mb-3" id="passwordGroup">
                  <label for="password" class="form-label">Mot de passe *</label>
                  <div class="input-group">
                    <input type="password" id="password" class="form-control">
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="generatePassword" title="Generer un mot de passe securise">
                      <i class="bi bi-key"></i> Generer
                    </button>
                  </div>
                  <div class="mt-2">
                    <div class="progress" style="height: 5px;">
                      <div id="passwordStrength" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <small id="passwordStrengthLabel" class="text-muted"></small>
                  </div>
                </div>

                <hr class="my-3">
                <h6 class="text-muted mb-3"><i class="bi bi-geo-alt me-1"></i>Adresse postale (pour la facturation)</h6>

                <div class="mb-3">
                  <label for="adresse" class="form-label">Adresse</label>
                  <textarea id="adresse" class="form-control" rows="2" placeholder="Numero et rue"></textarea>
                </div>

                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="code_postal" class="form-label">Code postal</label>
                    <input type="text" id="code_postal" class="form-control" placeholder="75001" maxlength="5">
                  </div>
                  <div class="col-md-8">
                    <label for="ville" class="form-label">Ville</label>
                    <input type="text" id="ville" class="form-control" placeholder="Paris">
                  </div>
                </div>

                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="commune_prise_en_charge_differente" onchange="toggleCommunePriseEnCharge()">
                    <label class="form-check-label" for="commune_prise_en_charge_differente">
                      <i class="bi bi-geo-alt-fill text-info"></i> Commune de prise en charge differente
                    </label>
                  </div>
                </div>

                <div class="row mb-3" id="communePriseEnChargeFields" style="display: none;">
                  <div class="col-md-4">
                    <label for="code_postal_prise_en_charge" class="form-label">CP prise en charge</label>
                    <input type="text" id="code_postal_prise_en_charge" class="form-control" placeholder="74140" maxlength="5">
                  </div>
                  <div class="col-md-8">
                    <label for="ville_prise_en_charge" class="form-label">Ville prise en charge</label>
                    <input type="text" id="ville_prise_en_charge" class="form-control" placeholder="Sciez">
                  </div>
                </div>

                <hr class="my-3">
                <h6 class="text-muted mb-3"><i class="bi bi-person-badge me-1"></i>Informations complementaires</h6>

                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="date_naissance" class="form-label">Date de naissance</label>
                    <input type="date" id="date_naissance" class="form-control">
                    <small id="ageDisplay" class="text-muted"></small>
                  </div>
                  <div class="col-md-4">
                    <label for="photo_url" class="form-label">Photo (URL)</label>
                    <input type="url" id="photo_url" class="form-control" placeholder="https://...">
                    <small class="text-muted">URL de la photo de l'usager</small>
                  </div>
                </div>

                <!-- Previsualisation photo -->
                <div class="mb-3" id="photoPreview" style="display: none;">
                  <label class="form-label">Previsualisation</label>
                  <div>
                    <img id="photoPreviewImg" src="" alt="Photo" class="img-thumbnail" style="max-width: 150px;">
                  </div>
                </div>
              </div>

              <!-- Onglet: Adhésion -->
              <div class="tab-pane fade" id="tab-adhesion">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="statut" class="form-label">Statut *</label>
                    <select id="statut" class="form-select" required>
                      <option value="actif">Actif</option>
                      <option value="inactif">Inactif</option>
                      <option value="suspendu">Suspendu</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="role" class="form-label">Rôle *</label>
                    <select id="role" class="form-select" required onchange="toggleModulesSection()">
                      <option value="usager">Usager</option>
                      <option value="benevole">Bénévole</option>
                      <option value="agent">Agent (accueil/scan)</option>
                      <option value="gestionnaire">Gestionnaire</option>
                      <option value="comptable">Comptable</option>
                      <option value="administrateur">Administrateur</option>
                    </select>
                    <small class="text-muted">Détermine les permissions sur le site</small>
                  </div>
                </div>

                <!-- Section Modules Autorisés (visible pour agent, gestionnaire, comptable) -->
                <div class="mb-3" id="modulesSection" style="display: none;">
                  <label class="form-label">Modules autorisés</label>
                  <div class="alert alert-info py-2">
                    <i class="bi bi-info-circle"></i>
                    <small>Sélectionnez les modules auxquels cet utilisateur aura accès. Si aucun n'est coché, il aura accès à tous les modules.</small>
                  </div>
                  <div class="row">
                    <div class="col-md-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="module_ludotheque" value="ludotheque">
                        <label class="form-check-label" for="module_ludotheque">
                          <i class="bi bi-puzzle text-warning"></i> Ludothèque
                        </label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="module_bibliotheque" value="bibliotheque">
                        <label class="form-check-label" for="module_bibliotheque">
                          <i class="bi bi-book text-success"></i> Bibliothèque
                        </label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="module_filmotheque" value="filmotheque">
                        <label class="form-check-label" for="module_filmotheque">
                          <i class="bi bi-film text-danger"></i> Filmothèque
                        </label>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="module_discotheque" value="discotheque">
                        <label class="form-check-label" for="module_discotheque">
                          <i class="bi bi-disc text-primary"></i> Discothèque
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Section Tags -->
                <div class="mb-3" id="tagsSection">
                  <label class="form-label"><i class="bi bi-tags me-1"></i>Tags</label>
                  <small class="text-muted d-block mb-2">
                    Selectionnez les tags applicables (salarie, benevole actif, handicap, etc.)
                  </small>
                  <div class="d-flex flex-wrap gap-2" id="tagsContainer">
                    <span class="text-muted small">Chargement des tags...</span>
                  </div>
                </div>

                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="adhesion_association">
                    <label class="form-check-label" for="adhesion_association">
                      Membre de l'association
                    </label>
                    <br>
                    <small class="text-muted">Permet de bénéficier de réductions sur les cotisations</small>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="date_adhesion" class="form-label">Date d'adhésion</label>
                    <input type="date" id="date_adhesion" class="form-control">
                    <small class="text-muted">Aujourd'hui par défaut</small>
                  </div>
                  <div class="col-md-6">
                    <label for="date_fin_adhesion" class="form-label">Date de fin d'adhésion</label>
                    <input type="date" id="date_fin_adhesion" class="form-control">
                    <small class="text-muted">Optionnel</small>
                  </div>
                </div>
              </div>

              <!-- Onglet: Notes -->
              <div class="tab-pane fade" id="tab-notes">
                <div class="mb-3">
                  <label for="notes" class="form-label">Notes internes</label>
                  <textarea id="notes" class="form-control" rows="6" placeholder="Notes visibles uniquement par les gestionnaires..."></textarea>
                  <small class="text-muted">Ces notes ne sont pas visibles par l'usager</small>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" form="adherentForm" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Envoi Email -->
  <div class="modal fade" id="sendEmailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-envelope"></i> Envoyer un email
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="emailForm">
            <input type="hidden" id="email-adherent-id">

            <!-- Destinataire -->
            <div class="mb-3">
              <label class="form-label">Destinataire</label>
              <input type="text" class="form-control" id="email-destinataire" readonly>
            </div>

            <!-- Mode de saisie -->
            <div class="mb-3">
              <label class="form-label">Mode de saisie</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="email-mode" id="email-mode-template" value="template" checked>
                <label class="btn btn-outline-primary" for="email-mode-template">
                  <i class="bi bi-file-text"></i> Utiliser un template
                </label>

                <input type="radio" class="btn-check" name="email-mode" id="email-mode-manual" value="manual">
                <label class="btn btn-outline-primary" for="email-mode-manual">
                  <i class="bi bi-pencil"></i> Saisie manuelle
                </label>
              </div>
            </div>

            <!-- Section Template -->
            <div id="email-template-section">
              <div class="mb-3">
                <label for="email-template-select" class="form-label">Choisir un template</label>
                <select class="form-select" id="email-template-select">
                  <option value="">Chargement...</option>
                </select>
              </div>
              <div class="alert alert-info" id="email-template-preview" style="display: none;">
                <strong>Aperçu :</strong>
                <p class="mb-1"><strong>Objet :</strong> <span id="email-preview-subject"></span></p>
                <p class="mb-0"><strong>Contenu :</strong></p>
                <div id="email-preview-body" style="max-height: 150px; overflow-y: auto;"></div>
              </div>
            </div>

            <!-- Section Manuelle -->
            <div id="email-manual-section" style="display: none;">
              <div class="mb-3">
                <label for="email-subject" class="form-label">Objet *</label>
                <input type="text" class="form-control" id="email-subject" placeholder="Objet de l'email">
              </div>
              <div class="mb-3">
                <label for="email-body" class="form-label">Message *</label>
                <textarea class="form-control" id="email-body" rows="8" placeholder="Contenu de l'email (HTML accepté)"></textarea>
                <small class="text-muted">Vous pouvez utiliser du HTML pour la mise en forme</small>
              </div>
            </div>

            <!-- Variables disponibles -->
            <div class="alert alert-light border">
              <strong><i class="bi bi-info-circle"></i> Variables disponibles :</strong>
              <code>{{prenom}}</code>, <code>{{nom}}</code>, <code>{{email}}</code>, <code>{{code_barre}}</code>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="sendEmailToAdherent()">
            <i class="bi bi-send"></i> Envoyer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Envoi SMS -->
  <div class="modal fade" id="sendSmsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-chat-dots"></i> Envoyer un SMS
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="smsForm">
            <input type="hidden" id="sms-adherent-id">

            <!-- Destinataire -->
            <div class="mb-3">
              <label class="form-label">Destinataire</label>
              <input type="text" class="form-control" id="sms-destinataire" readonly>
            </div>

            <!-- Mode de saisie -->
            <div class="mb-3">
              <label class="form-label">Mode de saisie</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="sms-mode" id="sms-mode-template" value="template" checked>
                <label class="btn btn-outline-primary" for="sms-mode-template">
                  <i class="bi bi-file-text"></i> Utiliser un template
                </label>

                <input type="radio" class="btn-check" name="sms-mode" id="sms-mode-manual" value="manual">
                <label class="btn btn-outline-primary" for="sms-mode-manual">
                  <i class="bi bi-pencil"></i> Saisie manuelle
                </label>
              </div>
            </div>

            <!-- Section Template -->
            <div id="sms-template-section">
              <div class="mb-3">
                <label for="sms-template-select" class="form-label">Choisir un template</label>
                <select class="form-select" id="sms-template-select">
                  <option value="">Chargement...</option>
                </select>
              </div>
              <div class="alert alert-info" id="sms-template-preview" style="display: none;">
                <strong>Aperçu :</strong>
                <p class="mb-0" id="sms-preview-body"></p>
              </div>
            </div>

            <!-- Section Manuelle -->
            <div id="sms-manual-section" style="display: none;">
              <div class="mb-3">
                <label for="sms-body" class="form-label">Message *</label>
                <textarea class="form-control" id="sms-body" rows="4" placeholder="Contenu du SMS" maxlength="160"></textarea>
                <div class="d-flex justify-content-between">
                  <small class="text-muted">Maximum 160 caractères</small>
                  <small class="text-muted"><span id="sms-char-count">0</span>/160</small>
                </div>
              </div>
            </div>

            <!-- Variables disponibles -->
            <div class="alert alert-light border">
              <strong><i class="bi bi-info-circle"></i> Variables disponibles :</strong>
              <code>{{prenom}}</code>, <code>{{nom}}</code>, <code>{{telephone}}</code>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="sendSmsToAdherent()">
            <i class="bi bi-send"></i> Envoyer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Visualisation Détaillée -->
  <div class="modal fade" id="viewAdherentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person-badge"></i> Details de l'usager
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Colonne gauche: Photo et infos principales -->
            <div class="col-md-4 text-center border-end">
              <img id="view_photo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Crect fill='%23dee2e6' width='150' height='150'/%3E%3Ccircle cx='75' cy='55' r='30' fill='%236c757d'/%3E%3Cellipse cx='75' cy='130' rx='45' ry='35' fill='%236c757d'/%3E%3C/svg%3E" alt="Photo" class="img-thumbnail mb-3" style="max-width: 150px;">
              <h5 id="view_nom_prenom">-</h5>
              <p class="text-muted mb-2">
                <i class="bi bi-upc-scan"></i> <span id="view_code_barre">-</span>
              </p>
              <div id="view_statut_badge" class="mb-3">
                <span class="badge bg-success">Actif</span>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-primary" id="btn_view_edit">
                  <i class="bi bi-pencil"></i> Modifier
                </button>
                <button class="btn btn-sm btn-outline-info" id="btn_view_print">
                  <i class="bi bi-printer"></i> Imprimer carte
                </button>
              </div>
            </div>

            <!-- Colonne droite: Détails -->
            <div class="col-md-8">
              <!-- Onglets pour organisation -->
              <ul class="nav nav-pills mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#view-tab-info" type="button">
                    <i class="bi bi-info-circle"></i> Infos
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-tab-famille" type="button">
                    <i class="bi bi-people"></i> Famille
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-tab-stats" type="button">
                    <i class="bi bi-graph-up"></i> Statistiques
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-tab-communications" type="button">
                    <i class="bi bi-chat-dots"></i> Communications
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-tab-reservations" type="button" id="view-tab-reservations-btn">
                    <i class="bi bi-bookmark"></i> Reservations <span class="badge bg-warning text-dark" id="view_reservations_badge" style="display: none;">0</span>
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" data-bs-toggle="pill" data-bs-target="#view-tab-actions" type="button">
                    <i class="bi bi-lightning"></i> Actions
                  </button>
                </li>
              </ul>

              <div class="tab-content">
                <!-- Onglet Infos -->
                <div class="tab-pane fade show active" id="view-tab-info">
                  <table class="table table-sm">
                    <tbody>
                      <tr>
                        <th style="width: 40%;"><i class="bi bi-envelope"></i> Email</th>
                        <td id="view_email">-</td>
                      </tr>
                      <tr>
                        <th><i class="bi bi-telephone"></i> Téléphone</th>
                        <td id="view_telephone">-</td>
                      </tr>
                      <tr>
                        <th><i class="bi bi-calendar"></i> Date de naissance</th>
                        <td id="view_date_naissance">-</td>
                      </tr>
                      <tr>
                        <th><i class="bi bi-geo-alt"></i> Adresse</th>
                        <td id="view_adresse_complete">-</td>
                      </tr>
                      <tr>
                        <th><i class="bi bi-shield-check"></i> Rôle</th>
                        <td><span id="view_role" class="badge bg-secondary">-</span></td>
                      </tr>
                      <tr>
                        <th><i class="bi bi-calendar-check"></i> Date d'adhésion</th>
                        <td id="view_date_adhesion">-</td>
                      </tr>
                      <tr>
                        <th><i class="bi bi-building"></i> Membre association</th>
                        <td id="view_adhesion_association">-</td>
                      </tr>
                    </tbody>
                  </table>

                  <div id="view_notes_section" style="display: none;">
                    <h6 class="mt-3"><i class="bi bi-journal-text"></i> Notes internes</h6>
                    <div class="alert alert-info" id="view_notes">-</div>
                  </div>
                </div>

                <!-- Onglet Famille -->
                <div class="tab-pane fade" id="view-tab-famille">
                  <!-- Info si compte enfant -->
                  <div id="view_famille_parent_info" class="alert alert-info d-none">
                    <i class="bi bi-info-circle"></i>
                    <strong>Compte rattache a :</strong>
                    <a href="#" id="view_famille_parent_link" class="alert-link"></a>
                    <span class="badge bg-secondary ms-2" id="view_famille_type_lien"></span>
                  </div>

                  <!-- Actions famille -->
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0"><i class="bi bi-people-fill"></i> Membres de la famille</h6>
                    <button class="btn btn-sm btn-outline-primary" id="btn_lier_membre" onclick="openLierMembreModal()">
                      <i class="bi bi-plus-lg"></i> Lier un membre
                    </button>
                  </div>

                  <!-- Liste des enfants -->
                  <div id="view_famille_enfants_list">
                    <p class="text-muted small">Aucun membre rattache</p>
                  </div>

                  <!-- Tarif famille -->
                  <div id="view_famille_tarif" class="mt-3 d-none">
                    <hr>
                    <div class="card bg-light">
                      <div class="card-body">
                        <h6><i class="bi bi-calculator"></i> Tarif famille</h6>
                        <div class="row text-center">
                          <div class="col-4">
                            <div class="fs-4 text-primary" id="view_famille_nb_membres">0</div>
                            <small class="text-muted">Membres</small>
                          </div>
                          <div class="col-4">
                            <div class="fs-4 text-success" id="view_famille_cout">0 EUR</div>
                            <small class="text-muted">Tarif famille</small>
                          </div>
                          <div class="col-4">
                            <div class="fs-4 text-info" id="view_famille_economie">0 EUR</div>
                            <small class="text-muted">Economie</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Onglet Statistiques -->
                <div class="tab-pane fade" id="view-tab-stats">
                  <div class="row text-center mb-3">
                    <div class="col-4">
                      <div class="card">
                        <div class="card-body">
                          <h3 class="text-primary" id="view_stat_emprunts_total">0</h3>
                          <small class="text-muted">Total emprunts</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="card">
                        <div class="card-body">
                          <h3 class="text-success" id="view_stat_emprunts_en_cours">0</h3>
                          <small class="text-muted">En cours</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="card">
                        <div class="card-body">
                          <h3 class="text-danger" id="view_stat_emprunts_retard">0</h3>
                          <small class="text-muted">En retard</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="view_cotisations_section">
                    <h6><i class="bi bi-credit-card"></i> Cotisations</h6>
                    <div id="view_cotisations_list">
                      <p class="text-muted">Chargement...</p>
                    </div>
                  </div>
                </div>

                <!-- Onglet Communications -->
                <div class="tab-pane fade" id="view-tab-communications">
                  <div id="view_communications_loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Chargement...</span>
                    </div>
                    <span class="ms-2">Chargement de l'historique...</span>
                  </div>
                  <div id="view_communications_content" style="display: none;">
                    <!-- Emails -->
                    <div class="mb-3">
                      <h6 class="d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-envelope text-primary"></i> Emails</span>
                        <span class="badge bg-primary" id="view_emails_count">0</span>
                      </h6>
                      <div id="view_emails_list" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted small">Aucun email</p>
                      </div>
                    </div>

                    <!-- SMS -->
                    <div class="mb-3">
                      <h6 class="d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-chat-dots text-success"></i> SMS</span>
                        <span class="badge bg-success" id="view_sms_count">0</span>
                      </h6>
                      <div id="view_sms_list" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted small">Aucun SMS</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Onglet Reservations -->
                <div class="tab-pane fade" id="view-tab-reservations">
                  <div id="view_reservations_loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Chargement...</span>
                    </div>
                    <span class="ms-2">Chargement des reservations...</span>
                  </div>
                  <div id="view_reservations_content" style="display: none;">
                    <!-- Stats rapides -->
                    <div class="row text-center mb-3">
                      <div class="col-4">
                        <div class="card border-warning">
                          <div class="card-body py-2">
                            <h5 class="text-warning mb-0" id="view_stat_reservations_attente">0</h5>
                            <small class="text-muted">En attente</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-4">
                        <div class="card border-success">
                          <div class="card-body py-2">
                            <h5 class="text-success mb-0" id="view_stat_reservations_prete">0</h5>
                            <small class="text-muted">Pretes</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-4">
                        <div class="card border-secondary">
                          <div class="card-body py-2">
                            <h5 class="text-secondary mb-0" id="view_stat_reservations_total">0</h5>
                            <small class="text-muted">Total actives</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Liste des reservations -->
                    <div id="view_reservations_list" style="max-height: 300px; overflow-y: auto;">
                      <p class="text-muted small">Aucune reservation</p>
                    </div>
                  </div>
                </div>

                <!-- Onglet Actions -->
                <div class="tab-pane fade" id="view-tab-actions">
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="btn_send_email">
                      <i class="bi bi-envelope"></i> Envoyer un email
                    </button>
                    <button class="btn btn-outline-success" id="btn_send_sms">
                      <i class="bi bi-phone"></i> Envoyer un SMS
                    </button>
                    <hr>
                    <button class="btn btn-outline-info" id="btn_new_cotisation">
                      <i class="bi bi-credit-card"></i> Nouvelle cotisation
                    </button>
                    <button class="btn btn-outline-warning" id="btn_new_emprunt">
                      <i class="bi bi-box-arrow-right"></i> Nouveau prêt
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Lier Membre Famille -->
  <div class="modal fade" id="lierMembreModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-people-fill"></i> Lier un membre de la famille</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Recherche -->
          <div class="mb-3">
            <label class="form-label">Rechercher un usager existant</label>
            <input type="text" class="form-control" id="searchMembreFamille"
                   placeholder="Nom, prenom, email..." onkeyup="rechercherMembresFamille()">
          </div>

          <!-- Resultats de recherche -->
          <div id="resultatsRechercheFamille" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
          </div>

          <!-- Type de lien -->
          <div class="mb-3">
            <label class="form-label">Type de lien</label>
            <select class="form-select" id="typeLienFamille">
              <option value="parent">Parent</option>
              <option value="tuteur">Tuteur legal</option>
              <option value="autre">Autre responsable</option>
            </select>
            <small class="text-muted">
              L'usager selectionne sera rattache comme "enfant" de l'usager actuellement consulte
            </small>
          </div>

          <input type="hidden" id="selectedMembreFamilleId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="btnConfirmerLienFamille" disabled onclick="confirmerLienFamille()">
            <i class="bi bi-link-45deg"></i> Lier
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SweetAlert2 pour les modals améliorées -->
  <script src="/vendor/sweetalert2/sweetalert2.all.min.js"></script>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/pagination.js"></script>
  <script src="js/adherents-utils.js"></script>
  <script src="js/adherents-form.js"></script>
  <script src="js/adherents-view.js"></script>
  <script src="js/adherents-table.js"></script>
  <script src="js/adherents-communications.js"></script>
  <script>
    // ============================================
    // Variables globales
    // ============================================
    let adherents = [];
    let searchTimeout = null;
    let modalInstance = null;
    let pagination = null;

    // ============================================
    // Chargement des adhérents avec filtres
    // ============================================
    async function loadAdherents(page = null, limit = null) {
      try {
        const statut = document.getElementById('statutFilter')?.value || '';
        const search = document.getElementById('searchInput')?.value || '';
        const role = document.getElementById('roleFilter')?.value || '';
        const assoc = document.getElementById('assocFilter')?.value || '';
        const sexe = document.getElementById('sexeFilter')?.value || '';
        const tag = document.getElementById('tagFilter')?.value || '';

        const params = {};
        if (statut) params.statut = statut;
        if (search) params.search = search;
        if (role) params.role = role;
        if (assoc) params.adhesion_association = assoc;
        if (sexe) params.sexe = sexe;
        if (tag) params.tag = tag;

        // Pagination params
        if (pagination) {
          params.page = page || pagination.getPage();
          params.limit = limit || pagination.getLimit();
        }

        const data = await adherentsAPI.getAll(params);
        adherents = data.adherents;

        // Mettre a jour la pagination si disponible
        if (pagination && data.pagination) {
          pagination.update(data.pagination);
        }

        // Utiliser la fonction de rendu du module table
        renderAdherents(adherents);
      } catch (error) {
        console.error('Error loading adherents:', error);
        document.getElementById('adherentsList').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            Erreur lors du chargement des adherents: ${error.message}
          </div>
        `;
      }
    }

    // ============================================
    // Chargement des options du filtre tag
    // ============================================
    async function loadTagFilterOptions() {
      try {
        const tags = await apiAdmin.get('/parametres/tags-utilisateur/actifs');
        const select = document.getElementById('tagFilter');
        if (select && tags && tags.length > 0) {
          // Garder l'option par defaut
          const defaultOption = select.querySelector('option[value=""]');
          select.innerHTML = '';
          if (defaultOption) select.appendChild(defaultOption);

          tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.code;
            option.textContent = tag.libelle;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Erreur chargement tags filtre:', error);
      }
    }

    // ============================================
    // Gestion de la recherche avec debounce
    // ============================================
    function handleSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (pagination) pagination.reset();
        loadAdherents();
      }, 500);
    }

    // ============================================
    // Fermeture modal
    // ============================================
    function closeModal() {
      if (modalInstance) {
        modalInstance.hide();
      }
    }

    // ============================================
    // Impression carte adhérent
    // ============================================
    function printCard(id) {
      barcodesAPI.printAdherentCard(id);
    }

    // ============================================
    // Suppression adhérent
    // ============================================
    async function deleteAdherent(id) {
      const result = await Swal.fire({
        title: 'Supprimer cet usager ?',
        text: 'Cette action est irréversible',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
      });

      if (result.isConfirmed) {
        try {
          await adherentsAPI.delete(id);
          showToast('Usager supprime avec succes', 'success');
          loadAdherents();
        } catch (error) {
          console.error('Erreur suppression:', error);
          showToast('Erreur lors de la suppression: ' + error.message, 'error');
        }
      }
    }

    // ============================================
    // GESTION FAMILLE
    // ============================================
    let lierMembreModalInstance = null;
    // currentViewAdherentId est déjà déclaré dans adherents-view.js
    let rechercheMembreTimeout = null;

    function openLierMembreModal() {
      // Reset
      document.getElementById('searchMembreFamille').value = '';
      document.getElementById('resultatsRechercheFamille').innerHTML = '';
      document.getElementById('selectedMembreFamilleId').value = '';
      document.getElementById('typeLienFamille').value = 'parent';
      document.getElementById('btnConfirmerLienFamille').disabled = true;

      if (!lierMembreModalInstance) {
        lierMembreModalInstance = new bootstrap.Modal(document.getElementById('lierMembreModal'));
      }
      lierMembreModalInstance.show();
    }

    async function rechercherMembresFamille() {
      clearTimeout(rechercheMembreTimeout);
      const query = document.getElementById('searchMembreFamille').value.trim();

      if (query.length < 2) {
        document.getElementById('resultatsRechercheFamille').innerHTML = '<p class="text-muted small p-2">Tapez au moins 2 caracteres...</p>';
        return;
      }

      rechercheMembreTimeout = setTimeout(async () => {
        try {
          const data = await adherentsAPI.rechercherDisponibles(query, currentViewAdherentId);
          const container = document.getElementById('resultatsRechercheFamille');

          if (!data.utilisateurs || data.utilisateurs.length === 0) {
            container.innerHTML = '<p class="text-muted small p-2">Aucun resultat</p>';
            return;
          }

          container.innerHTML = data.utilisateurs.map(u => `
            <button type="button" class="list-group-item list-group-item-action" onclick="selectMembreFamille(${u.id}, '${u.nom} ${u.prenom}')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>${u.nom} ${u.prenom}</strong>
                  <small class="text-muted d-block">${u.email || ''}</small>
                </div>
                ${u.date_naissance ? `<small class="text-muted">${formatDate(u.date_naissance)}</small>` : ''}
              </div>
            </button>
          `).join('');
        } catch (error) {
          console.error('Erreur recherche:', error);
        }
      }, 300);
    }

    function selectMembreFamille(id, nomComplet) {
      document.getElementById('selectedMembreFamilleId').value = id;
      document.getElementById('btnConfirmerLienFamille').disabled = false;

      // Mettre en surbrillance la selection
      document.querySelectorAll('#resultatsRechercheFamille .list-group-item').forEach(el => {
        el.classList.remove('active');
      });
      event.target.closest('.list-group-item').classList.add('active');
    }

    async function confirmerLienFamille() {
      const enfantId = document.getElementById('selectedMembreFamilleId').value;
      const typeLien = document.getElementById('typeLienFamille').value;

      if (!enfantId || !currentViewAdherentId) {
        showToast('Veuillez selectionner un membre', 'error');
        return;
      }

      try {
        await adherentsAPI.ajouterEnfant(currentViewAdherentId, parseInt(enfantId), typeLien);
        lierMembreModalInstance.hide();
        showToast('Membre rattache avec succes', 'success');
        // Recharger les infos famille
        loadFamilleInfo(currentViewAdherentId);
      } catch (error) {
        console.error('Erreur liaison:', error);
        showToast('Erreur: ' + error.message, 'error');
      }
    }

    async function retirerMembreFamille(enfantId) {
      if (!confirm('Voulez-vous vraiment retirer ce membre de la famille ?')) return;

      try {
        await adherentsAPI.retirerEnfant(currentViewAdherentId, enfantId);
        showToast('Membre retire de la famille', 'success');
        loadFamilleInfo(currentViewAdherentId);
      } catch (error) {
        console.error('Erreur retrait:', error);
        showToast('Erreur: ' + error.message, 'error');
      }
    }

    // ============================================
    // GESTION RESERVATIONS
    // ============================================
    async function loadReservationsInfo(adherentId) {
      const loadingEl = document.getElementById('view_reservations_loading');
      const contentEl = document.getElementById('view_reservations_content');
      const tabBtn = document.getElementById('view-tab-reservations-btn');
      const badge = document.getElementById('view_reservations_badge');

      // Afficher chargement
      loadingEl.style.display = '';
      contentEl.style.display = 'none';

      try {
        // Verifier si le module reservations est actif
        const modules = await publicAPI.getModulesActifs();
        if (!modules.reservations) {
          // Masquer l'onglet si module inactif
          tabBtn.parentElement.style.display = 'none';
          return;
        }
        tabBtn.parentElement.style.display = '';

        // Charger les reservations de l'usager
        const data = await reservationsAPI.getByUtilisateur(adherentId);
        const reservations = data.reservations || [];

        // Filtrer les reservations actives (en_attente, prete)
        const reservationsActives = reservations.filter(r =>
          ['en_attente', 'prete'].includes(r.statut)
        );
        const enAttente = reservationsActives.filter(r => r.statut === 'en_attente');
        const pretes = reservationsActives.filter(r => r.statut === 'prete');

        // Mettre a jour les stats
        document.getElementById('view_stat_reservations_attente').textContent = enAttente.length;
        document.getElementById('view_stat_reservations_prete').textContent = pretes.length;
        document.getElementById('view_stat_reservations_total').textContent = reservationsActives.length;

        // Badge sur l'onglet
        if (pretes.length > 0) {
          badge.textContent = pretes.length;
          badge.style.display = '';
          badge.className = 'badge bg-success ms-1'; // Vert pour pretes
        } else if (reservationsActives.length > 0) {
          badge.textContent = reservationsActives.length;
          badge.style.display = '';
          badge.className = 'badge bg-secondary ms-1';
        } else {
          badge.style.display = 'none';
        }

        // Afficher la liste
        const listContainer = document.getElementById('view_reservations_list');
        if (reservationsActives.length === 0) {
          listContainer.innerHTML = '<p class="text-muted text-center">Aucune reservation en cours</p>';
        } else {
          listContainer.innerHTML = reservationsActives.map(r => {
            const article = r.jeu || r.livre || r.film || r.disque;
            const articleType = r.jeu_id ? 'jeu' : r.livre_id ? 'livre' : r.film_id ? 'film' : 'disque';
            const typeIcon = {jeu: 'bi-dice-5', livre: 'bi-book', film: 'bi-film', disque: 'bi-disc'}[articleType];
            const statutBadge = r.statut === 'prete'
              ? '<span class="badge bg-success">Prete a recuperer</span>'
              : `<span class="badge bg-warning text-dark">En attente (pos. ${r.position_queue})</span>`;
            const dateExpiration = r.date_expiration
              ? `<small class="text-muted">Expire le ${formatDate(r.date_expiration)}</small>`
              : '';

            return `
              <div class="card mb-2 ${r.statut === 'prete' ? 'border-success' : ''}">
                <div class="card-body py-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <i class="bi ${typeIcon} text-muted me-1"></i>
                      <strong>${article?.titre || 'Article inconnu'}</strong>
                      <div class="mt-1">
                        ${statutBadge}
                        ${dateExpiration}
                      </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="cancelReservationFromView(${r.id})" title="Annuler">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        loadingEl.style.display = 'none';
        contentEl.style.display = '';

      } catch (error) {
        console.error('Erreur chargement reservations:', error);
        loadingEl.innerHTML = '<p class="text-danger">Erreur de chargement</p>';
      }
    }

    async function cancelReservationFromView(reservationId) {
      if (!confirm('Annuler cette reservation ?')) return;

      try {
        await reservationsAPI.cancel(reservationId);
        showToast('Reservation annulee', 'success');
        // Recharger les reservations
        loadReservationsInfo(currentViewAdherentId);
      } catch (error) {
        console.error('Erreur annulation:', error);
        showToast('Erreur: ' + error.message, 'error');
      }
    }

    async function loadFamilleInfo(adherentId) {
      try {
        const famille = await adherentsAPI.getFamille(adherentId);

        // Info parent si compte enfant
        const parentInfo = document.getElementById('view_famille_parent_info');
        if (famille.estEnfant && famille.responsable) {
          parentInfo.classList.remove('d-none');
          document.getElementById('view_famille_parent_link').textContent =
            `${famille.responsable.prenom} ${famille.responsable.nom}`;
          document.getElementById('view_famille_parent_link').href = '#';
          document.getElementById('view_famille_parent_link').onclick = () => viewAdherent(famille.responsable.id);
          document.getElementById('view_famille_type_lien').textContent = famille.lienAvecParent || '';
          // Masquer bouton lier si c'est un enfant
          document.getElementById('btn_lier_membre').classList.add('d-none');
        } else {
          parentInfo.classList.add('d-none');
          document.getElementById('btn_lier_membre').classList.remove('d-none');
        }

        // Liste des enfants
        const enfantsContainer = document.getElementById('view_famille_enfants_list');
        if (famille.enfants && famille.enfants.length > 0) {
          enfantsContainer.innerHTML = `
            <div class="list-group">
              ${famille.enfants.map(e => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${e.prenom} ${e.nom}</strong>
                    ${e.date_naissance ? `<small class="text-muted ms-2">(${formatDate(e.date_naissance)})</small>` : ''}
                    <span class="badge bg-secondary ms-2">${e.type_lien_famille || ''}</span>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAdherent(${e.id})" title="Voir">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="retirerMembreFamille(${e.id})" title="Retirer">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          enfantsContainer.innerHTML = '<p class="text-muted small">Aucun membre rattache</p>';
        }

        // Tarif famille (seulement si c'est un parent avec enfants)
        if (!famille.estEnfant && famille.enfants && famille.enfants.length > 0) {
          try {
            const cout = await adherentsAPI.getCoutFamille(adherentId);
            document.getElementById('view_famille_tarif').classList.remove('d-none');
            document.getElementById('view_famille_nb_membres').textContent = cout.nombreMembres;
            document.getElementById('view_famille_cout').textContent = `${cout.coutFamille.toFixed(2)} EUR`;
            document.getElementById('view_famille_economie').textContent = `${cout.economie.toFixed(2)} EUR`;
          } catch (e) {
            document.getElementById('view_famille_tarif').classList.add('d-none');
          }
        } else {
          document.getElementById('view_famille_tarif').classList.add('d-none');
        }

      } catch (error) {
        console.error('Erreur chargement famille:', error);
      }
    }

    // ============================================
    // Initialisation au chargement de la page
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Initialiser le template (navbar + sidebar)
      initTemplate('usagers');

      // Initialiser la pagination (sans toggle vue compacte pour adherents)
      pagination = new Pagination({
        module: 'adherents',
        containerId: 'paginationControls',
        onPageChange: (page, limit) => loadAdherents(page, limit),
        onViewModeChange: null,
        showViewToggle: false
      });

      // Charger les options du filtre tags
      loadTagFilterOptions();

      // Charger les adherents apres un court delai
      setTimeout(loadAdherents, 500);
    });
  </script>
</body>
</html>
