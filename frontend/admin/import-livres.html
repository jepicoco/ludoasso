<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'a verification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Livres BDP - Liberteko Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <link href="css/admin-style.css" rel="stylesheet">
  <style>
    .drop-zone {
      border: 3px dashed #dee2e6;
      border-radius: 12px;
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }

    .drop-zone:hover {
      border-color: #0d6efd;
      background-color: #e8f4ff;
    }

    .drop-zone.drag-over {
      border-color: #0d6efd;
      background-color: #cce5ff;
      transform: scale(1.02);
    }

    .drop-zone.has-file {
      border-color: #198754;
      background-color: #d1e7dd;
    }

    .drop-zone i {
      font-size: 4rem;
      color: #6c757d;
      margin-bottom: 1rem;
    }

    .drop-zone.has-file i {
      color: #198754;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: white;
      border-radius: 8px;
      margin-top: 15px;
    }

    .file-info .file-icon {
      font-size: 2rem;
      color: #198754;
    }

    .file-info .file-details {
      flex: 1;
    }

    .file-info .file-name {
      font-weight: 500;
    }

    .file-info .file-size {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      color: #6c757d;
    }

    .step.active {
      color: #0d6efd;
      font-weight: 500;
    }

    .step.completed {
      color: #198754;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .step.active .step-number {
      background: #0d6efd;
      color: white;
    }

    .step.completed .step-number {
      background: #198754;
      color: white;
    }

    .step-connector {
      width: 50px;
      height: 2px;
      background: #e9ecef;
    }

    .preview-table {
      font-size: 0.85rem;
    }

    .preview-table th {
      position: sticky;
      top: 0;
      background: #f8f9fa;
    }

    .results-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .result-card {
      flex: 1;
      min-width: 120px;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .result-card.success {
      background: #d1e7dd;
      color: #0f5132;
    }

    .result-card.warning {
      background: #fff3cd;
      color: #664d03;
    }

    .result-card.error {
      background: #f8d7da;
      color: #842029;
    }

    .result-card.info {
      background: #cfe2ff;
      color: #084298;
    }

    .result-card .number {
      font-size: 2.5rem;
      font-weight: bold;
    }

    .result-card .label {
      font-size: 0.9rem;
    }

    .conflict-section {
      background: #fff3cd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .conflict-tag {
      display: inline-block;
      background: #ffc107;
      color: #212529;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.85rem;
      margin: 3px;
    }

    .progress-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
    }

    .progress {
      height: 25px;
      border-radius: 12px;
    }

    .progress-bar {
      transition: width 0.3s ease;
    }

    .lot-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .lot-badge.en-cours {
      background: #cfe2ff;
      color: #084298;
    }

    .lot-badge.retard {
      background: #f8d7da;
      color: #842029;
    }

    .lot-badge.retourne {
      background: #d1e7dd;
      color: #0f5132;
    }

    .bdp-alert {
      background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .bdp-alert h5 {
      margin-bottom: 10px;
    }

    .bdp-stats {
      display: flex;
      gap: 30px;
      margin-top: 15px;
    }

    .bdp-stat {
      text-align: center;
    }

    .bdp-stat .number {
      font-size: 1.8rem;
      font-weight: bold;
    }

    .bdp-stat .label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <!-- Sub Navigation -->
        <div id="sub-nav-container"></div>

        <div class="mb-4">
          <h1><i class="bi bi-book"></i> Import Livres BDP</h1>
          <p class="text-muted">Importez des livres depuis un fichier ISO 2709 (MARC/UNIMARC) fourni par la BDP</p>
        </div>

        <!-- BDP Stats Alert -->
        <div class="bdp-alert" id="bdpAlert" style="display: none;">
          <h5><i class="bi bi-building"></i> Lots BDP en cours</h5>
          <p class="mb-0 small">Vous avez des lots a retourner a la BDP</p>
          <div class="bdp-stats" id="bdpStats">
            <!-- Rempli dynamiquement -->
          </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="mainTabs">
          <li class="nav-item">
            <a class="nav-link active" href="#" onclick="showTab('import')">
              <i class="bi bi-upload"></i> Nouvel Import
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showTab('lots')">
              <i class="bi bi-box-seam"></i> Lots BDP
              <span class="badge bg-warning text-dark" id="lotsEnCoursCount" style="display: none;"></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showTab('history')">
              <i class="bi bi-clock-history"></i> Historique
            </a>
          </li>
        </ul>

        <!-- Tab: Import -->
        <div id="tabImport">
          <!-- Step Indicator -->
          <div class="step-indicator">
            <div class="step active" id="step1-indicator">
              <span class="step-number">1</span>
              <span>Fichier</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step2-indicator">
              <span class="step-number">2</span>
              <span>Apercu</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step3-indicator">
              <span class="step-number">3</span>
              <span>Resolution</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" id="step4-indicator">
              <span class="step-number">4</span>
              <span>Import</span>
            </div>
          </div>

          <!-- Step 1: File Upload -->
          <div class="card mb-4" id="step1">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Etape 1 : Fichier ISO 2709</h5>
            </div>
            <div class="card-body">
              <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-file-earmark-binary"></i>
                <h4>Glissez-deposez votre fichier ISO 2709 ici</h4>
                <p class="text-muted">ou cliquez pour selectionner un fichier</p>
                <p class="text-muted small">Formats acceptes : .mrc, .iso, .marc (max 50 MB)</p>
              </div>
              <input type="file" id="fileInput" accept=".mrc,.iso,.marc,.dat" style="display: none;">

              <div class="row mt-4">
                <div class="col-md-4">
                  <label class="form-label">Numero de lot BDP</label>
                  <input type="text" class="form-control" id="numeroLot" placeholder="Ex: LOT-2024-001">
                  <small class="text-muted">Optionnel - Pour le suivi des retours</small>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Date de reception</label>
                  <input type="date" class="form-control" id="dateReception">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Date de retour prevue</label>
                  <input type="date" class="form-control" id="dateRetour">
                </div>
              </div>

              <div class="row mt-3">
                <div class="col-md-4">
                  <label class="form-label">Source</label>
                  <select class="form-select" id="source">
                    <option value="bdp" selected>BDP (Bibliotheque Departementale)</option>
                    <option value="bnf">BNF (Bibliotheque Nationale)</option>
                    <option value="autre">Autre source MARC</option>
                  </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button class="btn btn-primary" id="btnAnalyze" disabled onclick="analyzeFile()">
                    <i class="bi bi-search"></i> Analyser le fichier
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Preview -->
          <div class="card mb-4 d-none" id="step2">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-eye"></i> Etape 2 : Apercu des donnees</h5>
              <button class="btn btn-outline-secondary btn-sm" onclick="goToStep(1)">
                <i class="bi bi-arrow-left"></i> Retour
              </button>
            </div>
            <div class="card-body">
              <div class="results-summary mb-4" id="previewSummary">
                <!-- Rempli dynamiquement -->
              </div>

              <h6><i class="bi bi-table"></i> Apercu des 10 premiers livres</h6>
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped preview-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Titre</th>
                      <th>Auteur(s)</th>
                      <th>Editeur</th>
                      <th>ISBN</th>
                      <th>Annee</th>
                      <th>Statut</th>
                    </tr>
                  </thead>
                  <tbody id="previewTableBody">
                  </tbody>
                </table>
              </div>

              <div class="mt-4 d-flex justify-content-between">
                <div>
                  <span class="text-muted" id="previewInfo"></span>
                </div>
                <button class="btn btn-primary" onclick="goToStep(3)" id="btnNextStep2">
                  Continuer <i class="bi bi-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Step 3: Conflicts Resolution -->
          <div class="card mb-4 d-none" id="step3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-puzzle"></i> Etape 3 : Resolution des conflits</h5>
              <button class="btn btn-outline-secondary btn-sm" onclick="goToStep(2)">
                <i class="bi bi-arrow-left"></i> Retour
              </button>
            </div>
            <div class="card-body">
              <div id="noConflicts" class="text-center py-5">
                <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                <h4 class="mt-3">Aucun conflit detecte</h4>
                <p class="text-muted">Toutes les references (auteurs, editeurs, genres) sont connues.</p>
              </div>

              <div id="conflictsContainer" style="display: none;">
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                  Certaines references ne sont pas encore dans la base. Vous pouvez les creer automatiquement ou les ignorer.
                </div>

                <div id="conflictAuteurs" class="conflict-section" style="display: none;">
                  <h6><i class="bi bi-person"></i> Nouveaux auteurs</h6>
                  <div id="conflictAuteursList"></div>
                </div>

                <div id="conflictEditeurs" class="conflict-section" style="display: none;">
                  <h6><i class="bi bi-building"></i> Nouveaux editeurs</h6>
                  <div id="conflictEditeursList"></div>
                </div>

                <div id="conflictGenres" class="conflict-section" style="display: none;">
                  <h6><i class="bi bi-bookmark"></i> Nouveaux genres</h6>
                  <div id="conflictGenresList"></div>
                </div>

                <div id="conflictCollections" class="conflict-section" style="display: none;">
                  <h6><i class="bi bi-collection"></i> Nouvelles collections</h6>
                  <div id="conflictCollectionsList"></div>
                </div>

                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="createMissing" checked>
                  <label class="form-check-label" for="createMissing">
                    Creer automatiquement les references manquantes
                  </label>
                </div>
              </div>

              <div class="mt-4 d-flex justify-content-between">
                <div>
                  <span class="text-muted">Les references seront creees lors de l'import</span>
                </div>
                <button class="btn btn-success" onclick="resolveAndConfirm()">
                  <i class="bi bi-check-lg"></i> Confirmer et importer
                </button>
              </div>
            </div>
          </div>

          <!-- Step 4: Import Progress & Results -->
          <div class="card mb-4 d-none" id="step4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Etape 4 : Import en cours</h5>
            </div>
            <div class="card-body">
              <div id="importProgress" class="progress-container mb-4">
                <div class="d-flex justify-content-between mb-2">
                  <span id="progressLabel">Preparation...</span>
                  <span id="progressPercent">0%</span>
                </div>
                <div class="progress">
                  <div class="progress-bar progress-bar-striped progress-bar-animated"
                       role="progressbar" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-center">
                  <small class="text-muted" id="progressDetails"></small>
                </div>
              </div>

              <div id="importResults" style="display: none;">
                <div class="results-summary" id="resultsSummary">
                  <!-- Rempli dynamiquement -->
                </div>

                <div id="errorsSection" class="d-none">
                  <h6><i class="bi bi-exclamation-triangle text-warning"></i> Erreurs rencontrees</h6>
                  <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Titre</th>
                          <th>ISBN</th>
                          <th>Erreur</th>
                        </tr>
                      </thead>
                      <tbody id="errorsTableBody">
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="mt-4 d-flex gap-2">
                  <button class="btn btn-primary" onclick="goToStep(1)">
                    <i class="bi bi-arrow-repeat"></i> Nouvel import
                  </button>
                  <a href="livres.html" class="btn btn-outline-primary">
                    <i class="bi bi-list"></i> Voir les livres
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Lots BDP -->
        <div id="tabLots" style="display: none;">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-box-seam"></i> Gestion des lots BDP</h5>
              <div>
                <select class="form-select form-select-sm" id="lotsFilter" onchange="loadLots()">
                  <option value="">Tous les lots</option>
                  <option value="enCours">En cours</option>
                  <option value="retourne">Retournes</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Numero</th>
                      <th>Reception</th>
                      <th>Retour prevu</th>
                      <th>Exemplaires</th>
                      <th>Statut</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="lotsTableBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted">
                        <i class="bi bi-hourglass-split"></i> Chargement...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: History -->
        <div id="tabHistory" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historique des imports</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Fichier</th>
                      <th>Source</th>
                      <th>Total</th>
                      <th>Importes</th>
                      <th>Erreurs</th>
                      <th>Lot BDP</th>
                      <th>Statut</th>
                    </tr>
                  </thead>
                  <tbody id="historyTableBody">
                    <tr>
                      <td colspan="8" class="text-center text-muted">
                        <i class="bi bi-hourglass-split"></i> Chargement...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Help Section -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-question-circle"></i> Aide - Import ISO 2709</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="bi bi-file-earmark-binary"></i> Format ISO 2709 / UNIMARC</h6>
                <p>Le format ISO 2709 est le standard international pour l'echange de notices bibliographiques.
                   La BDP (Bibliotheque Departementale de Pret) fournit ses lots de livres dans ce format.</p>

                <h6 class="mt-4"><i class="bi bi-check-circle text-success"></i> Champs extraits automatiquement</h6>
                <div class="row small">
                  <div class="col-6">
                    <ul class="list-unstyled">
                      <li><i class="bi bi-arrow-right text-primary"></i> <strong>Titre</strong></li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Sous-titre</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> ISBN</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Auteur(s)</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Editeur</li>
                    </ul>
                  </div>
                  <div class="col-6">
                    <ul class="list-unstyled">
                      <li><i class="bi bi-arrow-right text-primary"></i> Annee</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Nombre de pages</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Collection</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Sujets/Genres</li>
                      <li><i class="bi bi-arrow-right text-primary"></i> Code Dewey</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <h6><i class="bi bi-building"></i> Gestion des lots BDP</h6>
                <p>Les lots BDP ont une date de retour. Le systeme vous alertera des retours a venir et en retard.</p>

                <ul class="small list-unstyled">
                  <li><span class="lot-badge en-cours"><i class="bi bi-clock"></i> En cours</span> Lot en circulation</li>
                  <li class="mt-2"><span class="lot-badge retard"><i class="bi bi-exclamation-triangle"></i> En retard</span> Date de retour depassee</li>
                  <li class="mt-2"><span class="lot-badge retourne"><i class="bi bi-check-circle"></i> Retourne</span> Lot rendu a la BDP</li>
                </ul>

                <div class="alert alert-info mt-3 mb-0">
                  <i class="bi bi-lightbulb"></i> <strong>Astuce :</strong>
                  Renseignez le numero de lot et la date de retour pour un meilleur suivi.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Retour Lot -->
  <div class="modal fade" id="retourModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-box-arrow-left"></i> Marquer le lot comme retourne</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Lot : <strong id="retourLotNumero"></strong></p>
          <div class="mb-3">
            <label class="form-label">Nombre d'exemplaires retournes</label>
            <input type="number" class="form-control" id="retourNbExemplaires" min="0">
            <small class="text-muted">Laissez vide pour retourner tous les exemplaires</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-success" onclick="confirmerRetour()">
            <i class="bi bi-check-lg"></i> Confirmer le retour
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="/vendor/sweetalert2/sweetalert2.all.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script src="js/import-livres.js"></script>
  <script>
    initTemplate('parametres');
    document.addEventListener('DOMContentLoaded', () => {
      renderSubNav('outils', 'import-livres');
      initImportLivres();
    });
  </script>
</body>
</html>
