<!DOCTYPE html>
<html lang="fr" class="auth-pending">
<head>
  <meta charset="UTF-8">
  <!-- Anti-flash: masquer le contenu jusqu'à vérification auth -->
  <style>.auth-pending body { visibility: hidden; }</style>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.replace('/admin/login.html');
    } else {
      document.documentElement.classList.remove('auth-pending');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner - Ludotheque Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    :root {
      --scanner-bg: #1a1a2e;
      --scanner-card: #16213e;
      --scanner-accent: #0f3460;
      --scanner-success: #00d26a;
      --scanner-error: #ff6b6b;
      --scanner-warning: #ffc107;
      --scanner-text: #e8e8e8;
    }

    body {
      background-color: var(--scanner-bg);
      color: var(--scanner-text);
      min-height: 100vh;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .scanner-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .scanner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--scanner-accent);
    }

    .scanner-header h1 {
      font-size: 1.5rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .scanner-header h1 i {
      color: var(--scanner-success);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .structure-indicator {
      display: flex;
      align-items: center;
    }

    .structure-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .structure-select {
      background-color: var(--scanner-accent);
      border: 1px solid #444;
      color: var(--scanner-text);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .structure-select:focus {
      outline: none;
      border-color: var(--scanner-success);
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-scanner {
      background-color: var(--scanner-accent);
      border: none;
      color: var(--scanner-text);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-scanner:hover {
      background-color: #1a4a7a;
      color: white;
    }

    .btn-scanner.btn-fullscreen {
      background-color: transparent;
      border: 1px solid var(--scanner-accent);
    }

    /* Zone Scanner */
    .scanner-zone {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    #reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
    }

    #reader video {
      border-radius: 12px;
    }

    .scanner-status {
      text-align: center;
      margin-top: 15px;
      font-size: 1.1rem;
    }

    .scanner-status.scanning {
      color: var(--scanner-warning);
    }

    .scanner-status.success {
      color: var(--scanner-success);
    }

    .scanner-status.error {
      color: var(--scanner-error);
    }

    /* Zone Adherent */
    .adherent-zone {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .adherent-zone h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 15px;
    }

    .adherent-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .adherent-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .adherent-details h4 {
      margin: 0 0 5px 0;
      font-size: 1.2rem;
    }

    .adherent-details p {
      margin: 0;
      color: #888;
      font-size: 0.9rem;
    }

    .adherent-placeholder {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .adherent-placeholder i {
      font-size: 3rem;
      margin-bottom: 10px;
      display: block;
    }

    .btn-clear-adherent {
      margin-left: auto;
      background: transparent;
      border: 1px solid var(--scanner-error);
      color: var(--scanner-error);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-clear-adherent:hover {
      background: var(--scanner-error);
      color: white;
    }

    /* Historique */
    .history-zone {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 20px;
    }

    .history-zone h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background-color: var(--scanner-accent);
    }

    .history-item.success {
      border-left: 4px solid var(--scanner-success);
    }

    .history-item.error {
      border-left: 4px solid var(--scanner-error);
    }

    .history-item.info {
      border-left: 4px solid var(--scanner-warning);
    }

    .history-icon {
      font-size: 1.5rem;
    }

    .history-icon.success { color: var(--scanner-success); }
    .history-icon.error { color: var(--scanner-error); }
    .history-icon.info { color: var(--scanner-warning); }

    .history-content {
      flex: 1;
    }

    .history-content .action {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .history-content .details {
      font-size: 0.85rem;
      color: #888;
    }

    .history-time {
      font-size: 0.8rem;
      color: #666;
    }

    .history-empty {
      text-align: center;
      padding: 30px;
      color: #666;
    }

    /* Modal Saisie Manuelle */
    .modal-content {
      background-color: var(--scanner-card);
      color: var(--scanner-text);
      border: none;
      border-radius: 16px;
    }

    .modal-header {
      border-bottom: 1px solid var(--scanner-accent);
    }

    .modal-footer {
      border-top: 1px solid var(--scanner-accent);
    }

    .form-control, .form-select {
      background-color: var(--scanner-accent);
      border: 1px solid #333;
      color: var(--scanner-text);
    }

    .form-control:focus, .form-select:focus {
      background-color: var(--scanner-accent);
      border-color: #667eea;
      color: var(--scanner-text);
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    /* Badge statut */
    .badge-statut {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-actif { background-color: var(--scanner-success); color: #000; }
    .badge-inactif { background-color: #6c757d; }
    .badge-suspendu { background-color: var(--scanner-error); }
    .badge-disponible { background-color: var(--scanner-success); color: #000; }
    .badge-emprunte { background-color: var(--scanner-warning); color: #000; }

    /* Animations */
    @keyframes pulse-success {
      0% { box-shadow: 0 0 0 0 rgba(0, 210, 106, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(0, 210, 106, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 210, 106, 0); }
    }

    @keyframes pulse-error {
      0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(255, 107, 107, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    .scanner-zone.flash-success {
      animation: pulse-success 0.5s ease-out;
    }

    .scanner-zone.flash-error {
      animation: pulse-error 0.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .scanner-container {
        padding: 10px;
      }

      .scanner-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .header-left {
        flex-direction: column;
        gap: 8px;
      }

      .scanner-header h1 {
        font-size: 1.2rem;
      }

      .structure-select {
        width: 100%;
        max-width: 250px;
      }

      .header-buttons {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }

      .header-buttons .btn-scanner {
        padding: 8px 12px;
        font-size: 0.85rem;
      }

      /* Masquer le texte des boutons sur petits ecrans, garder icones */
      .header-buttons .btn-scanner span.btn-text {
        display: none;
      }

      .adherent-info {
        flex-direction: column;
        text-align: center;
      }

      .btn-clear-adherent {
        margin: 10px auto 0;
        width: 100%;
        max-width: 250px;
      }

      .search-buttons {
        flex-direction: column;
      }

      .search-buttons .btn-search {
        width: 100%;
      }

      /* Scanner zone plus compacte */
      .scanner-zone {
        padding: 15px;
      }

      #reader {
        max-width: 100%;
      }

      /* Historique plus compact */
      .history-list {
        max-height: 200px;
      }

      .history-item {
        padding: 10px;
        gap: 8px;
      }

      .history-icon {
        font-size: 1.2rem;
      }

      .history-content .action {
        font-size: 0.9rem;
      }

      .history-content .details {
        font-size: 0.75rem;
      }
    }

    /* Tres petits ecrans (iPhone SE, etc.) */
    @media (max-width: 375px) {
      .scanner-header h1 {
        font-size: 1rem;
      }

      .header-buttons .btn-scanner {
        padding: 6px 10px;
        font-size: 0.8rem;
      }

      .adherent-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }

      .adherent-details h4 {
        font-size: 1rem;
      }
    }

    /* Limits Panel */
    .limits-panel .card {
      background: transparent !important;
    }

    .limits-panel .progress {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .limit-gauge .progress-bar.bg-success {
      background: linear-gradient(90deg, #00d26a, #00b85c) !important;
    }

    .limit-gauge .progress-bar.bg-warning {
      background: linear-gradient(90deg, #ffc107, #e5ac00) !important;
    }

    .limit-gauge .progress-bar.bg-danger {
      background: linear-gradient(90deg, #ff6b6b, #e55555) !important;
    }

    .limit-gauge .progress-bar.bg-info {
      background: linear-gradient(90deg, #17a2b8, #138496) !important;
    }

    /* Status badges in adherent zone */
    #adherent-status-badges .badge {
      font-size: 0.75rem;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    /* Validation Modal */
    #validationModal .modal-content {
      background-color: var(--scanner-card);
      color: var(--scanner-text);
      border: none;
      border-radius: 16px;
    }

    #validationModal .modal-header {
      border-bottom: 1px solid var(--scanner-accent);
      border-radius: 16px 16px 0 0;
    }

    #validationModal .modal-header.bg-danger,
    #validationModal .modal-header.bg-warning,
    #validationModal .modal-header.bg-info {
      border-bottom: none;
    }

    #validationModal .modal-footer {
      border-top: 1px solid var(--scanner-accent);
    }

    #validationModal .alert {
      background-color: var(--scanner-accent);
      border: none;
    }

    #validationModal .alert-secondary {
      background-color: rgba(108, 117, 125, 0.2);
    }

    #validationModal .alert-info {
      background-color: rgba(23, 162, 184, 0.2);
      color: #7dd3e1;
    }

    #validationModal .form-check-input {
      background-color: var(--scanner-accent);
      border-color: #555;
    }

    #validationModal .form-check-input:checked {
      background-color: var(--scanner-success);
      border-color: var(--scanner-success);
    }

    /* Zone Retour Info */
    .return-zone {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }

    .return-zone.active {
      display: block;
      border: 2px solid var(--scanner-success);
    }

    .return-zone.has-warning {
      border-color: var(--scanner-warning);
    }

    .return-zone.has-error {
      border-color: var(--scanner-error);
    }

    .return-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--scanner-accent);
    }

    .return-article-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .return-article-info {
      flex: 1;
    }

    .return-article-info h4 {
      margin: 0 0 4px 0;
      font-size: 1.1rem;
    }

    .return-article-info .return-dates {
      font-size: 0.85rem;
      color: #888;
    }

    .return-retard-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .return-retard-badge.ok {
      background-color: var(--scanner-success);
      color: #000;
    }

    .return-retard-badge.warning {
      background-color: var(--scanner-warning);
      color: #000;
    }

    .return-retard-badge.danger {
      background-color: var(--scanner-error);
      color: #fff;
    }

    .return-emprunteur {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background-color: var(--scanner-accent);
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .return-emprunteur .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .return-emprunteur .info {
      flex: 1;
    }

    .return-emprunteur .name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .return-emprunteur .badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .return-emprunteur .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
    }

    .return-reservation-alert {
      background-color: rgba(255, 193, 7, 0.15);
      border: 1px solid var(--scanner-warning);
      border-radius: 10px;
      padding: 12px;
      margin-top: 15px;
    }

    .return-reservation-alert h6 {
      margin: 0 0 10px 0;
      color: var(--scanner-warning);
      font-size: 0.9rem;
    }

    .return-reservation-choices {
      display: flex;
      gap: 10px;
    }

    .return-reservation-choices .btn {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.85rem;
    }

    /* Zone Usagers Session */
    .session-zone {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .session-users-panel, .session-details-panel {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 15px;
    }

    .session-users-panel h5, .session-details-panel h5 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin: 0 0 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-users-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .session-user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background-color: var(--scanner-accent);
    }

    .session-user-item:hover {
      background-color: #1a4a7a;
    }

    .session-user-item.active {
      background-color: #1a4a7a;
      border-left: 3px solid var(--scanner-success);
    }

    .session-user-item .status-icons {
      display: flex;
      gap: 2px;
      font-size: 0.7rem;
    }

    .session-user-item .initials {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .session-user-item .user-info {
      flex: 1;
      min-width: 0;
    }

    .session-user-item .user-name {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-user-item .user-counts {
      font-size: 0.75rem;
      color: #888;
    }

    .session-user-item .active-marker {
      color: var(--scanner-success);
      font-size: 0.8rem;
    }

    .status-icon {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-icon.ok { background-color: var(--scanner-success); }
    .status-icon.warning { background-color: var(--scanner-warning); }
    .status-icon.expired { background-color: var(--scanner-error); }
    .status-icon.not-required { background-color: #555; }

    .session-details-content {
      font-size: 0.85rem;
    }

    .session-details-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--scanner-accent);
    }

    .session-details-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .session-details-header .info h4 {
      margin: 0;
      font-size: 1rem;
    }

    .session-details-header .info p {
      margin: 0;
      color: #888;
      font-size: 0.8rem;
    }

    .session-details-section {
      margin-bottom: 12px;
    }

    .session-details-section h6 {
      font-size: 0.8rem;
      color: #888;
      margin: 0 0 6px 0;
    }

    .session-details-list {
      max-height: 120px;
      overflow-y: auto;
    }

    .session-details-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background-color: var(--scanner-accent);
      border-radius: 6px;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .session-details-item i {
      font-size: 0.9rem;
    }

    .session-details-item .title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-details-item .retard {
      color: var(--scanner-warning);
      font-size: 0.75rem;
    }

    .session-details-item .retard.danger {
      color: var(--scanner-error);
    }

    .session-empty {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      .session-zone {
        grid-template-columns: 1fr;
      }

      .return-header {
        flex-wrap: wrap;
      }

      .return-reservation-choices {
        flex-direction: column;
      }
    }

    /* Fullscreen mode */
    body.fullscreen-mode {
      padding: 0;
    }

    body.fullscreen-mode .scanner-container {
      max-width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body.fullscreen-mode .scanner-zone {
      flex: 1;
    }

    body.fullscreen-mode #reader {
      max-width: none;
      height: calc(100vh - 400px);
    }

    /* Resultats de recherche */
    .search-results {
      max-height: 300px;
      overflow-y: auto;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--scanner-accent);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .search-result-item:hover {
      background-color: #1a4a7a;
    }

    .search-result-item .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .search-result-item .jeu-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .search-result-item .info {
      flex: 1;
    }

    .search-result-item .info .name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .search-result-item .info .details {
      font-size: 0.8rem;
      color: #888;
    }

    .search-result-item .badge {
      font-size: 0.7rem;
    }

    .search-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-search {
      flex: 1;
      background-color: var(--scanner-accent);
      border: 1px dashed #555;
      color: #aaa;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-search:hover {
      background-color: #1a4a7a;
      border-color: #667eea;
      color: white;
    }

    .btn-search i {
      display: block;
      font-size: 1.5rem;
      margin-bottom: 4px;
    }

    /* Zone articles en attente */
    #pending-items-zone {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px dashed var(--scanner-warning);
      display: none;
    }

    .pending-items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .pending-items-header h6 {
      margin: 0;
      color: var(--scanner-warning);
      font-size: 0.95rem;
    }

    .pending-items-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .pending-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background-color: var(--scanner-accent);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .pending-item-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .pending-item-info i {
      font-size: 1.2rem;
      color: var(--scanner-warning);
    }

    .pending-item-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pending-items-hint {
      margin: 12px 0 0;
      font-size: 0.85rem;
      color: #888;
      text-align: center;
    }

    .pending-items-hint i {
      color: var(--scanner-warning);
    }

    @media (max-width: 768px) {
      #pending-items-zone {
        padding: 15px;
      }

      .pending-items-list {
        max-height: 150px;
      }

      .pending-item {
        padding: 8px 10px;
      }

      .pending-item-title {
        font-size: 0.9rem;
      }
    }

    /* Zone Controle (Mise en rayon) */
    .control-zone {
      background-color: var(--scanner-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #17a2b8;
      display: none;
    }

    .control-zone.active {
      display: block;
    }

    .control-zone h5 {
      margin: 0 0 15px 0;
      color: #17a2b8;
      font-size: 0.95rem;
    }

    .control-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding-bottom: 15px;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--scanner-accent);
    }

    .control-article-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      background: linear-gradient(135deg, #17a2b8 0%, #20c9e0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .control-article-info {
      flex: 1;
    }

    .control-article-info h4 {
      margin: 0 0 4px 0;
      font-size: 1.1rem;
    }

    .control-article-info .code {
      font-size: 0.85rem;
      color: #888;
    }

    .control-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .control-option-group label {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 5px;
      display: block;
    }

    .control-option-group select,
    .control-option-group textarea {
      width: 100%;
      background-color: var(--scanner-accent);
      border: 1px solid #444;
      color: var(--scanner-text);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .control-option-group select:focus,
    .control-option-group textarea:focus {
      outline: none;
      border-color: #17a2b8;
    }

    .control-option-group textarea {
      height: 60px;
      resize: none;
    }

    .control-reservation-alert {
      background-color: rgba(255, 193, 7, 0.15);
      border: 1px solid var(--scanner-warning);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: var(--scanner-warning);
    }

    .control-buttons {
      display: flex;
      gap: 10px;
    }

    .control-buttons .btn {
      flex: 1;
      padding: 12px;
    }

    .control-buttons .btn-mise-en-rayon {
      background-color: #17a2b8;
      border-color: #17a2b8;
      color: #fff;
    }

    .control-buttons .btn-mise-en-rayon:hover {
      background-color: #138496;
      border-color: #117a8b;
    }

    .control-buttons .btn-reparation {
      background-color: var(--scanner-warning);
      border-color: var(--scanner-warning);
      color: #000;
    }

    .control-buttons .btn-annuler {
      background-color: transparent;
      border: 1px solid #666;
      color: var(--scanner-text);
    }

    @media (max-width: 768px) {
      .control-options {
        grid-template-columns: 1fr;
      }

      .control-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="scanner-container">
    <!-- Header -->
    <div class="scanner-header">
      <div class="header-left">
        <h1>
          <i class="bi bi-upc-scan"></i>
          Scanner
        </h1>
        <div id="structure-indicator" class="structure-indicator"></div>
      </div>
      <div class="header-buttons">
        <button class="btn-scanner" onclick="openManualInput()">
          <i class="bi bi-keyboard"></i> Saisie manuelle
        </button>
        <button class="btn-scanner" onclick="switchCamera()">
          <i class="bi bi-camera-fill"></i> Changer camera
        </button>
        <button class="btn-scanner btn-fullscreen" onclick="toggleFullscreen()">
          <i class="bi bi-fullscreen"></i>
        </button>
        <a href="emprunts.html" class="btn-scanner">
          <i class="bi bi-arrow-left"></i> Retour
        </a>
      </div>
    </div>

    <!-- Zone Scanner -->
    <div class="scanner-zone" id="scanner-zone">
      <div id="reader"></div>
      <div class="scanner-status scanning" id="scanner-status">
        <i class="bi bi-camera-video"></i> En attente de scan...
      </div>
    </div>

    <!-- Zone Dernier Retour (affichee lors d'un scan retour) -->
    <div class="return-zone" id="return-zone">
      <div class="return-header">
        <div class="return-article-icon" id="return-article-icon">
          <i class="bi bi-box-seam"></i>
        </div>
        <div class="return-article-info">
          <h4 id="return-article-title">-</h4>
          <div class="return-dates">
            <span id="return-dates-info">-</span>
          </div>
        </div>
        <div class="return-retard-badge ok" id="return-retard-badge">
          A l'heure
        </div>
      </div>

      <div class="return-emprunteur" id="return-emprunteur">
        <div class="avatar" id="return-emprunteur-avatar">--</div>
        <div class="info">
          <div class="name" id="return-emprunteur-name">-</div>
          <div class="badges" id="return-emprunteur-badges"></div>
        </div>
        <div>
          <span class="badge bg-secondary" id="return-emprunts-restants">0 restants</span>
        </div>
      </div>

      <div class="return-reservation-alert" id="return-reservation-alert" style="display: none;">
        <h6><i class="bi bi-bookmark-star"></i> Article reserve</h6>
        <p id="return-reservation-info" style="margin: 0 0 10px 0; font-size: 0.85rem;">-</p>
        <div class="return-reservation-choices">
          <button class="btn btn-outline-secondary" onclick="processReturn('rayon')">
            <i class="bi bi-inbox"></i> Remettre en rayon
          </button>
          <button class="btn btn-warning" onclick="processReturn('cote')">
            <i class="bi bi-bookmark-check"></i> Mettre de cote
          </button>
        </div>
      </div>
    </div>

    <!-- Zone Controle (mise en rayon apres retour) -->
    <div class="control-zone" id="control-zone">
      <h5><i class="bi bi-clipboard-check"></i> Controle article - Mise en rayon</h5>

      <div class="control-header">
        <div class="control-article-icon" id="control-article-icon">
          <i class="bi bi-box-seam"></i>
        </div>
        <div class="control-article-info">
          <h4 id="control-article-title">-</h4>
          <div class="code" id="control-article-code">-</div>
        </div>
      </div>

      <div class="control-options">
        <div class="control-option-group">
          <label><i class="bi bi-star"></i> Etat de l'article</label>
          <select id="control-etat-select">
            <option value="neuf">Neuf</option>
            <option value="bon" selected>Bon</option>
            <option value="use">Use</option>
            <option value="abime">Abime</option>
            <option value="incomplet">Incomplet</option>
          </select>
        </div>
        <div class="control-option-group">
          <label><i class="bi bi-chat-text"></i> Notes de controle</label>
          <textarea id="control-notes" placeholder="Notes optionnelles..."></textarea>
        </div>
      </div>

      <div class="control-reservation-alert" id="control-reservation-alert" style="display: none;">
        <i class="bi bi-bookmark-star"></i> <span id="control-reservation-info">-</span>
      </div>

      <div class="control-buttons">
        <button class="btn btn-annuler" onclick="hideControlZone()">
          <i class="bi bi-x-lg"></i> Annuler
        </button>
        <button class="btn btn-reparation" onclick="sendToRepair()">
          <i class="bi bi-tools"></i> Reparation
        </button>
        <button class="btn btn-mise-en-rayon" onclick="confirmMiseEnRayon()">
          <i class="bi bi-box-arrow-in-down"></i> Mise en rayon
        </button>
      </div>
    </div>

    <!-- Zone Usagers Session (retours) -->
    <div class="session-zone" id="session-zone" style="display: none;">
      <div class="session-users-panel">
        <h5>
          <span><i class="bi bi-people"></i> Usagers session (<span id="session-users-count">0</span>)</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearSessionUsers()" style="font-size: 0.7rem; padding: 2px 8px;">
            <i class="bi bi-trash"></i>
          </button>
        </h5>
        <div class="session-users-list" id="session-users-list">
          <div class="session-empty">
            <i class="bi bi-inbox"></i><br>
            Aucun retour effectue
          </div>
        </div>
      </div>

      <div class="session-details-panel">
        <h5><i class="bi bi-person-lines-fill"></i> Details usager</h5>
        <div class="session-details-content" id="session-details-content">
          <div class="session-empty">
            <i class="bi bi-hand-index"></i><br>
            Cliquez sur un usager
          </div>
        </div>
      </div>
    </div>

    <!-- Zone Adherent -->
    <div class="adherent-zone">
      <h3><i class="bi bi-person-badge"></i> Adherent selectionne</h3>
      <div id="adherent-display">
        <div class="adherent-placeholder">
          <i class="bi bi-person-plus"></i>
          <p>Scannez la carte d'un adherent pour commencer</p>
        </div>
      </div>
      <div class="search-buttons">
        <button class="btn-search" onclick="openSearchAdherent()">
          <i class="bi bi-person-search"></i>
          Rechercher adherent
        </button>
        <button class="btn-search" onclick="openSearchJeu()">
          <i class="bi bi-search"></i>
          Rechercher article
        </button>
      </div>
    </div>

    <!-- Zone articles en attente -->
    <div id="pending-items-zone">
      <!-- Contenu genere dynamiquement par updatePendingItemsDisplay() -->
    </div>

    <!-- Historique -->
    <div class="history-zone">
      <h3>
        <span><i class="bi bi-clock-history"></i> Dernieres actions</span>
        <button class="btn-scanner" onclick="clearHistory()" style="padding: 4px 10px; font-size: 0.8rem;">
          <i class="bi bi-trash"></i> Vider
        </button>
      </h3>
      <div class="history-list" id="history-list">
        <div class="history-empty">
          <i class="bi bi-inbox"></i>
          <p>Aucune action pour le moment</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Saisie Manuelle -->
  <div class="modal fade" id="manualInputModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-keyboard"></i> Saisie manuelle
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Code-barre</label>
            <input type="text" class="form-control" id="manual-code" placeholder="ADH, JEU, LIV, FLM, DSQ..." autofocus>
            <div class="form-text">Saisissez le code-barre d'un adherent ou d'un article</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="submitManualCode()">
            <i class="bi bi-check-lg"></i> Valider
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Recherche Adherent -->
  <div class="modal fade" id="searchAdherentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person-search"></i> Rechercher un adherent
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nom, prenom ou numero</label>
            <input type="text" class="form-control" id="search-adherent-input" placeholder="Rechercher..." autofocus>
          </div>
          <div id="search-adherent-results" class="search-results">
            <p class="text-muted text-center">Tapez pour rechercher un adherent</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Recherche Article -->
  <div class="modal fade" id="searchJeuModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-search"></i> Rechercher un article
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Titre (jeu, livre, film, disque)</label>
            <input type="text" class="form-control" id="search-jeu-input" placeholder="Rechercher..." autofocus>
          </div>
          <div id="search-jeu-results" class="search-results">
            <p class="text-muted text-center">Tapez pour rechercher un article</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Aide -->
  <div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-question-circle"></i> Comment utiliser le scanner
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6><i class="bi bi-1-circle text-primary"></i> Pour un emprunt (methode classique)</h6>
          <ol>
            <li>Scannez la carte de l'adherent (code ADHxxxxxxxx)</li>
            <li>Scannez l'article a emprunter (JEU, LIV, FLM ou DSQ)</li>
            <li>L'emprunt est cree automatiquement</li>
          </ol>

          <h6 class="mt-4"><i class="bi bi-hourglass-split text-warning"></i> Mode multi-articles (nouveau !)</h6>
          <ol>
            <li>Scannez d'abord tous les articles (sans adherent)</li>
            <li>Les articles s'ajoutent a la file d'attente</li>
            <li>Scannez ensuite la carte adherent</li>
            <li>Tous les articles sont traites automatiquement</li>
          </ol>

          <h6 class="mt-4"><i class="bi bi-2-circle text-success"></i> Pour un retour</h6>
          <ol>
            <li>Scannez simplement l'article emprunte</li>
            <li>Si un adherent est selectionne, le retour est fait immediatement</li>
            <li>Sinon, l'article s'ajoute a la file d'attente</li>
          </ol>

          <h6 class="mt-4"><i class="bi bi-lightbulb text-warning"></i> Astuces</h6>
          <ul>
            <li>Codes-barres : ADH (adherent), JEU (jeu), LIV (livre), FLM (film), DSQ (disque)</li>
            <li>Vous pouvez melanger emprunts et retours dans la file d'attente</li>
            <li>Un son confirme chaque action reussie</li>
            <li>Cliquez sur le X d'un article pour le retirer de la file</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Compris !</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio feedback -->
  <audio id="sound-success" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+Xi3VmaHqHl52ck4t2ZGJxgZGdnpmOgHFiYnWDkpyeko2DdWliZnmGlJqXkop+b2Vlb36LmJiUjYN2aGZpfYqXmZWPhXhsaGp8iZaYlI+HeW1qa32Jl5iUj4Z4bGpsf4qYmJSOhXdram2Ai5mYk42Ed2pqboKMmpiSi4JzaGpvgo2amJGJf3JnaW+DjpuYkIh9cGZob4OPm5iPh3tvZWhvg4+bmI+GeW5lZ2+Dj5uYj4Z4bWRnb4OPm5iPhndtZGdvg5CbmI+Fd21kZ2+DkJuYj4V3bWRnb4SRm5iPhXZsY2Zvg5GbmI+FdW1jZm+DkZuYj4V1bGNmb4ORm5iPhXVsY2Zvg5GbmI+FdWxjZm+EkZuYj4V0a2JlboSRm5mPhHVrYmVuhJGbmY+Ec2tiZW6EkZuZj4RzamFlboSRm5mPhHNpYWRthJKbmY+Ec2hhZG2Ek5uZj4NyaGBjbIOTm5mOg3FnX2Nsg5Oamp6Ee2xoZ3J/jpmbk4x/cm1rcX6NmZmTi4BzbW5yf46ZmZKJfnFsbnKAj5mZkoh9cGtucoCQmZmSiHxvam5zgo+Zmn0=" type="audio/wav">
  </audio>
  <audio id="sound-error" preload="auto">
    <source src="data:audio/wav;base64,UklGRl4DAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YToDAABzAHMAdAB2AHgAeQB4AHYAdABxAG8AbQBrAGkAaABoAGkAagBsAG4AcQBzAHQAdQB0AHIAbwBsAGkAZgBkAGQAZABmAGkAbQBxAHQAdgB3AHcAdQByAG8AbABpAGcAZQBlAGYAaABrAG8AcwB2AHgAeAB3AHUAcQBuAGsAaABmAGUAZQBnAGoAbQBxAHQAdwB4AHcAdQByAG4AawBoAGYAZABkAGUAaABrAG8AcwB2AHgAeAB3AHQAcQBtAGoAZwBlAGQAZABmAGkAbQBwAHQAdwB4AHcAdQBxAG4AagBnAGUAZABkAGUAaABsAHAAcwB2AHgAeAB2AHMAbwBsAGgAZQBjAGMAZABmAGoAbgByAHUAeAB5AHgAdQByAG4AagBnAGQAYwBjAGQAZwBrAG8AcwB3AHkAeQB3AHQAcABsAGkAZQBjAGIAYwBlAGgAbABwAHQAeAB6AHkAdwBzAG8AawBnAGQAYgBhAGIAZABnAGsAcAB0AHgAegB6AHgAdABwAGwAaABkAGIAYQBhAGMAZgBqAG8AcwB3AHoAewB5AHUAcQBsAGgAZABhAGAAYABiAGUAaQBuAHMAdwB6AHsAeQB1AHEAbQBoAGQAYQBfAF8AYABjAGcAbABxAHUAeQB7AHoAeAB0AG8AawBmAGIAXwBeAF4AYABjAGgAbQByAHYAegB8AHsAeABzAG4AaQBlAGAAXgBdAF0AXwBjAGcAbQByAHcAewB9AHsAeABzAG4AaQBkAGAAXQBcAFwAXgBhAGYAbAByAHgAfAB+" type="audio/wav">
  </audio>

  <!-- Scripts -->
  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="/vendor/html5-qrcode/html5-qrcode.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/scanner-validation.js"></script>
  <script src="js/scanner.js"></script>
</body>
</html>
