<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Referentiels - Parametres - Ludotheque Admin</title>
  <link rel="icon" href="/public/logo_ludo_transparent_100x100.png" type="image/x-icon" />
  <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <style>
    .section-card {
      margin-bottom: 1.5rem;
    }
    .section-card .card-header {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .list-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
      background: white;
    }
    .list-item:hover {
      background-color: #f8f9fa;
    }
    .list-item .drag-handle {
      cursor: move;
      color: #6c757d;
      margin-right: 0.75rem;
    }
    .list-item .item-content {
      flex: 1;
    }
    .list-item .item-actions {
      display: flex;
      gap: 0.25rem;
    }
    .list-item.inactive {
      opacity: 0.5;
    }
    .badge-mode {
      font-size: 0.7rem;
      margin-left: 0.5rem;
    }
    .color-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .ref-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
    }
    .ref-stat-card {
      padding: 0.75rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 2px solid transparent;
    }
    .ref-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .ref-stat-card.active {
      border-color: var(--bs-primary);
      background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
    }
    .ref-stat-card h3 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--bs-primary);
    }
    .ref-stat-card small {
      color: #6c757d;
      font-size: 0.75rem;
    }
    .search-box {
      position: relative;
    }
    .search-box .bi-search {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }
    .search-box input {
      padding-left: 36px;
    }
    .nav-tabs .nav-link {
      color: #495057;
    }
    .nav-tabs .nav-link.active {
      font-weight: 600;
    }
    .tab-jeux .nav-link.active {
      border-color: #ffc107 #ffc107 #fff;
      color: #856404;
    }
    .tab-livres .nav-link.active {
      border-color: #0d6efd #0d6efd #fff;
      color: #0a58ca;
    }
    .tab-films .nav-link.active {
      border-color: #dc3545 #dc3545 #fff;
      color: #b02a37;
    }
    .tab-musiques .nav-link.active {
      border-color: #198754 #198754 #fff;
      color: #146c43;
    }
    /* Palette de couleurs predefinies */
    .color-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.15s, border-color 0.15s;
    }
    .color-swatch:hover {
      transform: scale(1.15);
      border-color: #333;
    }
    .color-swatch.active {
      border-color: #000;
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
    }
  </style>
</head>
<body>
  <!-- Navigation (genere par JS) -->
  <nav id="admin-navbar"></nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar (genere par JS) -->
      <div id="admin-sidebar" class="col-md-2 bg-light"></div>

      <!-- Main Content -->
      <div class="col-md-10">
        <!-- Sub-navigation -->
        <div id="sub-nav-container"></div>

        <div class="mb-4">
          <h1><i class="bi bi-tags"></i> Referentiels</h1>
          <p class="text-muted mb-0">Gestion des categories, genres, auteurs, editeurs et autres referentiels par collection</p>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="listesTabs" role="tablist">
          <li class="nav-item tab-jeux" role="presentation">
            <button class="nav-link active" id="jeux-tab" data-bs-toggle="tab" data-bs-target="#jeux" type="button">
              <i class="bi bi-dice-6 text-warning"></i> Referentiels Jeux
            </button>
          </li>
          <li class="nav-item tab-livres" role="presentation">
            <button class="nav-link" id="livres-tab" data-bs-toggle="tab" data-bs-target="#livres" type="button">
              <i class="bi bi-book text-primary"></i> Referentiels Livres
            </button>
          </li>
          <li class="nav-item tab-films" role="presentation">
            <button class="nav-link" id="films-tab" data-bs-toggle="tab" data-bs-target="#films" type="button">
              <i class="bi bi-film text-danger"></i> Referentiels Films
            </button>
          </li>
          <li class="nav-item tab-musiques" role="presentation">
            <button class="nav-link" id="musiques-tab" data-bs-toggle="tab" data-bs-target="#musiques" type="button">
              <i class="bi bi-vinyl text-success"></i> Referentiels Musiques
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="listesTabContent">
          <!-- ======================== -->
          <!-- Referentiels Jeux Tab    -->
          <!-- ======================== -->
          <div class="tab-pane fade show active" id="jeux" role="tabpanel">
            <!-- Stats des referentiels Jeux -->
            <div class="card section-card mb-3">
              <div class="card-header py-2">
                <i class="bi bi-bar-chart"></i> Vue d'ensemble
              </div>
              <div class="card-body py-2">
                <div id="ref-stats-jeux" class="ref-stats">
                  <div class="text-center py-2 w-100">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Selecteur de type de referentiel -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">Type de referentiel</label>
                <select class="form-select" id="refTypeJeux" onchange="onRefTypeChangeJeux()">
                  <option value="categories">Categories</option>
                  <option value="themes">Themes</option>
                  <option value="mecanismes">Mecanismes</option>
                  <option value="editeurs">Editeurs</option>
                  <option value="auteurs">Auteurs</option>
                  <option value="illustrateurs">Illustrateurs</option>
                  <option value="langues">Langues</option>
                  <option value="gammes">Gammes</option>
                  <option value="emplacements">Emplacements</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Rechercher</label>
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input type="text" class="form-control" id="refSearchJeux" placeholder="Filtrer..." oninput="onRefSearchJeux()">
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" id="showInactifsJeux" onchange="loadCurrentRefJeux()">
                  <label class="form-check-label" for="showInactifsJeux">Afficher inactifs</label>
                </div>
                <button class="btn btn-primary" onclick="openAddRefModalJeux()">
                  <i class="bi bi-plus"></i> Ajouter
                </button>
              </div>
            </div>

            <!-- Liste des elements -->
            <div class="card section-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span id="refListTitleJeux"><i class="bi bi-tags"></i> Categories</span>
                <span class="badge bg-secondary" id="refCountJeux">0</span>
              </div>
              <div class="card-body">
                <div id="ref-list-jeux">
                  <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ======================== -->
          <!-- Referentiels Livres Tab  -->
          <!-- ======================== -->
          <div class="tab-pane fade" id="livres" role="tabpanel">
            <!-- Stats des referentiels Livres -->
            <div class="card section-card mb-3">
              <div class="card-header py-2">
                <i class="bi bi-bar-chart"></i> Vue d'ensemble
              </div>
              <div class="card-body py-2">
                <div id="ref-stats-livres" class="ref-stats">
                  <div class="text-center py-2 w-100">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Selecteur de type de referentiel Livres -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">Type de referentiel</label>
                <select class="form-select" id="refTypeLivres" onchange="onRefTypeChangeLivres()">
                  <option value="genres">Genres</option>
                  <option value="formats">Formats</option>
                  <option value="collections">Collections</option>
                  <option value="emplacements">Emplacements</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Rechercher</label>
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input type="text" class="form-control" id="refSearchLivres" placeholder="Filtrer..." oninput="onRefSearchLivres()">
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" id="showInactifsLivres" onchange="loadCurrentRefLivres()">
                  <label class="form-check-label" for="showInactifsLivres">Afficher inactifs</label>
                </div>
                <button class="btn btn-primary" onclick="openAddRefModalLivres()">
                  <i class="bi bi-plus"></i> Ajouter
                </button>
              </div>
            </div>

            <!-- Liste des elements Livres -->
            <div class="card section-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span id="refListTitleLivres"><i class="bi bi-bookmark"></i> Genres</span>
                <span class="badge bg-secondary" id="refCountLivres">0</span>
              </div>
              <div class="card-body">
                <div id="ref-list-livres">
                  <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ======================== -->
          <!-- Referentiels Films Tab   -->
          <!-- ======================== -->
          <div class="tab-pane fade" id="films" role="tabpanel">
            <!-- Stats des referentiels Films -->
            <div class="card section-card mb-3">
              <div class="card-header py-2">
                <i class="bi bi-bar-chart"></i> Vue d'ensemble
              </div>
              <div class="card-body py-2">
                <div id="ref-stats-films" class="ref-stats">
                  <div class="text-center py-2 w-100">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Selecteur de type de referentiel Films -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">Type de referentiel</label>
                <select class="form-select" id="refTypeFilms" onchange="onRefTypeChangeFilms()">
                  <option value="genres">Genres</option>
                  <option value="supports">Supports</option>
                  <option value="realisateurs">Realisateurs</option>
                  <option value="acteurs">Acteurs</option>
                  <option value="studios">Studios</option>
                  <option value="emplacements">Emplacements</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Rechercher</label>
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input type="text" class="form-control" id="refSearchFilms" placeholder="Filtrer..." oninput="onRefSearchFilms()">
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" id="showInactifsFilms" onchange="loadCurrentRefFilms()">
                  <label class="form-check-label" for="showInactifsFilms">Afficher inactifs</label>
                </div>
                <button class="btn btn-primary" onclick="openAddRefModalFilms()">
                  <i class="bi bi-plus"></i> Ajouter
                </button>
              </div>
            </div>

            <!-- Liste des elements Films -->
            <div class="card section-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span id="refListTitleFilms"><i class="bi bi-tags"></i> Genres</span>
                <span class="badge bg-secondary" id="refCountFilms">0</span>
              </div>
              <div class="card-body">
                <div id="ref-list-films">
                  <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ======================== -->
          <!-- Referentiels Musiques Tab -->
          <!-- ======================== -->
          <div class="tab-pane fade" id="musiques" role="tabpanel">
            <!-- Stats des referentiels Musiques -->
            <div class="card section-card mb-3">
              <div class="card-header py-2">
                <i class="bi bi-bar-chart"></i> Vue d'ensemble
              </div>
              <div class="card-body py-2">
                <div id="ref-stats-musiques" class="ref-stats">
                  <div class="text-center py-2 w-100">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Selecteur de type de referentiel Musiques -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label fw-semibold">Type de referentiel</label>
                <select class="form-select" id="refTypeMusiques" onchange="onRefTypeChangeMusiques()">
                  <option value="genres">Genres</option>
                  <option value="formats">Formats</option>
                  <option value="artistes">Artistes</option>
                  <option value="labels">Labels</option>
                  <option value="emplacements">Emplacements</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Rechercher</label>
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input type="text" class="form-control" id="refSearchMusiques" placeholder="Filtrer..." oninput="onRefSearchMusiques()">
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" id="showInactifsMusiques" onchange="loadCurrentRefMusiques()">
                  <label class="form-check-label" for="showInactifsMusiques">Afficher inactifs</label>
                </div>
                <button class="btn btn-primary" onclick="openAddRefModalMusiques()">
                  <i class="bi bi-plus"></i> Ajouter
                </button>
              </div>
            </div>

            <!-- Liste des elements Musiques -->
            <div class="card section-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span id="refListTitleMusiques"><i class="bi bi-music-note"></i> Genres</span>
                <span class="badge bg-secondary" id="refCountMusiques">0</span>
              </div>
              <div class="card-body">
                <div id="ref-list-musiques">
                  <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Chargement...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter/Modifier Referentiel Jeux -->
  <div class="modal fade" id="modalRefJeux" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalRefJeuxTitle">Ajouter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formRefJeux">
            <input type="hidden" id="ref_jeux_id">

            <!-- Champ nom (commun a tous) -->
            <div class="mb-3" id="fieldNomJeux">
              <label for="ref_jeux_nom" class="form-label">Nom <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_jeux_nom" required>
            </div>

            <!-- Champ libelle (pour emplacements) -->
            <div class="mb-3 d-none" id="fieldLibelleJeux">
              <label for="ref_jeux_libelle" class="form-label">Libelle <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_jeux_libelle">
            </div>

            <!-- Champ code (langues, emplacements) -->
            <div class="mb-3 d-none" id="fieldCodeJeux">
              <label for="ref_jeux_code" class="form-label">Code</label>
              <input type="text" class="form-control" id="ref_jeux_code" maxlength="20">
              <div class="form-text">Code court (ISO pour langues)</div>
            </div>

            <!-- Champs prenom/nationalite (auteurs, illustrateurs) -->
            <div class="mb-3 d-none" id="fieldPrenomJeux">
              <label for="ref_jeux_prenom" class="form-label">Prenom</label>
              <input type="text" class="form-control" id="ref_jeux_prenom">
            </div>

            <div class="mb-3 d-none" id="fieldNationaliteJeux">
              <label for="ref_jeux_nationalite" class="form-label">Nationalite</label>
              <input type="text" class="form-control" id="ref_jeux_nationalite">
            </div>

            <!-- Champ pays (editeurs) -->
            <div class="mb-3 d-none" id="fieldPaysJeux">
              <label for="ref_jeux_pays" class="form-label">Pays</label>
              <input type="text" class="form-control" id="ref_jeux_pays">
            </div>

            <!-- Champ site_web (editeurs, illustrateurs) -->
            <div class="mb-3 d-none" id="fieldSiteWebJeux">
              <label for="ref_jeux_site_web" class="form-label">Site web</label>
              <input type="url" class="form-control" id="ref_jeux_site_web" placeholder="https://...">
            </div>

            <!-- Champ description -->
            <div class="mb-3 d-none" id="fieldDescriptionJeux">
              <label for="ref_jeux_description" class="form-label">Description</label>
              <textarea class="form-control" id="ref_jeux_description" rows="2"></textarea>
            </div>

            <!-- Champs couleur/icone (categories, themes) -->
            <div class="mb-3 d-none" id="fieldCouleurJeux">
              <label for="ref_jeux_couleur" class="form-label">Couleur</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="ref_jeux_couleur" value="#0d6efd">
                <input type="text" class="form-control" id="ref_jeux_couleur_text" value="#0d6efd" style="max-width: 100px;">
              </div>
              <div id="usedColorsContainerJeux" class="mt-2 d-none">
                <small class="text-muted">Mes couleurs</small>
                <div class="color-palette" id="usedColorsPaletteJeux"></div>
              </div>
              <div class="mt-2">
                <small class="text-muted">Palette</small>
                <div class="color-palette" id="colorPaletteJeux"></div>
              </div>
            </div>

            <div class="mb-3 d-none" id="fieldIconeJeux">
              <label for="ref_jeux_icone" class="form-label">Icone Bootstrap</label>
              <div class="input-group">
                <span class="input-group-text" id="ref_jeux_icone_preview"><i class="bi bi-tag"></i></span>
                <input type="text" class="form-control" id="ref_jeux_icone" placeholder="tag" value="tag">
              </div>
            </div>

            <!-- Champ editeur_id (gammes) -->
            <div class="mb-3 d-none" id="fieldEditeurJeux">
              <label for="ref_jeux_editeur_id" class="form-label">Editeur</label>
              <select class="form-select" id="ref_jeux_editeur_id">
                <option value="">-- Aucun --</option>
              </select>
            </div>

            <!-- Champ site_id (emplacements) -->
            <div class="mb-3 d-none" id="fieldSiteJeux">
              <label for="ref_jeux_site_id" class="form-label">Site</label>
              <select class="form-select" id="ref_jeux_site_id">
                <option value="">-- Aucun --</option>
              </select>
            </div>

            <!-- Actif -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ref_jeux_actif" checked>
              <label class="form-check-label" for="ref_jeux_actif">Actif</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveRefJeux()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter/Modifier Referentiel Livres -->
  <div class="modal fade" id="modalRefLivres" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalRefLivresTitle">Ajouter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formRefLivres">
            <input type="hidden" id="ref_livres_id">

            <!-- Champ nom -->
            <div class="mb-3" id="fieldNomLivres">
              <label for="ref_livres_nom" class="form-label">Nom <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_livres_nom" required>
            </div>

            <!-- Champ libelle (pour emplacements) -->
            <div class="mb-3 d-none" id="fieldLibelleLivres">
              <label for="ref_livres_libelle" class="form-label">Libelle <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_livres_libelle">
            </div>

            <!-- Champ code -->
            <div class="mb-3 d-none" id="fieldCodeLivres">
              <label for="ref_livres_code" class="form-label">Code</label>
              <input type="text" class="form-control" id="ref_livres_code" maxlength="20">
            </div>

            <!-- Champ description -->
            <div class="mb-3 d-none" id="fieldDescriptionLivres">
              <label for="ref_livres_description" class="form-label">Description</label>
              <textarea class="form-control" id="ref_livres_description" rows="2"></textarea>
            </div>

            <!-- Champs couleur/icone -->
            <div class="mb-3 d-none" id="fieldCouleurLivres">
              <label for="ref_livres_couleur" class="form-label">Couleur</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="ref_livres_couleur" value="#0d6efd">
                <input type="text" class="form-control" id="ref_livres_couleur_text" value="#0d6efd" style="max-width: 100px;">
              </div>
              <div id="usedColorsContainerLivres" class="mt-2 d-none">
                <small class="text-muted">Mes couleurs</small>
                <div class="color-palette" id="usedColorsPaletteLivres"></div>
              </div>
              <div class="mt-2">
                <small class="text-muted">Palette</small>
                <div class="color-palette" id="colorPaletteLivres"></div>
              </div>
            </div>

            <div class="mb-3 d-none" id="fieldIconeLivres">
              <label for="ref_livres_icone" class="form-label">Icone Bootstrap</label>
              <div class="input-group">
                <span class="input-group-text" id="ref_livres_icone_preview"><i class="bi bi-tag"></i></span>
                <input type="text" class="form-control" id="ref_livres_icone" placeholder="tag" value="tag">
              </div>
            </div>

            <!-- Champ site_id (emplacements) -->
            <div class="mb-3 d-none" id="fieldSiteLivres">
              <label for="ref_livres_site_id" class="form-label">Site</label>
              <select class="form-select" id="ref_livres_site_id">
                <option value="">-- Aucun --</option>
              </select>
            </div>

            <!-- Actif -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ref_livres_actif" checked>
              <label class="form-check-label" for="ref_livres_actif">Actif</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveRefLivres()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter/Modifier Referentiel Films -->
  <div class="modal fade" id="modalRefFilms" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalRefFilmsTitle">Ajouter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formRefFilms">
            <input type="hidden" id="ref_films_id">

            <!-- Champ nom -->
            <div class="mb-3" id="fieldNomFilms">
              <label for="ref_films_nom" class="form-label">Nom <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_films_nom" required>
            </div>

            <!-- Champ libelle (pour emplacements) -->
            <div class="mb-3 d-none" id="fieldLibelleFilms">
              <label for="ref_films_libelle" class="form-label">Libelle <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_films_libelle">
            </div>

            <!-- Champ code -->
            <div class="mb-3 d-none" id="fieldCodeFilms">
              <label for="ref_films_code" class="form-label">Code</label>
              <input type="text" class="form-control" id="ref_films_code" maxlength="20">
            </div>

            <!-- Champ prenom (realisateurs, acteurs) -->
            <div class="mb-3 d-none" id="fieldPrenomFilms">
              <label for="ref_films_prenom" class="form-label">Prenom</label>
              <input type="text" class="form-control" id="ref_films_prenom">
            </div>

            <!-- Champ nationalite -->
            <div class="mb-3 d-none" id="fieldNationaliteFilms">
              <label for="ref_films_nationalite" class="form-label">Nationalite</label>
              <input type="text" class="form-control" id="ref_films_nationalite">
            </div>

            <!-- Champ pays (studios) -->
            <div class="mb-3 d-none" id="fieldPaysFilms">
              <label for="ref_films_pays" class="form-label">Pays</label>
              <input type="text" class="form-control" id="ref_films_pays">
            </div>

            <!-- Champ description -->
            <div class="mb-3 d-none" id="fieldDescriptionFilms">
              <label for="ref_films_description" class="form-label">Description</label>
              <textarea class="form-control" id="ref_films_description" rows="2"></textarea>
            </div>

            <!-- Champs couleur/icone -->
            <div class="mb-3 d-none" id="fieldCouleurFilms">
              <label for="ref_films_couleur" class="form-label">Couleur</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="ref_films_couleur" value="#dc3545">
                <input type="text" class="form-control" id="ref_films_couleur_text" value="#dc3545" style="max-width: 100px;">
              </div>
              <div id="usedColorsContainerFilms" class="mt-2 d-none">
                <small class="text-muted">Mes couleurs</small>
                <div class="color-palette" id="usedColorsPaletteFilms"></div>
              </div>
              <div class="mt-2">
                <small class="text-muted">Palette</small>
                <div class="color-palette" id="colorPaletteFilms"></div>
              </div>
            </div>

            <div class="mb-3 d-none" id="fieldIconeFilms">
              <label for="ref_films_icone" class="form-label">Icone Bootstrap</label>
              <div class="input-group">
                <span class="input-group-text" id="ref_films_icone_preview"><i class="bi bi-tag"></i></span>
                <input type="text" class="form-control" id="ref_films_icone" placeholder="tag" value="tag">
              </div>
            </div>

            <!-- Champ site_id (emplacements) -->
            <div class="mb-3 d-none" id="fieldSiteFilms">
              <label for="ref_films_site_id" class="form-label">Site</label>
              <select class="form-select" id="ref_films_site_id">
                <option value="">-- Aucun --</option>
              </select>
            </div>

            <!-- Actif -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ref_films_actif" checked>
              <label class="form-check-label" for="ref_films_actif">Actif</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveRefFilms()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter/Modifier Referentiel Musiques -->
  <div class="modal fade" id="modalRefMusiques" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalRefMusiquesTitle">Ajouter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formRefMusiques">
            <input type="hidden" id="ref_musiques_id">

            <!-- Champ nom -->
            <div class="mb-3" id="fieldNomMusiques">
              <label for="ref_musiques_nom" class="form-label">Nom <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_musiques_nom" required>
            </div>

            <!-- Champ libelle (pour emplacements) -->
            <div class="mb-3 d-none" id="fieldLibelleMusiques">
              <label for="ref_musiques_libelle" class="form-label">Libelle <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="ref_musiques_libelle">
            </div>

            <!-- Champ code -->
            <div class="mb-3 d-none" id="fieldCodeMusiques">
              <label for="ref_musiques_code" class="form-label">Code</label>
              <input type="text" class="form-control" id="ref_musiques_code" maxlength="20">
            </div>

            <!-- Champ pays (labels) -->
            <div class="mb-3 d-none" id="fieldPaysMusiques">
              <label for="ref_musiques_pays" class="form-label">Pays</label>
              <input type="text" class="form-control" id="ref_musiques_pays">
            </div>

            <!-- Champ description -->
            <div class="mb-3 d-none" id="fieldDescriptionMusiques">
              <label for="ref_musiques_description" class="form-label">Description</label>
              <textarea class="form-control" id="ref_musiques_description" rows="2"></textarea>
            </div>

            <!-- Champs couleur/icone -->
            <div class="mb-3 d-none" id="fieldCouleurMusiques">
              <label for="ref_musiques_couleur" class="form-label">Couleur</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="ref_musiques_couleur" value="#198754">
                <input type="text" class="form-control" id="ref_musiques_couleur_text" value="#198754" style="max-width: 100px;">
              </div>
              <div id="usedColorsContainerMusiques" class="mt-2 d-none">
                <small class="text-muted">Mes couleurs</small>
                <div class="color-palette" id="usedColorsPaletteMusiques"></div>
              </div>
              <div class="mt-2">
                <small class="text-muted">Palette</small>
                <div class="color-palette" id="colorPaletteMusiques"></div>
              </div>
            </div>

            <div class="mb-3 d-none" id="fieldIconeMusiques">
              <label for="ref_musiques_icone" class="form-label">Icone Bootstrap</label>
              <div class="input-group">
                <span class="input-group-text" id="ref_musiques_icone_preview"><i class="bi bi-tag"></i></span>
                <input type="text" class="form-control" id="ref_musiques_icone" placeholder="tag" value="tag">
              </div>
            </div>

            <!-- Champ site_id (emplacements) -->
            <div class="mb-3 d-none" id="fieldSiteMusiques">
              <label for="ref_musiques_site_id" class="form-label">Site</label>
              <select class="form-select" id="ref_musiques_site_id">
                <option value="">-- Aucun --</option>
              </select>
            </div>

            <!-- Actif -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="ref_musiques_actif" checked>
              <label class="form-check-label" for="ref_musiques_actif">Actif</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveRefMusiques()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="js/api-admin.js"></script>
  <script src="js/auth-admin.js"></script>
  <script src="js/admin-navigation.js"></script>
  <script src="js/admin-template.js"></script>
  <script src="js/parametres-nav.js"></script>
  <script>
    // ========================
    // Variables globales
    // ========================
    let currentRefItemsJeux = [];
    let currentRefTypejeux = 'categories';
    let currentRefItemsLivres = [];
    let currentRefTypeLivres = 'genres';
    let currentRefItemsFilms = [];
    let currentRefTypeFilms = 'genres';
    let currentRefItemsMusiques = [];
    let currentRefTypeMusiques = 'genres';
    let searchTimeoutJeux = null;
    let searchTimeoutLivres = null;
    let searchTimeoutFilms = null;
    let searchTimeoutMusiques = null;
    let modalRefJeux, modalRefLivres, modalRefFilms, modalRefMusiques;
    let editeurs = [];
    let sites = [];

    // Palette de couleurs predefinies
    const PREDEFINED_COLORS = [
      '#dc3545', // Rouge
      '#fd7e14', // Orange
      '#ffc107', // Jaune
      '#28a745', // Vert
      '#20c997', // Turquoise
      '#17a2b8', // Cyan
      '#0d6efd', // Bleu
      '#6f42c1', // Violet
      '#e83e8c', // Rose
      '#6c757d', // Gris
      '#343a40', // Gris fonce
      '#795548', // Marron
      '#ff5722', // Orange fonce
      '#8bc34a', // Vert clair
      '#00bcd4', // Bleu clair
      '#9c27b0'  // Violet fonce
    ];

    // ========================
    // Configuration referentiels Jeux
    // ========================
    const REF_CONFIG_JEUX = {
      categories: {
        label: 'Categories',
        labelSingular: 'categorie',
        icon: 'tags',
        fields: ['nom', 'description', 'couleur', 'icone'],
        api: referentielsAPI.getCategories,
        apiCreate: referentielsAPI.createCategorie,
        apiUpdate: referentielsAPI.updateCategorie,
        apiDelete: referentielsAPI.deleteCategorie,
        apiToggle: referentielsAPI.toggleCategorie
      },
      themes: {
        label: 'Themes',
        labelSingular: 'theme',
        icon: 'bookmark',
        fields: ['nom', 'description', 'icone'],
        api: referentielsAPI.getThemes,
        apiCreate: referentielsAPI.createTheme,
        apiUpdate: referentielsAPI.updateTheme,
        apiDelete: referentielsAPI.deleteTheme,
        apiToggle: referentielsAPI.toggleTheme
      },
      mecanismes: {
        label: 'Mecanismes',
        labelSingular: 'mecanisme',
        icon: 'gear',
        fields: ['nom', 'description'],
        api: referentielsAPI.getMecanismes,
        apiCreate: referentielsAPI.createMecanisme,
        apiUpdate: referentielsAPI.updateMecanisme,
        apiDelete: referentielsAPI.deleteMecanisme,
        apiToggle: referentielsAPI.toggleMecanisme
      },
      editeurs: {
        label: 'Editeurs',
        labelSingular: 'editeur',
        icon: 'building',
        fields: ['nom', 'pays', 'site_web'],
        api: referentielsAPI.getEditeurs,
        apiCreate: referentielsAPI.createEditeur,
        apiUpdate: referentielsAPI.updateEditeur,
        apiDelete: referentielsAPI.deleteEditeur,
        apiToggle: referentielsAPI.toggleEditeur
      },
      auteurs: {
        label: 'Auteurs',
        labelSingular: 'auteur',
        icon: 'person',
        fields: ['nom', 'prenom', 'nationalite'],
        api: referentielsAPI.getAuteurs,
        apiCreate: referentielsAPI.createAuteur,
        apiUpdate: referentielsAPI.updateAuteur,
        apiDelete: referentielsAPI.deleteAuteur,
        apiToggle: referentielsAPI.toggleAuteur
      },
      illustrateurs: {
        label: 'Illustrateurs',
        labelSingular: 'illustrateur',
        icon: 'palette',
        fields: ['nom', 'prenom', 'site_web'],
        api: referentielsAPI.getIllustrateurs,
        apiCreate: referentielsAPI.createIllustrateur,
        apiUpdate: referentielsAPI.updateIllustrateur,
        apiDelete: referentielsAPI.deleteIllustrateur,
        apiToggle: referentielsAPI.toggleIllustrateur
      },
      langues: {
        label: 'Langues',
        labelSingular: 'langue',
        icon: 'translate',
        fields: ['nom', 'code'],
        api: referentielsAPI.getLangues,
        apiCreate: referentielsAPI.createLangue,
        apiUpdate: referentielsAPI.updateLangue,
        apiDelete: referentielsAPI.deleteLangue,
        apiToggle: referentielsAPI.toggleLangue
      },
      gammes: {
        label: 'Gammes',
        labelSingular: 'gamme',
        icon: 'collection',
        fields: ['nom', 'description', 'editeur'],
        api: referentielsAPI.getGammes,
        apiCreate: referentielsAPI.createGamme,
        apiUpdate: referentielsAPI.updateGamme,
        apiDelete: referentielsAPI.deleteGamme,
        apiToggle: referentielsAPI.toggleGamme
      },
      emplacements: {
        label: 'Emplacements',
        labelSingular: 'emplacement',
        icon: 'geo-alt',
        fields: ['libelle', 'code', 'description', 'couleur', 'icone', 'site'],
        useLibelle: true,
        api: referentielsAPI.getEmplacements,
        apiCreate: referentielsAPI.createEmplacement,
        apiUpdate: referentielsAPI.updateEmplacement,
        apiDelete: referentielsAPI.deleteEmplacement,
        apiToggle: referentielsAPI.toggleEmplacement
      }
    };

    // ========================
    // Configuration referentiels Livres
    // ========================
    const REF_CONFIG_LIVRES = {
      genres: {
        label: 'Genres',
        labelSingular: 'genre',
        icon: 'bookmark',
        fields: ['nom', 'description', 'couleur', 'icone'],
        apiGet: () => livresAPI.getGenres(),
        apiCreate: (data) => apiRequest('/livres/referentiels/genres', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/livres/referentiels/genres/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/livres/referentiels/genres/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/livres/referentiels/genres/${id}/toggle`, { method: 'PATCH' })
      },
      formats: {
        label: 'Formats',
        labelSingular: 'format',
        icon: 'book',
        fields: ['nom', 'description'],
        apiGet: () => livresAPI.getFormats(),
        apiCreate: (data) => apiRequest('/livres/referentiels/formats', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/livres/referentiels/formats/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/livres/referentiels/formats/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/livres/referentiels/formats/${id}/toggle`, { method: 'PATCH' })
      },
      collections: {
        label: 'Collections',
        labelSingular: 'collection',
        icon: 'collection',
        fields: ['nom', 'description'],
        apiGet: () => livresAPI.getCollections(),
        apiCreate: (data) => apiRequest('/livres/referentiels/collections', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/livres/referentiels/collections/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/livres/referentiels/collections/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/livres/referentiels/collections/${id}/toggle`, { method: 'PATCH' })
      },
      emplacements: {
        label: 'Emplacements',
        labelSingular: 'emplacement',
        icon: 'geo-alt',
        fields: ['libelle', 'code', 'description', 'couleur', 'icone', 'site'],
        useLibelle: true,
        apiGet: () => livresAPI.getEmplacements(),
        apiCreate: (data) => apiRequest('/livres/referentiels/emplacements', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/livres/referentiels/emplacements/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/livres/referentiels/emplacements/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/livres/referentiels/emplacements/${id}/toggle`, { method: 'PATCH' })
      }
    };

    // ========================
    // Initialisation
    // ========================
    initTemplate('parametres');

    document.addEventListener('DOMContentLoaded', () => {
      renderSubNav('general', 'listes');

      modalRefJeux = new bootstrap.Modal(document.getElementById('modalRefJeux'));
      modalRefLivres = new bootstrap.Modal(document.getElementById('modalRefLivres'));
      modalRefFilms = new bootstrap.Modal(document.getElementById('modalRefFilms'));
      modalRefMusiques = new bootstrap.Modal(document.getElementById('modalRefMusiques'));

      // Charger les stats et la premiere liste
      loadRefStatsJeux();
      loadCurrentRefJeux();

      // Charger les referentiels Livres quand on clique sur l'onglet
      document.getElementById('livres-tab').addEventListener('shown.bs.tab', () => {
        if (currentRefItemsLivres.length === 0) {
          loadRefStatsLivres();
          loadCurrentRefLivres();
        }
      });

      // Charger les referentiels Films quand on clique sur l'onglet
      document.getElementById('films-tab').addEventListener('shown.bs.tab', () => {
        if (currentRefItemsFilms.length === 0) {
          loadRefStatsFilms();
          loadCurrentRefFilms();
        }
      });

      // Charger les referentiels Musiques quand on clique sur l'onglet
      document.getElementById('musiques-tab').addEventListener('shown.bs.tab', () => {
        if (currentRefItemsMusiques.length === 0) {
          loadRefStatsMusiques();
          loadCurrentRefMusiques();
        }
      });

      // Preview icone Jeux
      document.getElementById('ref_jeux_icone').addEventListener('input', (e) => {
        const icon = e.target.value || 'tag';
        document.getElementById('ref_jeux_icone_preview').innerHTML = `<i class="bi bi-${icon}"></i>`;
      });

      // Sync couleur Jeux
      document.getElementById('ref_jeux_couleur').addEventListener('input', (e) => {
        document.getElementById('ref_jeux_couleur_text').value = e.target.value;
        updateColorPaletteSelection('Jeux', e.target.value);
      });
      document.getElementById('ref_jeux_couleur_text').addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
          document.getElementById('ref_jeux_couleur').value = e.target.value;
          updateColorPaletteSelection('Jeux', e.target.value);
        }
      });

      // Preview icone Livres
      document.getElementById('ref_livres_icone').addEventListener('input', (e) => {
        const icon = e.target.value || 'tag';
        document.getElementById('ref_livres_icone_preview').innerHTML = `<i class="bi bi-${icon}"></i>`;
      });

      // Sync couleur Livres
      document.getElementById('ref_livres_couleur').addEventListener('input', (e) => {
        document.getElementById('ref_livres_couleur_text').value = e.target.value;
        updateColorPaletteSelection('Livres', e.target.value);
      });
      document.getElementById('ref_livres_couleur_text').addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
          document.getElementById('ref_livres_couleur').value = e.target.value;
          updateColorPaletteSelection('Livres', e.target.value);
        }
      });

      // Preview icone Films
      document.getElementById('ref_films_icone').addEventListener('input', (e) => {
        const icon = e.target.value || 'tag';
        document.getElementById('ref_films_icone_preview').innerHTML = `<i class="bi bi-${icon}"></i>`;
      });

      // Sync couleur Films
      document.getElementById('ref_films_couleur').addEventListener('input', (e) => {
        document.getElementById('ref_films_couleur_text').value = e.target.value;
        updateColorPaletteSelection('Films', e.target.value);
      });
      document.getElementById('ref_films_couleur_text').addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
          document.getElementById('ref_films_couleur').value = e.target.value;
          updateColorPaletteSelection('Films', e.target.value);
        }
      });

      // Preview icone Musiques
      document.getElementById('ref_musiques_icone').addEventListener('input', (e) => {
        const icon = e.target.value || 'tag';
        document.getElementById('ref_musiques_icone_preview').innerHTML = `<i class="bi bi-${icon}"></i>`;
      });

      // Sync couleur Musiques
      document.getElementById('ref_musiques_couleur').addEventListener('input', (e) => {
        document.getElementById('ref_musiques_couleur_text').value = e.target.value;
        updateColorPaletteSelection('Musiques', e.target.value);
      });
      document.getElementById('ref_musiques_couleur_text').addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
          document.getElementById('ref_musiques_couleur').value = e.target.value;
          updateColorPaletteSelection('Musiques', e.target.value);
        }
      });

      // Initialiser les palettes de couleurs
      initColorPalettes();
    });

    // ========================
    // Palettes de couleurs
    // ========================
    function initColorPalettes() {
      const modules = ['Jeux', 'Livres', 'Films', 'Musiques'];
      modules.forEach(module => {
        const paletteContainer = document.getElementById(`colorPalette${module}`);
        if (paletteContainer) {
          paletteContainer.innerHTML = PREDEFINED_COLORS.map(color => `
            <div class="color-swatch"
                 style="background-color: ${color}"
                 data-color="${color}"
                 onclick="selectPaletteColor('${module}', '${color}')"
                 title="${color}">
            </div>
          `).join('');
        }
      });
    }

    function selectPaletteColor(module, color) {
      document.getElementById(`ref_${module.toLowerCase()}_couleur`).value = color;
      document.getElementById(`ref_${module.toLowerCase()}_couleur_text`).value = color;
      updateColorPaletteSelection(module, color);
    }

    function updateColorPaletteSelection(module, color) {
      // Update main palette
      const paletteContainer = document.getElementById(`colorPalette${module}`);
      if (paletteContainer) {
        paletteContainer.querySelectorAll('.color-swatch').forEach(swatch => {
          if (swatch.dataset.color.toLowerCase() === color.toLowerCase()) {
            swatch.classList.add('active');
          } else {
            swatch.classList.remove('active');
          }
        });
      }

      // Update used colors palette
      const usedPaletteContainer = document.getElementById(`usedColorsPalette${module}`);
      if (usedPaletteContainer) {
        usedPaletteContainer.querySelectorAll('.color-swatch').forEach(swatch => {
          if (swatch.dataset.color.toLowerCase() === color.toLowerCase()) {
            swatch.classList.add('active');
          } else {
            swatch.classList.remove('active');
          }
        });
      }
    }

    function getUsedColors(module) {
      let items = [];
      switch(module) {
        case 'Jeux': items = currentRefItemsJeux; break;
        case 'Livres': items = currentRefItemsLivres; break;
        case 'Films': items = currentRefItemsFilms; break;
        case 'Musiques': items = currentRefItemsMusiques; break;
      }

      const colors = items
        .filter(item => item.couleur)
        .map(item => item.couleur.toLowerCase());

      // Return unique colors
      return [...new Set(colors)];
    }

    function renderUsedColorsPalette(module, currentColor) {
      const container = document.getElementById(`usedColorsContainer${module}`);
      const palette = document.getElementById(`usedColorsPalette${module}`);
      if (!container || !palette) return;

      const usedColors = getUsedColors(module);

      if (usedColors.length === 0) {
        container.classList.add('d-none');
        return;
      }

      container.classList.remove('d-none');
      palette.innerHTML = usedColors.map(color => `
        <div class="color-swatch ${currentColor && currentColor.toLowerCase() === color ? 'active' : ''}"
             style="background-color: ${color}"
             data-color="${color}"
             onclick="selectPaletteColor('${module}', '${color}')"
             title="${color}">
        </div>
      `).join('');
    }

    // ========================
    // Stats referentiels Jeux
    // ========================
    async function loadRefStatsJeux() {
      try {
        const stats = await referentielsAPI.getStats();
        renderRefStatsJeux(stats);
      } catch (error) {
        console.error('Erreur stats:', error);
        document.getElementById('ref-stats-jeux').innerHTML = '<div class="text-muted">Stats non disponibles</div>';
      }
    }

    function renderRefStatsJeux(stats) {
      const container = document.getElementById('ref-stats-jeux');
      const items = [
        { key: 'categories', label: 'Categories', icon: 'tags' },
        { key: 'themes', label: 'Themes', icon: 'bookmark' },
        { key: 'mecanismes', label: 'Mecanismes', icon: 'gear' },
        { key: 'editeurs', label: 'Editeurs', icon: 'building' },
        { key: 'auteurs', label: 'Auteurs', icon: 'person' },
        { key: 'illustrateurs', label: 'Illustrateurs', icon: 'palette' },
        { key: 'langues', label: 'Langues', icon: 'translate' },
        { key: 'gammes', label: 'Gammes', icon: 'collection' },
        { key: 'emplacements', label: 'Emplacements', icon: 'geo-alt' }
      ];

      container.innerHTML = items.map(item => `
        <div class="ref-stat-card ${currentRefTypejeux === item.key ? 'active' : ''}" onclick="selectRefTypeJeux('${item.key}')">
          <i class="bi bi-${item.icon} text-warning"></i>
          <h3>${stats[item.key] || 0}</h3>
          <small>${item.label}</small>
        </div>
      `).join('');
    }

    function selectRefTypeJeux(type) {
      currentRefTypejeux = type;
      document.getElementById('refTypeJeux').value = type;
      loadCurrentRefJeux();
      loadRefStatsJeux();
    }

    // ========================
    // Stats referentiels Livres
    // ========================
    async function loadRefStatsLivres() {
      try {
        const stats = await livresAPI.getStats();
        renderRefStatsLivres(stats);
      } catch (error) {
        console.error('Erreur stats livres:', error);
        document.getElementById('ref-stats-livres').innerHTML = '<div class="text-muted">Stats non disponibles</div>';
      }
    }

    function renderRefStatsLivres(stats) {
      const container = document.getElementById('ref-stats-livres');
      const items = [
        { key: 'genres', label: 'Genres', icon: 'bookmark', count: stats.genres || 0 },
        { key: 'formats', label: 'Formats', icon: 'book', count: stats.formats || 0 },
        { key: 'collections', label: 'Collections', icon: 'collection', count: stats.collections || 0 },
        { key: 'emplacements', label: 'Emplacements', icon: 'geo-alt', count: stats.emplacements || 0 }
      ];

      container.innerHTML = items.map(item => `
        <div class="ref-stat-card ${currentRefTypeLivres === item.key ? 'active' : ''}" onclick="selectRefTypeLivres('${item.key}')">
          <i class="bi bi-${item.icon} text-primary"></i>
          <h3>${item.count}</h3>
          <small>${item.label}</small>
        </div>
      `).join('');
    }

    function selectRefTypeLivres(type) {
      currentRefTypeLivres = type;
      document.getElementById('refTypeLivres').value = type;
      loadCurrentRefLivres();
      loadRefStatsLivres();
    }

    // ========================
    // Referentiels Jeux - CRUD
    // ========================
    function onRefTypeChangeJeux() {
      currentRefTypejeux = document.getElementById('refTypeJeux').value;
      document.getElementById('refSearchJeux').value = '';
      loadCurrentRefJeux();
    }

    function onRefSearchJeux() {
      clearTimeout(searchTimeoutJeux);
      searchTimeoutJeux = setTimeout(() => loadCurrentRefJeux(), 300);
    }

    async function loadCurrentRefJeux() {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];
      if (!config) return;

      const container = document.getElementById('ref-list-jeux');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Chargement...</div>';

      document.getElementById('refListTitleJeux').innerHTML = `<i class="bi bi-${config.icon}"></i> ${config.label}`;

      try {
        const params = {};
        const search = document.getElementById('refSearchJeux').value;
        if (search) params.search = search;
        if (!document.getElementById('showInactifsJeux').checked) params.actif = 'true';

        const result = await config.api.call(referentielsAPI, params);
        currentRefItemsJeux = result.items || result;

        document.getElementById('refCountJeux').textContent = currentRefItemsJeux.length;
        renderRefListJeux();
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    function renderRefListJeux() {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];
      const container = document.getElementById('ref-list-jeux');

      if (currentRefItemsJeux.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mt-2">Aucun element trouve</p>
            <button class="btn btn-primary btn-sm" onclick="openAddRefModalJeux()">
              <i class="bi bi-plus"></i> Ajouter
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = currentRefItemsJeux.map(item => {
        const label = config.useLibelle ? item.libelle : item.nom;
        const extraInfo = getRefExtraInfo(item, config);

        return `
          <div class="list-item ${item.actif ? '' : 'inactive'}" data-id="${item.id}">
            <div class="item-content">
              ${item.couleur ? `<span class="color-dot" style="background-color:${item.couleur}"></span>` : ''}
              ${item.icone ? `<i class="bi bi-${item.icone} me-2"></i>` : `<i class="bi bi-${config.icon} me-2 text-muted"></i>`}
              <strong>${label}</strong>
              ${!item.actif ? '<span class="badge bg-warning badge-mode">Inactif</span>' : ''}
              ${extraInfo ? `<br><small class="text-muted">${extraInfo}</small>` : ''}
            </div>
            <div class="item-actions">
              <button class="btn btn-sm btn-outline-secondary" onclick="editRefJeux(${item.id})" title="Modifier">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-${item.actif ? 'warning' : 'success'}" onclick="toggleRefJeux(${item.id})" title="${item.actif ? 'Desactiver' : 'Activer'}">
                <i class="bi bi-${item.actif ? 'eye-slash' : 'eye'}"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRefJeux(${item.id})" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getRefExtraInfo(item, config) {
      const parts = [];
      if (item.code) parts.push(`Code: ${item.code}`);
      if (item.prenom) parts.push(item.prenom);
      if (item.nationalite) parts.push(item.nationalite);
      if (item.pays) parts.push(item.pays);
      if (item.site_web) parts.push(`<a href="${item.site_web}" target="_blank">Site web</a>`);
      if (item.description) parts.push(item.description.substring(0, 60) + (item.description.length > 60 ? '...' : ''));
      return parts.join(' - ');
    }

    async function openAddRefModalJeux() {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];

      document.getElementById('modalRefJeuxTitle').textContent = `Ajouter un(e) ${config.labelSingular}`;
      document.getElementById('formRefJeux').reset();
      document.getElementById('ref_jeux_id').value = '';
      document.getElementById('ref_jeux_actif').checked = true;

      document.getElementById('ref_jeux_couleur').value = '#0d6efd';
      document.getElementById('ref_jeux_couleur_text').value = '#0d6efd';
      document.getElementById('ref_jeux_icone').value = 'tag';
      document.getElementById('ref_jeux_icone_preview').innerHTML = '<i class="bi bi-tag"></i>';
      renderUsedColorsPalette('Jeux', '#0d6efd');
      updateColorPaletteSelection('Jeux', '#0d6efd');

      setupRefFormFieldsJeux(config);

      if (config.fields.includes('editeur')) await loadEditeursSelect();
      if (config.fields.includes('site')) await loadSitesSelect('ref_jeux_site_id');

      modalRefJeux.show();
    }

    async function editRefJeux(id) {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];
      const item = currentRefItemsJeux.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalRefJeuxTitle').textContent = `Modifier ${config.labelSingular}`;
      document.getElementById('ref_jeux_id').value = item.id;

      document.getElementById('ref_jeux_nom').value = item.nom || '';
      document.getElementById('ref_jeux_libelle').value = item.libelle || '';
      document.getElementById('ref_jeux_code').value = item.code || '';
      document.getElementById('ref_jeux_prenom').value = item.prenom || '';
      document.getElementById('ref_jeux_nationalite').value = item.nationalite || '';
      document.getElementById('ref_jeux_pays').value = item.pays || '';
      document.getElementById('ref_jeux_site_web').value = item.site_web || '';
      document.getElementById('ref_jeux_description').value = item.description || '';
      document.getElementById('ref_jeux_couleur').value = item.couleur || '#0d6efd';
      document.getElementById('ref_jeux_couleur_text').value = item.couleur || '#0d6efd';
      document.getElementById('ref_jeux_icone').value = item.icone || 'tag';
      document.getElementById('ref_jeux_icone_preview').innerHTML = `<i class="bi bi-${item.icone || 'tag'}"></i>`;
      document.getElementById('ref_jeux_actif').checked = item.actif;
      renderUsedColorsPalette('Jeux', item.couleur || '#0d6efd');
      updateColorPaletteSelection('Jeux', item.couleur || '#0d6efd');

      setupRefFormFieldsJeux(config);

      if (config.fields.includes('editeur')) {
        await loadEditeursSelect();
        document.getElementById('ref_jeux_editeur_id').value = item.editeur_id || '';
      }
      if (config.fields.includes('site')) {
        await loadSitesSelect('ref_jeux_site_id');
        document.getElementById('ref_jeux_site_id').value = item.site_id || '';
      }

      modalRefJeux.show();
    }

    function setupRefFormFieldsJeux(config) {
      ['fieldNomJeux', 'fieldLibelleJeux', 'fieldCodeJeux', 'fieldPrenomJeux', 'fieldNationaliteJeux',
       'fieldPaysJeux', 'fieldSiteWebJeux', 'fieldDescriptionJeux', 'fieldCouleurJeux', 'fieldIconeJeux',
       'fieldEditeurJeux', 'fieldSiteJeux'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
      });

      if (config.useLibelle) {
        document.getElementById('fieldLibelleJeux').classList.remove('d-none');
        document.getElementById('ref_jeux_libelle').required = true;
        document.getElementById('ref_jeux_nom').required = false;
      } else {
        document.getElementById('fieldNomJeux').classList.remove('d-none');
        document.getElementById('ref_jeux_nom').required = true;
        document.getElementById('ref_jeux_libelle').required = false;
      }

      config.fields.forEach(field => {
        switch(field) {
          case 'code': document.getElementById('fieldCodeJeux').classList.remove('d-none'); break;
          case 'prenom': document.getElementById('fieldPrenomJeux').classList.remove('d-none'); break;
          case 'nationalite': document.getElementById('fieldNationaliteJeux').classList.remove('d-none'); break;
          case 'pays': document.getElementById('fieldPaysJeux').classList.remove('d-none'); break;
          case 'site_web': document.getElementById('fieldSiteWebJeux').classList.remove('d-none'); break;
          case 'description': document.getElementById('fieldDescriptionJeux').classList.remove('d-none'); break;
          case 'couleur': document.getElementById('fieldCouleurJeux').classList.remove('d-none'); break;
          case 'icone': document.getElementById('fieldIconeJeux').classList.remove('d-none'); break;
          case 'editeur': document.getElementById('fieldEditeurJeux').classList.remove('d-none'); break;
          case 'site': document.getElementById('fieldSiteJeux').classList.remove('d-none'); break;
        }
      });
    }

    async function loadEditeursSelect() {
      try {
        const result = await referentielsAPI.getEditeurs({ actif: 'true' });
        editeurs = result.items || result;
        const select = document.getElementById('ref_jeux_editeur_id');
        select.innerHTML = '<option value="">-- Aucun --</option>' +
          editeurs.map(e => `<option value="${e.id}">${e.nom}</option>`).join('');
      } catch (error) {
        console.error('Erreur chargement editeurs:', error);
      }
    }

    async function loadSitesSelect(selectId) {
      try {
        const response = await fetch('/api/sites', {
          headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        });
        if (response.ok) {
          sites = await response.json();
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Aucun --</option>' +
            sites.map(s => `<option value="${s.id}">${s.nom}</option>`).join('');
        }
      } catch (error) {
        console.error('Erreur chargement sites:', error);
      }
    }

    async function saveRefJeux() {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];
      const id = document.getElementById('ref_jeux_id').value;

      const data = {
        actif: document.getElementById('ref_jeux_actif').checked
      };

      if (config.useLibelle) {
        data.libelle = document.getElementById('ref_jeux_libelle').value;
      } else {
        data.nom = document.getElementById('ref_jeux_nom').value;
      }

      if (config.fields.includes('code')) data.code = document.getElementById('ref_jeux_code').value || null;
      if (config.fields.includes('prenom')) data.prenom = document.getElementById('ref_jeux_prenom').value || null;
      if (config.fields.includes('nationalite')) data.nationalite = document.getElementById('ref_jeux_nationalite').value || null;
      if (config.fields.includes('pays')) data.pays = document.getElementById('ref_jeux_pays').value || null;
      if (config.fields.includes('site_web')) data.site_web = document.getElementById('ref_jeux_site_web').value || null;
      if (config.fields.includes('description')) data.description = document.getElementById('ref_jeux_description').value || null;
      if (config.fields.includes('couleur')) data.couleur = document.getElementById('ref_jeux_couleur').value;
      if (config.fields.includes('icone')) data.icone = document.getElementById('ref_jeux_icone').value || null;
      if (config.fields.includes('editeur')) data.editeur_id = document.getElementById('ref_jeux_editeur_id').value || null;
      if (config.fields.includes('site')) data.site_id = document.getElementById('ref_jeux_site_id').value || null;

      try {
        if (id) {
          await config.apiUpdate.call(referentielsAPI, id, data);
        } else {
          await config.apiCreate.call(referentielsAPI, data);
        }

        modalRefJeux.hide();
        showToast(`${config.labelSingular} enregistre(e)`, 'success');
        loadCurrentRefJeux();
        loadRefStatsJeux();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function toggleRefJeux(id) {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];
      try {
        await config.apiToggle.call(referentielsAPI, id);
        loadCurrentRefJeux();
      } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la modification', 'error');
      }
    }

    async function deleteRefJeux(id) {
      const config = REF_CONFIG_JEUX[currentRefTypejeux];
      if (!confirm(`Supprimer ce ${config.labelSingular} ?`)) return;

      try {
        await config.apiDelete.call(referentielsAPI, id);
        showToast(`${config.labelSingular} supprime(e)`, 'success');
        loadCurrentRefJeux();
        loadRefStatsJeux();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Impossible de supprimer (element utilise)', 'error');
      }
    }

    // ========================
    // Referentiels Livres - CRUD
    // ========================
    function onRefTypeChangeLivres() {
      currentRefTypeLivres = document.getElementById('refTypeLivres').value;
      document.getElementById('refSearchLivres').value = '';
      loadCurrentRefLivres();
    }

    function onRefSearchLivres() {
      clearTimeout(searchTimeoutLivres);
      searchTimeoutLivres = setTimeout(() => loadCurrentRefLivres(), 300);
    }

    async function loadCurrentRefLivres() {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];
      if (!config) return;

      const container = document.getElementById('ref-list-livres');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Chargement...</div>';

      document.getElementById('refListTitleLivres').innerHTML = `<i class="bi bi-${config.icon}"></i> ${config.label}`;

      try {
        let result = await config.apiGet();
        // L'API retourne { genres: [...] }, { formats: [...] }, etc.
        let items = result[currentRefTypeLivres] || result.items || result || [];
        if (!Array.isArray(items)) items = [];

        // Filtrer par recherche
        const search = document.getElementById('refSearchLivres').value.toLowerCase();
        if (search) {
          items = items.filter(item => {
            const label = config.useLibelle ? item.libelle : item.nom;
            return label && label.toLowerCase().includes(search);
          });
        }

        // Filtrer inactifs
        if (!document.getElementById('showInactifsLivres').checked) {
          items = items.filter(item => item.actif !== false);
        }

        currentRefItemsLivres = items;

        document.getElementById('refCountLivres').textContent = currentRefItemsLivres.length;
        renderRefListLivres();
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    function renderRefListLivres() {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];
      const container = document.getElementById('ref-list-livres');

      if (currentRefItemsLivres.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mt-2">Aucun element trouve</p>
            <button class="btn btn-primary btn-sm" onclick="openAddRefModalLivres()">
              <i class="bi bi-plus"></i> Ajouter
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = currentRefItemsLivres.map(item => {
        const label = config.useLibelle ? item.libelle : item.nom;
        const extraInfo = getRefExtraInfo(item, config);

        return `
          <div class="list-item ${item.actif === false ? 'inactive' : ''}" data-id="${item.id}">
            <div class="item-content">
              ${item.couleur ? `<span class="color-dot" style="background-color:${item.couleur}"></span>` : ''}
              ${item.icone ? `<i class="bi bi-${item.icone} me-2"></i>` : `<i class="bi bi-${config.icon} me-2 text-muted"></i>`}
              <strong>${label}</strong>
              ${item.actif === false ? '<span class="badge bg-warning badge-mode">Inactif</span>' : ''}
              ${extraInfo ? `<br><small class="text-muted">${extraInfo}</small>` : ''}
            </div>
            <div class="item-actions">
              <button class="btn btn-sm btn-outline-secondary" onclick="editRefLivres(${item.id})" title="Modifier">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-${item.actif === false ? 'success' : 'warning'}" onclick="toggleRefLivres(${item.id})" title="${item.actif === false ? 'Activer' : 'Desactiver'}">
                <i class="bi bi-${item.actif === false ? 'eye' : 'eye-slash'}"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRefLivres(${item.id})" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function openAddRefModalLivres() {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];

      document.getElementById('modalRefLivresTitle').textContent = `Ajouter un(e) ${config.labelSingular}`;
      document.getElementById('formRefLivres').reset();
      document.getElementById('ref_livres_id').value = '';
      document.getElementById('ref_livres_actif').checked = true;

      document.getElementById('ref_livres_couleur').value = '#0d6efd';
      document.getElementById('ref_livres_couleur_text').value = '#0d6efd';
      document.getElementById('ref_livres_icone').value = 'tag';
      document.getElementById('ref_livres_icone_preview').innerHTML = '<i class="bi bi-tag"></i>';
      renderUsedColorsPalette('Livres', '#0d6efd');
      updateColorPaletteSelection('Livres', '#0d6efd');

      setupRefFormFieldsLivres(config);

      if (config.fields.includes('site')) await loadSitesSelect('ref_livres_site_id');

      modalRefLivres.show();
    }

    async function editRefLivres(id) {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];
      const item = currentRefItemsLivres.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalRefLivresTitle').textContent = `Modifier ${config.labelSingular}`;
      document.getElementById('ref_livres_id').value = item.id;

      document.getElementById('ref_livres_nom').value = item.nom || '';
      document.getElementById('ref_livres_libelle').value = item.libelle || '';
      document.getElementById('ref_livres_code').value = item.code || '';
      document.getElementById('ref_livres_description').value = item.description || '';
      document.getElementById('ref_livres_couleur').value = item.couleur || '#0d6efd';
      document.getElementById('ref_livres_couleur_text').value = item.couleur || '#0d6efd';
      document.getElementById('ref_livres_icone').value = item.icone || 'tag';
      document.getElementById('ref_livres_icone_preview').innerHTML = `<i class="bi bi-${item.icone || 'tag'}"></i>`;
      document.getElementById('ref_livres_actif').checked = item.actif !== false;
      renderUsedColorsPalette('Livres', item.couleur || '#0d6efd');
      updateColorPaletteSelection('Livres', item.couleur || '#0d6efd');

      setupRefFormFieldsLivres(config);

      if (config.fields.includes('site')) {
        await loadSitesSelect('ref_livres_site_id');
        document.getElementById('ref_livres_site_id').value = item.site_id || '';
      }

      modalRefLivres.show();
    }

    function setupRefFormFieldsLivres(config) {
      ['fieldNomLivres', 'fieldLibelleLivres', 'fieldCodeLivres', 'fieldDescriptionLivres',
       'fieldCouleurLivres', 'fieldIconeLivres', 'fieldSiteLivres'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
      });

      if (config.useLibelle) {
        document.getElementById('fieldLibelleLivres').classList.remove('d-none');
        document.getElementById('ref_livres_libelle').required = true;
        document.getElementById('ref_livres_nom').required = false;
      } else {
        document.getElementById('fieldNomLivres').classList.remove('d-none');
        document.getElementById('ref_livres_nom').required = true;
        document.getElementById('ref_livres_libelle').required = false;
      }

      config.fields.forEach(field => {
        switch(field) {
          case 'code': document.getElementById('fieldCodeLivres').classList.remove('d-none'); break;
          case 'description': document.getElementById('fieldDescriptionLivres').classList.remove('d-none'); break;
          case 'couleur': document.getElementById('fieldCouleurLivres').classList.remove('d-none'); break;
          case 'icone': document.getElementById('fieldIconeLivres').classList.remove('d-none'); break;
          case 'site': document.getElementById('fieldSiteLivres').classList.remove('d-none'); break;
        }
      });
    }

    async function saveRefLivres() {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];
      const id = document.getElementById('ref_livres_id').value;

      const data = {
        actif: document.getElementById('ref_livres_actif').checked
      };

      if (config.useLibelle) {
        data.libelle = document.getElementById('ref_livres_libelle').value;
      } else {
        data.nom = document.getElementById('ref_livres_nom').value;
      }

      if (config.fields.includes('code')) data.code = document.getElementById('ref_livres_code').value || null;
      if (config.fields.includes('description')) data.description = document.getElementById('ref_livres_description').value || null;
      if (config.fields.includes('couleur')) data.couleur = document.getElementById('ref_livres_couleur').value;
      if (config.fields.includes('icone')) data.icone = document.getElementById('ref_livres_icone').value || null;
      if (config.fields.includes('site')) data.site_id = document.getElementById('ref_livres_site_id').value || null;

      try {
        if (id) {
          await config.apiUpdate(id, data);
        } else {
          await config.apiCreate(data);
        }

        modalRefLivres.hide();
        showToast(`${config.labelSingular} enregistre(e)`, 'success');
        loadCurrentRefLivres();
        loadRefStatsLivres();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function toggleRefLivres(id) {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];
      try {
        await config.apiToggle(id);
        loadCurrentRefLivres();
      } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la modification', 'error');
      }
    }

    async function deleteRefLivres(id) {
      const config = REF_CONFIG_LIVRES[currentRefTypeLivres];
      if (!confirm(`Supprimer ce ${config.labelSingular} ?`)) return;

      try {
        await config.apiDelete(id);
        showToast(`${config.labelSingular} supprime(e)`, 'success');
        loadCurrentRefLivres();
        loadRefStatsLivres();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Impossible de supprimer (element utilise)', 'error');
      }
    }

    // ========================
    // Configuration referentiels Films
    // ========================
    const REF_CONFIG_FILMS = {
      genres: {
        label: 'Genres',
        labelSingular: 'genre',
        icon: 'film',
        fields: ['nom', 'description', 'couleur', 'icone'],
        apiGet: () => filmsAPI.getGenres(),
        apiCreate: (data) => apiRequest('/films/referentiels/genres', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/films/referentiels/genres/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/films/referentiels/genres/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/films/referentiels/genres/${id}/toggle`, { method: 'PATCH' })
      },
      supports: {
        label: 'Supports',
        labelSingular: 'support',
        icon: 'disc',
        fields: ['nom', 'description'],
        apiGet: () => filmsAPI.getSupports(),
        apiCreate: (data) => apiRequest('/films/referentiels/supports', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/films/referentiels/supports/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/films/referentiels/supports/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/films/referentiels/supports/${id}/toggle`, { method: 'PATCH' })
      },
      realisateurs: {
        label: 'Realisateurs',
        labelSingular: 'realisateur',
        icon: 'camera-reels',
        fields: ['nom', 'prenom', 'nationalite'],
        apiGet: () => filmsAPI.getRealisateurs(),
        apiCreate: (data) => apiRequest('/films/referentiels/realisateurs', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/films/referentiels/realisateurs/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/films/referentiels/realisateurs/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/films/referentiels/realisateurs/${id}/toggle`, { method: 'PATCH' })
      },
      acteurs: {
        label: 'Acteurs',
        labelSingular: 'acteur',
        icon: 'person-badge',
        fields: ['nom', 'prenom', 'nationalite'],
        apiGet: () => filmsAPI.getActeurs(),
        apiCreate: (data) => apiRequest('/films/referentiels/acteurs', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/films/referentiels/acteurs/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/films/referentiels/acteurs/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/films/referentiels/acteurs/${id}/toggle`, { method: 'PATCH' })
      },
      studios: {
        label: 'Studios',
        labelSingular: 'studio',
        icon: 'building',
        fields: ['nom', 'pays', 'description'],
        apiGet: () => filmsAPI.getStudios(),
        apiCreate: (data) => apiRequest('/films/referentiels/studios', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/films/referentiels/studios/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/films/referentiels/studios/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/films/referentiels/studios/${id}/toggle`, { method: 'PATCH' })
      },
      emplacements: {
        label: 'Emplacements',
        labelSingular: 'emplacement',
        icon: 'geo-alt',
        fields: ['libelle', 'code', 'description', 'couleur', 'icone', 'site'],
        useLibelle: true,
        apiGet: () => filmsAPI.getEmplacements(),
        apiCreate: (data) => apiRequest('/films/referentiels/emplacements', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/films/referentiels/emplacements/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/films/referentiels/emplacements/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/films/referentiels/emplacements/${id}/toggle`, { method: 'PATCH' })
      }
    };

    // ========================
    // Configuration referentiels Musiques
    // ========================
    const REF_CONFIG_MUSIQUES = {
      genres: {
        label: 'Genres',
        labelSingular: 'genre',
        icon: 'music-note',
        fields: ['nom', 'description', 'couleur', 'icone'],
        apiGet: () => disquesAPI.getGenres(),
        apiCreate: (data) => apiRequest('/disques/referentiels/genres', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/disques/referentiels/genres/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/disques/referentiels/genres/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/disques/referentiels/genres/${id}/toggle`, { method: 'PATCH' })
      },
      formats: {
        label: 'Formats',
        labelSingular: 'format',
        icon: 'vinyl',
        fields: ['nom', 'description'],
        apiGet: () => disquesAPI.getFormats(),
        apiCreate: (data) => apiRequest('/disques/referentiels/formats', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/disques/referentiels/formats/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/disques/referentiels/formats/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/disques/referentiels/formats/${id}/toggle`, { method: 'PATCH' })
      },
      artistes: {
        label: 'Artistes',
        labelSingular: 'artiste',
        icon: 'person-badge',
        fields: ['nom', 'description'],
        apiGet: () => disquesAPI.getArtistes(),
        apiCreate: (data) => apiRequest('/disques/referentiels/artistes', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/disques/referentiels/artistes/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/disques/referentiels/artistes/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/disques/referentiels/artistes/${id}/toggle`, { method: 'PATCH' })
      },
      labels: {
        label: 'Labels',
        labelSingular: 'label',
        icon: 'building',
        fields: ['nom', 'pays', 'description'],
        apiGet: () => disquesAPI.getLabels(),
        apiCreate: (data) => apiRequest('/disques/referentiels/labels', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/disques/referentiels/labels/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/disques/referentiels/labels/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/disques/referentiels/labels/${id}/toggle`, { method: 'PATCH' })
      },
      emplacements: {
        label: 'Emplacements',
        labelSingular: 'emplacement',
        icon: 'geo-alt',
        fields: ['libelle', 'code', 'description', 'couleur', 'icone', 'site'],
        useLibelle: true,
        apiGet: () => disquesAPI.getEmplacements(),
        apiCreate: (data) => apiRequest('/disques/referentiels/emplacements', { method: 'POST', body: JSON.stringify(data) }),
        apiUpdate: (id, data) => apiRequest(`/disques/referentiels/emplacements/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
        apiDelete: (id) => apiRequest(`/disques/referentiels/emplacements/${id}`, { method: 'DELETE' }),
        apiToggle: (id) => apiRequest(`/disques/referentiels/emplacements/${id}/toggle`, { method: 'PATCH' })
      }
    };

    // ========================
    // Stats referentiels Films
    // ========================
    async function loadRefStatsFilms() {
      try {
        const stats = await filmsAPI.getStats();
        renderRefStatsFilms(stats);
      } catch (error) {
        console.error('Erreur stats films:', error);
        document.getElementById('ref-stats-films').innerHTML = '<div class="text-muted">Stats non disponibles</div>';
      }
    }

    function renderRefStatsFilms(stats) {
      const container = document.getElementById('ref-stats-films');
      const items = [
        { key: 'genres', label: 'Genres', icon: 'film', count: stats.genres || 0 },
        { key: 'supports', label: 'Supports', icon: 'disc', count: stats.supports || 0 },
        { key: 'realisateurs', label: 'Realisateurs', icon: 'camera-reels', count: stats.realisateurs || 0 },
        { key: 'acteurs', label: 'Acteurs', icon: 'person-badge', count: stats.acteurs || 0 },
        { key: 'studios', label: 'Studios', icon: 'building', count: stats.studios || 0 },
        { key: 'emplacements', label: 'Emplacements', icon: 'geo-alt', count: stats.emplacements || 0 }
      ];

      container.innerHTML = items.map(item => `
        <div class="ref-stat-card ${currentRefTypeFilms === item.key ? 'active' : ''}" onclick="selectRefTypeFilms('${item.key}')">
          <i class="bi bi-${item.icon} text-danger"></i>
          <h3>${item.count}</h3>
          <small>${item.label}</small>
        </div>
      `).join('');
    }

    function selectRefTypeFilms(type) {
      currentRefTypeFilms = type;
      document.getElementById('refTypeFilms').value = type;
      loadCurrentRefFilms();
      loadRefStatsFilms();
    }

    // ========================
    // Stats referentiels Musiques
    // ========================
    async function loadRefStatsMusiques() {
      try {
        const stats = await disquesAPI.getStats();
        renderRefStatsMusiques(stats);
      } catch (error) {
        console.error('Erreur stats musiques:', error);
        document.getElementById('ref-stats-musiques').innerHTML = '<div class="text-muted">Stats non disponibles</div>';
      }
    }

    function renderRefStatsMusiques(stats) {
      const container = document.getElementById('ref-stats-musiques');
      const items = [
        { key: 'genres', label: 'Genres', icon: 'music-note', count: stats.genres || 0 },
        { key: 'formats', label: 'Formats', icon: 'vinyl', count: stats.formats || 0 },
        { key: 'artistes', label: 'Artistes', icon: 'person-badge', count: stats.artistes || 0 },
        { key: 'labels', label: 'Labels', icon: 'building', count: stats.labels || 0 },
        { key: 'emplacements', label: 'Emplacements', icon: 'geo-alt', count: stats.emplacements || 0 }
      ];

      container.innerHTML = items.map(item => `
        <div class="ref-stat-card ${currentRefTypeMusiques === item.key ? 'active' : ''}" onclick="selectRefTypeMusiques('${item.key}')">
          <i class="bi bi-${item.icon} text-success"></i>
          <h3>${item.count}</h3>
          <small>${item.label}</small>
        </div>
      `).join('');
    }

    function selectRefTypeMusiques(type) {
      currentRefTypeMusiques = type;
      document.getElementById('refTypeMusiques').value = type;
      loadCurrentRefMusiques();
      loadRefStatsMusiques();
    }

    // ========================
    // Referentiels Films - CRUD
    // ========================
    function onRefTypeChangeFilms() {
      currentRefTypeFilms = document.getElementById('refTypeFilms').value;
      document.getElementById('refSearchFilms').value = '';
      loadCurrentRefFilms();
    }

    function onRefSearchFilms() {
      clearTimeout(searchTimeoutFilms);
      searchTimeoutFilms = setTimeout(() => loadCurrentRefFilms(), 300);
    }

    async function loadCurrentRefFilms() {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];
      if (!config) return;

      const container = document.getElementById('ref-list-films');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Chargement...</div>';

      document.getElementById('refListTitleFilms').innerHTML = `<i class="bi bi-${config.icon}"></i> ${config.label}`;

      try {
        let result = await config.apiGet();
        let items = result[currentRefTypeFilms] || result.items || result || [];
        if (!Array.isArray(items)) items = [];

        const search = document.getElementById('refSearchFilms').value.toLowerCase();
        if (search) {
          items = items.filter(item => {
            const label = config.useLibelle ? item.libelle : item.nom;
            return label && label.toLowerCase().includes(search);
          });
        }

        if (!document.getElementById('showInactifsFilms').checked) {
          items = items.filter(item => item.actif !== false);
        }

        currentRefItemsFilms = items;
        document.getElementById('refCountFilms').textContent = currentRefItemsFilms.length;
        renderRefListFilms();
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    function renderRefListFilms() {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];
      const container = document.getElementById('ref-list-films');

      if (currentRefItemsFilms.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mt-2">Aucun element trouve</p>
            <button class="btn btn-primary btn-sm" onclick="openAddRefModalFilms()">
              <i class="bi bi-plus"></i> Ajouter
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = currentRefItemsFilms.map(item => {
        const label = config.useLibelle ? item.libelle : item.nom;
        const extraInfo = getRefExtraInfo(item, config);

        return `
          <div class="list-item ${item.actif === false ? 'inactive' : ''}" data-id="${item.id}">
            <div class="item-content">
              ${item.couleur ? `<span class="color-dot" style="background-color:${item.couleur}"></span>` : ''}
              ${item.icone ? `<i class="bi bi-${item.icone} me-2"></i>` : `<i class="bi bi-${config.icon} me-2 text-muted"></i>`}
              <strong>${label}</strong>
              ${item.actif === false ? '<span class="badge bg-warning badge-mode">Inactif</span>' : ''}
              ${extraInfo ? `<br><small class="text-muted">${extraInfo}</small>` : ''}
            </div>
            <div class="item-actions">
              <button class="btn btn-sm btn-outline-secondary" onclick="editRefFilms(${item.id})" title="Modifier">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-${item.actif === false ? 'success' : 'warning'}" onclick="toggleRefFilms(${item.id})" title="${item.actif === false ? 'Activer' : 'Desactiver'}">
                <i class="bi bi-${item.actif === false ? 'eye' : 'eye-slash'}"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRefFilms(${item.id})" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function openAddRefModalFilms() {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];

      document.getElementById('modalRefFilmsTitle').textContent = `Ajouter un(e) ${config.labelSingular}`;
      document.getElementById('formRefFilms').reset();
      document.getElementById('ref_films_id').value = '';
      document.getElementById('ref_films_actif').checked = true;

      document.getElementById('ref_films_couleur').value = '#dc3545';
      document.getElementById('ref_films_couleur_text').value = '#dc3545';
      document.getElementById('ref_films_icone').value = 'tag';
      document.getElementById('ref_films_icone_preview').innerHTML = '<i class="bi bi-tag"></i>';
      renderUsedColorsPalette('Films', '#dc3545');
      updateColorPaletteSelection('Films', '#dc3545');

      setupRefFormFieldsFilms(config);

      if (config.fields.includes('site')) await loadSitesSelect('ref_films_site_id');

      modalRefFilms.show();
    }

    async function editRefFilms(id) {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];
      const item = currentRefItemsFilms.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalRefFilmsTitle').textContent = `Modifier ${config.labelSingular}`;
      document.getElementById('ref_films_id').value = item.id;

      document.getElementById('ref_films_nom').value = item.nom || '';
      document.getElementById('ref_films_libelle').value = item.libelle || '';
      document.getElementById('ref_films_code').value = item.code || '';
      document.getElementById('ref_films_prenom').value = item.prenom || '';
      document.getElementById('ref_films_nationalite').value = item.nationalite || '';
      document.getElementById('ref_films_pays').value = item.pays || '';
      document.getElementById('ref_films_description').value = item.description || '';
      document.getElementById('ref_films_couleur').value = item.couleur || '#dc3545';
      document.getElementById('ref_films_couleur_text').value = item.couleur || '#dc3545';
      document.getElementById('ref_films_icone').value = item.icone || 'tag';
      document.getElementById('ref_films_icone_preview').innerHTML = `<i class="bi bi-${item.icone || 'tag'}"></i>`;
      document.getElementById('ref_films_actif').checked = item.actif !== false;
      renderUsedColorsPalette('Films', item.couleur || '#dc3545');
      updateColorPaletteSelection('Films', item.couleur || '#dc3545');

      setupRefFormFieldsFilms(config);

      if (config.fields.includes('site')) {
        await loadSitesSelect('ref_films_site_id');
        document.getElementById('ref_films_site_id').value = item.site_id || '';
      }

      modalRefFilms.show();
    }

    function setupRefFormFieldsFilms(config) {
      ['fieldNomFilms', 'fieldLibelleFilms', 'fieldCodeFilms', 'fieldPrenomFilms', 'fieldNationaliteFilms',
       'fieldPaysFilms', 'fieldDescriptionFilms', 'fieldCouleurFilms', 'fieldIconeFilms', 'fieldSiteFilms'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
      });

      if (config.useLibelle) {
        document.getElementById('fieldLibelleFilms').classList.remove('d-none');
        document.getElementById('ref_films_libelle').required = true;
        document.getElementById('ref_films_nom').required = false;
      } else {
        document.getElementById('fieldNomFilms').classList.remove('d-none');
        document.getElementById('ref_films_nom').required = true;
        document.getElementById('ref_films_libelle').required = false;
      }

      config.fields.forEach(field => {
        switch(field) {
          case 'code': document.getElementById('fieldCodeFilms').classList.remove('d-none'); break;
          case 'prenom': document.getElementById('fieldPrenomFilms').classList.remove('d-none'); break;
          case 'nationalite': document.getElementById('fieldNationaliteFilms').classList.remove('d-none'); break;
          case 'pays': document.getElementById('fieldPaysFilms').classList.remove('d-none'); break;
          case 'description': document.getElementById('fieldDescriptionFilms').classList.remove('d-none'); break;
          case 'couleur': document.getElementById('fieldCouleurFilms').classList.remove('d-none'); break;
          case 'icone': document.getElementById('fieldIconeFilms').classList.remove('d-none'); break;
          case 'site': document.getElementById('fieldSiteFilms').classList.remove('d-none'); break;
        }
      });
    }

    async function saveRefFilms() {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];
      const id = document.getElementById('ref_films_id').value;

      const data = { actif: document.getElementById('ref_films_actif').checked };

      if (config.useLibelle) {
        data.libelle = document.getElementById('ref_films_libelle').value;
      } else {
        data.nom = document.getElementById('ref_films_nom').value;
      }

      if (config.fields.includes('code')) data.code = document.getElementById('ref_films_code').value || null;
      if (config.fields.includes('prenom')) data.prenom = document.getElementById('ref_films_prenom').value || null;
      if (config.fields.includes('nationalite')) data.nationalite = document.getElementById('ref_films_nationalite').value || null;
      if (config.fields.includes('pays')) data.pays = document.getElementById('ref_films_pays').value || null;
      if (config.fields.includes('description')) data.description = document.getElementById('ref_films_description').value || null;
      if (config.fields.includes('couleur')) data.couleur = document.getElementById('ref_films_couleur').value;
      if (config.fields.includes('icone')) data.icone = document.getElementById('ref_films_icone').value || null;
      if (config.fields.includes('site')) data.site_id = document.getElementById('ref_films_site_id').value || null;

      try {
        if (id) {
          await config.apiUpdate(id, data);
        } else {
          await config.apiCreate(data);
        }

        modalRefFilms.hide();
        showToast(`${config.labelSingular} enregistre(e)`, 'success');
        loadCurrentRefFilms();
        loadRefStatsFilms();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function toggleRefFilms(id) {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];
      try {
        await config.apiToggle(id);
        loadCurrentRefFilms();
      } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la modification', 'error');
      }
    }

    async function deleteRefFilms(id) {
      const config = REF_CONFIG_FILMS[currentRefTypeFilms];
      if (!confirm(`Supprimer ce ${config.labelSingular} ?`)) return;

      try {
        await config.apiDelete(id);
        showToast(`${config.labelSingular} supprime(e)`, 'success');
        loadCurrentRefFilms();
        loadRefStatsFilms();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Impossible de supprimer (element utilise)', 'error');
      }
    }

    // ========================
    // Referentiels Musiques - CRUD
    // ========================
    function onRefTypeChangeMusiques() {
      currentRefTypeMusiques = document.getElementById('refTypeMusiques').value;
      document.getElementById('refSearchMusiques').value = '';
      loadCurrentRefMusiques();
    }

    function onRefSearchMusiques() {
      clearTimeout(searchTimeoutMusiques);
      searchTimeoutMusiques = setTimeout(() => loadCurrentRefMusiques(), 300);
    }

    async function loadCurrentRefMusiques() {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];
      if (!config) return;

      const container = document.getElementById('ref-list-musiques');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Chargement...</div>';

      document.getElementById('refListTitleMusiques').innerHTML = `<i class="bi bi-${config.icon}"></i> ${config.label}`;

      try {
        let result = await config.apiGet();
        let items = result[currentRefTypeMusiques] || result.items || result || [];
        if (!Array.isArray(items)) items = [];

        const search = document.getElementById('refSearchMusiques').value.toLowerCase();
        if (search) {
          items = items.filter(item => {
            const label = config.useLibelle ? item.libelle : item.nom;
            return label && label.toLowerCase().includes(search);
          });
        }

        if (!document.getElementById('showInactifsMusiques').checked) {
          items = items.filter(item => item.actif !== false);
        }

        currentRefItemsMusiques = items;
        document.getElementById('refCountMusiques').textContent = currentRefItemsMusiques.length;
        renderRefListMusiques();
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    function renderRefListMusiques() {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];
      const container = document.getElementById('ref-list-musiques');

      if (currentRefItemsMusiques.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mt-2">Aucun element trouve</p>
            <button class="btn btn-primary btn-sm" onclick="openAddRefModalMusiques()">
              <i class="bi bi-plus"></i> Ajouter
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = currentRefItemsMusiques.map(item => {
        const label = config.useLibelle ? item.libelle : item.nom;
        const extraInfo = getRefExtraInfo(item, config);

        return `
          <div class="list-item ${item.actif === false ? 'inactive' : ''}" data-id="${item.id}">
            <div class="item-content">
              ${item.couleur ? `<span class="color-dot" style="background-color:${item.couleur}"></span>` : ''}
              ${item.icone ? `<i class="bi bi-${item.icone} me-2"></i>` : `<i class="bi bi-${config.icon} me-2 text-muted"></i>`}
              <strong>${label}</strong>
              ${item.actif === false ? '<span class="badge bg-warning badge-mode">Inactif</span>' : ''}
              ${extraInfo ? `<br><small class="text-muted">${extraInfo}</small>` : ''}
            </div>
            <div class="item-actions">
              <button class="btn btn-sm btn-outline-secondary" onclick="editRefMusiques(${item.id})" title="Modifier">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-${item.actif === false ? 'success' : 'warning'}" onclick="toggleRefMusiques(${item.id})" title="${item.actif === false ? 'Activer' : 'Desactiver'}">
                <i class="bi bi-${item.actif === false ? 'eye' : 'eye-slash'}"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteRefMusiques(${item.id})" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function openAddRefModalMusiques() {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];

      document.getElementById('modalRefMusiquesTitle').textContent = `Ajouter un(e) ${config.labelSingular}`;
      document.getElementById('formRefMusiques').reset();
      document.getElementById('ref_musiques_id').value = '';
      document.getElementById('ref_musiques_actif').checked = true;

      document.getElementById('ref_musiques_couleur').value = '#198754';
      document.getElementById('ref_musiques_couleur_text').value = '#198754';
      document.getElementById('ref_musiques_icone').value = 'tag';
      document.getElementById('ref_musiques_icone_preview').innerHTML = '<i class="bi bi-tag"></i>';
      renderUsedColorsPalette('Musiques', '#198754');
      updateColorPaletteSelection('Musiques', '#198754');

      setupRefFormFieldsMusiques(config);

      if (config.fields.includes('site')) await loadSitesSelect('ref_musiques_site_id');

      modalRefMusiques.show();
    }

    async function editRefMusiques(id) {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];
      const item = currentRefItemsMusiques.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modalRefMusiquesTitle').textContent = `Modifier ${config.labelSingular}`;
      document.getElementById('ref_musiques_id').value = item.id;

      document.getElementById('ref_musiques_nom').value = item.nom || '';
      document.getElementById('ref_musiques_libelle').value = item.libelle || '';
      document.getElementById('ref_musiques_code').value = item.code || '';
      document.getElementById('ref_musiques_pays').value = item.pays || '';
      document.getElementById('ref_musiques_description').value = item.description || '';
      document.getElementById('ref_musiques_couleur').value = item.couleur || '#198754';
      document.getElementById('ref_musiques_couleur_text').value = item.couleur || '#198754';
      document.getElementById('ref_musiques_icone').value = item.icone || 'tag';
      document.getElementById('ref_musiques_icone_preview').innerHTML = `<i class="bi bi-${item.icone || 'tag'}"></i>`;
      document.getElementById('ref_musiques_actif').checked = item.actif !== false;
      renderUsedColorsPalette('Musiques', item.couleur || '#198754');
      updateColorPaletteSelection('Musiques', item.couleur || '#198754');

      setupRefFormFieldsMusiques(config);

      if (config.fields.includes('site')) {
        await loadSitesSelect('ref_musiques_site_id');
        document.getElementById('ref_musiques_site_id').value = item.site_id || '';
      }

      modalRefMusiques.show();
    }

    function setupRefFormFieldsMusiques(config) {
      ['fieldNomMusiques', 'fieldLibelleMusiques', 'fieldCodeMusiques', 'fieldPaysMusiques',
       'fieldDescriptionMusiques', 'fieldCouleurMusiques', 'fieldIconeMusiques', 'fieldSiteMusiques'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
      });

      if (config.useLibelle) {
        document.getElementById('fieldLibelleMusiques').classList.remove('d-none');
        document.getElementById('ref_musiques_libelle').required = true;
        document.getElementById('ref_musiques_nom').required = false;
      } else {
        document.getElementById('fieldNomMusiques').classList.remove('d-none');
        document.getElementById('ref_musiques_nom').required = true;
        document.getElementById('ref_musiques_libelle').required = false;
      }

      config.fields.forEach(field => {
        switch(field) {
          case 'code': document.getElementById('fieldCodeMusiques').classList.remove('d-none'); break;
          case 'pays': document.getElementById('fieldPaysMusiques').classList.remove('d-none'); break;
          case 'description': document.getElementById('fieldDescriptionMusiques').classList.remove('d-none'); break;
          case 'couleur': document.getElementById('fieldCouleurMusiques').classList.remove('d-none'); break;
          case 'icone': document.getElementById('fieldIconeMusiques').classList.remove('d-none'); break;
          case 'site': document.getElementById('fieldSiteMusiques').classList.remove('d-none'); break;
        }
      });
    }

    async function saveRefMusiques() {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];
      const id = document.getElementById('ref_musiques_id').value;

      const data = { actif: document.getElementById('ref_musiques_actif').checked };

      if (config.useLibelle) {
        data.libelle = document.getElementById('ref_musiques_libelle').value;
      } else {
        data.nom = document.getElementById('ref_musiques_nom').value;
      }

      if (config.fields.includes('code')) data.code = document.getElementById('ref_musiques_code').value || null;
      if (config.fields.includes('pays')) data.pays = document.getElementById('ref_musiques_pays').value || null;
      if (config.fields.includes('description')) data.description = document.getElementById('ref_musiques_description').value || null;
      if (config.fields.includes('couleur')) data.couleur = document.getElementById('ref_musiques_couleur').value;
      if (config.fields.includes('icone')) data.icone = document.getElementById('ref_musiques_icone').value || null;
      if (config.fields.includes('site')) data.site_id = document.getElementById('ref_musiques_site_id').value || null;

      try {
        if (id) {
          await config.apiUpdate(id, data);
        } else {
          await config.apiCreate(data);
        }

        modalRefMusiques.hide();
        showToast(`${config.labelSingular} enregistre(e)`, 'success');
        loadCurrentRefMusiques();
        loadRefStatsMusiques();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Erreur lors de l\'enregistrement', 'error');
      }
    }

    async function toggleRefMusiques(id) {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];
      try {
        await config.apiToggle(id);
        loadCurrentRefMusiques();
      } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la modification', 'error');
      }
    }

    async function deleteRefMusiques(id) {
      const config = REF_CONFIG_MUSIQUES[currentRefTypeMusiques];
      if (!confirm(`Supprimer ce ${config.labelSingular} ?`)) return;

      try {
        await config.apiDelete(id);
        showToast(`${config.labelSingular} supprime(e)`, 'success');
        loadCurrentRefMusiques();
        loadRefStatsMusiques();
      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Impossible de supprimer (element utilise)', 'error');
      }
    }

    // ========================
    // Utils
    // ========================
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '1100';
      document.body.appendChild(container);
      return container;
    }
  </script>
</body>
</html>
