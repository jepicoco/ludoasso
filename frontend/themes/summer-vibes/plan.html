<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="site-title">Plan interactif - Liberteko</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <script src="/js/theme-loader.js"></script>
  <style>
    /* Plan-specific styles */
    .plan-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
      position: relative;
      background: var(--summer-cream);
    }

    .plan-header {
      background: var(--summer-white);
      padding: var(--space-md) var(--space-lg);
      box-shadow: var(--soft-shadow);
      border-bottom: var(--border-light);
      z-index: 100;
    }

    .plan-controls {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
      flex-wrap: wrap;
    }

    .site-selector {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .site-selector label {
      font-weight: 600;
      color: var(--color-text);
    }

    .site-selector select {
      padding: var(--space-sm) var(--space-md);
      border: 2px solid #e5e7eb;
      border-radius: var(--radius-md);
      background: var(--summer-white);
      color: var(--color-text);
      font-family: var(--font-body);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .site-selector select:focus {
      outline: none;
      border-color: var(--summer-gold);
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
    }

    .floor-tabs {
      display: flex;
      gap: var(--space-xs);
      flex-wrap: wrap;
    }

    .floor-tab {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      background: transparent;
      color: var(--color-text-secondary);
      border: 2px solid #e5e7eb;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: var(--font-body);
    }

    .floor-tab:hover {
      background: var(--summer-gold-pale);
      border-color: var(--summer-gold-light);
    }

    .floor-tab.active {
      background: var(--gradient-sunset);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
    }

    .plan-canvas-wrapper {
      flex: 1;
      overflow: auto;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-lg);
    }

    .plan-canvas {
      background: var(--summer-white);
      border-radius: var(--radius-lg);
      box-shadow: var(--card-shadow);
      overflow: auto;
      max-width: 100%;
      max-height: 100%;
    }

    #planSvg {
      display: block;
      max-width: 100%;
      height: auto;
    }

    /* SVG Element Styles */
    .plan-element {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .plan-element:hover {
      filter: brightness(1.1);
      stroke-width: 3;
    }

    .plan-element.selected {
      filter: brightness(1.2) drop-shadow(0 0 10px rgba(245, 158, 11, 0.8));
      stroke: var(--summer-gold);
      stroke-width: 4;
    }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background: var(--summer-white);
      box-shadow: -4px 0 30px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      transition: right 0.4s ease;
      display: flex;
      flex-direction: column;
    }

    .side-panel.open {
      right: 0;
    }

    .side-panel-header {
      background: var(--gradient-sunset);
      color: white;
      padding: var(--space-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .side-panel-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: white;
    }

    .close-panel {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-panel:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .side-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-lg);
    }

    .element-info {
      background: var(--summer-gold-pale);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-lg);
      border-left: 4px solid var(--summer-gold);
    }

    .element-info strong {
      color: var(--summer-orange);
    }

    .articles-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .article-item {
      background: var(--summer-cream);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      display: flex;
      gap: var(--space-md);
      border: var(--border-light);
      transition: all 0.3s ease;
      text-decoration: none;
      color: inherit;
    }

    .article-item:hover {
      box-shadow: var(--card-shadow);
      transform: translateY(-2px);
      border-color: var(--summer-gold-light);
    }

    .article-image {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      flex-shrink: 0;
      background: var(--summer-white);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .article-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .article-image i {
      font-size: 2rem;
      color: var(--summer-gold);
    }

    .article-details {
      flex: 1;
      min-width: 0;
    }

    .article-title {
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-xs);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .article-meta {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      align-items: center;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-xl);
      color: var(--color-text-secondary);
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--summer-gold);
      margin-bottom: var(--space-md);
      display: block;
    }

    .loading-spinner {
      text-align: center;
      padding: var(--space-xl);
    }

    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 4px solid var(--summer-gold-pale);
      border-top-color: var(--summer-gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    .overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .side-panel {
        width: 100%;
        right: -100%;
      }

      .plan-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .floor-tabs {
        justify-content: center;
      }

      .plan-canvas-wrapper {
        padding: var(--space-sm);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-container">
      <a href="/" class="logo">
        <i class="bi bi-sun logo-icon"></i>
        <span class="logo-text" id="header-title">LIBERTEKO</span>
      </a>
      <nav>
        <ul class="nav-menu">
          <li><a href="/">Accueil</a></li>
          <li><a href="/catalogue.html">Catalogue</a></li>
          <li><a href="/infos.html">Infos</a></li>
          <li><a href="/aide.html">Aide</a></li>
          <li><a href="/plan.html" class="active">Plan</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </nav>
      <a href="/usager/login.html" class="btn-login">
        <i class="bi bi-person-circle"></i> Connexion
      </a>
    </div>
  </header>

  <!-- Plan Container -->
  <div class="plan-container" id="planContainer" style="display: none;">
    <div class="plan-header">
      <div class="plan-controls">
        <div class="site-selector" id="siteSelectorContainer" style="display: none;">
          <label for="siteSelect">
            <i class="bi bi-geo-alt"></i> Site :
          </label>
          <select id="siteSelect">
            <option value="">Chargement...</option>
          </select>
        </div>
        <div class="floor-tabs" id="floorTabs"></div>
      </div>
    </div>

    <div class="plan-canvas-wrapper">
      <div class="plan-canvas">
        <svg id="planSvg" xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600">
          <!-- Plan will be rendered here -->
        </svg>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="page-content" id="emptyState" style="display: none;">
    <div class="empty-state">
      <i class="bi bi-map"></i>
      <h2>Aucun plan disponible</h2>
      <p>Le module de plan interactif n'est pas activé ou aucun plan n'a été configuré.</p>
      <a href="/" class="btn btn-primary mt-4">
        <i class="bi bi-house"></i> Retour à l'accueil
      </a>
    </div>
  </div>

  <!-- Side Panel -->
  <div class="overlay" id="overlay"></div>
  <div class="side-panel" id="sidePanel">
    <div class="side-panel-header">
      <h2 id="panelTitle">Articles</h2>
      <button class="close-panel" id="closePanel">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="side-panel-content" id="panelContent">
      <!-- Content will be loaded here -->
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-section">
        <h4>Contact</h4>
        <p id="footer-address"></p>
        <p id="footer-phone"></p>
        <p id="footer-email"></p>
      </div>
      <div class="footer-section">
        <h4>Navigation</h4>
        <ul>
          <li><a href="/">Accueil</a></li>
          <li><a href="/catalogue.html">Catalogue</a></li>
          <li><a href="/plan.html">Plan</a></li>
          <li><a href="/infos.html">Infos pratiques</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Legal</h4>
        <ul>
          <li><a href="/mentions-legales.html">Mentions legales</a></li>
          <li><a href="/cgu.html">CGU</a></li>
          <li><a href="/cgv.html">CGV</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Espace membre</h4>
        <ul>
          <li><a href="/usager/login.html">Connexion</a></li>
          <li><a href="/admin/login.html">Administration</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span> - Tous droits reserves</p>
    </div>
  </footer>

  <script>
    let currentSiteId = null;
    let currentFloor = 0;
    let planData = null;
    let selectedElement = null;

    async function init() {
      document.getElementById('year').textContent = new Date().getFullYear();

      try {
        // Load configuration
        const configResp = await fetch('/api/public/config');
        const config = await configResp.json();

        const siteName = config.nom_site || 'Liberteko';
        document.getElementById('site-title').textContent = `Plan interactif - ${siteName}`;
        document.getElementById('header-title').textContent = siteName.toUpperCase();
        document.getElementById('footer-name').textContent = siteName;

        // Contact info
        if (config.contact) {
          if (config.contact.adresse) {
            document.getElementById('footer-address').innerHTML = `<i class="bi bi-geo-alt"></i> ${config.contact.adresse}`;
          }
          if (config.contact.telephone) {
            document.getElementById('footer-phone').innerHTML = `<i class="bi bi-telephone"></i> ${config.contact.telephone}`;
          }
          if (config.contact.email) {
            document.getElementById('footer-email').innerHTML = `<i class="bi bi-envelope"></i> ${config.contact.email}`;
          }
        }

        // Check if plan module is enabled
        const paramsResp = await fetch('/api/public/parametres');
        const params = await paramsResp.json();

        if (!params.module_plan_interactif) {
          document.getElementById('emptyState').style.display = 'block';
          return;
        }

        // Load sites
        await loadSites();

      } catch (e) {
        console.error('Init error:', e);
        document.getElementById('emptyState').style.display = 'block';
      }
    }

    async function loadSites() {
      try {
        const resp = await fetch('/api/sites');
        const sites = await resp.json();

        if (sites.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          return;
        }

        const siteSelect = document.getElementById('siteSelect');
        siteSelect.innerHTML = sites.map(site =>
          `<option value="${site.id}">${site.nom}</option>`
        ).join('');

        if (sites.length > 1) {
          document.getElementById('siteSelectorContainer').style.display = 'flex';
        }

        // Load first site by default
        currentSiteId = sites[0].id;
        siteSelect.value = currentSiteId;

        siteSelect.addEventListener('change', (e) => {
          currentSiteId = e.target.value;
          loadPlan();
        });

        await loadPlan();

      } catch (e) {
        console.error('Sites loading error:', e);
        document.getElementById('emptyState').style.display = 'block';
      }
    }

    async function loadPlan() {
      if (!currentSiteId) return;

      try {
        const resp = await fetch(`/api/plans/public/site/${currentSiteId}`);
        planData = await resp.json();

        if (!planData || !planData.elements || planData.elements.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('planContainer').style.display = 'none';
          return;
        }

        document.getElementById('planContainer').style.display = 'flex';
        document.getElementById('emptyState').style.display = 'none';

        renderFloorTabs();
        renderPlan();

      } catch (e) {
        console.error('Plan loading error:', e);
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('planContainer').style.display = 'none';
      }
    }

    function renderFloorTabs() {
      if (!planData || !planData.elements) return;

      const floors = [...new Set(planData.elements.map(el => el.etage || 0))].sort((a, b) => a - b);

      if (floors.length <= 1) {
        document.getElementById('floorTabs').innerHTML = '';
        return;
      }

      const floorTabs = document.getElementById('floorTabs');
      floorTabs.innerHTML = floors.map(floor => `
        <button class="floor-tab ${floor === currentFloor ? 'active' : ''}" data-floor="${floor}">
          ${floor === 0 ? 'Rez-de-chaussee' : `Etage ${floor}`}
        </button>
      `).join('');

      floorTabs.querySelectorAll('.floor-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          currentFloor = parseInt(e.target.dataset.floor);
          renderFloorTabs();
          renderPlan();
        });
      });
    }

    function renderPlan() {
      if (!planData || !planData.elements) return;

      const svg = document.getElementById('planSvg');
      svg.innerHTML = '';

      // Filter elements for current floor
      const floorElements = planData.elements.filter(el => (el.etage || 0) === currentFloor);

      if (floorElements.length === 0) {
        svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#999" font-size="20">Aucun element sur cet etage</text>';
        return;
      }

      // Calculate viewBox based on elements
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      floorElements.forEach(el => {
        if (el.x < minX) minX = el.x;
        if (el.y < minY) minY = el.y;
        if (el.x + el.largeur > maxX) maxX = el.x + el.largeur;
        if (el.y + el.hauteur > maxY) maxY = el.y + el.hauteur;
      });

      const padding = 50;
      const width = maxX - minX + padding * 2;
      const height = maxY - minY + padding * 2;
      svg.setAttribute('viewBox', `${minX - padding} ${minY - padding} ${width} ${height}`);

      // Render elements
      floorElements.forEach(el => {
        const element = createSvgElement(el);
        svg.appendChild(element);
      });
    }

    function createSvgElement(el) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.classList.add('plan-element');
      g.dataset.elementId = el.id;

      let shape;
      const color = el.couleur || getTypeColor(el.type);

      if (el.type === 'zone') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        shape.setAttribute('x', el.x);
        shape.setAttribute('y', el.y);
        shape.setAttribute('width', el.largeur);
        shape.setAttribute('height', el.hauteur);
        shape.setAttribute('fill', color);
        shape.setAttribute('fill-opacity', '0.3');
        shape.setAttribute('stroke', color);
        shape.setAttribute('stroke-width', '2');
        shape.setAttribute('rx', '8');
      } else if (el.type === 'mur') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        shape.setAttribute('x', el.x);
        shape.setAttribute('y', el.y);
        shape.setAttribute('width', el.largeur);
        shape.setAttribute('height', el.hauteur);
        shape.setAttribute('fill', color);
        shape.setAttribute('stroke', '#333');
        shape.setAttribute('stroke-width', '1');
      } else {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        shape.setAttribute('x', el.x);
        shape.setAttribute('y', el.y);
        shape.setAttribute('width', el.largeur);
        shape.setAttribute('height', el.hauteur);
        shape.setAttribute('fill', color);
        shape.setAttribute('stroke', darkenColor(color));
        shape.setAttribute('stroke-width', '2');
        shape.setAttribute('rx', '4');
      }

      g.appendChild(shape);

      // Add label
      if (el.nom) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', el.x + el.largeur / 2);
        text.setAttribute('y', el.y + el.hauteur / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', el.type === 'zone' ? '#333' : '#fff');
        text.setAttribute('font-weight', '600');
        text.setAttribute('font-size', Math.min(el.largeur / 8, 14));
        text.setAttribute('pointer-events', 'none');
        text.textContent = el.nom;
        g.appendChild(text);
      }

      // Click handler
      g.addEventListener('click', () => {
        selectElement(el);
      });

      return g;
    }

    function getTypeColor(type) {
      const colors = {
        mur: '#6b7280',
        etagere: '#f59e0b',
        meuble: '#f97316',
        table: '#ef4444',
        zone: '#0ea5e9'
      };
      return colors[type] || '#9ca3af';
    }

    function darkenColor(color) {
      // Simple color darkening
      const hex = color.replace('#', '');
      const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 30);
      const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 30);
      const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 30);
      return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }

    async function selectElement(element) {
      // Remove previous selection
      document.querySelectorAll('.plan-element').forEach(el => {
        el.classList.remove('selected');
      });

      // Add selection to clicked element
      const svgElement = document.querySelector(`[data-element-id="${element.id}"]`);
      if (svgElement) {
        svgElement.classList.add('selected');
      }

      selectedElement = element;

      // Open side panel
      document.getElementById('overlay').classList.add('active');
      document.getElementById('sidePanel').classList.add('open');
      document.getElementById('panelTitle').textContent = element.nom || 'Element';

      // Load articles
      await loadElementArticles(element.id);
    }

    async function loadElementArticles(elementId) {
      const panelContent = document.getElementById('panelContent');
      panelContent.innerHTML = `
        <div class="element-info">
          <strong>Type :</strong> ${getTypeLabel(selectedElement.type)}<br>
          ${selectedElement.description ? `<strong>Description :</strong> ${selectedElement.description}` : ''}
        </div>
        <h3>Articles associes</h3>
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      `;

      try {
        const resp = await fetch(`/api/plans/public/elements/${elementId}/articles`);
        const articles = await resp.json();

        if (articles.length === 0) {
          panelContent.innerHTML = `
            <div class="element-info">
              <strong>Type :</strong> ${getTypeLabel(selectedElement.type)}<br>
              ${selectedElement.description ? `<strong>Description :</strong> ${selectedElement.description}` : ''}
            </div>
            <h3>Articles associes</h3>
            <div class="empty-state">
              <i class="bi bi-box"></i>
              <p>Aucun article associe a cet element</p>
            </div>
          `;
          return;
        }

        renderArticles(articles);

      } catch (e) {
        console.error('Articles loading error:', e);
        panelContent.innerHTML = `
          <div class="element-info">
            <strong>Type :</strong> ${getTypeLabel(selectedElement.type)}<br>
            ${selectedElement.description ? `<strong>Description :</strong> ${selectedElement.description}` : ''}
          </div>
          <div class="empty-state">
            <i class="bi bi-exclamation-circle"></i>
            <p>Erreur lors du chargement des articles</p>
          </div>
        `;
      }
    }

    function renderArticles(articles) {
      const panelContent = document.getElementById('panelContent');
      panelContent.innerHTML = `
        <div class="element-info">
          <strong>Type :</strong> ${getTypeLabel(selectedElement.type)}<br>
          ${selectedElement.description ? `<strong>Description :</strong> ${selectedElement.description}` : ''}
        </div>
        <h3>Articles associes (${articles.length})</h3>
        <div class="articles-list">
          ${articles.map(article => renderArticle(article)).join('')}
        </div>
      `;
    }

    function renderArticle(article) {
      const icon = getCollectionIcon(article.collection);
      const status = getStatusInfo(article);

      return `
        <a href="/fiche.html?collection=${article.collection}&id=${article.id}" class="article-item">
          <div class="article-image">
            ${article.image_url
              ? `<img src="${article.image_url}" alt="${article.titre}">`
              : `<i class="bi bi-${icon}"></i>`
            }
          </div>
          <div class="article-details">
            <div class="article-title">${article.titre}</div>
            <div class="article-meta">
              <span class="badge badge-primary">
                <i class="bi bi-${icon}"></i> ${getCollectionLabel(article.collection)}
              </span>
              <span class="badge ${status.class}">
                <i class="bi bi-${status.icon}"></i> ${status.label}
              </span>
            </div>
          </div>
        </a>
      `;
    }

    function getTypeLabel(type) {
      const labels = {
        mur: 'Mur',
        etagere: 'Etagere',
        meuble: 'Meuble',
        table: 'Table',
        zone: 'Zone'
      };
      return labels[type] || type;
    }

    function getCollectionIcon(collection) {
      const icons = {
        jeux: 'dice-6',
        livres: 'book',
        films: 'film',
        disques: 'vinyl'
      };
      return icons[collection] || 'box';
    }

    function getCollectionLabel(collection) {
      const labels = {
        jeux: 'Jeu',
        livres: 'Livre',
        films: 'Film',
        disques: 'Disque'
      };
      return labels[collection] || collection;
    }

    function getStatusInfo(article) {
      if (article.statut === 'emprunte') {
        return { label: 'Emprunte', icon: 'arrow-right-circle', class: 'badge-warning' };
      } else if (article.statut === 'disponible') {
        return { label: 'Disponible', icon: 'check-circle', class: 'badge-success' };
      } else {
        return { label: 'Indisponible', icon: 'x-circle', class: 'badge-danger' };
      }
    }

    function closePanel() {
      document.getElementById('overlay').classList.remove('active');
      document.getElementById('sidePanel').classList.remove('open');

      // Remove selection
      document.querySelectorAll('.plan-element').forEach(el => {
        el.classList.remove('selected');
      });

      selectedElement = null;
    }

    // Event listeners
    document.getElementById('closePanel').addEventListener('click', closePanel);
    document.getElementById('overlay').addEventListener('click', closePanel);

    // Initialize
    init();
  </script>
</body>
</html>
