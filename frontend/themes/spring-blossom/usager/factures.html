<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-name" content="spring-blossom">
  <title id="site-title">Mes factures - Liberteko</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <script src="/js/theme-loader.js"></script>
  <style>
    .factures-container { max-width: 1000px; margin: 0 auto; padding: var(--space-xl) var(--space-lg); }
    .user-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg) 0; margin-bottom: var(--space-lg); border-bottom: var(--border-light); }
    .user-menu { display: flex; gap: var(--space-md); }
    .user-menu a { padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); color: var(--color-text-secondary); text-decoration: none; transition: all 0.3s ease; display: flex; align-items: center; gap: var(--space-xs); }
    .user-menu a:hover, .user-menu a.active { background: var(--spring-pink-pale); color: var(--spring-pink); }
    .btn-logout { background: none; border: 2px solid #dc2626; color: #dc2626; padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: var(--space-xs); }
    .btn-logout:hover { background: #dc2626; color: white; }
    .page-title { margin-bottom: var(--space-xl); }
    .page-title h1 { font-size: 2rem; color: var(--color-text); display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm); }
    .page-title h1 i { color: var(--spring-pink); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl); }
    .stat-card { background: var(--spring-white); border-radius: var(--radius-lg); padding: var(--space-lg); box-shadow: var(--soft-shadow); display: flex; align-items: center; gap: var(--space-md); }
    .stat-icon { width: 45px; height: 45px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .stat-icon.primary { background: var(--spring-pink-pale); color: var(--spring-pink); }
    .stat-icon.success { background: #dcfce7; color: #166534; }
    .stat-icon.warning { background: #fef9c3; color: #854d0e; }
    .stat-icon.danger { background: #fee2e2; color: #dc2626; }
    .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--color-text); }
    .stat-label { font-size: 0.8rem; color: var(--color-text-secondary); }
    .tabs { display: flex; gap: var(--space-sm); margin-bottom: var(--space-xl); background: var(--spring-cream); padding: var(--space-sm); border-radius: var(--radius-lg); }
    .tab-btn { flex: 1; padding: var(--space-md); border: none; background: transparent; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; color: var(--color-text-secondary); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: var(--space-sm); }
    .tab-btn:hover { color: var(--spring-pink); }
    .tab-btn.active { background: var(--spring-white); color: var(--spring-pink); box-shadow: var(--soft-shadow); }
    .facture-card { background: var(--spring-white); border-radius: var(--radius-lg); box-shadow: var(--soft-shadow); border: var(--border-soft); margin-bottom: var(--space-md); overflow: hidden; transition: all 0.4s var(--spring-ease); cursor: pointer; }
    .facture-card:hover { transform: translateY(-4px); box-shadow: var(--card-shadow); }
    .facture-card.avoir { border-left: 4px solid #a855f7; }
    .facture-card.impayee { border-left: 4px solid #f59e0b; }
    .facture-card-content { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg); gap: var(--space-md); flex-wrap: wrap; }
    .facture-info h3 { font-size: 1.1rem; color: var(--color-text); margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-sm); }
    .facture-info .date { color: var(--color-text-secondary); font-size: 0.9rem; }
    .facture-montant { text-align: right; }
    .facture-montant .total { font-size: 1.5rem; font-weight: 700; color: var(--color-text); }
    .facture-montant .total.avoir { color: #dc2626; }
    .facture-montant .reste { font-size: 0.85rem; color: #f59e0b; }
    .status-badge { padding: var(--space-xs) var(--space-md); border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; }
    .status-emise { background: #dbeafe; color: #1d4ed8; }
    .status-partiellement_reglee { background: #fef9c3; color: #854d0e; }
    .status-reglee { background: #dcfce7; color: #166534; }
    .status-annulee { background: #fee2e2; color: #dc2626; }
    .status-avoir { background: #f3e8ff; color: #7c3aed; }
    .reglement-item { background: var(--spring-white); border-radius: var(--radius-lg); box-shadow: var(--soft-shadow); border-left: 4px solid #10b981; padding: var(--space-lg); margin-bottom: var(--space-md); }
    .reglement-header { display: flex; justify-content: space-between; align-items: center; }
    .reglement-montant { font-size: 1.2rem; font-weight: 700; color: #166534; }
    .empty-state { text-align: center; padding: var(--space-2xl); background: var(--spring-white); border-radius: var(--radius-lg); box-shadow: var(--soft-shadow); }
    .empty-state i { font-size: 4rem; color: var(--spring-pink); margin-bottom: var(--space-md); display: block; opacity: 0.5; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: var(--space-lg); }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--spring-white); border-radius: var(--radius-lg); max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: var(--hover-shadow); }
    .modal-header { padding: var(--space-lg); border-bottom: var(--border-light); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; display: flex; align-items: center; gap: var(--space-sm); }
    .modal-header h3 i { color: var(--spring-pink); }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-light); }
    .modal-body { padding: var(--space-lg); }
    .modal-footer { padding: var(--space-lg); border-top: var(--border-light); display: flex; justify-content: flex-end; gap: var(--space-sm); }
    .ligne-facture { display: flex; justify-content: space-between; padding: var(--space-sm) 0; border-bottom: var(--border-soft); }
    .ligne-facture:last-child { border-bottom: none; }
    .totaux-box { background: var(--spring-cream); border-radius: var(--radius-md); padding: var(--space-md); margin-top: var(--space-md); }
    @media (max-width: 768px) {
      .user-header { flex-direction: column; gap: var(--space-md); }
      .user-menu { width: 100%; justify-content: center; flex-wrap: wrap; }
      .facture-card-content { flex-direction: column; text-align: center; }
      .facture-montant { text-align: center; }
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="petals-container">
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
  </div>

  <header class="site-header">
    <div class="header-container">
      <a href="/" class="logo"><i class="bi bi-flower1 logo-icon"></i><span class="logo-text" id="header-title">LIBERTEKO</span></a>
      <nav><ul class="nav-menu">
        <li><a href="/">Accueil</a></li>
        <li><a href="/catalogue.html">Catalogue</a></li>
        <li><a href="/infos.html">Infos</a></li>
      </ul></nav>
      <a href="/usager/dashboard.html" class="btn-login"><i class="bi bi-person-circle"></i> Mon espace</a>
    </div>
  </header>

  <div class="factures-container">
    <div class="user-header">
      <nav class="user-menu">
        <a href="/usager/dashboard.html"><i class="bi bi-house"></i> Accueil</a>
        <a href="/usager/emprunts.html"><i class="bi bi-bookmark"></i> Emprunts</a>
        <a href="/usager/factures.html" class="active"><i class="bi bi-receipt"></i> Factures</a>
        <a href="/usager/profil.html"><i class="bi bi-person"></i> Profil</a>
      </nav>
      <button class="btn-logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Deconnexion</button>
    </div>

    <div class="page-title">
      <h1><i class="bi bi-receipt"></i> Mes factures</h1>
      <p>Consultez vos factures et reglements</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon primary"><i class="bi bi-file-text"></i></div><div><div class="stat-value" id="nb-factures">-</div><div class="stat-label">Factures</div></div></div>
      <div class="stat-card"><div class="stat-icon success"><i class="bi bi-check-circle"></i></div><div><div class="stat-value" id="montant-regle">-</div><div class="stat-label">Regle</div></div></div>
      <div class="stat-card"><div class="stat-icon warning"><i class="bi bi-clock"></i></div><div><div class="stat-value" id="montant-impaye">-</div><div class="stat-label">Impaye</div></div></div>
      <div class="stat-card"><div class="stat-icon danger"><i class="bi bi-arrow-return-left"></i></div><div><div class="stat-value" id="montant-avoirs">-</div><div class="stat-label">Avoirs</div></div></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="factures" onclick="switchTab('factures')"><i class="bi bi-file-text"></i> Factures</button>
      <button class="tab-btn" data-tab="reglements" onclick="switchTab('reglements')"><i class="bi bi-credit-card"></i> Reglements</button>
    </div>

    <div id="tab-factures"><div id="factures-list"><div class="empty-state"><i class="bi bi-arrow-repeat spinning"></i><p>Chargement...</p></div></div></div>
    <div id="tab-reglements" style="display:none;"><div id="reglements-list"><div class="empty-state"><i class="bi bi-arrow-repeat spinning"></i><p>Chargement...</p></div></div></div>
  </div>

  <div class="modal-overlay" id="modal-facture">
    <div class="modal">
      <div class="modal-header"><h3 id="modal-title"><i class="bi bi-file-text"></i> Facture</h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal()">Fermer</button>
        <button class="btn btn-primary" id="btn-download"><i class="bi bi-download"></i> PDF</button>
      </div>
    </div>
  </div>

  <footer class="site-footer"><div class="footer-bottom"><p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span></p></div></footer>

  <script>
    let token = null, factureSelectionnee = null;

    async function init() {
      document.getElementById('year').textContent = new Date().getFullYear();
      token = localStorage.getItem('usager_token');
      if (!token) { window.location.href = '/usager/login.html'; return; }
      try {
        const resp = await fetch('/api/public/config');
        const config = await resp.json();
        const siteName = config.nom_site || 'Liberteko';
        document.getElementById('site-title').textContent = `Mes factures - ${siteName}`;
        document.getElementById('header-title').textContent = siteName.toUpperCase();
        document.getElementById('footer-name').textContent = siteName;
      } catch (e) {}
      await loadResume(); await loadFactures();
    }

    async function loadResume() {
      try {
        const resp = await fetch('/api/usager/factures/resume', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) return;
        const r = await resp.json();
        document.getElementById('nb-factures').textContent = r.total_factures;
        document.getElementById('montant-regle').textContent = formatMontant(r.montant_regle);
        document.getElementById('montant-impaye').textContent = formatMontant(r.montant_impaye);
        document.getElementById('montant-avoirs').textContent = formatMontant(r.montant_total_avoirs);
      } catch (e) {}
    }

    async function loadFactures() {
      try {
        const resp = await fetch('/api/usager/factures', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) { if (resp.status === 401) logout(); return; }
        const data = await resp.json();
        if (data.factures.length === 0) {
          document.getElementById('factures-list').innerHTML = '<div class="empty-state"><i class="bi bi-file-earmark-x"></i><h3>Aucune facture</h3></div>';
          return;
        }
        document.getElementById('factures-list').innerHTML = data.factures.map(f => {
          const isAvoir = f.type_document === 'avoir';
          return `<div class="facture-card ${isAvoir ? 'avoir' : (f.reste_a_payer > 0.01 ? 'impayee' : '')}" onclick="voirFacture(${f.id})">
            <div class="facture-card-content">
              <div class="facture-info">
                <h3><i class="bi bi-${isAvoir ? 'arrow-return-left' : 'file-text'}"></i> ${f.numero}</h3>
                <div class="date">${formatDate(f.date_emission)}</div>
              </div>
              <span class="status-badge status-${isAvoir ? 'avoir' : f.statut}">${isAvoir ? 'Avoir' : getStatutLabel(f.statut)}</span>
              <div class="facture-montant">
                <div class="total ${isAvoir ? 'avoir' : ''}">${isAvoir ? '-' : ''}${formatMontant(f.montant_ttc)}</div>
                ${!isAvoir && f.reste_a_payer > 0.01 ? `<div class="reste">Reste: ${formatMontant(f.reste_a_payer)}</div>` : ''}
              </div>
            </div>
          </div>`;
        }).join('');
      } catch (e) { document.getElementById('factures-list').innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><h3>Erreur</h3></div>'; }
    }

    async function loadReglements() {
      try {
        const resp = await fetch('/api/usager/factures/tous/reglements', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.reglements.length === 0) {
          document.getElementById('reglements-list').innerHTML = '<div class="empty-state"><i class="bi bi-credit-card"></i><h3>Aucun reglement</h3></div>';
          return;
        }
        document.getElementById('reglements-list').innerHTML = data.reglements.map(r => `
          <div class="reglement-item">
            <div class="reglement-header">
              <span><strong>${formatDate(r.date_reglement)}</strong> - ${formatModePaiement(r.mode_paiement)}</span>
              <span class="reglement-montant">+${formatMontant(r.montant)}</span>
            </div>
            <small><a href="#" onclick="voirFacture(${r.facture_id}); return false;">${r.type_document === 'avoir' ? 'Avoir' : 'Facture'} ${r.facture_numero}</a></small>
          </div>
        `).join('');
      } catch (e) {}
    }

    async function voirFacture(id) {
      try {
        const resp = await fetch(`/api/usager/factures/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) throw new Error();
        const f = await resp.json();
        factureSelectionnee = f;
        const isAvoir = f.type_document === 'avoir';
        document.getElementById('modal-title').innerHTML = `<i class="bi bi-${isAvoir ? 'arrow-return-left' : 'file-text'}"></i> ${isAvoir ? 'Avoir' : 'Facture'} ${f.numero}`;
        let html = `<p><strong>Date:</strong> ${formatDate(f.date_emission)}</p><p><strong>Statut:</strong> <span class="status-badge status-${f.statut}">${getStatutLabel(f.statut)}</span></p><hr><h4>Lignes</h4>`;
        f.lignes.forEach(l => { html += `<div class="ligne-facture"><span>${l.description}</span><strong>${formatMontant(l.montant_ttc)}</strong></div>`; });
        html += `<div class="totaux-box"><div class="ligne-facture"><span>Total HT</span><span>${formatMontant(f.montant_ht)}</span></div><div class="ligne-facture"><span>TVA</span><span>${formatMontant(f.montant_tva)}</span></div><div class="ligne-facture"><span><strong>Total TTC</strong></span><strong>${formatMontant(f.montant_ttc)}</strong></div></div>`;
        if (f.reglements?.length) { html += '<hr><h4>Reglements</h4>'; f.reglements.forEach(r => { html += `<div class="ligne-facture"><span>${formatDate(r.date_reglement)} - ${formatModePaiement(r.mode_paiement)}</span><strong style="color:#166534">+${formatMontant(r.montant)}</strong></div>`; }); }
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-facture').classList.add('show');
      } catch (e) { alert('Erreur'); }
    }

    function closeModal() { document.getElementById('modal-facture').classList.remove('show'); }

    document.getElementById('btn-download').addEventListener('click', async () => {
      if (!factureSelectionnee) return;
      try {
        const resp = await fetch(`/api/usager/factures/${factureSelectionnee.id}/pdf`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) throw new Error();
        const blob = await resp.blob();
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${factureSelectionnee.type_document === 'avoir' ? 'Avoir' : 'Facture'}_${factureSelectionnee.numero.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
        a.click(); URL.revokeObjectURL(a.href);
      } catch (e) { alert('Erreur'); }
    });

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.getElementById('tab-factures').style.display = tab === 'factures' ? 'block' : 'none';
      document.getElementById('tab-reglements').style.display = tab === 'reglements' ? 'block' : 'none';
      if (tab === 'reglements') loadReglements();
    }

    function formatMontant(m) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(m || 0); }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR') : '-'; }
    function getStatutLabel(s) { return { emise: 'Emise', partiellement_reglee: 'Partiel', reglee: 'Reglee', annulee: 'Annulee' }[s] || s; }
    function formatModePaiement(m) { return { especes: 'Especes', cheque: 'Cheque', carte_bancaire: 'CB', virement: 'Virement' }[m] || m; }
    function logout() { localStorage.removeItem('usager_token'); window.location.href = '/usager/login.html'; }

    init();
  </script>
</body>
</html>
