<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-name" content="spring-blossom">
  <title id="site-title">Reinitialiser le mot de passe - Liberteko</title>
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <script src="/js/theme-loader.js"></script>
  <style>
    .reset-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: var(--space-xl); position: relative; z-index: 1; }
    .reset-card { background: var(--spring-white); border-radius: var(--radius-xl); box-shadow: var(--card-shadow); width: 100%; max-width: 420px; overflow: hidden; border: var(--border-soft); animation: card-bloom 0.6s ease-out; }
    .reset-header { background: var(--gradient-spring); padding: var(--space-xl); text-align: center; position: relative; overflow: hidden; }
    .reset-header::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='20' cy='20' r='2' fill='rgba(255,255,255,0.3)'/%3E%3Ccircle cx='80' cy='30' r='3' fill='rgba(255,255,255,0.2)'/%3E%3Ccircle cx='40' cy='80' r='2' fill='rgba(255,255,255,0.3)'/%3E%3C/svg%3E"); animation: float-flowers 20s linear infinite; }
    .reset-logo { width: 80px; height: 80px; background: var(--spring-white); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-md); box-shadow: var(--bloom-glow); animation: bloom-pulse 3s ease-in-out infinite; position: relative; z-index: 1; }
    .reset-logo i { font-size: 2.5rem; color: var(--spring-pink); }
    .reset-header h1 { color: white; font-size: 1.5rem; margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 1; }
    .reset-header p { color: rgba(255,255,255,0.9); margin: var(--space-xs) 0 0; font-size: 0.95rem; position: relative; z-index: 1; }
    .reset-body { padding: var(--space-xl); }
    .form-group { margin-bottom: var(--space-lg); }
    .form-label { display: block; font-weight: 600; color: var(--color-text); margin-bottom: var(--space-sm); font-size: 0.95rem; }
    .input-icon-wrapper { position: relative; }
    .input-icon-wrapper i.input-icon { position: absolute; left: var(--space-md); top: 50%; transform: translateY(-50%); color: var(--spring-pink); font-size: 1.1rem; }
    .input-icon-wrapper input { padding-left: calc(var(--space-md) * 2 + 1.1rem); padding-right: calc(var(--space-md) * 2 + 1.1rem); }
    .form-input { width: 100%; padding: var(--space-md); border: 2px solid #e5e7eb; border-radius: var(--radius-md); font-size: 1rem; transition: all 0.3s ease; background: var(--spring-white); }
    .form-input:focus { outline: none; border-color: var(--spring-pink); box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.1); }
    .toggle-btn { position: absolute; right: var(--space-md); top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--color-text-light); cursor: pointer; padding: 0; }
    .btn-submit { width: 100%; padding: var(--space-md) var(--space-lg); background: var(--gradient-spring); color: white; border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: var(--space-sm); }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: var(--hover-shadow); }
    .reset-footer { text-align: center; padding: var(--space-lg); border-top: var(--border-light); background: var(--spring-cream); }
    .reset-footer a { color: var(--spring-pink); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: var(--space-xs); }
    .alert { padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg); display: none; align-items: center; gap: var(--space-sm); }
    .alert-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
    .alert.show { display: flex; }
    .password-strength { margin-top: var(--space-xs); }
    .strength-bar { height: 4px; border-radius: 2px; background: #e5e7eb; overflow: hidden; }
    .strength-fill { height: 100%; transition: all 0.3s ease; border-radius: 2px; }
    .strength-fill.weak { width: 33%; background: #dc2626; }
    .strength-fill.medium { width: 66%; background: #f59e0b; }
    .strength-fill.strong { width: 100%; background: #22c55e; }
    .strength-text { font-size: 0.75rem; margin-top: var(--space-xs); }
    .strength-text.weak { color: #dc2626; }
    .strength-text.medium { color: #f59e0b; }
    .strength-text.strong { color: #22c55e; }
    .success-content { text-align: center; padding: var(--space-lg) 0; }
    .success-content i { font-size: 4rem; color: var(--spring-green); margin-bottom: var(--space-md); display: block; animation: bloom-pulse 2s ease-in-out infinite; }
    .success-content h3 { color: var(--color-text); margin-bottom: var(--space-sm); }
    .success-content p { color: var(--color-text-secondary); margin-bottom: var(--space-lg); }
    .invalid-token { text-align: center; padding: var(--space-lg) 0; }
    .invalid-token i { font-size: 4rem; color: #dc2626; margin-bottom: var(--space-md); display: block; }
    .invalid-token h3 { color: var(--color-text); margin-bottom: var(--space-sm); }
    .invalid-token p { color: var(--color-text-secondary); margin-bottom: var(--space-lg); }
    .flower-deco { position: absolute; font-size: 2rem; opacity: 0.1; animation: float-flower 6s ease-in-out infinite; }
    .flower-deco:nth-child(1) { top: 10%; left: 5%; animation-delay: 0s; }
    .flower-deco:nth-child(2) { top: 30%; right: 8%; animation-delay: 1.5s; }
    .flower-deco:nth-child(3) { bottom: 20%; left: 10%; animation-delay: 0.8s; }
    .flower-deco:nth-child(4) { bottom: 10%; right: 5%; animation-delay: 2s; }
    @keyframes float-flower { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(10deg); } }
    @media (max-width: 480px) { .reset-card { margin: var(--space-md); } .reset-header, .reset-body { padding: var(--space-lg); } }
  </style>
</head>
<body>
  <div class="petals-container">
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
  </div>

  <span class="flower-deco">ðŸŒ¸</span>
  <span class="flower-deco">ðŸŒ·</span>
  <span class="flower-deco">ðŸŒº</span>
  <span class="flower-deco">ðŸ’®</span>

  <div class="reset-page">
    <div class="reset-card">
      <div class="reset-header">
        <div class="reset-logo"><i class="bi bi-shield-lock"></i></div>
        <h1>Nouveau mot de passe</h1>
        <p>Creez un nouveau mot de passe securise</p>
      </div>

      <div class="reset-body">
        <div class="alert alert-danger" id="error-alert"><i class="bi bi-exclamation-circle"></i><span id="error-message"></span></div>

        <div id="form-section">
          <form id="reset-form">
            <div class="form-group">
              <label class="form-label" for="password">Nouveau mot de passe</label>
              <div class="input-icon-wrapper">
                <i class="bi bi-lock input-icon"></i>
                <input type="password" id="password" class="form-input" placeholder="Minimum 6 caracteres" required minlength="6">
                <button type="button" class="toggle-btn" onclick="togglePassword('password')"><i class="bi bi-eye"></i></button>
              </div>
              <div class="password-strength">
                <div class="strength-bar"><div class="strength-fill" id="strength-fill"></div></div>
                <div class="strength-text" id="strength-text"></div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="confirm-password">Confirmer le mot de passe</label>
              <div class="input-icon-wrapper">
                <i class="bi bi-lock-fill input-icon"></i>
                <input type="password" id="confirm-password" class="form-input" placeholder="Retapez le mot de passe" required>
                <button type="button" class="toggle-btn" onclick="togglePassword('confirm-password')"><i class="bi bi-eye"></i></button>
              </div>
            </div>

            <button type="submit" class="btn-submit">
              <i class="bi bi-check-lg"></i>
              Reinitialiser le mot de passe
            </button>
          </form>
        </div>

        <div id="success-section" style="display: none;">
          <div class="success-content">
            <i class="bi bi-check-circle"></i>
            <h3>Mot de passe modifie !</h3>
            <p>Votre mot de passe a ete reinitialise avec succes. Vous pouvez maintenant vous connecter.</p>
            <a href="/usager/login.html?reset=success" class="btn btn-primary"><i class="bi bi-box-arrow-in-right"></i> Se connecter</a>
          </div>
        </div>

        <div id="invalid-section" style="display: none;">
          <div class="invalid-token">
            <i class="bi bi-x-circle"></i>
            <h3>Lien invalide ou expire</h3>
            <p>Ce lien de reinitialisation n'est plus valide. Veuillez faire une nouvelle demande.</p>
            <a href="/usager/forgot-password.html" class="btn btn-primary"><i class="bi bi-arrow-repeat"></i> Nouvelle demande</a>
          </div>
        </div>
      </div>

      <div class="reset-footer">
        <a href="/usager/login.html"><i class="bi bi-arrow-left"></i> Retour a la connexion</a>
      </div>
    </div>
  </div>

  <script>
    let resetToken = null;

    async function init() {
      try {
        const configResp = await fetch('/api/public/config');
        const config = await configResp.json();
        const siteName = config.nom_site || 'Liberteko';
        document.getElementById('site-title').textContent = `Reinitialiser le mot de passe - ${siteName}`;
      } catch (e) { console.error('Config error:', e); }

      // Get token from URL
      const params = new URLSearchParams(window.location.search);
      resetToken = params.get('token');

      if (!resetToken) {
        showInvalidToken();
        return;
      }

      // Optionally verify token validity here
    }

    document.getElementById('password').addEventListener('input', updateStrength);

    function updateStrength() {
      const password = document.getElementById('password').value;
      const fill = document.getElementById('strength-fill');
      const text = document.getElementById('strength-text');

      let strength = 0;
      if (password.length >= 6) strength++;
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;

      fill.className = 'strength-fill';
      text.className = 'strength-text';

      if (password.length === 0) {
        text.textContent = '';
      } else if (strength <= 2) {
        fill.classList.add('weak');
        text.classList.add('weak');
        text.textContent = 'Faible';
      } else if (strength <= 3) {
        fill.classList.add('medium');
        text.classList.add('medium');
        text.textContent = 'Moyen';
      } else {
        fill.classList.add('strong');
        text.classList.add('strong');
        text.textContent = 'Fort';
      }
    }

    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (password !== confirmPassword) {
        showError('Les mots de passe ne correspondent pas');
        return;
      }

      if (password.length < 6) {
        showError('Le mot de passe doit contenir au moins 6 caracteres');
        return;
      }

      try {
        const resp = await fetch('/api/usager/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: resetToken, password })
        });

        if (!resp.ok) {
          const data = await resp.json();
          if (data.message && data.message.includes('expire')) {
            showInvalidToken();
          } else {
            showError(data.message || 'Erreur lors de la reinitialisation');
          }
          return;
        }

        document.getElementById('form-section').style.display = 'none';
        document.getElementById('success-section').style.display = 'block';
      } catch (e) {
        console.error('Reset error:', e);
        showError('Erreur de connexion. Veuillez reessayer.');
      }
    });

    function togglePassword(id) {
      const input = document.getElementById(id);
      const btn = input.nextElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
      } else {
        input.type = 'password';
        btn.innerHTML = '<i class="bi bi-eye"></i>';
      }
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-alert').classList.add('show');
    }

    function hideError() {
      document.getElementById('error-alert').classList.remove('show');
    }

    function showInvalidToken() {
      document.getElementById('form-section').style.display = 'none';
      document.getElementById('invalid-section').style.display = 'block';
    }

    init();
  </script>
  <script src="/js/animation-toggle.js"></script>
</body>
</html>
