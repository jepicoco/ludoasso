<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-name" content="spring-blossom">
  <title id="site-title">Mon espace - Liberteko</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <script src="/js/theme-loader.js"></script>
  <style>
    .dashboard-container { max-width: 1200px; margin: 0 auto; padding: var(--space-xl) var(--space-lg); }
    .welcome-card { background: var(--gradient-spring); border-radius: var(--radius-xl); padding: var(--space-2xl); color: white; margin-bottom: var(--space-xl); position: relative; overflow: hidden; animation: card-bloom 0.6s ease-out; }
    .welcome-card::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='20' cy='20' r='3' fill='rgba(255,255,255,0.2)'/%3E%3Ccircle cx='80' cy='30' r='4' fill='rgba(255,255,255,0.15)'/%3E%3Ccircle cx='40' cy='80' r='3' fill='rgba(255,255,255,0.2)'/%3E%3C/svg%3E"); animation: float-flowers 20s linear infinite; }
    .welcome-content { position: relative; z-index: 1; }
    .welcome-card h1 { font-size: 2rem; margin-bottom: var(--space-sm); display: flex; align-items: center; gap: var(--space-md); }
    .welcome-card h1 i { font-size: 2.5rem; animation: bloom-pulse 3s ease-in-out infinite; }
    .welcome-card p { opacity: 0.95; font-size: 1.1rem; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-xl); margin-bottom: var(--space-xl); }
    .stat-card { background: var(--spring-white); border-radius: var(--radius-lg); padding: var(--space-xl); box-shadow: var(--soft-shadow); border: var(--border-soft); display: flex; align-items: center; gap: var(--space-lg); transition: all 0.4s var(--spring-ease); animation: slide-in 0.5s ease-out backwards; }
    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow); }
    .stat-icon { width: 70px; height: 70px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; }
    .stat-icon.pink { background: var(--spring-pink-pale); color: var(--spring-pink); }
    .stat-icon.cyan { background: rgba(6, 182, 212, 0.15); color: var(--spring-cyan); }
    .stat-icon.green { background: rgba(34, 197, 94, 0.15); color: var(--spring-green); }
    .stat-info h3 { font-size: 2rem; color: var(--color-text); margin-bottom: var(--space-xs); }
    .stat-info p { color: var(--color-text-secondary); font-size: 0.95rem; }
    .section-card { background: var(--spring-white); border-radius: var(--radius-lg); box-shadow: var(--soft-shadow); border: var(--border-soft); margin-bottom: var(--space-xl); overflow: hidden; animation: card-bloom 0.6s ease-out backwards; }
    .section-card:nth-of-type(1) { animation-delay: 0.2s; }
    .section-card:nth-of-type(2) { animation-delay: 0.4s; }
    .section-header { background: var(--spring-cream); padding: var(--space-lg); border-bottom: var(--border-soft); display: flex; justify-content: space-between; align-items: center; }
    .section-header h2 { font-size: 1.25rem; color: var(--color-text); display: flex; align-items: center; gap: var(--space-sm); margin: 0; }
    .section-header h2 i { color: var(--spring-pink); }
    .section-body { padding: var(--space-lg); }
    .emprunt-item { display: flex; align-items: center; gap: var(--space-lg); padding: var(--space-md); border-radius: var(--radius-md); transition: all 0.3s ease; margin-bottom: var(--space-sm); }
    .emprunt-item:hover { background: var(--spring-pink-pale); }
    .emprunt-item:last-child { margin-bottom: 0; }
    .emprunt-icon { width: 50px; height: 50px; border-radius: var(--radius-md); background: var(--spring-pink-pale); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--spring-pink); flex-shrink: 0; }
    .emprunt-info { flex: 1; }
    .emprunt-info h4 { font-size: 1rem; color: var(--color-text); margin-bottom: var(--space-xs); }
    .emprunt-info p { font-size: 0.85rem; color: var(--color-text-secondary); }
    .emprunt-status { text-align: right; }
    .date-badge { padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; }
    .date-ok { background: #dcfce7; color: #166534; }
    .date-warning { background: #fef9c3; color: #854d0e; }
    .date-danger { background: #fee2e2; color: #dc2626; }
    .empty-state { text-align: center; padding: var(--space-xl); color: var(--color-text-secondary); }
    .empty-state i { font-size: 3rem; color: var(--spring-pink); margin-bottom: var(--space-md); display: block; opacity: 0.5; }
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); }
    .quick-action { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); background: var(--spring-cream); border-radius: var(--radius-md); text-decoration: none; color: var(--color-text); transition: all 0.3s ease; border: var(--border-soft); }
    .quick-action:hover { background: var(--spring-pink-pale); transform: translateX(5px); }
    .quick-action i { font-size: 1.5rem; color: var(--spring-pink); }
    .quick-action span { font-weight: 600; }
    .cotisation-status { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-lg); border-radius: var(--radius-md); }
    .cotisation-status.active { background: #dcfce7; border: 1px solid #bbf7d0; }
    .cotisation-status.expired { background: #fee2e2; border: 1px solid #fecaca; }
    .cotisation-status.expiring { background: #fef9c3; border: 1px solid #fde68a; }
    .cotisation-status i { font-size: 2rem; }
    .cotisation-status.active i { color: #166534; }
    .cotisation-status.expired i { color: #dc2626; }
    .cotisation-status.expiring i { color: #854d0e; }
    .cotisation-info h4 { font-size: 1.1rem; margin-bottom: var(--space-xs); }
    .cotisation-status.active h4 { color: #166534; }
    .cotisation-status.expired h4 { color: #dc2626; }
    .cotisation-status.expiring h4 { color: #854d0e; }
    .cotisation-info p { font-size: 0.9rem; opacity: 0.8; }
    .user-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg) 0; margin-bottom: var(--space-lg); border-bottom: var(--border-light); }
    .user-menu { display: flex; gap: var(--space-md); }
    .user-menu a { padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); color: var(--color-text-secondary); text-decoration: none; transition: all 0.3s ease; display: flex; align-items: center; gap: var(--space-xs); }
    .user-menu a:hover, .user-menu a.active { background: var(--spring-pink-pale); color: var(--spring-pink); }
    .btn-logout { background: none; border: 2px solid #dc2626; color: #dc2626; padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: var(--space-xs); }
    .btn-logout:hover { background: #dc2626; color: white; }
    @media (max-width: 768px) { .welcome-card { padding: var(--space-xl); } .welcome-card h1 { font-size: 1.5rem; } .user-header { flex-direction: column; gap: var(--space-md); } .user-menu { width: 100%; justify-content: center; flex-wrap: wrap; } }
  </style>
</head>
<body>
  <div class="petals-container">
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
    <div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div><div class="petal"></div>
  </div>

  <header class="site-header">
    <div class="header-container">
      <a href="/" class="logo"><i class="bi bi-flower1 logo-icon"></i><span class="logo-text" id="header-title">LIBERTEKO</span></a>
      <nav><ul class="nav-menu">
        <li><a href="/">Accueil</a></li>
        <li><a href="/catalogue.html">Catalogue</a></li>
        <li><a href="/infos.html">Infos</a></li>
      </ul></nav>
      <a href="/usager/dashboard.html" class="btn-login"><i class="bi bi-person-circle"></i> Mon espace</a>
    </div>
  </header>

  <div class="dashboard-container">
    <div class="user-header">
      <div class="user-menu">
        <a href="/usager/dashboard.html" class="active"><i class="bi bi-house"></i> Tableau de bord</a>
        <a href="/usager/emprunts.html"><i class="bi bi-bookmark"></i> Mes emprunts</a>
        <a href="/usager/factures.html"><i class="bi bi-receipt"></i> Mes factures</a>
        <a href="/usager/profil.html"><i class="bi bi-person"></i> Mon profil</a>
      </div>
      <button class="btn-logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Deconnexion</button>
    </div>

    <div class="welcome-card">
      <div class="welcome-content">
        <h1><i class="bi bi-flower2"></i> Bonjour <span id="user-name">!</span></h1>
        <p>Bienvenue dans votre espace personnel. Gerez vos emprunts et votre profil.</p>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-icon pink"><i class="bi bi-bookmark-check"></i></div>
        <div class="stat-info"><h3 id="emprunts-count">0</h3><p>Emprunts en cours</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon cyan"><i class="bi bi-clock-history"></i></div>
        <div class="stat-info"><h3 id="historique-count">0</h3><p>Emprunts au total</p></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><i class="bi bi-calendar-check"></i></div>
        <div class="stat-info"><h3 id="cotisation-status">-</h3><p>Adhesion</p></div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <h2><i class="bi bi-bookmark"></i> Emprunts en cours</h2>
        <a href="/usager/emprunts.html" class="btn btn-sm btn-outline">Voir tout</a>
      </div>
      <div class="section-body" id="emprunts-list">
        <div class="empty-state"><i class="bi bi-inbox"></i><p>Aucun emprunt en cours</p></div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <h2><i class="bi bi-lightning"></i> Actions rapides</h2>
      </div>
      <div class="section-body">
        <div class="quick-actions">
          <a href="/catalogue.html" class="quick-action"><i class="bi bi-search"></i><span>Parcourir le catalogue</span></a>
          <a href="/usager/emprunts.html" class="quick-action"><i class="bi bi-bookmark"></i><span>Gerer mes emprunts</span></a>
          <a href="/usager/profil.html" class="quick-action"><i class="bi bi-person"></i><span>Modifier mon profil</span></a>
          <a href="/infos.html" class="quick-action"><i class="bi bi-info-circle"></i><span>Infos pratiques</span></a>
        </div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-header">
        <h2><i class="bi bi-card-checklist"></i> Mon adhesion</h2>
      </div>
      <div class="section-body" id="cotisation-section">
        <div class="empty-state"><i class="bi bi-hourglass"></i><p>Chargement...</p></div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-section"><h4>Contact</h4><p id="footer-address"></p><p id="footer-phone"></p><p id="footer-email"></p></div>
      <div class="footer-section"><h4>Navigation</h4><ul><li><a href="/">Accueil</a></li><li><a href="/catalogue.html">Catalogue</a></li></ul></div>
      <div class="footer-section"><h4>Mon compte</h4><ul><li><a href="/usager/emprunts.html">Mes emprunts</a></li><li><a href="/usager/factures.html">Mes factures</a></li><li><a href="/usager/profil.html">Mon profil</a></li></ul></div>
    </div>
    <div class="footer-bottom"><p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span></p></div>
  </footer>

  <script>
    const icons = { jeux: 'dice-6', livres: 'book', films: 'film', disques: 'vinyl' };

    async function init() {
      document.getElementById('year').textContent = new Date().getFullYear();

      const token = localStorage.getItem('usager_token');
      if (!token) { window.location.href = '/usager/login.html'; return; }

      try {
        const configResp = await fetch('/api/public/config');
        const config = await configResp.json();
        const siteName = config.nom_site || 'Liberteko';
        document.getElementById('site-title').textContent = `Mon espace - ${siteName}`;
        document.getElementById('header-title').textContent = siteName.toUpperCase();
        document.getElementById('footer-name').textContent = siteName;
        if (config.contact) {
          if (config.contact.adresse) document.getElementById('footer-address').innerHTML = `<i class="bi bi-geo-alt"></i> ${config.contact.adresse}`;
          if (config.contact.telephone) document.getElementById('footer-phone').innerHTML = `<i class="bi bi-telephone"></i> ${config.contact.telephone}`;
          if (config.contact.email) document.getElementById('footer-email').innerHTML = `<i class="bi bi-envelope"></i> ${config.contact.email}`;
        }
      } catch (e) { console.error('Config error:', e); }

      await loadUserData();
    }

    async function loadUserData() {
      const token = localStorage.getItem('usager_token');

      try {
        const profileResp = await fetch('/api/usager/auth/profile', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!profileResp.ok) { logout(); return; }
        const profile = await profileResp.json();

        document.getElementById('user-name').textContent = profile.prenom || 'membre';

        const empruntsResp = await fetch('/api/usager/emprunts', { headers: { 'Authorization': `Bearer ${token}` } });
        const emprunts = await empruntsResp.json();
        const enCours = emprunts.filter(e => e.statut === 'en_cours' || e.statut === 'en cours');

        document.getElementById('emprunts-count').textContent = enCours.length;
        document.getElementById('historique-count').textContent = emprunts.length;

        renderEmprunts(enCours.slice(0, 3));
        renderCotisation(profile);
      } catch (e) {
        console.error('Load error:', e);
        logout();
      }
    }

    function renderEmprunts(emprunts) {
      const container = document.getElementById('emprunts-list');
      if (!emprunts || emprunts.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>Aucun emprunt en cours</p></div>';
        return;
      }

      container.innerHTML = emprunts.map(e => {
        const icon = icons[e.collection] || 'box';
        const retour = new Date(e.date_retour_prevue);
        const today = new Date();
        const diff = Math.ceil((retour - today) / (1000 * 60 * 60 * 24));
        let dateClass = 'date-ok', dateText = `${diff} jours restants`;
        if (diff < 0) { dateClass = 'date-danger'; dateText = `${Math.abs(diff)} jours de retard`; }
        else if (diff <= 3) { dateClass = 'date-warning'; dateText = diff === 0 ? "Aujourd'hui" : `${diff} jour${diff > 1 ? 's' : ''} restant${diff > 1 ? 's' : ''}`; }

        return `<div class="emprunt-item">
          <div class="emprunt-icon"><i class="bi bi-${icon}"></i></div>
          <div class="emprunt-info"><h4>${e.article_nom || 'Article'}</h4><p>Emprunte le ${new Date(e.date_emprunt).toLocaleDateString('fr-FR')}</p></div>
          <div class="emprunt-status"><span class="date-badge ${dateClass}">${dateText}</span></div>
        </div>`;
      }).join('');
    }

    function renderCotisation(profile) {
      const container = document.getElementById('cotisation-section');
      const dateFinStr = profile.date_fin_adhesion || profile.date_fin_cotisation;

      if (!dateFinStr) {
        container.innerHTML = '<div class="cotisation-status expired"><i class="bi bi-exclamation-circle"></i><div class="cotisation-info"><h4>Pas d\'adhesion active</h4><p>Contactez l\'association pour adherer</p></div></div>';
        document.getElementById('cotisation-status').textContent = 'Inactive';
        return;
      }

      const dateFin = new Date(dateFinStr);
      const today = new Date();
      const diff = Math.ceil((dateFin - today) / (1000 * 60 * 60 * 24));

      if (diff < 0) {
        container.innerHTML = `<div class="cotisation-status expired"><i class="bi bi-exclamation-circle"></i><div class="cotisation-info"><h4>Adhesion expiree</h4><p>Votre adhesion a expire le ${dateFin.toLocaleDateString('fr-FR')}</p></div></div>`;
        document.getElementById('cotisation-status').textContent = 'Expiree';
      } else if (diff <= 30) {
        container.innerHTML = `<div class="cotisation-status expiring"><i class="bi bi-exclamation-triangle"></i><div class="cotisation-info"><h4>Adhesion bientot expiree</h4><p>Expire le ${dateFin.toLocaleDateString('fr-FR')} (${diff} jours)</p></div></div>`;
        document.getElementById('cotisation-status').textContent = `${diff}j`;
      } else {
        container.innerHTML = `<div class="cotisation-status active"><i class="bi bi-check-circle"></i><div class="cotisation-info"><h4>Adhesion active</h4><p>Valide jusqu'au ${dateFin.toLocaleDateString('fr-FR')}</p></div></div>`;
        document.getElementById('cotisation-status').textContent = 'Active';
      }
    }

    function logout() {
      localStorage.removeItem('usager_token');
      localStorage.removeItem('usager_info');
      window.location.href = '/usager/login.html';
    }

    init();
  </script>
  <script src="/js/animation-toggle.js"></script>
</body>
</html>
