<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="site-title">Plan Interactif - Liberteko</title>
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <style>
    /* Plan-specific styles for ELEGANT-DARK theme */
    .plan-container {
      max-width: 1600px;
      margin: 2rem auto;
      padding: 0 2rem;
      min-height: calc(100vh - 400px);
    }

    .plan-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .plan-header h1 {
      font-size: 2.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .plan-header p {
      color: var(--text-muted);
      font-size: 1.1rem;
    }

    .plan-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .site-selector {
      position: relative;
    }

    .site-selector select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-color);
      padding: 0.75rem 3rem 0.75rem 1.25rem;
      border-radius: var(--border-radius-sm);
      font-size: 1rem;
      cursor: pointer;
      appearance: none;
      transition: all 0.3s ease;
      min-width: 250px;
    }

    .site-selector select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.1);
    }

    .site-selector::after {
      content: '\F282';
      font-family: 'bootstrap-icons';
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--text-muted);
    }

    .floor-tabs {
      display: flex;
      gap: 0.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--border-radius-sm);
      padding: 0.25rem;
    }

    .floor-tab {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .floor-tab:hover {
      color: var(--text-color);
      background: rgba(168, 85, 247, 0.1);
    }

    .floor-tab.active {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }

    .plan-canvas {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: auto;
      min-height: 600px;
    }

    #planSvg {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }

    /* SVG Element Styles */
    .plan-element {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .plan-element:hover {
      opacity: 0.8;
      filter: brightness(1.2);
    }

    .plan-wall {
      fill: var(--surface-light);
      stroke: var(--border);
      stroke-width: 2;
    }

    .plan-shelf {
      fill: rgba(59, 130, 246, 0.3);
      stroke: #3b82f6;
      stroke-width: 2;
    }

    .plan-table {
      fill: rgba(251, 191, 36, 0.3);
      stroke: #fbbf24;
      stroke-width: 2;
    }

    .plan-furniture {
      fill: rgba(168, 85, 247, 0.3);
      stroke: #a855f7;
      stroke-width: 2;
    }

    .plan-zone {
      fill: rgba(34, 211, 238, 0.2);
      stroke: #22d3ee;
      stroke-width: 2;
      stroke-dasharray: 5,5;
    }

    .plan-text {
      fill: var(--text-color);
      font-size: 14px;
      font-weight: 500;
      pointer-events: none;
      text-anchor: middle;
    }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background: var(--surface);
      border-left: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2000;
      overflow-y: auto;
    }

    .side-panel.open {
      right: 0;
    }

    .side-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1999;
    }

    .side-panel-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }

    .panel-header {
      padding: 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 10;
    }

    .panel-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      color: var(--text-color);
    }

    .panel-close {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-color);
      width: 40px;
      height: 40px;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }

    .panel-close:hover {
      background: var(--surface-light);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .panel-content {
      padding: 2rem;
    }

    .panel-loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .panel-loading i {
      font-size: 2rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .panel-empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .panel-empty i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .article-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .article-item {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--border-radius-sm);
      padding: 1rem;
      display: flex;
      gap: 1rem;
      transition: all 0.3s ease;
      text-decoration: none;
      color: var(--text-color);
    }

    .article-item:hover {
      border-color: var(--primary-color);
      transform: translateX(-4px);
      box-shadow: var(--shadow);
    }

    .article-image {
      width: 80px;
      height: 80px;
      border-radius: var(--border-radius-sm);
      object-fit: cover;
      background: var(--surface-light);
      flex-shrink: 0;
    }

    .article-info {
      flex: 1;
      min-width: 0;
    }

    .article-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .article-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-type {
      background: rgba(168, 85, 247, 0.15);
      color: var(--primary-color);
    }

    .badge-status {
      background: rgba(34, 211, 238, 0.15);
      color: var(--accent-color);
    }

    .badge-status.emprunte {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .badge-status.indisponible {
      background: rgba(244, 114, 182, 0.15);
      color: var(--accent-secondary);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 2rem;
    }

    .btn-primary {
      display: inline-block;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 0.75rem 2rem;
      border-radius: var(--border-radius-sm);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
      box-shadow: var(--glow);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .side-panel {
        width: 100%;
        right: -100%;
      }

      .plan-controls {
        flex-direction: column;
        gap: 1rem;
      }

      .site-selector select {
        width: 100%;
      }

      .plan-header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="bg-gradient"></div>

  <!-- Header -->
  <header class="site-header">
    <div class="header-container">
      <a href="/" class="logo">
        <i class="bi bi-hexagon"></i>
        <span id="header-title">Liberteko</span>
      </a>
      <nav>
        <ul class="nav-menu">
          <li><a href="/catalogue.html">Catalogue</a></li>
          <li><a href="/plan.html" class="active">Plan</a></li>
          <li><a href="/infos.html">À propos</a></li>
          <li><a href="/aide.html">Aide</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </nav>
      <a href="/usager/login.html" class="btn-login">Connexion</a>
    </div>
  </header>

  <!-- Main Content -->
  <div class="plan-container">
    <div class="plan-header">
      <h1><i class="bi bi-pin-map"></i> Plan Interactif</h1>
      <p>Explorez notre espace et découvrez où se trouvent nos collections</p>
    </div>

    <!-- Controls -->
    <div class="plan-controls">
      <div class="site-selector" id="siteSelector" style="display: none;">
        <select id="siteSelect">
          <option value="">Chargement...</option>
        </select>
      </div>

      <div class="floor-tabs" id="floorTabs" style="display: none;">
        <!-- Floor tabs will be generated dynamically -->
      </div>
    </div>

    <!-- Plan Canvas -->
    <div class="plan-canvas" id="planCanvas">
      <svg id="planSvg" viewBox="0 0 1000 800" xmlns="http://www.w3.org/2000/svg">
        <!-- Plan elements will be generated dynamically -->
      </svg>
    </div>

    <!-- Empty State (shown when module is disabled) -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <i class="bi bi-map"></i>
      <h3>Plan interactif non disponible</h3>
      <p>Cette fonctionnalité n'est pas encore activée.</p>
      <a href="/catalogue.html" class="btn-primary">Explorer le catalogue</a>
    </div>
  </div>

  <!-- Side Panel Overlay -->
  <div class="side-panel-overlay" id="panelOverlay"></div>

  <!-- Side Panel -->
  <div class="side-panel" id="sidePanel">
    <div class="panel-header">
      <h2 id="panelTitle">Élément</h2>
      <button class="panel-close" id="panelClose">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="panel-content" id="panelContent">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-brand">
        <a href="/" class="logo">
          <i class="bi bi-hexagon"></i>
          <span id="footer-brand-name">Liberteko</span>
        </a>
        <p>Votre médiathèque associative de proximité. Partageons la culture ensemble.</p>
      </div>

      <div class="footer-section">
        <h4>Navigation</h4>
        <ul>
          <li><a href="/catalogue.html">Catalogue</a></li>
          <li><a href="/plan.html">Plan</a></li>
          <li><a href="/infos.html">Informations</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Contact</h4>
        <ul>
          <li id="footer-address"></li>
          <li id="footer-phone"></li>
          <li id="footer-email"></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Légal</h4>
        <ul>
          <li><a href="/mentions-legales.html">Mentions légales</a></li>
          <li><a href="/cgu.html">CGU</a></li>
          <li><a href="/cgv.html">CGV</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span>. Tous droits réservés.</p>
      <div class="footer-links">
        <a href="/mentions-legales.html">Mentions légales</a>
        <a href="/cgu.html">CGU</a>
      </div>
    </div>
  </footer>

  <script>
    // Global state
    let currentSiteId = null;
    let currentFloor = 0;
    let planData = null;
    let sites = [];

    // Load configuration
    async function loadConfig() {
      try {
        const resp = await fetch('/api/public/parametres');
        if (!resp.ok) return false;
        const data = await resp.json();

        const nom = data.nom || 'Liberteko';
        document.getElementById('site-title').textContent = `Plan Interactif - ${nom}`;
        document.getElementById('header-title').textContent = nom;
        document.getElementById('footer-brand-name').textContent = nom;
        document.getElementById('footer-name').textContent = nom;

        if (data.adresse) {
          document.getElementById('footer-address').textContent = data.adresse;
        }
        if (data.telephone) {
          document.getElementById('footer-phone').textContent = data.telephone;
        }
        if (data.email) {
          document.getElementById('footer-email').innerHTML = `<a href="mailto:${data.email}">${data.email}</a>`;
        }

        return data.module_plan_interactif === true;
      } catch (e) {
        console.error('Erreur config:', e);
        return false;
      }
    }

    // Load sites
    async function loadSites() {
      try {
        const resp = await fetch('/api/sites');
        if (!resp.ok) return [];
        const data = await resp.json();
        return Array.isArray(data) ? data : [];
      } catch (e) {
        console.error('Erreur sites:', e);
        return [];
      }
    }

    // Load plan data for a site
    async function loadPlanData(siteId) {
      try {
        const resp = await fetch(`/api/plans/public/site/${siteId}`);
        if (!resp.ok) return null;
        const data = await resp.json();
        return data;
      } catch (e) {
        console.error('Erreur plan:', e);
        return null;
      }
    }

    // Render site selector
    function renderSiteSelector() {
      const selector = document.getElementById('siteSelector');
      const select = document.getElementById('siteSelect');

      if (sites.length === 0) {
        selector.style.display = 'none';
        return;
      }

      if (sites.length === 1) {
        selector.style.display = 'none';
        currentSiteId = sites[0].id;
        return;
      }

      // Multiple sites - show selector
      selector.style.display = 'block';
      select.innerHTML = sites.map(site =>
        `<option value="${site.id}">${site.nom}</option>`
      ).join('');

      currentSiteId = sites[0].id;
      select.value = currentSiteId;

      select.addEventListener('change', async (e) => {
        currentSiteId = parseInt(e.target.value);
        await loadAndRenderPlan();
      });
    }

    // Render floor tabs
    function renderFloorTabs() {
      const tabsContainer = document.getElementById('floorTabs');

      if (!planData || !planData.elements) {
        tabsContainer.style.display = 'none';
        return;
      }

      // Get unique floors
      const floors = [...new Set(planData.elements.map(el => el.etage || 0))].sort((a, b) => a - b);

      if (floors.length <= 1) {
        tabsContainer.style.display = 'none';
        currentFloor = floors[0] || 0;
        return;
      }

      // Multiple floors - show tabs
      tabsContainer.style.display = 'flex';
      tabsContainer.innerHTML = floors.map(floor => {
        const label = floor === 0 ? 'RDC' : floor > 0 ? `Étage ${floor}` : `Sous-sol ${Math.abs(floor)}`;
        return `<button class="floor-tab ${floor === currentFloor ? 'active' : ''}" data-floor="${floor}">${label}</button>`;
      }).join('');

      // Add click handlers
      tabsContainer.querySelectorAll('.floor-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          currentFloor = parseInt(tab.dataset.floor);
          renderFloorTabs();
          renderPlan();
        });
      });
    }

    // Render plan SVG
    function renderPlan() {
      const svg = document.getElementById('planSvg');

      if (!planData || !planData.elements) {
        svg.innerHTML = '<text x="500" y="400" text-anchor="middle" fill="#94a3b8" font-size="18">Aucun plan disponible</text>';
        return;
      }

      // Filter elements by current floor
      const elements = planData.elements.filter(el => (el.etage || 0) === currentFloor);

      if (elements.length === 0) {
        svg.innerHTML = '<text x="500" y="400" text-anchor="middle" fill="#94a3b8" font-size="18">Aucun élément sur cet étage</text>';
        return;
      }

      // Calculate viewBox to fit all elements
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      elements.forEach(el => {
        const coords = el.coordonnees;
        if (coords) {
          const x = coords.x || 0;
          const y = coords.y || 0;
          const width = coords.width || coords.largeur || 100;
          const height = coords.height || coords.hauteur || 100;

          minX = Math.min(minX, x);
          minY = Math.min(minY, y);
          maxX = Math.max(maxX, x + width);
          maxY = Math.max(maxY, y + height);
        }
      });

      // Add padding
      const padding = 50;
      minX -= padding;
      minY -= padding;
      maxX += padding;
      maxY += padding;

      svg.setAttribute('viewBox', `${minX} ${minY} ${maxX - minX} ${maxY - minY}`);

      // Render elements
      svg.innerHTML = elements.map(el => {
        const coords = el.coordonnees;
        if (!coords) return '';

        const x = coords.x || 0;
        const y = coords.y || 0;
        const width = coords.width || coords.largeur || 100;
        const height = coords.height || coords.hauteur || 100;
        const type = el.type || 'furniture';

        let shape = '';
        if (coords.points) {
          // Polygon
          const points = coords.points.map(p => `${p.x},${p.y}`).join(' ');
          shape = `<polygon points="${points}" class="plan-element plan-${type}" data-id="${el.id}" />`;
        } else if (coords.radius) {
          // Circle
          shape = `<circle cx="${x}" cy="${y}" r="${coords.radius}" class="plan-element plan-${type}" data-id="${el.id}" />`;
        } else {
          // Rectangle
          shape = `<rect x="${x}" y="${y}" width="${width}" height="${height}" class="plan-element plan-${type}" data-id="${el.id}" />`;
        }

        // Add label
        const centerX = coords.points ? coords.points.reduce((sum, p) => sum + p.x, 0) / coords.points.length : x + width / 2;
        const centerY = coords.points ? coords.points.reduce((sum, p) => sum + p.y, 0) / coords.points.length : y + height / 2;
        const label = `<text x="${centerX}" y="${centerY}" class="plan-text">${el.nom}</text>`;

        return shape + label;
      }).join('');

      // Add click handlers
      svg.querySelectorAll('.plan-element').forEach(el => {
        el.addEventListener('click', () => {
          const elementId = parseInt(el.dataset.id);
          openElementPanel(elementId);
        });
      });
    }

    // Open side panel for an element
    async function openElementPanel(elementId) {
      const element = planData.elements.find(el => el.id === elementId);
      if (!element) return;

      const panel = document.getElementById('sidePanel');
      const overlay = document.getElementById('panelOverlay');
      const title = document.getElementById('panelTitle');
      const content = document.getElementById('panelContent');

      title.textContent = element.nom;
      content.innerHTML = '<div class="panel-loading"><i class="bi bi-arrow-clockwise"></i><p>Chargement...</p></div>';

      panel.classList.add('open');
      overlay.classList.add('visible');

      // Load articles for this element
      try {
        const resp = await fetch(`/api/plans/public/elements/${elementId}/articles`);
        if (!resp.ok) throw new Error('Erreur de chargement');

        const articles = await resp.json();

        if (!articles || articles.length === 0) {
          content.innerHTML = `
            <div class="panel-empty">
              <i class="bi bi-inbox"></i>
              <p>Aucun article associé à cet élément</p>
            </div>
          `;
          return;
        }

        // Render articles
        content.innerHTML = `
          <div class="article-list">
            ${articles.map(article => renderArticleItem(article)).join('')}
          </div>
        `;
      } catch (e) {
        console.error('Erreur articles:', e);
        content.innerHTML = `
          <div class="panel-empty">
            <i class="bi bi-exclamation-triangle"></i>
            <p>Erreur lors du chargement des articles</p>
          </div>
        `;
      }
    }

    // Render an article item
    function renderArticleItem(article) {
      const type = article.type || 'article';
      const status = article.statut || article.disponible ? 'disponible' : 'emprunte';
      const image = article.image_url || article.image || '/images/placeholder.png';
      const title = article.titre || article.nom || 'Sans titre';
      const url = `/fiche.html?type=${type}&id=${article.id}`;

      const typeLabels = {
        jeu: 'Jeu',
        livre: 'Livre',
        film: 'Film',
        disque: 'Album'
      };

      const statusLabels = {
        disponible: 'Disponible',
        emprunte: 'Emprunté',
        indisponible: 'Indisponible'
      };

      return `
        <a href="${url}" class="article-item">
          <img src="${image}" alt="${title}" class="article-image" onerror="this.src='/images/placeholder.png'">
          <div class="article-info">
            <div class="article-title">${title}</div>
            <div class="article-meta">
              <span class="badge badge-type">${typeLabels[type] || type}</span>
              <span class="badge badge-status ${status}">${statusLabels[status] || status}</span>
            </div>
          </div>
        </a>
      `;
    }

    // Close panel
    function closePanel() {
      document.getElementById('sidePanel').classList.remove('open');
      document.getElementById('panelOverlay').classList.remove('visible');
    }

    // Load and render plan
    async function loadAndRenderPlan() {
      planData = await loadPlanData(currentSiteId);
      renderFloorTabs();
      renderPlan();
    }

    // Initialize
    async function init() {
      document.getElementById('year').textContent = new Date().getFullYear();

      // Check if module is enabled
      const moduleEnabled = await loadConfig();

      if (!moduleEnabled) {
        document.getElementById('planCanvas').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      // Load sites
      sites = await loadSites();
      renderSiteSelector();

      // Load plan if we have a site
      if (currentSiteId) {
        await loadAndRenderPlan();
      } else {
        document.getElementById('planCanvas').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
      }

      // Panel close handlers
      document.getElementById('panelClose').addEventListener('click', closePanel);
      document.getElementById('panelOverlay').addEventListener('click', closePanel);
    }

    init();
  </script>
</body>
</html>
