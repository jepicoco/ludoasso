<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="site-title">Plan Interactif - Liberteko</title>
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <style>
    /* Plan Interactif - Forest Green Theme - Organic Interactive Map */
    .leaf-pattern {
      height: 180px;
    }

    .page-title {
      text-align: center;
      padding: 2rem;
      color: white;
    }

    .page-title h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .page-title p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .plan-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem 4rem;
    }

    /* Site Selector Card */
    .site-selector-card {
      background: white;
      border-radius: 30px;
      padding: 1.5rem 2rem;
      box-shadow: var(--shadow-lg);
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .site-selector-card label {
      font-weight: 700;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .site-selector-card select {
      flex: 1;
      padding: 0.75rem 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .site-selector-card select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    /* Plan Container */
    .plan-container {
      background: white;
      border-radius: 30px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    /* Floor Tabs */
    .floor-tabs {
      display: flex;
      gap: 0.5rem;
      padding: 1.5rem;
      border-bottom: 2px solid var(--secondary-color);
      background: var(--secondary-color);
      flex-wrap: wrap;
    }

    .floor-tab {
      padding: 0.75rem 1.5rem;
      border: none;
      background: white;
      border-radius: 50px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .floor-tab:hover {
      background: rgba(5, 150, 105, 0.15);
    }

    .floor-tab.active {
      background: var(--nature-gradient);
      color: white;
      box-shadow: var(--shadow);
    }

    /* Canvas Area */
    .plan-canvas {
      padding: 2rem;
      min-height: 500px;
      position: relative;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .plan-svg-container {
      width: 100%;
      max-width: 100%;
      overflow: auto;
    }

    #planSvg {
      width: 100%;
      height: auto;
      max-height: 70vh;
    }

    /* SVG Elements Styling */
    .plan-element {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .plan-element.wall {
      fill: #94a3b8;
      stroke: #64748b;
      stroke-width: 2;
    }

    .plan-element.shelf {
      fill: #fbbf24;
      stroke: #f59e0b;
      stroke-width: 2;
    }

    .plan-element.shelf:hover {
      fill: #fcd34d;
      stroke: #d97706;
    }

    .plan-element.table {
      fill: #34d399;
      stroke: #059669;
      stroke-width: 2;
    }

    .plan-element.table:hover {
      fill: #6ee7b7;
      stroke: #047857;
    }

    .plan-element.furniture {
      fill: #818cf8;
      stroke: #6366f1;
      stroke-width: 2;
    }

    .plan-element.furniture:hover {
      fill: #a5b4fc;
      stroke: #4f46e5;
    }

    .plan-element.zone {
      fill: rgba(5, 150, 105, 0.1);
      stroke: var(--primary-color);
      stroke-width: 2;
      stroke-dasharray: 5,5;
    }

    .plan-element.zone:hover {
      fill: rgba(5, 150, 105, 0.2);
    }

    .plan-element.selected {
      stroke: #dc2626;
      stroke-width: 4;
      filter: drop-shadow(0 0 8px rgba(220, 38, 38, 0.5));
    }

    .plan-label {
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      font-weight: 700;
      fill: var(--text-color);
      pointer-events: none;
      text-anchor: middle;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 4rem;
      color: var(--primary-light);
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 0.5rem;
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--secondary-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      max-width: 450px;
      height: 100vh;
      background: white;
      box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .side-panel.open {
      right: 0;
    }

    .panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .panel-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .panel-header {
      background: var(--nature-gradient);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .close-panel {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-panel:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .panel-section {
      margin-bottom: 2rem;
    }

    .panel-section h4 {
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Article Cards in Panel */
    .article-card {
      background: var(--background);
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      transition: all 0.3s ease;
      text-decoration: none;
      color: var(--text-color);
    }

    .article-card:hover {
      transform: translateX(-5px);
      box-shadow: var(--shadow);
    }

    .article-image {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      object-fit: cover;
      background: white;
      flex-shrink: 0;
    }

    .article-image.placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
      font-size: 2rem;
    }

    .article-info {
      flex: 1;
      min-width: 0;
    }

    .article-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .article-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .type-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .type-badge.jeux {
      background: #FEF3C7;
      color: #d97706;
    }

    .type-badge.livres {
      background: #DBEAFE;
      color: #2563eb;
    }

    .type-badge.films {
      background: #F3E8FF;
      color: #9333ea;
    }

    .type-badge.disques {
      background: #D1FAE5;
      color: #059669;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .status-badge.disponible {
      background: #D1FAE5;
      color: #047857;
    }

    .status-badge.emprunte {
      background: #FEE2E2;
      color: #dc2626;
    }

    .no-articles {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }

    .no-articles i {
      font-size: 3rem;
      color: var(--primary-light);
      margin-bottom: 1rem;
    }

    /* Module Disabled State */
    .module-disabled {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 30px;
      box-shadow: var(--shadow-lg);
    }

    .module-disabled i {
      font-size: 4rem;
      color: var(--primary-light);
      margin-bottom: 1rem;
    }

    .module-disabled h2 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 1rem;
    }

    .module-disabled p {
      color: var(--text-light);
      font-size: 1.1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .site-selector-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .site-selector-card select {
        width: 100%;
      }

      .floor-tabs {
        justify-content: center;
      }

      .plan-canvas {
        padding: 1rem;
      }

      .side-panel {
        max-width: 100%;
      }

      .panel-content {
        padding: 1.5rem;
      }

      .article-card {
        flex-direction: column;
      }

      .article-image {
        width: 100%;
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Decorative Pattern -->
  <div class="leaf-pattern"></div>

  <!-- Header - Organic Rounded -->
  <header class="site-header">
    <div class="header-container">
      <a href="/" class="logo">
        <i class="bi bi-tree"></i>
        <span id="header-title">Liberteko</span>
      </a>
      <nav>
        <ul class="nav-menu">
          <li><a href="/catalogue.html">Catalogue</a></li>
          <li><a href="/infos.html">Infos</a></li>
          <li><a href="/aide.html">Aide</a></li>
          <li><a href="/plan.html" class="active">Plan</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </nav>
      <a href="/usager/login.html" class="btn-login">
        Mon Espace
      </a>
    </div>
  </header>

  <!-- Page Title -->
  <section class="page-title">
    <h1><i class="bi bi-map"></i> Plan Interactif</h1>
    <p>Explorez notre espace et découvrez où se trouvent nos collections</p>
  </section>

  <!-- Main Content -->
  <main class="plan-wrapper">
    <!-- Module Disabled Message (hidden by default) -->
    <div id="moduleDisabled" class="module-disabled" style="display: none;">
      <i class="bi bi-lock"></i>
      <h2>Module non activé</h2>
      <p>Le plan interactif n'est pas disponible pour le moment.</p>
    </div>

    <!-- Plan Content (hidden by default until loaded) -->
    <div id="planContent" style="display: none;">
      <!-- Site Selector -->
      <div id="siteSelectorCard" class="site-selector-card" style="display: none;">
        <label for="siteSelector">
          <i class="bi bi-building"></i>
          Site :
        </label>
        <select id="siteSelector">
          <option value="">Sélectionnez un site...</option>
        </select>
      </div>

      <!-- Plan Container -->
      <div class="plan-container">
        <!-- Floor Tabs -->
        <div id="floorTabs" class="floor-tabs" style="display: none;"></div>

        <!-- Canvas -->
        <div class="plan-canvas">
          <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>Chargement du plan...</p>
          </div>

          <div id="emptyState" class="empty-state" style="display: none;">
            <i class="bi bi-map"></i>
            <h3>Aucun plan disponible</h3>
            <p>Sélectionnez un site pour afficher son plan.</p>
          </div>

          <div id="planSvgContainer" class="plan-svg-container" style="display: none;">
            <svg id="planSvg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid meet">
              <!-- Plan elements will be dynamically added here -->
            </svg>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Side Panel Overlay -->
  <div id="panelOverlay" class="panel-overlay"></div>

  <!-- Side Panel -->
  <div id="sidePanel" class="side-panel">
    <div class="panel-header">
      <h3>
        <i class="bi bi-box-seam"></i>
        <span id="panelTitle">Articles</span>
      </h3>
      <button class="close-panel" onclick="closeSidePanel()">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="panel-content">
      <div id="panelArticles" class="panel-section">
        <h4><i class="bi bi-collection"></i> Articles liés</h4>
        <div id="articlesContainer"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-section">
        <h4>Nous trouver</h4>
        <p id="footer-address"></p>
        <p id="footer-phone"></p>
        <p id="footer-email"></p>
      </div>
      <div class="footer-section">
        <h4>Horaires</h4>
        <div id="footer-horaires">
          <p>Voir la page Infos</p>
        </div>
      </div>
      <div class="footer-section">
        <h4>Liens</h4>
        <ul>
          <li><a href="/infos.html"><i class="bi bi-info-circle"></i> Présentation</a></li>
          <li><a href="/mentions-legales.html"><i class="bi bi-file-text"></i> Mentions légales</a></li>
          <li><a href="/cgu.html"><i class="bi bi-shield-check"></i> CGU</a></li>
          <li><a href="/contact.html"><i class="bi bi-envelope"></i> Contact</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span> - Cultivons la culture ensemble</p>
    </div>
  </footer>

  <script>
    // State Management
    let currentSiteId = null;
    let currentFloor = 0;
    let planData = null;
    let sites = [];
    let selectedElementId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('year').textContent = new Date().getFullYear();
      await loadConfig();
      await checkModuleEnabled();
    });

    // Load Configuration
    async function loadConfig() {
      try {
        const resp = await fetch('/api/public/parametres');
        if (!resp.ok) return;
        const data = await resp.json();

        document.getElementById('site-title').textContent = `Plan Interactif - ${data.nom || 'Liberteko'}`;
        document.getElementById('header-title').textContent = data.nom || 'Liberteko';
        document.getElementById('footer-name').textContent = data.nom || 'Liberteko';

        if (data.adresse) {
          document.getElementById('footer-address').innerHTML = `<i class="bi bi-geo-alt"></i> ${data.adresse}`;
        }
        if (data.telephone) {
          document.getElementById('footer-phone').innerHTML = `<i class="bi bi-telephone"></i> ${data.telephone}`;
        }
        if (data.email) {
          document.getElementById('footer-email').innerHTML = `<i class="bi bi-envelope"></i> ${data.email}`;
        }
      } catch (e) {
        console.error('Erreur config:', e);
      }
    }

    // Check if Module is Enabled
    async function checkModuleEnabled() {
      try {
        const resp = await fetch('/api/public/parametres');
        if (!resp.ok) {
          showModuleDisabled();
          return;
        }
        const data = await resp.json();

        if (data.module_plan_interactif) {
          await loadSites();
        } else {
          showModuleDisabled();
        }
      } catch (e) {
        console.error('Erreur vérification module:', e);
        showModuleDisabled();
      }
    }

    function showModuleDisabled() {
      document.getElementById('moduleDisabled').style.display = 'block';
      document.getElementById('planContent').style.display = 'none';
    }

    // Load Sites
    async function loadSites() {
      try {
        const resp = await fetch('/api/sites');
        if (!resp.ok) {
          showEmptyState();
          return;
        }
        sites = await resp.json();

        if (sites.length === 0) {
          showEmptyState();
          return;
        }

        document.getElementById('planContent').style.display = 'block';

        // Show site selector if multiple sites
        if (sites.length > 1) {
          const selector = document.getElementById('siteSelector');
          selector.innerHTML = '<option value="">Sélectionnez un site...</option>';
          sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = site.nom;
            selector.appendChild(option);
          });
          document.getElementById('siteSelectorCard').style.display = 'flex';
          selector.addEventListener('change', (e) => {
            if (e.target.value) {
              loadPlan(parseInt(e.target.value));
            }
          });
        } else {
          // Auto-load single site
          loadPlan(sites[0].id);
        }
      } catch (e) {
        console.error('Erreur chargement sites:', e);
        showEmptyState();
      }
    }

    // Load Plan for Site
    async function loadPlan(siteId) {
      currentSiteId = siteId;
      showLoading();

      try {
        const resp = await fetch(`/api/plans/public/site/${siteId}`);
        if (!resp.ok) {
          showEmptyState();
          return;
        }
        planData = await resp.json();

        if (!planData || !planData.elements || planData.elements.length === 0) {
          showEmptyState();
          return;
        }

        renderPlan();
      } catch (e) {
        console.error('Erreur chargement plan:', e);
        showEmptyState();
      }
    }

    // Render Plan
    function renderPlan() {
      // Get unique floors
      const floors = [...new Set(planData.elements.map(el => el.etage || 0))].sort((a, b) => a - b);

      // Show floor tabs if multiple floors
      if (floors.length > 1) {
        renderFloorTabs(floors);
      } else {
        document.getElementById('floorTabs').style.display = 'none';
      }

      currentFloor = floors[0];
      renderFloor(currentFloor);
    }

    // Render Floor Tabs
    function renderFloorTabs(floors) {
      const tabsContainer = document.getElementById('floorTabs');
      tabsContainer.style.display = 'flex';
      tabsContainer.innerHTML = '';

      floors.forEach(floor => {
        const tab = document.createElement('button');
        tab.className = 'floor-tab';
        tab.innerHTML = `<i class="bi bi-layers"></i> ${getFloorLabel(floor)}`;
        tab.onclick = () => {
          currentFloor = floor;
          renderFloor(floor);
          // Update active tab
          document.querySelectorAll('.floor-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        };
        if (floor === currentFloor) {
          tab.classList.add('active');
        }
        tabsContainer.appendChild(tab);
      });
    }

    function getFloorLabel(floor) {
      if (floor === 0) return 'Rez-de-chaussée';
      if (floor > 0) return `Étage ${floor}`;
      return `Sous-sol ${Math.abs(floor)}`;
    }

    // Render Floor
    function renderFloor(floor) {
      const svg = document.getElementById('planSvg');
      svg.innerHTML = '';

      // Filter elements for current floor
      const elements = planData.elements.filter(el => (el.etage || 0) === floor);

      if (elements.length === 0) {
        showEmptyState();
        return;
      }

      // Calculate viewBox based on elements
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      elements.forEach(el => {
        const coords = parseCoordinates(el.coordonnees);
        coords.forEach(([x, y]) => {
          minX = Math.min(minX, x);
          minY = Math.min(minY, y);
          maxX = Math.max(maxX, x);
          maxY = Math.max(maxY, y);
        });
      });

      const padding = 50;
      const width = maxX - minX + padding * 2;
      const height = maxY - minY + padding * 2;
      svg.setAttribute('viewBox', `${minX - padding} ${minY - padding} ${width} ${height}`);

      // Render elements
      elements.forEach(el => {
        renderElement(svg, el);
      });

      hideLoading();
      document.getElementById('planSvgContainer').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
    }

    // Parse Coordinates
    function parseCoordinates(coordStr) {
      try {
        return JSON.parse(coordStr);
      } catch (e) {
        console.error('Erreur parsing coordonnées:', e);
        return [];
      }
    }

    // Render Element
    function renderElement(svg, element) {
      const coords = parseCoordinates(element.coordonnees);
      if (coords.length === 0) return;

      const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');

      // Create shape based on type
      let shape;
      if (element.forme === 'rectangle' || element.forme === 'shelf' || element.forme === 'table') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        const [x, y] = coords[0];
        const [x2, y2] = coords[1] || [x + 100, y + 50];
        shape.setAttribute('x', Math.min(x, x2));
        shape.setAttribute('y', Math.min(y, y2));
        shape.setAttribute('width', Math.abs(x2 - x));
        shape.setAttribute('height', Math.abs(y2 - y));
      } else if (element.forme === 'circle') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        const [x, y] = coords[0];
        const radius = coords[1] ? Math.sqrt(Math.pow(coords[1][0] - x, 2) + Math.pow(coords[1][1] - y, 2)) : 30;
        shape.setAttribute('cx', x);
        shape.setAttribute('cy', y);
        shape.setAttribute('r', radius);
      } else {
        // Polygon
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const points = coords.map(([x, y]) => `${x},${y}`).join(' ');
        shape.setAttribute('points', points);
      }

      shape.setAttribute('class', `plan-element ${element.type_element || 'furniture'}`);
      shape.setAttribute('data-element-id', element.id);

      // Add click handler for interactive elements
      if (element.type_element !== 'wall') {
        shape.style.cursor = 'pointer';
        shape.addEventListener('click', () => {
          handleElementClick(element);
        });
      }

      group.appendChild(shape);

      // Add label if exists
      if (element.nom) {
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        const center = getCenterPoint(coords);
        label.setAttribute('x', center[0]);
        label.setAttribute('y', center[1]);
        label.setAttribute('class', 'plan-label');
        label.textContent = element.nom;
        group.appendChild(label);
      }

      svg.appendChild(group);
    }

    // Get Center Point
    function getCenterPoint(coords) {
      const sumX = coords.reduce((sum, [x]) => sum + x, 0);
      const sumY = coords.reduce((sum, [, y]) => sum + y, 0);
      return [sumX / coords.length, sumY / coords.length];
    }

    // Handle Element Click
    async function handleElementClick(element) {
      // Highlight selected element
      document.querySelectorAll('.plan-element').forEach(el => {
        el.classList.remove('selected');
      });
      document.querySelector(`[data-element-id="${element.id}"]`).classList.add('selected');

      selectedElementId = element.id;
      await loadArticlesForElement(element);
    }

    // Load Articles for Element
    async function loadArticlesForElement(element) {
      document.getElementById('panelTitle').textContent = element.nom || 'Articles';
      const container = document.getElementById('articlesContainer');
      container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Chargement...</p></div>';

      openSidePanel();

      try {
        const resp = await fetch(`/api/plans/public/elements/${element.id}/articles`);
        if (!resp.ok) {
          container.innerHTML = '<div class="no-articles"><i class="bi bi-inbox"></i><p>Aucun article lié à cet emplacement.</p></div>';
          return;
        }

        const articles = await resp.json();

        if (articles.length === 0) {
          container.innerHTML = '<div class="no-articles"><i class="bi bi-inbox"></i><p>Aucun article lié à cet emplacement.</p></div>';
          return;
        }

        renderArticles(articles);
      } catch (e) {
        console.error('Erreur chargement articles:', e);
        container.innerHTML = '<div class="no-articles"><i class="bi bi-exclamation-triangle"></i><p>Erreur lors du chargement des articles.</p></div>';
      }
    }

    // Render Articles
    function renderArticles(articles) {
      const container = document.getElementById('articlesContainer');
      container.innerHTML = '';

      articles.forEach(article => {
        const card = createArticleCard(article);
        container.appendChild(card);
      });
    }

    // Create Article Card
    function createArticleCard(article) {
      const card = document.createElement('a');
      card.className = 'article-card';
      card.href = `/fiche.html?collection=${article.collection}&id=${article.id}`;

      // Image
      const img = document.createElement('div');
      if (article.image_url) {
        const imgEl = document.createElement('img');
        imgEl.src = article.image_url;
        imgEl.alt = article.titre;
        imgEl.className = 'article-image';
        img.appendChild(imgEl);
      } else {
        img.className = 'article-image placeholder';
        img.innerHTML = getCollectionIcon(article.collection);
      }
      card.appendChild(img);

      // Info
      const info = document.createElement('div');
      info.className = 'article-info';

      const title = document.createElement('div');
      title.className = 'article-title';
      title.textContent = article.titre || 'Sans titre';
      info.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'article-meta';

      const typeBadge = document.createElement('span');
      typeBadge.className = `type-badge ${article.collection}`;
      typeBadge.textContent = getCollectionLabel(article.collection);
      meta.appendChild(typeBadge);

      const statusBadge = document.createElement('span');
      statusBadge.className = `status-badge ${article.statut === 'disponible' ? 'disponible' : 'emprunte'}`;
      statusBadge.innerHTML = article.statut === 'disponible'
        ? '<i class="bi bi-check-circle-fill"></i> Disponible'
        : '<i class="bi bi-x-circle-fill"></i> Emprunté';
      meta.appendChild(statusBadge);

      info.appendChild(meta);
      card.appendChild(info);

      return card;
    }

    // Get Collection Icon
    function getCollectionIcon(collection) {
      const icons = {
        jeux: '<i class="bi bi-dice-6"></i>',
        livres: '<i class="bi bi-book"></i>',
        films: '<i class="bi bi-film"></i>',
        disques: '<i class="bi bi-vinyl"></i>'
      };
      return icons[collection] || '<i class="bi bi-box"></i>';
    }

    // Get Collection Label
    function getCollectionLabel(collection) {
      const labels = {
        jeux: 'Jeu',
        livres: 'Livre',
        films: 'Film',
        disques: 'Disque'
      };
      return labels[collection] || collection;
    }

    // Side Panel Controls
    function openSidePanel() {
      document.getElementById('sidePanel').classList.add('open');
      document.getElementById('panelOverlay').classList.add('visible');
    }

    function closeSidePanel() {
      document.getElementById('sidePanel').classList.remove('open');
      document.getElementById('panelOverlay').classList.remove('visible');
      // Remove selection
      document.querySelectorAll('.plan-element').forEach(el => {
        el.classList.remove('selected');
      });
      selectedElementId = null;
    }

    // Close on overlay click
    document.getElementById('panelOverlay').addEventListener('click', closeSidePanel);

    // Loading States
    function showLoading() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('planSvgContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('planSvgContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }
  </script>
</body>
</html>
