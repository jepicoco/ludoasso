<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-name" content="pixel-geek">
  <title>Mes factures - Espace Usager</title>
  <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">
  <script src="/js/theme-loader.js"></script>
  <style>
    .page-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .page-title { font-family: 'Press Start 2P', cursive; font-size: 0.9rem; color: var(--pixel-cyan); text-shadow: 3px 3px 0 var(--pixel-purple); margin-bottom: 2rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--bg-card); border: 4px solid var(--pixel-blue); padding: 1rem; display: flex; align-items: center; gap: 1rem; }
    .stat-icon { width: 50px; height: 50px; border: 3px solid; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .stat-icon.primary { border-color: var(--pixel-cyan); color: var(--pixel-cyan); }
    .stat-icon.success { border-color: var(--pixel-green); color: var(--pixel-green); }
    .stat-icon.warning { border-color: var(--pixel-gold); color: var(--pixel-gold); }
    .stat-icon.danger { border-color: var(--pixel-pink); color: var(--pixel-pink); }
    .stat-value { font-family: 'Press Start 2P', cursive; font-size: 0.7rem; color: var(--text-primary); }
    .stat-label { font-size: 0.7rem; color: var(--text-secondary); }
    .pixel-tabs { display: flex; gap: 0; margin-bottom: 2rem; border-bottom: 4px solid var(--pixel-purple); }
    .pixel-tab { padding: 1rem 1.5rem; background: var(--bg-card); border: 3px solid var(--pixel-purple); border-bottom: none; color: var(--text-secondary); font-family: 'Press Start 2P', cursive; font-size: 0.5rem; cursor: pointer; transition: all 0.1s ease; }
    .pixel-tab:hover { background: rgba(255, 107, 157, 0.2); }
    .pixel-tab.active { background: var(--pixel-pink); border-color: var(--pixel-pink); color: white; position: relative; top: 4px; }
    .facture-card { background: var(--bg-card); border: 4px solid var(--pixel-blue); margin-bottom: 1rem; cursor: pointer; transition: all 0.1s ease; }
    .facture-card:hover { border-color: var(--pixel-cyan); transform: translate(-2px, -2px); box-shadow: 4px 4px 0 var(--pixel-purple); }
    .facture-card.avoir { border-color: var(--pixel-purple); }
    .facture-card.impayee { border-color: var(--pixel-gold); }
    .facture-card-body { padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .facture-info h3 { font-family: 'Press Start 2P', cursive; font-size: 0.6rem; color: var(--pixel-cyan); margin-bottom: 0.5rem; }
    .facture-info .date { font-size: 0.8rem; color: var(--text-secondary); }
    .pixel-badge { font-family: 'Press Start 2P', cursive; font-size: 0.4rem; padding: 0.5rem 0.75rem; border: 2px solid; }
    .pixel-badge.emise { border-color: var(--pixel-blue); color: var(--pixel-blue); }
    .pixel-badge.partiellement_reglee { border-color: var(--pixel-gold); color: var(--pixel-gold); }
    .pixel-badge.reglee { border-color: var(--pixel-green); color: var(--pixel-green); }
    .pixel-badge.annulee { border-color: var(--pixel-pink); color: var(--pixel-pink); }
    .pixel-badge.avoir { border-color: var(--pixel-purple); color: var(--pixel-purple); }
    .facture-montant { text-align: right; }
    .facture-montant .total { font-family: 'Press Start 2P', cursive; font-size: 0.7rem; color: var(--pixel-green); }
    .facture-montant .total.avoir { color: var(--pixel-pink); }
    .facture-montant .reste { font-size: 0.7rem; color: var(--pixel-gold); }
    .reglement-item { background: var(--bg-card); border: 4px solid var(--pixel-green); padding: 1rem; margin-bottom: 1rem; }
    .reglement-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .reglement-montant { font-family: 'Press Start 2P', cursive; font-size: 0.6rem; color: var(--pixel-green); }
    .empty-state { text-align: center; padding: 3rem; background: var(--bg-card); border: 4px solid var(--pixel-blue); }
    .empty-state i { font-size: 3rem; color: var(--pixel-cyan); margin-bottom: 1rem; display: block; }
    .empty-state h3 { font-family: 'Press Start 2P', cursive; font-size: 0.6rem; color: var(--text-primary); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--bg-card); border: 4px solid var(--pixel-cyan); max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 1rem; border-bottom: 4px solid var(--pixel-purple); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-family: 'Press Start 2P', cursive; font-size: 0.6rem; color: var(--pixel-cyan); margin: 0; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--pixel-pink); }
    .modal-body { padding: 1rem; }
    .modal-footer { padding: 1rem; border-top: 4px solid var(--pixel-purple); display: flex; justify-content: flex-end; gap: 0.5rem; }
    .ligne-facture { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 2px dashed var(--pixel-purple); }
    .ligne-facture:last-child { border-bottom: none; }
    .totaux-box { background: rgba(0, 255, 255, 0.1); border: 3px solid var(--pixel-cyan); padding: 1rem; margin-top: 1rem; }
    @media (max-width: 768px) { .facture-card-body { flex-direction: column; text-align: center; } .facture-montant { text-align: center; } }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-container">
      <a href="/" class="logo"><span class="logo-icon">🎮</span><span class="logo-text" id="header-title">LIBERTEKO</span></a>
      <nav><ul class="nav-menu"><li><a href="/">Accueil</a></li><li><a href="/catalogue.html">Catalogue</a></li><li><a href="/infos.html">Infos</a></li></ul></nav>
      <div class="header-actions"><a href="/usager/dashboard.html" class="btn btn-primary btn-sm"><i class="bi bi-person"></i> Espace</a></div>
    </div>
  </header>

  <div class="user-nav-bar" style="background: var(--bg-card); border-bottom: 4px solid var(--pixel-purple); padding: 0.5rem 2rem; display: flex; gap: 1rem; justify-content: center;">
    <a href="/usager/dashboard.html" style="color: var(--text-secondary); font-family: 'Press Start 2P', cursive; font-size: 0.5rem; padding: 0.5rem;"><i class="bi bi-house"></i> ACCUEIL</a>
    <a href="/usager/emprunts.html" style="color: var(--text-secondary); font-family: 'Press Start 2P', cursive; font-size: 0.5rem; padding: 0.5rem;"><i class="bi bi-bookmark"></i> EMPRUNTS</a>
    <a href="/usager/factures.html" style="color: var(--pixel-cyan); font-family: 'Press Start 2P', cursive; font-size: 0.5rem; padding: 0.5rem;"><i class="bi bi-receipt"></i> FACTURES</a>
    <a href="/usager/profil.html" style="color: var(--text-secondary); font-family: 'Press Start 2P', cursive; font-size: 0.5rem; padding: 0.5rem;"><i class="bi bi-person"></i> PROFIL</a>
    <a href="#" onclick="logout()" style="color: var(--pixel-pink); font-family: 'Press Start 2P', cursive; font-size: 0.5rem; padding: 0.5rem;"><i class="bi bi-power"></i> QUIT</a>
  </div>

  <div class="page-container">
    <h1 class="page-title"><i class="bi bi-receipt"></i> MES FACTURES</h1>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon primary"><i class="bi bi-file-text"></i></div><div><div class="stat-value" id="nb-factures">-</div><div class="stat-label">Factures</div></div></div>
      <div class="stat-card"><div class="stat-icon success"><i class="bi bi-check"></i></div><div><div class="stat-value" id="montant-regle">-</div><div class="stat-label">Regle</div></div></div>
      <div class="stat-card"><div class="stat-icon warning"><i class="bi bi-clock"></i></div><div><div class="stat-value" id="montant-impaye">-</div><div class="stat-label">Impaye</div></div></div>
      <div class="stat-card"><div class="stat-icon danger"><i class="bi bi-arrow-return-left"></i></div><div><div class="stat-value" id="montant-avoirs">-</div><div class="stat-label">Avoirs</div></div></div>
    </div>

    <div class="pixel-tabs">
      <button class="pixel-tab active" data-tab="factures" onclick="switchTab('factures')"><i class="bi bi-file-text"></i> FACTURES</button>
      <button class="pixel-tab" data-tab="reglements" onclick="switchTab('reglements')"><i class="bi bi-coin"></i> REGLEMENTS</button>
    </div>

    <div id="tab-factures"><div id="factures-list"><div class="empty-state"><i class="bi bi-hourglass-split"></i><h3>LOADING...</h3></div></div></div>
    <div id="tab-reglements" style="display:none;"><div id="reglements-list"><div class="empty-state"><i class="bi bi-hourglass-split"></i><h3>LOADING...</h3></div></div></div>
  </div>

  <div class="modal-overlay" id="modal-facture">
    <div class="modal">
      <div class="modal-header"><h3 id="modal-title">FACTURE</h3><button class="modal-close" onclick="closeModal()">X</button></div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal()">FERMER</button>
        <button class="btn btn-primary" id="btn-download"><i class="bi bi-download"></i> PDF</button>
      </div>
    </div>
  </div>

  <footer class="site-footer"><div class="footer-content"><p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span> - GAME OVER</p></div></footer>

  <script>
    let token = null, factureSelectionnee = null;

    async function init() {
      document.getElementById('year').textContent = new Date().getFullYear();
      token = localStorage.getItem('usager_token');
      if (!token) { window.location.href = '/usager/login.html'; return; }
      try {
        const resp = await fetch('/api/public/config');
        const config = await resp.json();
        const siteName = config.nom_site || 'Liberteko';
        document.getElementById('header-title').textContent = siteName.toUpperCase();
        document.getElementById('footer-name').textContent = siteName;
      } catch (e) {}
      await loadResume(); await loadFactures();
    }

    async function loadResume() {
      try {
        const resp = await fetch('/api/usager/factures/resume', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) return;
        const r = await resp.json();
        document.getElementById('nb-factures').textContent = r.total_factures;
        document.getElementById('montant-regle').textContent = formatMontant(r.montant_regle);
        document.getElementById('montant-impaye').textContent = formatMontant(r.montant_impaye);
        document.getElementById('montant-avoirs').textContent = formatMontant(r.montant_total_avoirs);
      } catch (e) {}
    }

    async function loadFactures() {
      try {
        const resp = await fetch('/api/usager/factures', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) { if (resp.status === 401) logout(); return; }
        const data = await resp.json();
        if (data.factures.length === 0) {
          document.getElementById('factures-list').innerHTML = '<div class="empty-state"><i class="bi bi-file-x"></i><h3>NO DATA</h3></div>';
          return;
        }
        document.getElementById('factures-list').innerHTML = data.factures.map(f => {
          const isAvoir = f.type_document === 'avoir';
          return `<div class="facture-card ${isAvoir ? 'avoir' : (f.reste_a_payer > 0.01 ? 'impayee' : '')}" onclick="voirFacture(${f.id})">
            <div class="facture-card-body">
              <div class="facture-info"><h3><i class="bi bi-${isAvoir ? 'arrow-return-left' : 'file-text'}"></i> ${f.numero}</h3><div class="date">${formatDate(f.date_emission)}</div></div>
              <span class="pixel-badge ${isAvoir ? 'avoir' : f.statut}">${isAvoir ? 'AVOIR' : getStatutLabel(f.statut).toUpperCase()}</span>
              <div class="facture-montant"><div class="total ${isAvoir ? 'avoir' : ''}">${isAvoir ? '-' : ''}${formatMontant(f.montant_ttc)}</div>${!isAvoir && f.reste_a_payer > 0.01 ? `<div class="reste">DUE: ${formatMontant(f.reste_a_payer)}</div>` : ''}</div>
            </div>
          </div>`;
        }).join('');
      } catch (e) { document.getElementById('factures-list').innerHTML = '<div class="empty-state"><i class="bi bi-bug"></i><h3>ERROR</h3></div>'; }
    }

    async function loadReglements() {
      try {
        const resp = await fetch('/api/usager/factures/tous/reglements', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.reglements.length === 0) {
          document.getElementById('reglements-list').innerHTML = '<div class="empty-state"><i class="bi bi-coin"></i><h3>NO COINS</h3></div>';
          return;
        }
        document.getElementById('reglements-list').innerHTML = data.reglements.map(r => `
          <div class="reglement-item">
            <div class="reglement-header"><span>${formatDate(r.date_reglement)} - ${formatModePaiement(r.mode_paiement)}</span><span class="reglement-montant">+${formatMontant(r.montant)}</span></div>
            <small><a href="#" onclick="voirFacture(${r.facture_id}); return false;" style="color: var(--pixel-cyan);">${r.facture_numero}</a></small>
          </div>
        `).join('');
      } catch (e) {}
    }

    async function voirFacture(id) {
      try {
        const resp = await fetch(`/api/usager/factures/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) throw new Error();
        const f = await resp.json();
        factureSelectionnee = f;
        document.getElementById('modal-title').textContent = `${f.type_document === 'avoir' ? 'AVOIR' : 'FACTURE'} ${f.numero}`;
        let html = `<p><strong>Date:</strong> ${formatDate(f.date_emission)}</p><p><strong>Status:</strong> <span class="pixel-badge ${f.statut}">${getStatutLabel(f.statut).toUpperCase()}</span></p><hr style="border-color: var(--pixel-purple);"><h4 style="font-family: 'Press Start 2P', cursive; font-size: 0.5rem; color: var(--pixel-cyan);">ITEMS</h4>`;
        f.lignes.forEach(l => { html += `<div class="ligne-facture"><span>${l.description}</span><strong>${formatMontant(l.montant_ttc)}</strong></div>`; });
        html += `<div class="totaux-box"><div class="ligne-facture"><span>HT</span><span>${formatMontant(f.montant_ht)}</span></div><div class="ligne-facture"><span>TVA</span><span>${formatMontant(f.montant_tva)}</span></div><div class="ligne-facture"><span><strong>TOTAL</strong></span><strong style="color: var(--pixel-green);">${formatMontant(f.montant_ttc)}</strong></div></div>`;
        if (f.reglements?.length) { html += '<hr style="border-color: var(--pixel-purple);"><h4 style="font-family: \'Press Start 2P\', cursive; font-size: 0.5rem; color: var(--pixel-green);">PAYMENTS</h4>'; f.reglements.forEach(r => { html += `<div class="ligne-facture"><span>${formatDate(r.date_reglement)}</span><strong style="color:var(--pixel-green)">+${formatMontant(r.montant)}</strong></div>`; }); }
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-facture').classList.add('show');
      } catch (e) { alert('ERROR!'); }
    }

    function closeModal() { document.getElementById('modal-facture').classList.remove('show'); }

    document.getElementById('btn-download').addEventListener('click', async () => {
      if (!factureSelectionnee) return;
      try {
        const resp = await fetch(`/api/usager/factures/${factureSelectionnee.id}/pdf`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) throw new Error();
        const blob = await resp.blob();
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${factureSelectionnee.type_document === 'avoir' ? 'Avoir' : 'Facture'}_${factureSelectionnee.numero.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
        a.click(); URL.revokeObjectURL(a.href);
      } catch (e) { alert('DOWNLOAD FAILED'); }
    });

    function switchTab(tab) {
      document.querySelectorAll('.pixel-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.getElementById('tab-factures').style.display = tab === 'factures' ? 'block' : 'none';
      document.getElementById('tab-reglements').style.display = tab === 'reglements' ? 'block' : 'none';
      if (tab === 'reglements') loadReglements();
    }

    function formatMontant(m) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(m || 0); }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR') : '-'; }
    function getStatutLabel(s) { return { emise: 'Emise', partiellement_reglee: 'Partiel', reglee: 'Reglee', annulee: 'Annulee' }[s] || s; }
    function formatModePaiement(m) { return { especes: 'CASH', cheque: 'CHECK', carte_bancaire: 'CARD', virement: 'WIRE' }[m] || m; }
    function logout() { localStorage.removeItem('usager_token'); window.location.href = '/usager/login.html'; }

    init();
  </script>
</body>
</html>
