<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-name" content="winter-wonder">
    <title id="site-title">Plan du site - Liberteko</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/theme/css/theme.css">
    <script src="/js/theme-loader.js"></script>
    <style>
        /* Plan-specific styles matching Winter Wonder theme */
        :root {
            --element-mur: #475569;
            --element-etagere: #f59e0b;
            --element-etagere-fill: rgba(251, 191, 36, 0.6);
            --element-meuble: #64748b;
            --element-meuble-fill: rgba(148, 163, 184, 0.5);
            --element-table: #0ea5e9;
            --element-table-fill: rgba(125, 211, 252, 0.4);
            --element-zone: #7dd3fc;
        }

        body {
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        /* Container */
        .plan-page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2rem;
            color: var(--snow-white);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .page-header h1 i {
            color: var(--frost-medium);
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Site Selector */
        .site-selector-container {
            margin-bottom: 2rem;
            text-align: center;
        }

        .site-selector {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-glass);
            backdrop-filter: var(--glass-blur);
            border: var(--border-frost);
            border-radius: var(--border-radius-sm);
            padding: 0.75rem 1.25rem;
        }

        .site-selector label {
            color: var(--frost-medium);
            font-weight: 500;
            font-size: 0.9rem;
            margin: 0;
        }

        .site-selector select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            padding: 0.5rem 2rem 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .site-selector select:focus {
            border-color: var(--frost-medium);
            box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.2);
        }

        .site-selector select option {
            background: var(--bg-card-solid);
            color: var(--text-primary);
        }

        /* Plan Container */
        .plan-container {
            background: var(--bg-glass);
            backdrop-filter: var(--glass-blur);
            border: var(--border-frost);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .plan-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 1.25rem 1.5rem;
            border-bottom: var(--border-frost);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .plan-title {
            margin: 0;
            font-size: 1.25rem;
            color: var(--snow-white);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .plan-title i {
            color: var(--frost-medium);
        }

        /* Etage Tabs */
        .etages-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .etage-tab {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--border-radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .etage-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--frost-medium);
            color: var(--text-primary);
        }

        .etage-tab.active {
            background: linear-gradient(135deg, var(--frost-blue), var(--frost-deep));
            border-color: var(--frost-blue);
            color: white;
            box-shadow: var(--shadow-frost);
        }

        /* Canvas */
        .plan-canvas-wrapper {
            position: relative;
            min-height: 600px;
            background: rgba(255, 255, 255, 0.02);
        }

        .plan-svg {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        .plan-svg:active {
            cursor: grabbing;
        }

        /* SVG Elements */
        .element-mur {
            stroke: var(--element-mur);
            stroke-width: 6;
            stroke-linecap: round;
            fill: none;
        }

        .element-etagere {
            stroke: var(--element-etagere);
            stroke-width: 2;
            fill: var(--element-etagere-fill);
            cursor: pointer;
            transition: all 0.2s;
        }

        .element-etagere:hover {
            fill: rgba(251, 191, 36, 0.8);
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5));
        }

        .element-meuble {
            stroke: var(--element-meuble);
            stroke-width: 2;
            fill: var(--element-meuble-fill);
            cursor: pointer;
            transition: all 0.2s;
        }

        .element-meuble:hover {
            fill: rgba(148, 163, 184, 0.7);
            filter: drop-shadow(0 0 8px rgba(148, 163, 184, 0.5));
        }

        .element-table {
            stroke: var(--element-table);
            stroke-width: 2;
            fill: var(--element-table-fill);
            cursor: pointer;
            transition: all 0.2s;
        }

        .element-table:hover {
            fill: rgba(125, 211, 252, 0.6);
            filter: drop-shadow(0 0 8px rgba(125, 211, 252, 0.5));
        }

        .element-zone {
            stroke: var(--element-zone);
            stroke-width: 2;
            stroke-dasharray: 5,5;
            fill: var(--element-zone);
            fill-opacity: 0.15;
            cursor: pointer;
            transition: fill-opacity 0.2s;
        }

        .element-zone:hover {
            fill-opacity: 0.3;
        }

        .element-label {
            font-size: 12px;
            font-weight: 500;
            fill: var(--text-primary);
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* Tooltip */
        .plan-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: var(--glass-blur);
            border: var(--border-frost);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            display: none;
            box-shadow: var(--shadow-md);
        }

        .plan-tooltip.visible {
            display: block;
        }

        .tooltip-title {
            font-weight: 600;
            color: var(--frost-medium);
            margin-bottom: 0.5rem;
        }

        .tooltip-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tooltip-info i {
            color: var(--frost-medium);
            margin-right: 0.25rem;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10;
        }

        .zoom-controls button {
            width: 44px;
            height: 44px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: var(--glass-blur);
            border: var(--border-frost);
            border-radius: var(--border-radius-sm);
            color: var(--frost-medium);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .zoom-controls button:hover {
            background: rgba(15, 23, 42, 1);
            color: var(--warm-amber);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Loading & Empty States */
        .plan-loading,
        .no-plan {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
        }

        .plan-loading .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(125, 211, 252, 0.2);
            border-top-color: var(--frost-medium);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-plan i {
            font-size: 4rem;
            color: var(--frost-medium);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .no-plan h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Legend */
        .plan-legend {
            background: rgba(0, 0, 0, 0.15);
            padding: 1rem 1.5rem;
            border-top: var(--border-frost);
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-color.mur {
            background: var(--element-mur);
        }

        .legend-color.etagere {
            background: var(--element-etagere-fill);
            border: 2px solid var(--element-etagere);
        }

        .legend-color.meuble {
            background: var(--element-meuble-fill);
            border: 2px solid var(--element-meuble);
        }

        .legend-color.table {
            background: var(--element-table-fill);
            border: 2px solid var(--element-table);
        }

        .legend-color.zone {
            background: rgba(125, 211, 252, 0.2);
            border: 2px dashed var(--element-zone);
        }

        /* Side Panel for Articles */
        .side-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: var(--glass-blur);
            border-left: var(--border-frost);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .side-panel.open {
            right: 0;
        }

        .side-panel-header {
            padding: 1.5rem;
            border-bottom: var(--border-frost);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-panel-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--snow-white);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .side-panel-header h3 i {
            color: var(--frost-medium);
        }

        .side-panel-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s;
        }

        .side-panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--warm-amber);
        }

        .side-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .articles-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .article-card {
            background: var(--bg-glass);
            border: var(--border-frost);
            border-radius: var(--border-radius-sm);
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .article-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--frost-medium);
            transform: translateX(-4px);
            box-shadow: var(--shadow-md);
        }

        .article-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--border-radius-sm);
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .article-info {
            flex: 1;
            min-width: 0;
        }

        .article-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .article-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .article-badges {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-badge.jeu {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warm-amber);
        }

        .type-badge.livre {
            background: rgba(125, 211, 252, 0.2);
            color: var(--frost-medium);
        }

        .type-badge.film {
            background: rgba(251, 146, 60, 0.2);
            color: var(--warm-orange);
        }

        .type-badge.disque {
            background: rgba(16, 185, 129, 0.2);
            color: var(--color-success);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-badge.disponible {
            background: rgba(16, 185, 129, 0.2);
            color: var(--color-success);
        }

        .status-badge.emprunte {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-danger);
        }

        .no-articles {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .no-articles i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .articles-loading {
            text-align: center;
            padding: 3rem 1rem;
        }

        .articles-loading .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(125, 211, 252, 0.2);
            border-top-color: var(--frost-medium);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* Module Disabled Warning */
        .module-disabled {
            text-align: center;
            padding: 4rem 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .module-disabled i {
            font-size: 4rem;
            color: var(--frost-medium);
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .module-disabled h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .module-disabled p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .plan-page-container {
                padding: 1rem;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .plan-header {
                flex-direction: column;
                align-items: stretch;
            }

            .etages-tabs {
                justify-content: center;
            }

            .plan-canvas-wrapper {
                min-height: 400px;
            }

            .side-panel {
                width: 100%;
                right: -100%;
            }

            .zoom-controls {
                bottom: 1rem;
                right: 1rem;
            }

            .zoom-controls button {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-container">
            <a href="/" class="logo">
                <i class="bi bi-snow2 logo-icon"></i>
                <span class="logo-text" id="header-title">LIBERTEKO</span>
            </a>
            <nav>
                <ul class="nav-menu">
                    <li><a href="/">Accueil</a></li>
                    <li><a href="/catalogue.html">Catalogue</a></li>
                    <li><a href="/infos.html">Infos</a></li>
                    <li><a href="/aide.html">Aide</a></li>
                    <li><a href="/plan.html" class="active">Plan</a></li>
                    <li><a href="/contact.html">Contact</a></li>
                </ul>
            </nav>
            <a href="/usager/login.html" class="btn-login">
                <i class="bi bi-person-circle"></i> Connexion
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <div class="plan-page-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i class="bi bi-map"></i>
                <span>Plan du site</span>
            </h1>
            <p>Explorez notre espace et découvrez où se trouvent nos collections</p>
        </div>

        <!-- Module Check Container -->
        <div id="contentContainer">
            <!-- Site Selector (shown only if multiple sites) -->
            <div class="site-selector-container d-none" id="siteSelectorContainer">
                <div class="site-selector">
                    <label for="siteSelect">
                        <i class="bi bi-building"></i>
                        Site :
                    </label>
                    <select id="siteSelect">
                        <option value="">Chargement...</option>
                    </select>
                </div>
            </div>

            <!-- Plan Container -->
            <div class="plan-container d-none" id="planContainer">
                <div class="plan-header">
                    <h2 class="plan-title">
                        <i class="bi bi-diagram-3"></i>
                        <span id="planTitle">Plan</span>
                    </h2>
                    <div class="etages-tabs" id="etagesTabs">
                        <!-- Tabs generated dynamically -->
                    </div>
                </div>

                <div class="plan-canvas-wrapper" id="canvasWrapper">
                    <div class="plan-loading" id="loadingIndicator">
                        <div class="spinner"></div>
                        <p>Chargement du plan...</p>
                    </div>

                    <div class="no-plan d-none" id="noPlan">
                        <i class="bi bi-map"></i>
                        <h4>Aucun plan disponible</h4>
                        <p>Le plan de ce site n'a pas encore été créé.</p>
                    </div>

                    <svg class="plan-svg d-none" id="planSvg" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <pattern id="gridPattern" width="20" height="20" patternUnits="userSpaceOnUse">
                                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/>
                            </pattern>
                        </defs>
                        <g id="planContent"></g>
                    </svg>

                    <!-- Zoom Controls -->
                    <div class="zoom-controls d-none" id="zoomControls">
                        <button id="btnZoomIn" title="Zoom avant">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <button id="btnZoomOut" title="Zoom arrière">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                        <button id="btnZoomReset" title="Réinitialiser">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                    </div>

                    <!-- Tooltip -->
                    <div class="plan-tooltip" id="planTooltip">
                        <div class="tooltip-title"></div>
                        <div class="tooltip-info"></div>
                    </div>
                </div>

                <div class="plan-legend d-none" id="planLegend">
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color mur"></div>
                            <span>Murs</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color etagere"></div>
                            <span>Étagères</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color meuble"></div>
                            <span>Meubles</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color table"></div>
                            <span>Tables</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color zone"></div>
                            <span>Zones</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module Disabled Message -->
            <div class="module-disabled d-none" id="moduleDisabled">
                <i class="bi bi-exclamation-triangle"></i>
                <h2>Plan non disponible</h2>
                <p>Le plan interactif n'est pas activé pour le moment. Veuillez contacter l'administration pour plus d'informations.</p>
                <a href="/" class="btn btn-primary">
                    <i class="bi bi-house"></i> Retour à l'accueil
                </a>
            </div>
        </div>
    </div>

    <!-- Side Panel for Articles -->
    <div class="side-panel" id="sidePanel">
        <div class="side-panel-header">
            <h3>
                <i class="bi bi-geo-alt"></i>
                <span id="emplacementName">Articles</span>
            </h3>
            <button class="side-panel-close" id="closePanelBtn">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="side-panel-body" id="sidePanelBody">
            <!-- Content loaded dynamically -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-section">
                <h4>Contact</h4>
                <p id="footer-address"></p>
                <p id="footer-phone"></p>
                <p id="footer-email"></p>
            </div>
            <div class="footer-section">
                <h4>Navigation</h4>
                <ul>
                    <li><a href="/">Accueil</a></li>
                    <li><a href="/catalogue.html">Catalogue</a></li>
                    <li><a href="/infos.html">Infos pratiques</a></li>
                    <li><a href="/plan.html">Plan</a></li>
                    <li><a href="/contact.html">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Légal</h4>
                <ul>
                    <li><a href="/mentions-legales.html">Mentions légales</a></li>
                    <li><a href="/cgu.html">CGU</a></li>
                    <li><a href="/cgv.html">CGV</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Espace membre</h4>
                <ul>
                    <li><a href="/usager/login.html">Connexion</a></li>
                    <li><a href="/admin/login.html">Administration</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <span id="year"></span> <span id="footer-name">Liberteko</span> - Tous droits réservés</p>
        </div>
    </footer>

    <!-- Snowfall Animation -->
    <script src="/theme/js/snowfall.js"></script>

    <script>
        /**
         * Plan Viewer - Winter Wonder Theme
         */
        const PlanApp = {
            moduleEnabled: false,
            sites: [],
            currentSiteId: null,
            plan: null,
            currentEtage: null,
            zoom: 1,
            panX: 0,
            panY: 0,
            isDragging: false,
            lastMousePos: { x: 0, y: 0 },

            async init() {
                // Set year
                document.getElementById('year').textContent = new Date().getFullYear();

                // Load config
                await this.loadConfig();

                // Check if module is enabled
                await this.checkModule();

                if (this.moduleEnabled) {
                    // Load sites
                    await this.loadSites();

                    // Bind events
                    this.bindEvents();

                    // Load plan for selected/first site
                    if (this.currentSiteId) {
                        await this.loadPlan();
                    }
                }
            },

            async loadConfig() {
                try {
                    const response = await fetch('/api/public/config');
                    const config = await response.json();

                    const siteName = config.nom_site || 'Liberteko';
                    document.getElementById('site-title').textContent = `Plan du site - ${siteName}`;
                    document.getElementById('header-title').textContent = siteName.toUpperCase();
                    document.getElementById('footer-name').textContent = siteName;

                    // Contact info
                    if (config.contact) {
                        if (config.contact.adresse) {
                            document.getElementById('footer-address').innerHTML = `<i class="bi bi-geo-alt"></i> ${config.contact.adresse}`;
                        }
                        if (config.contact.telephone) {
                            document.getElementById('footer-phone').innerHTML = `<i class="bi bi-telephone"></i> ${config.contact.telephone}`;
                        }
                        if (config.contact.email) {
                            document.getElementById('footer-email').innerHTML = `<i class="bi bi-envelope"></i> ${config.contact.email}`;
                        }
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            },

            async checkModule() {
                try {
                    const response = await fetch('/api/public/parametres');
                    const params = await response.json();
                    this.moduleEnabled = params.module_plan_interactif === true;

                    if (this.moduleEnabled) {
                        document.getElementById('planContainer').classList.remove('d-none');
                    } else {
                        document.getElementById('moduleDisabled').classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Error checking module:', error);
                    document.getElementById('moduleDisabled').classList.remove('d-none');
                }
            },

            async loadSites() {
                try {
                    const response = await fetch('/api/sites');
                    if (!response.ok) throw new Error('Cannot load sites');

                    this.sites = await response.json();

                    // Get site from URL or use first site
                    const params = new URLSearchParams(window.location.search);
                    const urlSiteId = params.get('site');

                    if (urlSiteId && this.sites.find(s => s.id == urlSiteId)) {
                        this.currentSiteId = parseInt(urlSiteId);
                    } else if (this.sites.length > 0) {
                        this.currentSiteId = this.sites[0].id;
                    }

                    // Show site selector if multiple sites
                    if (this.sites.length > 1) {
                        this.renderSiteSelector();
                    }
                } catch (error) {
                    console.error('Error loading sites:', error);
                    // Try to load default site
                    this.currentSiteId = 1;
                }
            },

            renderSiteSelector() {
                const container = document.getElementById('siteSelectorContainer');
                const select = document.getElementById('siteSelect');

                select.innerHTML = this.sites.map(site =>
                    `<option value="${site.id}" ${site.id === this.currentSiteId ? 'selected' : ''}>
                        ${site.nom}
                    </option>`
                ).join('');

                select.addEventListener('change', (e) => {
                    this.currentSiteId = parseInt(e.target.value);
                    this.loadPlan();
                });

                container.classList.remove('d-none');
            },

            bindEvents() {
                // Zoom controls
                document.getElementById('btnZoomIn').addEventListener('click', () => this.setZoom(this.zoom * 1.2));
                document.getElementById('btnZoomOut').addEventListener('click', () => this.setZoom(this.zoom / 1.2));
                document.getElementById('btnZoomReset').addEventListener('click', () => this.resetView());

                // Pan with mouse drag
                const svg = document.getElementById('planSvg');
                svg.addEventListener('mousedown', (e) => this.onMouseDown(e));
                svg.addEventListener('mousemove', (e) => this.onMouseMove(e));
                svg.addEventListener('mouseup', () => this.onMouseUp());
                svg.addEventListener('mouseleave', () => this.onMouseUp());

                // Zoom with wheel
                svg.addEventListener('wheel', (e) => this.onWheel(e));

                // Close side panel
                document.getElementById('closePanelBtn').addEventListener('click', () => this.closeSidePanel());
            },

            async loadPlan() {
                try {
                    document.getElementById('loadingIndicator').classList.remove('d-none');
                    document.getElementById('planSvg').classList.add('d-none');
                    document.getElementById('noPlan').classList.add('d-none');

                    const response = await fetch(`/api/plans/public/site/${this.currentSiteId}`);

                    if (!response.ok) {
                        if (response.status === 404) {
                            this.showNoPlan();
                            return;
                        }
                        throw new Error('Error loading plan');
                    }

                    this.plan = await response.json();
                    this.renderPlan();

                } catch (error) {
                    console.error('Error:', error);
                    this.showNoPlan();
                }
            },

            showNoPlan() {
                document.getElementById('loadingIndicator').classList.add('d-none');
                document.getElementById('noPlan').classList.remove('d-none');
            },

            renderPlan() {
                if (!this.plan || !this.plan.etages || this.plan.etages.length === 0) {
                    this.showNoPlan();
                    return;
                }

                // Hide loading, show plan
                document.getElementById('loadingIndicator').classList.add('d-none');
                document.getElementById('planSvg').classList.remove('d-none');
                document.getElementById('zoomControls').classList.remove('d-none');
                document.getElementById('planLegend').classList.remove('d-none');

                // Update title
                document.getElementById('planTitle').textContent = this.plan.nom || 'Plan du site';

                // Render etages tabs
                this.renderEtagesTabs();

                // Select first etage
                if (this.plan.etages.length > 0) {
                    this.selectEtage(this.plan.etages[0].id);
                }
            },

            renderEtagesTabs() {
                const container = document.getElementById('etagesTabs');
                container.innerHTML = '';

                this.plan.etages.forEach(etage => {
                    const tab = document.createElement('button');
                    tab.className = 'etage-tab';
                    tab.dataset.etageId = etage.id;

                    let label = etage.nom;
                    if (etage.type === 'etage' && etage.numero !== null) {
                        label = etage.numero === 0 ? 'RDC' : `Étage ${etage.numero}`;
                        if (etage.nom && etage.nom !== label) {
                            label += ` - ${etage.nom}`;
                        }
                    }

                    tab.textContent = label;
                    tab.addEventListener('click', () => this.selectEtage(etage.id));
                    container.appendChild(tab);
                });
            },

            selectEtage(etageId) {
                // Update active tab
                document.querySelectorAll('.etage-tab').forEach(tab => {
                    tab.classList.toggle('active', parseInt(tab.dataset.etageId) === etageId);
                });

                // Find etage
                this.currentEtage = this.plan.etages.find(e => e.id === etageId);
                if (!this.currentEtage) return;

                // Reset view
                this.resetView();

                // Render elements
                this.renderElements();
            },

            renderElements() {
                const content = document.getElementById('planContent');
                content.innerHTML = '';

                if (!this.currentEtage || !this.currentEtage.elements) return;

                // Set SVG viewBox
                const svg = document.getElementById('planSvg');
                const width = this.plan.largeur_defaut || 1200;
                const height = this.plan.hauteur_defaut || 800;
                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

                // Background
                if (this.currentEtage.couleur_fond) {
                    const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    bg.setAttribute('x', 0);
                    bg.setAttribute('y', 0);
                    bg.setAttribute('width', width);
                    bg.setAttribute('height', height);
                    bg.setAttribute('fill', this.currentEtage.couleur_fond);
                    content.appendChild(bg);
                }

                // Sort elements: zones first (background), then others
                const sortedElements = [...this.currentEtage.elements].sort((a, b) => {
                    const order = { zone: 0, mur: 1, etagere: 2, meuble: 3, table: 4 };
                    return (order[a.type_element] || 5) - (order[b.type_element] || 5);
                });

                // Render each element
                sortedElements.forEach(element => {
                    this.renderElement(element, content);
                });

                this.updateTransform();
            },

            renderElement(element, container) {
                const points = element.points || [];
                if (points.length === 0) return;

                let svgElement;

                if (element.type_element === 'mur') {
                    // Wall: polyline
                    svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
                    svgElement.setAttribute('points', pointsStr);
                    svgElement.classList.add('element-mur');
                    container.appendChild(svgElement);
                } else {
                    // Rectangle elements
                    if (points.length >= 2) {
                        const x = Math.min(points[0].x, points[1].x);
                        const y = Math.min(points[0].y, points[1].y);
                        const w = Math.abs(points[1].x - points[0].x);
                        const h = Math.abs(points[1].y - points[0].y);

                        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                        group.dataset.elementId = element.id;
                        group.dataset.type = element.type_element;

                        // Rectangle
                        svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        svgElement.setAttribute('x', x);
                        svgElement.setAttribute('y', y);
                        svgElement.setAttribute('width', w);
                        svgElement.setAttribute('height', h);
                        svgElement.classList.add(`element-${element.type_element}`);

                        // Apply rotation if exists
                        if (element.rotation) {
                            const cx = x + w / 2;
                            const cy = y + h / 2;
                            svgElement.setAttribute('transform', `rotate(${element.rotation} ${cx} ${cy})`);
                        }

                        // Apply custom style
                        if (element.style) {
                            if (element.style.couleur) svgElement.style.fill = element.style.couleur;
                            if (element.style.couleur_bordure) svgElement.style.stroke = element.style.couleur_bordure;
                        }

                        group.appendChild(svgElement);

                        // Label
                        if (element.nom) {
                            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            label.setAttribute('x', x + w / 2);
                            label.setAttribute('y', y + h / 2);
                            label.classList.add('element-label');
                            label.textContent = element.nom;
                            group.appendChild(label);
                        }

                        // Interactive elements (with emplacements)
                        if (element.emplacements && element.emplacements.length > 0) {
                            group.style.cursor = 'pointer';
                            group.addEventListener('click', () => this.showArticles(element));
                            group.addEventListener('mouseenter', (e) => this.showTooltip(e, element));
                            group.addEventListener('mousemove', (e) => this.moveTooltip(e));
                            group.addEventListener('mouseleave', () => this.hideTooltip());
                        }

                        container.appendChild(group);
                    }
                }
            },

            showTooltip(event, element) {
                const tooltip = document.getElementById('planTooltip');
                const title = tooltip.querySelector('.tooltip-title');
                const info = tooltip.querySelector('.tooltip-info');

                title.textContent = element.nom || this.getTypeName(element.type_element);

                const nbEmplacements = element.emplacements ? element.emplacements.length : 0;
                const nbArticles = element.emplacements ?
                    element.emplacements.reduce((sum, e) => sum + (e.nb_articles || 0), 0) : 0;

                info.innerHTML = `
                    <i class="bi bi-geo-alt"></i> ${nbEmplacements} emplacement(s)<br>
                    <i class="bi bi-box"></i> ${nbArticles} article(s)
                `;

                tooltip.classList.add('visible');
                this.moveTooltip(event);
            },

            moveTooltip(event) {
                const tooltip = document.getElementById('planTooltip');
                const wrapper = document.getElementById('canvasWrapper');
                const rect = wrapper.getBoundingClientRect();

                let x = event.clientX - rect.left + 15;
                let y = event.clientY - rect.top + 15;

                // Keep tooltip in bounds
                if (x + tooltip.offsetWidth > rect.width) {
                    x = event.clientX - rect.left - tooltip.offsetWidth - 15;
                }
                if (y + tooltip.offsetHeight > rect.height) {
                    y = event.clientY - rect.top - tooltip.offsetHeight - 15;
                }

                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            },

            hideTooltip() {
                document.getElementById('planTooltip').classList.remove('visible');
            },

            getTypeName(type) {
                const names = {
                    mur: 'Mur',
                    etagere: 'Étagère',
                    meuble: 'Meuble',
                    table: 'Table',
                    zone: 'Zone'
                };
                return names[type] || type;
            },

            async showArticles(element) {
                // Open side panel
                document.getElementById('sidePanel').classList.add('open');
                document.getElementById('emplacementName').textContent = element.nom || this.getTypeName(element.type_element);

                const bodyContainer = document.getElementById('sidePanelBody');

                // Show loading
                bodyContainer.innerHTML = '<div class="articles-loading"><div class="spinner"></div><p>Chargement...</p></div>';

                try {
                    // Fetch articles for this element
                    const response = await fetch(`/api/plans/public/elements/${element.id}/articles`);

                    if (!response.ok) throw new Error('Error loading articles');

                    const articles = await response.json();

                    if (articles.length === 0) {
                        bodyContainer.innerHTML = `
                            <div class="no-articles">
                                <i class="bi bi-inbox"></i>
                                <p>Aucun article à cet emplacement</p>
                            </div>
                        `;
                        return;
                    }

                    bodyContainer.innerHTML = `
                        <div class="articles-list">
                            ${articles.map(article => `
                                <a href="/fiche.html?collection=${article.type}&id=${article.id}" class="article-card">
                                    <img src="${article.image || '/images/placeholder.png'}" alt="" class="article-image">
                                    <div class="article-info">
                                        <div class="article-title">${this.escapeHtml(article.nom)}</div>
                                        <div class="article-meta">
                                            ${article.emplacement ? `<span><i class="bi bi-geo-alt"></i> ${article.emplacement}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="article-badges">
                                        <span class="type-badge ${article.type}">${this.getTypeLabel(article.type)}</span>
                                        <span class="status-badge ${article.disponible ? 'disponible' : 'emprunte'}">
                                            ${article.disponible ? 'Disponible' : 'Emprunté'}
                                        </span>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    `;

                } catch (error) {
                    console.error('Error:', error);
                    bodyContainer.innerHTML = `
                        <div class="no-articles">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Erreur de chargement des articles</p>
                        </div>
                    `;
                }
            },

            closeSidePanel() {
                document.getElementById('sidePanel').classList.remove('open');
            },

            getTypeLabel(type) {
                const labels = {
                    jeu: 'Jeu',
                    livre: 'Livre',
                    film: 'Film',
                    disque: 'Disque'
                };
                return labels[type] || type;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // Zoom & Pan
            setZoom(newZoom) {
                this.zoom = Math.max(0.25, Math.min(4, newZoom));
                this.updateTransform();
            },

            resetView() {
                this.zoom = 1;
                this.panX = 0;
                this.panY = 0;
                this.updateTransform();
            },

            updateTransform() {
                const content = document.getElementById('planContent');
                content.setAttribute('transform', `translate(${this.panX}, ${this.panY}) scale(${this.zoom})`);
            },

            onMouseDown(e) {
                if (e.button === 0 && e.target.tagName === 'svg') {
                    this.isDragging = true;
                    this.lastMousePos = { x: e.clientX, y: e.clientY };
                }
            },

            onMouseMove(e) {
                if (this.isDragging) {
                    const dx = e.clientX - this.lastMousePos.x;
                    const dy = e.clientY - this.lastMousePos.y;
                    this.panX += dx;
                    this.panY += dy;
                    this.lastMousePos = { x: e.clientX, y: e.clientY };
                    this.updateTransform();
                }
            },

            onMouseUp() {
                this.isDragging = false;
            },

            onWheel(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                this.setZoom(this.zoom * delta);
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => PlanApp.init());
    </script>
    <script src="/js/animation-toggle.js"></script>
</body>
</html>
