<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes emprunts - Espace Usager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --couleur-primaire: #0d6efd;
      --couleur-secondaire: #6c757d;
    }
    body {
      background-color: #f8f9fa;
    }
    .navbar {
      background: var(--couleur-primaire) !important;
    }
    .nav-tabs .nav-link {
      color: var(--couleur-secondaire);
      border: none;
      padding: 1rem 1.5rem;
    }
    .nav-tabs .nav-link.active {
      color: var(--couleur-primaire);
      border-bottom: 3px solid var(--couleur-primaire);
      background: transparent;
    }
    .emprunt-card {
      border: none;
      border-radius: 0.75rem;
      transition: box-shadow 0.2s;
      margin-bottom: 1rem;
    }
    .emprunt-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      background: #e9ecef;
    }
    .item-image-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
    }
    .item-image-placeholder.jeu { background: linear-gradient(135deg, #6f42c1, #8b5cf6); }
    .item-image-placeholder.livre { background: linear-gradient(135deg, #20c997, #10b981); }
    .item-image-placeholder.film { background: linear-gradient(135deg, #fd7e14, #f59e0b); }
    .item-image-placeholder.disque { background: linear-gradient(135deg, #e83e8c, #ec4899); }
    .badge-type {
      font-size: 0.7rem;
      padding: 0.25em 0.5em;
    }
    .badge-jeu { background: #6f42c1; }
    .badge-livre { background: #20c997; }
    .badge-film { background: #fd7e14; }
    .badge-disque { background: #e83e8c; }
    .badge-retard { background: #dc3545; }
    .badge-warning { background: #ffc107; color: #000; }
    .badge-ok { background: #198754; }
    .badge-retourne { background: #6c757d; }
    .timeline {
      position: relative;
      padding-left: 2rem;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e9ecef;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 0.75rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.5rem;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--couleur-primaire);
    }
    .timeline-item.auto::before { background: #198754; }
    .timeline-item.manuelle::before { background: #ffc107; }
    .timeline-item.refusee::before { background: #dc3545; }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      opacity: 0.3;
    }
    .pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="dashboard.html" id="siteName">Mon Espace</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html"><i class="bi bi-house me-1"></i>Accueil</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="emprunts.html"><i class="bi bi-collection me-1"></i>Mes emprunts</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle me-1"></i><span id="userName">Mon compte</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="profil.html"><i class="bi bi-person me-2"></i>Mon profil</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" id="btnLogout"><i class="bi bi-box-arrow-right me-2"></i>Deconnexion</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenu -->
  <div class="container py-4">
    <h4 class="mb-4"><i class="bi bi-collection me-2"></i>Mes emprunts</h4>

    <!-- Onglets -->
    <ul class="nav nav-tabs mb-4" id="empruntsTabs">
      <li class="nav-item">
        <a class="nav-link active" href="#" data-tab="en-cours">
          <i class="bi bi-clock me-1"></i>En cours
          <span class="badge bg-primary ms-1" id="countEnCours">0</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" data-tab="historique">
          <i class="bi bi-archive me-1"></i>Historique
        </a>
      </li>
    </ul>

    <!-- Contenu des onglets -->
    <div id="tabContent">
      <div class="text-center py-4">
        <div class="spinner-border text-primary"></div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container d-none" id="paginationContainer">
      <nav>
        <ul class="pagination" id="pagination"></ul>
      </nav>
    </div>
  </div>

  <!-- Modal Details -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Details de l'emprunt</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailsContent">
          <div class="text-center py-4">
            <div class="spinner-border text-primary"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Prolongation -->
  <div class="modal fade" id="prolongationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Demander une prolongation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Vous etes sur le point de demander une prolongation pour :</p>
          <h6 id="prolongationItemTitle" class="mb-3"></h6>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <span id="prolongationInfo"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="btnConfirmProlongation">
            <i class="bi bi-check me-1"></i>Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = '/api';
    let currentTab = 'en-cours';
    let currentPage = 1;
    let currentEmpruntId = null;

    // Auth
    function checkAuth() {
      const token = localStorage.getItem('usager_token');
      if (!token) {
        window.location.href = 'login.html';
        return null;
      }
      return token;
    }

    function getHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('usager_token')}`
      };
    }

    // User info
    function loadUserInfo() {
      const userInfo = JSON.parse(localStorage.getItem('usager_info') || '{}');
      document.getElementById('userName').textContent = userInfo.prenom || 'Mon compte';
    }

    // Type badge
    function getTypeBadge(type) {
      const badges = {
        jeu: '<span class="badge badge-type badge-jeu">Jeu</span>',
        livre: '<span class="badge badge-type badge-livre">Livre</span>',
        film: '<span class="badge badge-type badge-film">Film</span>',
        disque: '<span class="badge badge-type badge-disque">Disque</span>'
      };
      return badges[type] || '';
    }

    // Type icon
    function getTypeIcon(type) {
      const icons = {
        jeu: 'bi-dice-5',
        livre: 'bi-book',
        film: 'bi-film',
        disque: 'bi-vinyl'
      };
      return icons[type] || 'bi-box';
    }

    // Render item image with fallback placeholder
    function renderItemImage(item, type) {
      if (item?.image_url) {
        return `<img src="${item.image_url}" alt="" class="item-image me-3" onerror="this.outerHTML='<div class=\\'item-image-placeholder ${type} me-3\\'><i class=\\'bi ${getTypeIcon(type)}\\'></i></div>'">`;
      }
      return `<div class="item-image-placeholder ${type} me-3"><i class="bi ${getTypeIcon(type)}"></i></div>`;
    }

    // Statut badge
    function getStatutBadge(emprunt) {
      if (emprunt.statut === 'retourne') {
        return '<span class="badge badge-retourne">Retourne</span>';
      }
      const jours = emprunt.jours_restants;
      if (emprunt.statut === 'en_retard' || jours < 0) {
        return `<span class="badge badge-retard">${Math.abs(jours)} jour(s) de retard</span>`;
      }
      if (jours <= 3) {
        return `<span class="badge badge-warning">${jours} jour(s) restant(s)</span>`;
      }
      return `<span class="badge badge-ok">${jours} jours restants</span>`;
    }

    // Charger emprunts en cours
    async function loadEnCours() {
      const container = document.getElementById('tabContent');

      try {
        const response = await fetch(`${API_URL}/usager/emprunts/en-cours`, {
          headers: getHeaders()
        });

        if (response.status === 401) {
          localStorage.removeItem('usager_token');
          window.location.href = 'login.html';
          return;
        }

        const data = await response.json();
        const emprunts = data.emprunts || [];

        document.getElementById('countEnCours').textContent = emprunts.length;
        document.getElementById('paginationContainer').classList.add('d-none');

        if (emprunts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <h6 class="mt-3">Aucun emprunt en cours</h6>
              <p>Vous n'avez pas d'emprunt actuellement.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = emprunts.map(emprunt => renderEmpruntCard(emprunt, true)).join('');
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    // Charger historique
    async function loadHistorique(page = 1) {
      const container = document.getElementById('tabContent');

      try {
        const response = await fetch(`${API_URL}/usager/emprunts/historique?page=${page}&limit=10`, {
          headers: getHeaders()
        });

        const data = await response.json();
        const emprunts = data.historique || [];
        const pagination = data.pagination;

        if (emprunts.length === 0 && page === 1) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-archive"></i>
              <h6 class="mt-3">Historique vide</h6>
              <p>Vous n'avez pas encore retourne d'emprunt.</p>
            </div>
          `;
          document.getElementById('paginationContainer').classList.add('d-none');
          return;
        }

        container.innerHTML = emprunts.map(emprunt => renderEmpruntCard(emprunt, false)).join('');

        // Pagination
        if (pagination.pages > 1) {
          renderPagination(pagination);
          document.getElementById('paginationContainer').classList.remove('d-none');
        } else {
          document.getElementById('paginationContainer').classList.add('d-none');
        }
      } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
      }
    }

    // Render carte emprunt
    function renderEmpruntCard(emprunt, showProlongation) {
      const item = emprunt.item;
      const itemType = emprunt.item_type;
      const prolongationBtn = showProlongation && emprunt.prolongation?.possible &&
        (emprunt.prolongation.auto_restantes > 0 || emprunt.prolongation.manuelle_possible)
        ? `<button class="btn btn-sm btn-outline-primary" onclick="openProlongation(${emprunt.id}, '${item?.titre?.replace(/'/g, "\\'")}', ${emprunt.prolongation.jours_accordes}, ${emprunt.prolongation.auto_restantes > 0})">
            <i class="bi bi-arrow-repeat me-1"></i>Prolonger
           </button>`
        : '';

      return `
        <div class="card emprunt-card shadow-sm">
          <div class="card-body">
            <div class="d-flex">
              ${renderItemImage(item, itemType)}
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">${item?.titre || 'Article'}</h6>
                    <div class="mb-2">${getTypeBadge(itemType)}</div>
                  </div>
                  ${getStatutBadge(emprunt)}
                </div>
                <div class="row text-muted small">
                  <div class="col-sm-4">
                    <i class="bi bi-calendar-plus me-1"></i>Emprunte le ${new Date(emprunt.date_emprunt).toLocaleDateString('fr-FR')}
                  </div>
                  <div class="col-sm-4">
                    <i class="bi bi-calendar-check me-1"></i>Retour prevu ${new Date(emprunt.date_retour_prevue).toLocaleDateString('fr-FR')}
                  </div>
                  ${emprunt.date_retour_effective ? `
                  <div class="col-sm-4">
                    <i class="bi bi-check-circle me-1"></i>Retourne le ${new Date(emprunt.date_retour_effective).toLocaleDateString('fr-FR')}
                  </div>
                  ` : ''}
                </div>
                ${emprunt.nb_prolongations > 0 ? `<div class="mt-2"><span class="badge bg-secondary">${emprunt.nb_prolongations} prolongation(s)</span></div>` : ''}
              </div>
              <div class="ms-3 d-flex flex-column gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="showDetails(${emprunt.id})">
                  <i class="bi bi-eye"></i>
                </button>
                ${prolongationBtn}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Pagination
    function renderPagination(pagination) {
      const container = document.getElementById('pagination');
      let html = '';

      if (pagination.page > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">&laquo;</a></li>`;
      }

      for (let i = 1; i <= pagination.pages; i++) {
        html += `<li class="page-item ${i === pagination.page ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>`;
      }

      if (pagination.page < pagination.pages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">&raquo;</a></li>`;
      }

      container.innerHTML = html;
    }

    function changePage(page) {
      currentPage = page;
      loadHistorique(page);
    }

    // Details
    async function showDetails(id) {
      const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
      const content = document.getElementById('detailsContent');
      modal.show();

      try {
        const response = await fetch(`${API_URL}/usager/emprunts/${id}`, {
          headers: getHeaders()
        });
        const emprunt = await response.json();
        const itemType = emprunt.item_type;

        const imageHtml = emprunt.item?.image_url
          ? `<img src="${emprunt.item.image_url}" alt="" class="img-fluid rounded mb-3" style="max-height: 200px;" onerror="this.outerHTML='<div class=\\'item-image-placeholder ${itemType} mb-3\\' style=\\'width:150px;height:150px;margin:0 auto;\\'><i class=\\'bi ${getTypeIcon(itemType)}\\' style=\\'font-size:3rem;\\'></i></div>'">`
          : `<div class="item-image-placeholder ${itemType} mb-3" style="width:150px;height:150px;margin:0 auto;"><i class="bi ${getTypeIcon(itemType)}" style="font-size:3rem;"></i></div>`;

        content.innerHTML = `
          <div class="row">
            <div class="col-md-4 text-center">
              ${imageHtml}
              ${getTypeBadge(itemType)}
            </div>
            <div class="col-md-8">
              <h5>${emprunt.item?.titre || 'Article'}</h5>
              <table class="table table-sm">
                <tr><th>Date d'emprunt</th><td>${new Date(emprunt.date_emprunt).toLocaleDateString('fr-FR')}</td></tr>
                <tr><th>Retour prevu</th><td>${new Date(emprunt.date_retour_prevue).toLocaleDateString('fr-FR')}</td></tr>
                ${emprunt.date_retour_initiale ? `<tr><th>Retour initial</th><td>${new Date(emprunt.date_retour_initiale).toLocaleDateString('fr-FR')}</td></tr>` : ''}
                ${emprunt.date_retour_effective ? `<tr><th>Retourne le</th><td>${new Date(emprunt.date_retour_effective).toLocaleDateString('fr-FR')}</td></tr>` : ''}
                <tr><th>Statut</th><td>${getStatutBadge(emprunt)}</td></tr>
                <tr><th>Prolongations</th><td>${emprunt.nb_prolongations || 0}</td></tr>
              </table>

              ${emprunt.prolongations && emprunt.prolongations.length > 0 ? `
                <h6 class="mt-4">Historique des prolongations</h6>
                <div class="timeline">
                  ${emprunt.prolongations.map(p => `
                    <div class="timeline-item ${p.type} ${p.statut === 'refusee' ? 'refusee' : ''}">
                      <strong>${p.type === 'automatique' ? 'Auto' : 'Manuelle'}</strong>
                      - ${p.jours_ajoutes} jours
                      <span class="badge ${p.statut === 'validee' ? 'bg-success' : p.statut === 'refusee' ? 'bg-danger' : 'bg-warning'}">${p.statut}</span>
                      <br><small class="text-muted">${new Date(p.date_demande).toLocaleDateString('fr-FR')}</small>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      } catch (error) {
        content.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement des details</div>';
      }
    }

    // Prolongation
    function openProlongation(empruntId, titre, jours, isAuto) {
      currentEmpruntId = empruntId;
      document.getElementById('prolongationItemTitle').textContent = titre;
      document.getElementById('prolongationInfo').textContent = isAuto
        ? `Cette prolongation de ${jours} jours sera accordee automatiquement.`
        : `Cette demande de prolongation (${jours} jours) sera soumise a validation.`;
      new bootstrap.Modal(document.getElementById('prolongationModal')).show();
    }

    document.getElementById('btnConfirmProlongation').addEventListener('click', async () => {
      const btn = document.getElementById('btnConfirmProlongation');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Envoi...';

      try {
        const response = await fetch(`${API_URL}/usager/emprunts/${currentEmpruntId}/prolonger`, {
          method: 'POST',
          headers: getHeaders()
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Erreur lors de la prolongation');
        }

        bootstrap.Modal.getInstance(document.getElementById('prolongationModal')).hide();
        alert(data.message + (data.avertissement ? '\n\n' + data.avertissement : ''));
        loadEnCours();
      } catch (error) {
        alert(error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Confirmer';
      }
    });

    // Onglets
    document.querySelectorAll('#empruntsTabs .nav-link').forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('#empruntsTabs .nav-link').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        currentPage = 1;

        if (currentTab === 'en-cours') {
          loadEnCours();
        } else {
          loadHistorique();
        }
      });
    });

    // Logout
    document.getElementById('btnLogout').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('usager_token');
      localStorage.removeItem('usager_info');
      window.location.href = 'login.html';
    });

    // Init
    if (checkAuth()) {
      loadUserInfo();
      loadEnCours();
    }
  </script>
</body>
</html>
